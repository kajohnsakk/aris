[{"id":"f3b6bbf6.437c88","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"c1a8034a.38433","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"4ae7f72e.33e4a8","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"cb20a881.1311f8","type":"tab","label":"WEBFORM_RECONCILE","disabled":false,"info":""},{"id":"a926ea52.1ac368","type":"tab","label":"CHECK_GBPAY_PAYMENT_STATUS","disabled":false,"info":""},{"id":"8913cd6.260d13","type":"tab","label":"CHECK_VERIFY_BANK_ACCOUNT","disabled":false,"info":""},{"id":"e3110c85.6a04a","type":"tab","label":"CHECK_VERIFY_BANK_ACCOUNT_API","disabled":false,"info":""},{"id":"1db78bed.51e4f4","type":"tab","label":"CALCULATE_GBPAY_PAYMENT_FEE","disabled":false,"info":""},{"id":"b6c1c291.17b39","type":"tab","label":"SERVER_STATUS","disabled":false,"info":""},{"id":"c0036ad7.2ae908","type":"tab","label":"SERVER_SIDE_MANAGEMENT","disabled":false,"info":""},{"id":"f527f707.d5a028","type":"tab","label":"UTILITIES","disabled":false,"info":""},{"id":"2928f438.efbd8c","type":"tab","label":"FACEBOOK_TOKEN","disabled":false,"info":""},{"id":"e8022868.328888","type":"tab","label":"FILL_MISSING_FB_NAME_IN_ORDERS","disabled":false,"info":""},{"id":"857f6a49.c4a9c8","type":"tab","label":"UNUSED","disabled":true,"info":""},{"id":"3d002355.92967c","type":"tab","label":"CHECK_STORE_FACEBOOK_TOKEN","disabled":false,"info":""},{"id":"54db45d9.f3c69c","type":"tab","label":"RE-ENRICH_FB_USER","disabled":false,"info":""},{"id":"7d797c29.c6e334","type":"tab","label":"EVENT_CALENDAR_NOTIFY","disabled":false,"info":""},{"id":"e8be7382.4fff","type":"tab","label":"GITHUB","disabled":false,"info":""},{"id":"3ab4a75f.ad0fa8","type":"tab","label":"AUTOMATICALLY_ADD_FILTERDATE_FIELD","disabled":false,"info":""},{"id":"e1d0a067.d26ac","type":"tab","label":"LAB","disabled":false,"info":""},{"id":"2880ede8.a08db2","type":"tab","label":"CHECK_SINGLE_ORDER_STATUS","disabled":false,"info":""},{"id":"bd1a26e8.d70568","type":"tab","label":"GET_PLATFORM_PACKAGE","disabled":false,"info":""},{"id":"e9d0b6f8.aa9d68","type":"tab","label":"CHECK_CURRENT_STORE_PACKAGE","disabled":false,"info":""},{"id":"96714785.e18a48","type":"tab","label":"RECURRING_RESULT","disabled":false,"info":""},{"id":"3f620e82.481e02","type":"tab","label":"REFRESH_PAGE","disabled":false,"info":""},{"id":"353f8139.23f9ee","type":"tab","label":"LIVE_FORMAT_CHECKER","disabled":false,"info":""},{"id":"4780809c.72938","type":"subflow","name":"GET_FB_APP_ACCESS_TOKEN","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"9e67d65e.ef2ac8"}]}],"out":[{"x":500,"y":260,"wires":[{"id":"76e29b78.9c7ef4","port":0}]}],"env":[]},{"id":"e94cb67f.c8bdb8","type":"subflow","name":"VALIDATE_PAGE_TOKEN","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"c702d382.d3389"}]}],"out":[{"x":1120,"y":200,"wires":[{"id":"2cb2f4b5.f564fc","port":0}]}],"env":[]},{"id":"f4a4de11.64a5b","type":"subflow","name":"GET_ARIS_SALES_CHANNEL_LIST","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"f0e03117.b3e5a"}]}],"out":[{"x":580,"y":320,"wires":[{"id":"46d110d0.35f19","port":0}]}],"env":[]},{"id":"f9558482.a57198","type":"subflow","name":"GET_NJOIN_CHANNEL_LIST","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"b12117ed.ae9e68"}]}],"out":[{"x":660,"y":320,"wires":[{"id":"a33fd24a.19962","port":0}]}],"env":[]},{"id":"d9807e99.e20e","type":"subflow","name":"SET_ES_AUTH_HEADER","info":"","category":"","in":[{"x":100,"y":120,"wires":[{"id":"64850d4d.a73a64"}]}],"out":[{"x":360,"y":180,"wires":[{"id":"64850d4d.a73a64","port":0}]}],"env":[]},{"id":"8402b62c.173098","type":"subflow","name":"GET_NJOIN_CHANNEL_INFO","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"b76edad2.25eba8"}]}],"out":[{"x":940,"y":320,"wires":[{"id":"8a164b45.127548","port":0}]}],"env":[]},{"id":"23202381.5182ac","type":"subflow","name":"DELETE_CURRENT_NJOIN_CHANNEL","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"62b76312.abac7c"}]}],"out":[{"x":520,"y":300,"wires":[{"id":"251275c9.82ad2a","port":0}]}],"env":[]},{"id":"18a54c13.8f5a14","type":"subflow","name":"CREATE_NEW_NJOIN_CHANNEL","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"4a86807d.1e437"}]}],"out":[{"x":660,"y":300,"wires":[{"id":"842e2470.0eebd8","port":0}]}],"env":[]},{"id":"18d8766d.0eab4a","type":"subflow","name":"PROCESS_NJOIN_CHANNEL_OBJECT","info":"","category":"","in":[{"x":60,"y":240,"wires":[{"id":"4003a56f.ba7eac"}]}],"out":[{"x":1420,"y":240,"wires":[{"id":"6dad861.0d9c678","port":0},{"id":"fec507bd.6e7078","port":0}]}],"env":[]},{"id":"9b3766de.c1d1f8","type":"subflow","name":"GET_ARIS_ORDERS","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"bf3eb56.9939b48"}]}],"out":[{"x":580,"y":280,"wires":[{"id":"2fdfddc7.8b0622","port":0}]}],"env":[]},{"id":"7c57b6ff.5c2668","type":"subflow","name":"GET_UNENRICHED_ORDERS","info":"","category":"","in":[{"x":140,"y":140,"wires":[{"id":"b93559c0.5d97d8"}]}],"out":[{"x":480,"y":340,"wires":[{"id":"2c78f769.cb8748","port":0}]}],"env":[]},{"id":"76ec9c8c.680c04","type":"subflow","name":"GET_USER_INFO_BY_PSID","info":"","category":"","in":[{"x":80,"y":100,"wires":[{"id":"6a2bdb07.115634"}]}],"out":[{"x":740,"y":560,"wires":[{"id":"e17bf791.9b4ea8","port":0},{"id":"79d7433e.9d39ac","port":0}]}],"env":[]},{"id":"f994513c.ce808","type":"subflow","name":"UPDATE_ORDER_BY_ID","info":"","category":"","in":[{"x":140,"y":180,"wires":[{"id":"c4c5b93c.309df8"}]}],"out":[{"x":640,"y":300,"wires":[{"id":"be681891.19be38","port":0}]}],"env":[]},{"id":"ad109f4f.2bbca","type":"subflow","name":"ENRICH_FB_USER","info":"","category":"","in":[{"x":120,"y":140,"wires":[{"id":"97052783.238658"}]}],"out":[{"x":580,"y":360,"wires":[{"id":"5f794c99.b863d4","port":0}]}],"env":[]},{"id":"d7b9dd24.581ab","type":"subflow","name":"UPDATE_FIELD_WITH_SCRIPT","info":"","category":"","in":[{"x":120,"y":120,"wires":[{"id":"9e29c9ee.e90cb8"}]}],"out":[{"x":720,"y":360,"wires":[{"id":"c50464f2.032a48","port":0}]}],"env":[]},{"id":"d3d9dfef.e84f3","type":"subflow","name":"GET_ALL_STORE_INTO_MSG","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"95287fd9.f2ab3"}]}],"out":[{"x":360,"y":160,"wires":[{"id":"9b220d7d.6e4ee","port":0}]}],"env":[]},{"id":"e3259a63.dffef8","type":"subflow","name":"GET_ALL_PACKAGE","info":"","category":"","in":[{"x":20,"y":80,"wires":[{"id":"6ed4a717.ea6778"}]}],"out":[{"x":120,"y":160,"wires":[{"id":"c96572f1.e2757","port":0}]}],"env":[]},{"id":"8c824985.837028","type":"subflow","name":"GET_CURRENT_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"b6280643.a99748"}]}],"out":[{"x":340,"y":160,"wires":[{"id":"7cec02a9.3eabec","port":0}]}],"env":[]},{"id":"b4ba47fc.ef5b78","type":"subflow","name":"GET_ALL_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"4b9d93b0.5f774c"}]}],"out":[{"x":340,"y":160,"wires":[{"id":"beb9856a.5df008","port":0}]}],"env":[]},{"id":"6cb8ab4b.297704","type":"subflow","name":"GET_LAST_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"b8b748.d8f898b8"}]}],"out":[{"x":340,"y":120,"wires":[{"id":"4bf6645f.64907c","port":0}]}],"env":[]},{"id":"e6bec180.90507","type":"subflow","name":"CALCULATE_PACKAGE_DATA","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"c4a50ad9.9926e8"}]}],"out":[{"x":340,"y":160,"wires":[{"id":"a2b8efc8.61b68","port":0}]}],"env":[]},{"id":"1fcbb17.3f98d4f","type":"subflow","name":"INSERT_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"bd8869bd.20fea8"}]}],"out":[{"x":340,"y":120,"wires":[{"id":"f78cb2f1.68326","port":0}]}],"env":[]},{"id":"27c70303.21f51c","type":"subflow","name":"CALCULATE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"a79c7e3d.99a62"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"f544df01.4dce3","port":0}]}],"env":[]},{"id":"7f331021.1cff8","type":"subflow","name":"GET_BEGINNER_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"21b4cdaa.5f3be2"}]}],"out":[{"x":340,"y":220,"wires":[{"id":"bcaca93a.941b78","port":0}]}],"env":[]},{"id":"7c855960.2e0268","type":"subflow","name":"UPDATE_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"6099afff.cd493"}]}],"out":[{"x":340,"y":180,"wires":[{"id":"cb0ab71f.02e7a8","port":0}]}],"env":[]},{"id":"41dfc406.754afc","type":"subflow","name":"INSERT_RECURRING_TRANSACTION","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"6e73c8a9.b481b8"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"8518f7ab.1ce7d8","port":0}]}],"env":[]},{"id":"a0a175a1.505618","type":"subflow","name":"GET_CURRENT_STORE_PACKAGE (2)","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"7786945.3bf766c"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"8d4f48aa.2332f8","port":0}]}],"env":[]},{"id":"ad739067.50319","type":"subflow","name":"GET_RECURRING_INFO","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"575fd0e.f9c7b3"}]}],"out":[{"x":340,"y":180,"wires":[{"id":"ac026f4f.b9f7d","port":0}]}],"env":[]},{"id":"d5f106a6.0487a8","type":"subflow","name":"INSERT_STORE_PACKAGE (2)","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"4b3676ed.623398"}]}],"out":[{"x":340,"y":220,"wires":[{"id":"26e6c9af.efa6b6","port":0}]}],"env":[]},{"id":"13cde19d.29391e","type":"subflow","name":"UPDATE_RECURRING_INFO","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"71fb4680.852958"}]}],"out":[{"x":360,"y":220,"wires":[{"id":"27300774.541578","port":0}]}],"env":[]},{"id":"d96c41e9.777ec","type":"subflow","name":"GET_NEXT_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"e594a41b.257e08"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"45637ee0.67bfd","port":0}]}],"env":[]},{"id":"f41d9a37.a83158","type":"subflow","name":"GET_STORE_PACKAGE_INFO","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"73f1613a.74828"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"66a7c531.f760bc","port":0}]}],"env":[]},{"id":"e2998060.c233b","type":"subflow","name":"SEND_EMAIL","info":"## **Parameters**\n\n - msg.emailTo\n - msg.emailSubject\n - msg.emailText","category":"","in":[{"x":280,"y":120,"wires":[{"id":"155fa44a.749e9c"}]}],"out":[{"x":580,"y":120,"wires":[{"id":"26cc885.530bb78","port":0}]}],"env":[]},{"id":"91f0dfd1.af154","type":"subflow","name":"VALIDATE_PAGE_TOKEN (2)","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"d2294e2f.842f7"}]}],"out":[{"x":1120,"y":200,"wires":[{"id":"412f1965.fa0288","port":0}]}],"env":[]},{"id":"6e6d961d.724ba8","type":"subflow","name":"GET_ARIS_SALES_CHANNEL_LIST (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"4c17e547.b2257c"}]}],"out":[{"x":580,"y":320,"wires":[{"id":"afe7e948.bf6988","port":0}]}],"env":[]},{"id":"bca86633.b71988","type":"subflow","name":"GET_NJOIN_CHANNEL_LIST (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"fea93da1.f53df"}]}],"out":[{"x":660,"y":320,"wires":[{"id":"9bb4998d.40d7c8","port":0}]}],"env":[]},{"id":"1a02742f.665d2c","type":"subflow","name":"GET_NJOIN_CHANNEL_INFO (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"62473c4c.17c4b4"}]}],"out":[{"x":940,"y":320,"wires":[{"id":"77124214.5209ec","port":0}]}],"env":[]},{"id":"e68aec6.b15961","type":"subflow","name":"DELETE_CURRENT_NJOIN_CHANNEL (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"911e4fde.93a1b"}]}],"out":[{"x":520,"y":300,"wires":[{"id":"27fe846c.48359c","port":0}]}],"env":[]},{"id":"1218c9db.594cf6","type":"subflow","name":"CREATE_NEW_NJOIN_CHANNEL (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"34dde1ae.fc511e"}]}],"out":[{"x":660,"y":300,"wires":[{"id":"c7f5ff51.66645","port":0}]}],"env":[]},{"id":"a67b3af.dcc66c8","type":"subflow","name":"PROCESS_NJOIN_CHANNEL_OBJECT (2)","info":"","category":"","in":[{"x":60,"y":240,"wires":[{"id":"9206354c.a65d58"}]}],"out":[{"x":1420,"y":240,"wires":[{"id":"3654f424.0a2dfc","port":0},{"id":"17af835b.60a48d","port":0}]}],"env":[]},{"id":"7797e113.65218","type":"subflow","name":"GET_ARIS_ORDERS (2)","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"4a822cb8.b6c324"}]}],"out":[{"x":580,"y":280,"wires":[{"id":"54b00c9c.8e1b34","port":0}]}],"env":[]},{"id":"399766a6.56b85a","type":"subflow","name":"GET_UNENRICHED_ORDERS (2)","info":"","category":"","in":[{"x":140,"y":140,"wires":[{"id":"93ccb0ea.659a6"}]}],"out":[{"x":480,"y":340,"wires":[{"id":"15bd8a50.652d36","port":0}]}],"env":[]},{"id":"8e9669d8.a92928","type":"subflow","name":"GET_USER_INFO_BY_PSID (2)","info":"","category":"","in":[{"x":80,"y":100,"wires":[{"id":"88716218.7cfaa"}]}],"out":[{"x":740,"y":560,"wires":[{"id":"dfd66170.da834","port":0},{"id":"fefa89b3.c78958","port":0}]}],"env":[]},{"id":"1819ea43.73b6e6","type":"subflow","name":"UPDATE_ORDER_BY_ID (2)","info":"","category":"","in":[{"x":140,"y":180,"wires":[{"id":"2f92dae2.1928e6"}]}],"out":[{"x":640,"y":300,"wires":[{"id":"2e65c707.574318","port":0}]}],"env":[]},{"id":"bf305289.c33db","type":"subflow","name":"UPDATE_FIELD_WITH_SCRIPT (2)","info":"","category":"","in":[{"x":120,"y":120,"wires":[{"id":"29c40792.f747f8"}]}],"out":[{"x":720,"y":360,"wires":[{"id":"9ca4ec7f.d8909","port":0}]}],"env":[]},{"id":"fa642309.a8d4a","type":"subflow","name":"INSERT_STORE_PACKAGE (2) (2)","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"7c05185b.f3f798"}]}],"out":[{"x":340,"y":220,"wires":[{"id":"30103626.2b17ea","port":0}]}],"env":[]},{"id":"caae1bac.0130f8","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_v99r9sg5ft1qqejb43aqu6tn1g%40group.calendar.google.com/private-435a6458c91797ccf3fdaa7cddea5ab8/basic.ics","username":"arislab","password":"","caldav":"false","name":"Event Calendar","replacedates":false},{"id":"23cfbbfa.aea8b4","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_8pfo12uk63ba97rkf3evppveds%40group.calendar.google.com/private-c2512834523ec09c96c6373c8cd6d403/basic.ics","username":"arislab","password":"","caldav":"false","name":"Test Event Calendar","replacedates":false},{"id":"b8cc4aa3.a27048","type":"aws-config-s3","z":""},{"id":"df7b6a89.123188","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_v99r9sg5ft1qqejb43aqu6tn1g%40group.calendar.google.com/private-435a6458c91797ccf3fdaa7cddea5ab8/basic.ics","username":"arislab","password":"","caldav":"false","name":"Event Calendar","replacedates":false},{"id":"c914875d.7e14a8","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_8pfo12uk63ba97rkf3evppveds%40group.calendar.google.com/private-c2512834523ec09c96c6373c8cd6d403/basic.ics","username":"arislab","password":"","caldav":"false","name":"Test Event Calendar","replacedates":false},{"id":"7835c0dd.3c165","type":"aws-config-s3","z":""},{"id":"9e67d65e.ef2ac8","type":"function","z":"4780809c.72938","name":"GET_APP_ACCESS_TOKEN","func":"const FB_APP_ID = \"502170539988549\";\nconst FB_APP_SECRET = \"73fc7474f3879738ac173d845c473930\";\n\n// msg.headers = {};\n// msg.headers['Authorization'] = `NTAyMTcwNTM5OTg4NTQ5Og==`;\n\nmsg.url = \"https://graph.facebook.com/oauth/access_token?client_id=\" + FB_APP_ID + \"&client_secret=\" + FB_APP_SECRET + \"&grant_type=client_credentials\";\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["55a83966.357718","19ce8b3f.6c9b15"]]},{"id":"790a133f.37e34c","type":"debug","z":"4780809c.72938","name":"GET_FB_APP_ACCESS_TOKEN_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":160,"wires":[]},{"id":"55a83966.357718","type":"debug","z":"4780809c.72938","name":"GET_FB_APP_ACCESS_TOKEN_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":80,"wires":[]},{"id":"d325c5ff.3ccdf8","type":"debug","z":"4780809c.72938","name":"GET_FB_APP_ACCESS_TOKEN_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":120,"wires":[]},{"id":"19ce8b3f.6c9b15","type":"http request","z":"4780809c.72938","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":230,"y":120,"wires":[["d325c5ff.3ccdf8","76e29b78.9c7ef4"]]},{"id":"76e29b78.9c7ef4","type":"change","z":"4780809c.72938","name":"","rules":[{"t":"set","p":"FB_ACCESS_TOKEN","pt":"msg","to":"payload.access_token","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":160,"wires":[["790a133f.37e34c"]]},{"id":"97cf43f2.2ef93","type":"http request","z":"e94cb67f.c8bdb8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":530,"y":160,"wires":[["2fc7fe6.7cc5802","2cb2f4b5.f564fc"]]},{"id":"e6465a0e.f19e08","type":"function","z":"e94cb67f.c8bdb8","name":"INIT_REQUEST","func":"const FB_ACCESS_TOKEN = msg.FB_ACCESS_TOKEN;\nconst INPUT_TOKEN = msg.TOKEN_TO_VALIDATE;\n\nmsg.url = `https://graph.facebook.com/debug_token?input_token=${INPUT_TOKEN}&access_token=${FB_ACCESS_TOKEN}`\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":200,"wires":[["97cf43f2.2ef93","1605bcd0.0335d3"]]},{"id":"1605bcd0.0335d3","type":"debug","z":"e94cb67f.c8bdb8","name":"VALIDATE_PAGE_TOKEN_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":380,"wires":[]},{"id":"2fc7fe6.7cc5802","type":"debug","z":"e94cb67f.c8bdb8","name":"VALIDATE_PAGE_TOKEN_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"e0e22fe8.56eb4","type":"function","z":"f4a4de11.64a5b","name":"INIT_REQUEST_FOR_GETTING_SALES_CHANNEL","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/sales_channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"regexp\":{\n      \"channels.facebook\": \".+\"\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["12d4ade2.824502","17502b06.85c725"]]},{"id":"12d4ade2.824502","type":"debug","z":"f4a4de11.64a5b","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":140,"wires":[]},{"id":"58abc155.e1c8c","type":"debug","z":"f4a4de11.64a5b","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":180,"wires":[]},{"id":"79c4a067.fe0f5","type":"debug","z":"f4a4de11.64a5b","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":220,"wires":[]},{"id":"46d110d0.35f19","type":"change","z":"f4a4de11.64a5b","name":"","rules":[{"t":"set","p":"arisSalesChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["79c4a067.fe0f5"]]},{"id":"9018895e.8a3448","type":"function","z":"f9558482.a57198","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":140,"wires":[["841910a6.1dabd","d55098c2.a926d8"]]},{"id":"841910a6.1dabd","type":"debug","z":"f9558482.a57198","name":"GET_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":140,"wires":[]},{"id":"b140c34a.d1606","type":"debug","z":"f9558482.a57198","name":"GET_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":180,"wires":[]},{"id":"36a13808.bb4198","type":"debug","z":"f9558482.a57198","name":"GET_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":220,"wires":[]},{"id":"a33fd24a.19962","type":"change","z":"f9558482.a57198","name":"","rules":[{"t":"set","p":"njoinChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["36a13808.bb4198"]]},{"id":"17502b06.85c725","type":"http request","z":"f4a4de11.64a5b","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":230,"y":180,"wires":[["58abc155.e1c8c","46d110d0.35f19"]]},{"id":"d55098c2.a926d8","type":"http request","z":"f9558482.a57198","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["b140c34a.d1606","a33fd24a.19962"]]},{"id":"64850d4d.a73a64","type":"function","z":"d9807e99.e20e","name":"","func":"let basicAuth;\n\nif (msg.env === \"dev\") {\n    basicAuth = \"ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\";\n} else if (msg.env === \"alpha\") {\n    basicAuth = \"ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\";\n} else if (msg.env === \"prod\") {\n    basicAuth = \"ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\";\n}\n\nmsg.ES_BASIC_AUTH_HEADER = basicAuth;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":140,"wires":[[]]},{"id":"4cdd17fa.c4d7e8","type":"function","z":"8402b62c.173098","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL_INFO","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nlet FB_ID = msg.payload._source.channels.facebook;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nnode.error('Getting facebook channel id: ' + FB_ID + ' from njoin');\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match\": {\n            \"id\": `facebook_${FB_ID}`\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":140,"wires":[["19a9d7bf.ac26a8","c77a8aa9.c34488"]]},{"id":"8a164b45.127548","type":"change","z":"8402b62c.173098","name":"","rules":[{"t":"set","p":"njoinChannelInfo","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":220,"wires":[["2f602979.61fa56"]]},{"id":"19a9d7bf.ac26a8","type":"http request","z":"8402b62c.173098","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":180,"wires":[["8a164b45.127548","54524715.ae9868"]]},{"id":"c77a8aa9.c34488","type":"debug","z":"8402b62c.173098","name":"GET_NJOIN_CHANNEL_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":140,"wires":[]},{"id":"54524715.ae9868","type":"debug","z":"8402b62c.173098","name":"GET_NJOIN_CHANNEL_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":180,"wires":[]},{"id":"2f602979.61fa56","type":"debug","z":"8402b62c.173098","name":"GET_NJOIN_CHANNEL_INFO_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":220,"wires":[]},{"id":"f0e03117.b3e5a","type":"subflow:d9807e99.e20e","z":"f4a4de11.64a5b","name":"","env":[],"x":270,"y":100,"wires":[["e0e22fe8.56eb4"]]},{"id":"b76edad2.25eba8","type":"subflow:d9807e99.e20e","z":"8402b62c.173098","name":"","env":[],"x":330,"y":100,"wires":[["4cdd17fa.c4d7e8"]]},{"id":"b12117ed.ae9e68","type":"subflow:d9807e99.e20e","z":"f9558482.a57198","name":"","x":290,"y":100,"wires":[["9018895e.8a3448"]]},{"id":"c702d382.d3389","type":"subflow:4780809c.72938","z":"e94cb67f.c8bdb8","name":"","env":[],"x":290,"y":80,"wires":[["e6465a0e.f19e08"]]},{"id":"2cb2f4b5.f564fc","type":"change","z":"e94cb67f.c8bdb8","name":"","rules":[{"t":"set","p":"RESULT_VALIDATE_PAGE_TOKEN","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":160,"wires":[[]]},{"id":"62b76312.abac7c","type":"subflow:d9807e99.e20e","z":"23202381.5182ac","name":"","env":[],"x":290,"y":120,"wires":[["6ac7c6.c60e483c"]]},{"id":"6ac7c6.c60e483c","type":"function","z":"23202381.5182ac","name":"INIT_REQUEST_FOR_DELETING_CURRENT_NJOIN_CHANNEL_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst channelDocID = msg.njoinChannelDocID;\nconst url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}/_update`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\n// msg.payload = {\n//     \"doc\": {\n//         \"isDeleted\": true\n//     }\n// }\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["667c7b05.2466a4","c12b0d4d.dfde8"]]},{"id":"c12b0d4d.dfde8","type":"http request","z":"23202381.5182ac","name":"","method":"DELETE","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":200,"wires":[["251275c9.82ad2a","34c356f0.262fba"]]},{"id":"251275c9.82ad2a","type":"change","z":"23202381.5182ac","name":"","rules":[{"t":"set","p":"resultDeleteCurrentNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":240,"wires":[["40718826.5ca7a8"]]},{"id":"667c7b05.2466a4","type":"debug","z":"23202381.5182ac","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":160,"wires":[]},{"id":"34c356f0.262fba","type":"debug","z":"23202381.5182ac","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":200,"wires":[]},{"id":"40718826.5ca7a8","type":"debug","z":"23202381.5182ac","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":240,"wires":[]},{"id":"4a86807d.1e437","type":"subflow:d9807e99.e20e","z":"18a54c13.8f5a14","name":"","env":[],"x":230,"y":100,"wires":[["be9ab969.1ccdf8"]]},{"id":"be9ab969.1ccdf8","type":"function","z":"18a54c13.8f5a14","name":"INIT_REQUEST_FOR_CREATING_NEW_NJOIN_CHANNEL","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst docID = msg.temp_facebook_channel_config['_source']['id'];\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\nconst url = `https://${nes}/njoin-${nuser}/channel/${docID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.payload = msg.temp_facebook_channel_config._source;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["1df72f2a.2a1541","d7d49f3.b49836"]]},{"id":"d7d49f3.b49836","type":"http request","z":"18a54c13.8f5a14","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":180,"wires":[["842e2470.0eebd8","81adc231.675d7"]]},{"id":"842e2470.0eebd8","type":"change","z":"18a54c13.8f5a14","name":"","rules":[{"t":"set","p":"resultCreateNewNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":220,"wires":[["76d35dd5.9d2a24"]]},{"id":"1df72f2a.2a1541","type":"debug","z":"18a54c13.8f5a14","name":"CREATE_NEW_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":140,"wires":[]},{"id":"81adc231.675d7","type":"debug","z":"18a54c13.8f5a14","name":"CREATE_NEW_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":180,"wires":[]},{"id":"76d35dd5.9d2a24","type":"debug","z":"18a54c13.8f5a14","name":"CREATE_NEW_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":220,"wires":[]},{"id":"4003a56f.ba7eac","type":"switch","z":"18d8766d.0eab4a","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":240,"wires":[["6dad861.0d9c678"],["cae8a718.990a48"]]},{"id":"6dad861.0d9c678","type":"function","z":"18d8766d.0eab4a","name":"","func":"node.error('njoinChannelInfo is equal 0, go next...');\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":40,"wires":[[]]},{"id":"cae8a718.990a48","type":"function","z":"18d8766d.0eab4a","name":"INITIAL_INDEX_NJOIN_CHANNEL","func":"node.error('njoinChannelInfo(s) are more than 0 : '+msg.njoinChannelInfo.hits.total);\n\nmsg.indexNjoinChannel = 0;\nmsg.njoinChannelList = msg.njoinChannelInfo.hits.hits;\n\nreturn msg;\n\n/*\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n*/","outputs":1,"noerr":0,"x":340,"y":300,"wires":[["5b9b1b22.bb6ab4"]]},{"id":"785b99.940d3468","type":"comment","z":"18d8766d.0eab4a","name":"Njoin Channel LOOP","info":"","x":290,"y":340,"wires":[]},{"id":"5b9b1b22.bb6ab4","type":"switch","z":"18d8766d.0eab4a","name":"Index Njoin Channel = njoinChannelList length?","property":"indexNjoinChannel","propertyType":"msg","rules":[{"t":"lt","v":"njoinChannelList.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":380,"wires":[["926f1c42.50172"],["e5c0542a.7b8058"]]},{"id":"eda5596c.9ec308","type":"link in","z":"18d8766d.0eab4a","name":"","links":["575e523b.54825c"],"x":135,"y":380,"wires":[["5b9b1b22.bb6ab4"]]},{"id":"a7aede23.79dfb","type":"function","z":"18d8766d.0eab4a","name":"INCREASE_INDEX_NJOIN_CHANNEL","func":"msg.indexNjoinChannel++;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":940,"wires":[["9677677c.cf88e8"]]},{"id":"575e523b.54825c","type":"link out","z":"18d8766d.0eab4a","name":"","links":["eda5596c.9ec308"],"x":695,"y":940,"wires":[]},{"id":"e5c0542a.7b8058","type":"function","z":"18d8766d.0eab4a","name":"END_LOOP","func":"node.error('End Njoin Channel Loop.');\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":240,"wires":[["6c7113a3.2a589c"]]},{"id":"926f1c42.50172","type":"function","z":"18d8766d.0eab4a","name":"INITIAL_NJOIN_CHANNEL_BEFORE_PROCESS","func":"let processIndex = msg.indexNjoinChannel;\nlet processNjoinChannel = msg.njoinChannelList[processIndex];\n//msg.payload = processNjoinChannel;\nmsg.processNjoinChannel = processNjoinChannel;\nmsg.TOKEN_TO_VALIDATE = processNjoinChannel._source.token;\nnode.error(processNjoinChannel);\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":440,"wires":[["d7409542.088d18"]]},{"id":"d7409542.088d18","type":"subflow:e94cb67f.c8bdb8","z":"18d8766d.0eab4a","name":"","env":[],"x":400,"y":480,"wires":[["783d347a.ad027c","44374fd7.513b4"]]},{"id":"783d347a.ad027c","type":"debug","z":"18d8766d.0eab4a","name":"RESULT_VALIDATE_PAGE_TOKEN_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":480,"wires":[]},{"id":"44374fd7.513b4","type":"switch","z":"18d8766d.0eab4a","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":400,"y":560,"wires":[["460fc4f4.c532cc"],["b1416167.42953"]]},{"id":"460fc4f4.c532cc","type":"function","z":"18d8766d.0eab4a","name":"PAGE_TOKEN_VALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is VALID.');\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":620,"wires":[["9f53f3cb.6e1ec"]]},{"id":"b1416167.42953","type":"function","z":"18d8766d.0eab4a","name":"PAGE_TOKEN_INVALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is INVALID. Prepare to DELETE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":620,"wires":[["d7adbe41.ef12f"]]},{"id":"d7adbe41.ef12f","type":"function","z":"18d8766d.0eab4a","name":"SET_NJOIN_CHANNEL_DOC_ID","func":"node.error('Set njoin channel doc ID: '+msg.processNjoinChannel._id+' with Page Token: '+msg.processNjoinChannel._source.id+' to DELETE.');\nmsg.njoinChannelDocID = msg.processNjoinChannel._id;\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":820,"wires":[["ad78c997.7ad318"]]},{"id":"ad78c997.7ad318","type":"subflow:23202381.5182ac","z":"18d8766d.0eab4a","name":"","env":[],"x":480,"y":860,"wires":[["a7aede23.79dfb"]]},{"id":"9f53f3cb.6e1ec","type":"switch","z":"18d8766d.0eab4a","name":"Temp njoin channel is not empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":800,"y":680,"wires":[["2269da21.6388b6"],["d7adbe41.ef12f"]]},{"id":"2269da21.6388b6","type":"function","z":"18d8766d.0eab4a","name":"Temp join channel is empty","func":"node.error('temp njoin channel is empty, so set njoin channel: '+msg.processNjoinChannel._source.id+' into temp njoin channel.');\nmsg.tempNjoinChannelInfo = msg.processNjoinChannel;\n\n//node.error(msg.tempNjoinChannelInfo);\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":740,"wires":[["d7adbe41.ef12f"]]},{"id":"6c7113a3.2a589c","type":"switch","z":"18d8766d.0eab4a","name":"Temp njoin channel is empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":300,"wires":[["fec507bd.6e7078"],["58a6342e.250f3c"]]},{"id":"58a6342e.250f3c","type":"function","z":"18d8766d.0eab4a","name":"INIT_PAGE_DATA_TO_CREATE","func":"msg.temp_facebook_channel_config = msg.tempNjoinChannelInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":360,"wires":[["f6f2f984.5495e8"]]},{"id":"f6f2f984.5495e8","type":"subflow:18a54c13.8f5a14","z":"18d8766d.0eab4a","name":"","env":[],"x":880,"y":400,"wires":[["d68174f1.d55b18","fec507bd.6e7078"]]},{"id":"d68174f1.d55b18","type":"debug","z":"18d8766d.0eab4a","name":"RESULT_CREATE_NJOIN_CHANNEL","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1290,"y":440,"wires":[]},{"id":"fec507bd.6e7078","type":"function","z":"18d8766d.0eab4a","name":"PROCESS_DONE","func":"node.error('Process DONE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":340,"wires":[[]]},{"id":"9677677c.cf88e8","type":"delay","z":"18d8766d.0eab4a","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":590,"y":940,"wires":[["575e523b.54825c"]]},{"id":"82dccdd5.5a56","type":"function","z":"9b3766de.c1d1f8","name":"INIT_REQUEST_FOR_GETTING_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst storeID = msg.storeID\nconst url = `https://${nes}/${platform_index}/order/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        { \"match\": { \"storeID.keyword\": storeID } },\n        { \"match\": { \"userInfo.firstName.keyword\": \"\" } },\n        { \"match\": { \"userInfo.lastName.keyword\": \"\" } }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["bea45754.614ab8","8efef0f1.4f363"]]},{"id":"bea45754.614ab8","type":"debug","z":"9b3766de.c1d1f8","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":120,"wires":[]},{"id":"15cc8454.5234fc","type":"debug","z":"9b3766de.c1d1f8","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":160,"wires":[]},{"id":"d94e4ce4.74465","type":"debug","z":"9b3766de.c1d1f8","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":200,"wires":[]},{"id":"2fdfddc7.8b0622","type":"change","z":"9b3766de.c1d1f8","name":"","rules":[{"t":"set","p":"arisOrdersList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":200,"wires":[["d94e4ce4.74465"]]},{"id":"8efef0f1.4f363","type":"http request","z":"9b3766de.c1d1f8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":210,"y":160,"wires":[["15cc8454.5234fc","2fdfddc7.8b0622"]]},{"id":"bf3eb56.9939b48","type":"subflow:d9807e99.e20e","z":"9b3766de.c1d1f8","name":"","env":[],"x":250,"y":80,"wires":[["82dccdd5.5a56"]]},{"id":"a5596041.03196","type":"function","z":"7c57b6ff.5c2668","name":"INIT_REQUEST_FOR_GETTING_UNENRICHED_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/order/_search?size=100`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"exists\": {\n            \"field\": \"userInfo.firstName\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.firstName.keyword\": \"\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.lastName.keyword\": \"\"\n          }\n        }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":180,"wires":[["603d459d.cef69c","7546e4b4.4b11fc"]]},{"id":"603d459d.cef69c","type":"debug","z":"7c57b6ff.5c2668","name":"GET_UNENRICHED_ORDERS_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":180,"wires":[]},{"id":"98da92bb.e4d1","type":"debug","z":"7c57b6ff.5c2668","name":"GET_UNENRICHED_ORDERS_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":220,"wires":[]},{"id":"de29f1.7226d61","type":"debug","z":"7c57b6ff.5c2668","name":"GET_UNENRICHED_ORDERS_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":260,"wires":[]},{"id":"2c78f769.cb8748","type":"change","z":"7c57b6ff.5c2668","name":"","rules":[{"t":"set","p":"unenrichedOrders","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":260,"wires":[["de29f1.7226d61"]]},{"id":"7546e4b4.4b11fc","type":"http request","z":"7c57b6ff.5c2668","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":330,"y":220,"wires":[["98da92bb.e4d1","2c78f769.cb8748"]]},{"id":"b93559c0.5d97d8","type":"subflow:d9807e99.e20e","z":"7c57b6ff.5c2668","name":"","env":[],"x":370,"y":140,"wires":[["a5596041.03196"]]},{"id":"19af63ac.9fc22c","type":"function","z":"76ec9c8c.680c04","name":"INIT_REQUEST_FOR_GETTING_USER_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst userPSID = msg.userPSID;\nconst url = `https://${nes}/njoin-${nuser}/user/${userPSID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.userInfo = {\n    \"firstName\": \"\",\n    \"lastName\": \"\"\n};\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["bf20103f.b5d42","3314ff71.5617a"]]},{"id":"bf20103f.b5d42","type":"debug","z":"76ec9c8c.680c04","name":"GET_USER_INFO_BY_PSID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":140,"wires":[]},{"id":"21a81f0f.2cd7c","type":"debug","z":"76ec9c8c.680c04","name":"GET_USER_INFO_BY_PSID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":180,"wires":[]},{"id":"86d992e.c34507","type":"debug","z":"76ec9c8c.680c04","name":"GET_USER_INFO_BY_PSID_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":680,"wires":[]},{"id":"e17bf791.9b4ea8","type":"change","z":"76ec9c8c.680c04","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload._source.info.facebook.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload._source.info.facebook.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":560,"wires":[["86d992e.c34507"]]},{"id":"6a2bdb07.115634","type":"subflow:d9807e99.e20e","z":"76ec9c8c.680c04","name":"","env":[],"x":290,"y":100,"wires":[["19af63ac.9fc22c"]]},{"id":"3314ff71.5617a","type":"http request","z":"76ec9c8c.680c04","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["21a81f0f.2cd7c","3976a5e3.1257aa"]]},{"id":"c4c5b93c.309df8","type":"subflow:d9807e99.e20e","z":"f994513c.ce808","name":"","env":[],"x":350,"y":180,"wires":[["32c1c98a.ef2666"]]},{"id":"32c1c98a.ef2666","type":"function","z":"f994513c.ce808","name":"INIT_REQUEST_UPDATE_ORDER","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst docID = msg.UnenrichedOrderDocID;\n\nconst url = `https://${nes}/${platform_index}/order/${docID}/_update`;\n\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nconst updateBody = msg.UnenrichedOrderUpdateBody;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nmsg.payload = {\n    \"doc\": {\n        \"userInfo\": {\n            \"firstName\": updateBody['firstName'],\n            \"lastName\": updateBody['lastName']\n        }\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":220,"wires":[["be681891.19be38","1bdaab2f.ca9de5"]]},{"id":"be681891.19be38","type":"http request","z":"f994513c.ce808","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":310,"y":260,"wires":[["20f3830b.61d14c"]]},{"id":"1bdaab2f.ca9de5","type":"debug","z":"f994513c.ce808","name":"UPDATE_ORDER_BY_ID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":790,"y":220,"wires":[]},{"id":"20f3830b.61d14c","type":"debug","z":"f994513c.ce808","name":"UPDATE_ORDER_BY_ID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":260,"wires":[]},{"id":"3976a5e3.1257aa","type":"function","z":"76ec9c8c.680c04","name":"CHECK_USER_IS_UNDEFINED","func":"const sourceObj = msg.payload._source;\nconst fbName = sourceObj.info.facebook.name;\nconst fbPSID = sourceObj.info.facebook.id;\nconst pageToken = sourceObj.info._channel.config.token;\n\nif (\n    fbName === \"undefined undefined\" &&\n    sourceObj.info.facebook.hasOwnProperty('first_name') === false &&\n    sourceObj.info.facebook.hasOwnProperty('last_name') === false\n) {\n    node.error('This user info is un-enriched, re-enriching..');\n    msg.enrichPSID = fbPSID;\n    msg.enrichToken = pageToken;\n    return [msg, null];\n} else {\n    node.error('This user info is already enriched')\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":310,"y":340,"wires":[["d12ff415.718218"],["e17bf791.9b4ea8"]]},{"id":"97052783.238658","type":"function","z":"ad109f4f.2bbca","name":"","func":"const enrichPSID = msg.enrichPSID;\nconst enrichToken = msg.enrichToken;\nconst url = `https://graph.facebook.com/${enrichPSID}?fields=first_name,last_name&access_token=${enrichToken}`\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":140,"wires":[["84f78c55.83bac","a5171256.dec47"]]},{"id":"84f78c55.83bac","type":"http request","z":"ad109f4f.2bbca","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":350,"y":180,"wires":[["5f794c99.b863d4","d16c974a.d729d8"]]},{"id":"5f794c99.b863d4","type":"change","z":"ad109f4f.2bbca","name":"","rules":[{"t":"set","p":"enrichFBResult","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":220,"wires":[["432ace6f.5fb82"]]},{"id":"d12ff415.718218","type":"subflow:ad109f4f.2bbca","z":"76ec9c8c.680c04","name":"","env":[],"x":590,"y":280,"wires":[["a5f6766f.bad678","b5d10ad4.2ad208"]]},{"id":"a5171256.dec47","type":"debug","z":"ad109f4f.2bbca","name":"ENRICH_FB_USER_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":140,"wires":[]},{"id":"d16c974a.d729d8","type":"debug","z":"ad109f4f.2bbca","name":"ENRICH_FB_USER_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":180,"wires":[]},{"id":"432ace6f.5fb82","type":"debug","z":"ad109f4f.2bbca","name":"ENRICH_FB_USER_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":220,"wires":[]},{"id":"a5f6766f.bad678","type":"debug","z":"76ec9c8c.680c04","name":"enrich_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"79d7433e.9d39ac","type":"change","z":"76ec9c8c.680c04","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":380,"wires":[[]]},{"id":"b5d10ad4.2ad208","type":"function","z":"76ec9c8c.680c04","name":"CHECK_ENRICH_RESPONSE","func":"const reqResponse = msg.payload;\n\nif (\n    reqResponse.hasOwnProperty('first_name') &&\n    reqResponse.hasOwnProperty('last_name')\n) {\n    node.error('Enrich user successful');\n    return [msg, null];\n} else {\n    node.error('Error while enriching user: ');\n    node.error(reqResponse);\n    return [msg, null];\n}","outputs":2,"noerr":0,"x":660,"y":340,"wires":[["79d7433e.9d39ac"],[]]},{"id":"8312789.65df688","type":"function","z":"d7b9dd24.581ab","name":"INIT_REQUEST_FOR_UPDATING_FIELD_WITH_SCRIPT","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst type = msg.updateType;\nconst url = `https://${nes}/${platform_index}/${type}/_update_by_query`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\nconst query = JSON.parse(msg.updateQuery);\nconst script = JSON.parse(msg.updateScript);\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nlet tempPayload = {};\ntempPayload['query'] = query;\ntempPayload['script'] = script;\n\nmsg.payload = JSON.stringify(tempPayload);\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["ac6e02c3.09e02","cc77b69d.559948"]]},{"id":"c50464f2.032a48","type":"change","z":"d7b9dd24.581ab","name":"","rules":[{"t":"set","p":"resultUpdateFieldWithScript","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":240,"wires":[["df646052.3fa7f"]]},{"id":"ac6e02c3.09e02","type":"http request","z":"d7b9dd24.581ab","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":200,"wires":[["c50464f2.032a48","3a1c2be0.5e8f14"]]},{"id":"9e29c9ee.e90cb8","type":"subflow:d9807e99.e20e","z":"d7b9dd24.581ab","name":"","env":[],"x":330,"y":120,"wires":[["8312789.65df688","19a7a23a.84c07e"]]},{"id":"9b415d52.71dd9","type":"comment","z":"d7b9dd24.581ab","name":"Params: updateType / updateQuery / updateScript","info":"**msg.updateType:** Type to update\n**msg.updateQuery:** Query to execute\n**msg.updateScript:** Script to execute","x":390,"y":60,"wires":[]},{"id":"19a7a23a.84c07e","type":"debug","z":"d7b9dd24.581ab","name":"UPDATE_FIELD_WITH_SCRIPT_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":120,"wires":[]},{"id":"cc77b69d.559948","type":"debug","z":"d7b9dd24.581ab","name":"UPDATE_FIELD_WITH_SCRIPT_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":160,"wires":[]},{"id":"3a1c2be0.5e8f14","type":"debug","z":"d7b9dd24.581ab","name":"UPDATE_FIELD_WITH_SCRIPT_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":200,"wires":[]},{"id":"df646052.3fa7f","type":"debug","z":"d7b9dd24.581ab","name":"UPDATE_FIELD_WITH_SCRIPT_debug4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":240,"wires":[]},{"id":"6ed4a717.ea6778","type":"function","z":"e3259a63.dffef8","name":"GET_ALL_PACKAGE","func":"delete msg.payload;\nmsg.url = \"https://manage.arislab.ai/getPlatformPackage\";\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["c96572f1.e2757","9e99db68.056818"]]},{"id":"c96572f1.e2757","type":"http request","z":"e3259a63.dffef8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":170,"y":120,"wires":[["b08ed82e.ce2d68"]]},{"id":"b08ed82e.ce2d68","type":"debug","z":"e3259a63.dffef8","name":"GET_ALL_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":470,"y":120,"wires":[]},{"id":"95287fd9.f2ab3","type":"function","z":"d3d9dfef.e84f3","name":"GET_ALL_STORE","func":"delete msg.payload;\nmsg.url = msg.apiUrl + \"/businessProfile/all\";\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":80,"wires":[["9b220d7d.6e4ee","91e496d.ca21968"]]},{"id":"9b220d7d.6e4ee","type":"http request","z":"d3d9dfef.e84f3","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["24558455.9b8e1c"]]},{"id":"24558455.9b8e1c","type":"debug","z":"d3d9dfef.e84f3","name":"GET_ALL_STORE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":460,"y":120,"wires":[]},{"id":"91e496d.ca21968","type":"debug","z":"d3d9dfef.e84f3","name":"GET_ALL_STORE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":460,"y":80,"wires":[]},{"id":"9e99db68.056818","type":"debug","z":"e3259a63.dffef8","name":"GET_ALL_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":470,"y":80,"wires":[]},{"id":"b6280643.a99748","type":"function","z":"8c824985.837028","name":"GET_CURRENT_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}/current`;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":80,"wires":[["7cec02a9.3eabec","402a47c2.07e018"]]},{"id":"7cec02a9.3eabec","type":"http request","z":"8c824985.837028","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["dc62102d.70816"]]},{"id":"dc62102d.70816","type":"debug","z":"8c824985.837028","name":"GET_CURRENT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":680,"y":120,"wires":[]},{"id":"402a47c2.07e018","type":"debug","z":"8c824985.837028","name":"GET_CURRENT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":680,"y":80,"wires":[]},{"id":"4b9d93b0.5f774c","type":"function","z":"b4ba47fc.ef5b78","name":"GET_ALL_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["beb9856a.5df008","6416a23c.76f94c"]]},{"id":"beb9856a.5df008","type":"http request","z":"b4ba47fc.ef5b78","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["c7429c65.069d9"]]},{"id":"c7429c65.069d9","type":"debug","z":"b4ba47fc.ef5b78","name":"GET_ALL_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"6416a23c.76f94c","type":"debug","z":"b4ba47fc.ef5b78","name":"GET_ALL_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"b8b748.d8f898b8","type":"function","z":"6cb8ab4b.297704","name":"GET_LAST_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}/last`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["4bf6645f.64907c","821ff1c8.79bf5"]]},{"id":"4bf6645f.64907c","type":"http request","z":"6cb8ab4b.297704","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["2a144ac3.8b6486"]]},{"id":"2a144ac3.8b6486","type":"debug","z":"6cb8ab4b.297704","name":"GET_LAST_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"821ff1c8.79bf5","type":"debug","z":"6cb8ab4b.297704","name":"GET_LAST_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"c4a50ad9.9926e8","type":"function","z":"e6bec180.90507","name":"CALCULATE_PACKAGE_DATA","func":"msg.url = `https://manage.arislab.ai/calculateStorePackage`;\nmsg.payload = {\n    \"newPackageObj\": msg.newPackage,\n    \"isActiveNow\": true,\n    \"currentPackageObj\": {}\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["a2b8efc8.61b68","20a64f83.9e638"]]},{"id":"a2b8efc8.61b68","type":"http request","z":"e6bec180.90507","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["4341544b.75c39c"]]},{"id":"4341544b.75c39c","type":"debug","z":"e6bec180.90507","name":"CALCULATE_PACKAGE_DATA_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"20a64f83.9e638","type":"debug","z":"e6bec180.90507","name":"CALCULATE_PACKAGE_DATA_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"bd8869bd.20fea8","type":"function","z":"1fcbb17.3f98d4f","name":"INSERT_STORE_PACKAGE","func":"const storePackageInfo = msg.storePackageInfo;\n\nmsg.url = `${msg.apiUrl}storePackage/new`;\nmsg.payload = storePackageInfo;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":80,"wires":[["32ab435f.d7ac6c","f78cb2f1.68326"]]},{"id":"32ab435f.d7ac6c","type":"debug","z":"1fcbb17.3f98d4f","name":"INSERT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":570,"y":80,"wires":[]},{"id":"f78cb2f1.68326","type":"http request","z":"1fcbb17.3f98d4f","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["4eb03117.e093f"]]},{"id":"4eb03117.e093f","type":"debug","z":"1fcbb17.3f98d4f","name":"INSERT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":120,"wires":[]},{"id":"a79c7e3d.99a62","type":"function","z":"27c70303.21f51c","name":"CALCULATE_PACKAGE","func":"const packageInfo = msg.packageInfo;\n\nlet data = {\n    newPackageObj: packageInfo,\n    isActiveNow: true\n};\n\nmsg.url = `https://manage.arislab.ai/calculateStorePackage`;\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":80,"wires":[["d2791276.d7dab","f544df01.4dce3"]]},{"id":"d2791276.d7dab","type":"debug","z":"27c70303.21f51c","name":"CALCULATE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":520,"y":80,"wires":[]},{"id":"f544df01.4dce3","type":"http request","z":"27c70303.21f51c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["30104f.1b6d1fb2"]]},{"id":"30104f.1b6d1fb2","type":"debug","z":"27c70303.21f51c","name":"CALCULATE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":520,"y":120,"wires":[]},{"id":"21b4cdaa.5f3be2","type":"function","z":"7f331021.1cff8","name":"GET_BEGINNER_PACKAGE","func":"msg.url = `https://manage.arislab.ai/getPlatformPackage?packageName=beginner`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["bcaca93a.941b78","2eac2f68.395e7"]]},{"id":"bcaca93a.941b78","type":"http request","z":"7f331021.1cff8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["b1a33e47.963ee"]]},{"id":"2eac2f68.395e7","type":"debug","z":"7f331021.1cff8","name":"GET_BEGINNER_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":80,"wires":[]},{"id":"b1a33e47.963ee","type":"debug","z":"7f331021.1cff8","name":"GET_BEGINNER_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":120,"wires":[]},{"id":"6099afff.cd493","type":"function","z":"7c855960.2e0268","name":"UPDATE_STORE_PACKAGE","func":"const storePackageInfo = msg.storePackageInfo;\n\nmsg.url = `${msg.apiUrl}storePackage/storePackageID/${storePackageInfo.storePackageID}/update`;\nmsg.payload = storePackageInfo;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["24f5c3ec.797fdc","cb0ab71f.02e7a8"]]},{"id":"24f5c3ec.797fdc","type":"debug","z":"7c855960.2e0268","name":"UPDATE_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":570,"y":80,"wires":[]},{"id":"cb0ab71f.02e7a8","type":"http request","z":"7c855960.2e0268","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["f1e8183c.3c4de8"]]},{"id":"f1e8183c.3c4de8","type":"debug","z":"7c855960.2e0268","name":"UPDATE_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":120,"wires":[]},{"id":"6e73c8a9.b481b8","type":"function","z":"41dfc406.754afc","name":"INSERT_RECURRING_TRANSACTION","func":"const storePackageInfo = msg.storePackageInfo;\nconst recurringResult = msg.recurringResult;\nconst recurringStatus = msg.recurringStatus;\n\nlet recurringTransaction = {\n    recurringTransactionID: \"\",\n    storePackageInfo: storePackageInfo,\n    recurringResult: recurringResult,\n    status: recurringStatus,\n    createdAt: Date.now()\n};\n\nmsg.url = `${msg.apiUrl}recurringTransaction/new`;\nmsg.payload = recurringTransaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["3e3a1744.04d5e8","8518f7ab.1ce7d8"]]},{"id":"3e3a1744.04d5e8","type":"debug","z":"41dfc406.754afc","name":"INSERT_RECURRING_TRANSACTION_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":80,"wires":[]},{"id":"8518f7ab.1ce7d8","type":"http request","z":"41dfc406.754afc","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["67917db9.fff044"]]},{"id":"67917db9.fff044","type":"debug","z":"41dfc406.754afc","name":"INSERT_RECURRING_TRANSACTION_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":670,"y":120,"wires":[]},{"id":"7786945.3bf766c","type":"function","z":"a0a175a1.505618","name":"GET_CURRENT_STORE_PACKAGE","func":"const storeID = msg.recurringInfo.storeID;\n\nmsg.url = `${msg.apiUrl}storePackage/storeID/${storeID}/current`;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":80,"wires":[["deef0c30.e07be","8d4f48aa.2332f8"]]},{"id":"deef0c30.e07be","type":"debug","z":"a0a175a1.505618","name":"GET_CURRENT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":80,"wires":[]},{"id":"8d4f48aa.2332f8","type":"http request","z":"a0a175a1.505618","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["ec56abb.bb4a358"]]},{"id":"ec56abb.bb4a358","type":"debug","z":"a0a175a1.505618","name":"GET_CURRENT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":640,"y":120,"wires":[]},{"id":"575fd0e.f9c7b3","type":"function","z":"ad739067.50319","name":"GET_RECURRING_INFO","func":"const recurringNo = msg.recurringResult.recurringNo;\n\nmsg.url = `${msg.apiUrl}recurring/recurringNo/${recurringNo}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":80,"wires":[["ac026f4f.b9f7d","873b5c5d.11f9b"]]},{"id":"ac026f4f.b9f7d","type":"http request","z":"ad739067.50319","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["ba5b8123.0af39"]]},{"id":"873b5c5d.11f9b","type":"debug","z":"ad739067.50319","name":"GET_RECURRING_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":520,"y":80,"wires":[]},{"id":"ba5b8123.0af39","type":"debug","z":"ad739067.50319","name":"GET_RECURRING_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":520,"y":120,"wires":[]},{"id":"4b3676ed.623398","type":"function","z":"d5f106a6.0487a8","name":"INSERT_STORE_PACKAGE","func":"msg.url = `${msg.apiUrl}/storePackage/new`;\nmsg.payload = msg.storePackageData;\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":80,"wires":[["26e6c9af.efa6b6","c46bb8d2.086de8"]]},{"id":"26e6c9af.efa6b6","type":"http request","z":"d5f106a6.0487a8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["8a6b4bcf.ed1988"]]},{"id":"8a6b4bcf.ed1988","type":"debug","z":"d5f106a6.0487a8","name":"INSERT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":590,"y":120,"wires":[]},{"id":"c46bb8d2.086de8","type":"debug","z":"d5f106a6.0487a8","name":"INSERT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":590,"y":80,"wires":[]},{"id":"71fb4680.852958","type":"function","z":"13cde19d.29391e","name":"UPDATE_RECURRING_INFO","func":"const storePackageInfo = msg.storePackageInfo;\nconst storeID = msg.STORE_ID;\nconst currentRecurringInfo = msg.recurringInfo;\nlet newRecurringInfo = generateNewRecurringData(msg.recurringInfo, storePackageInfo['packageInfo']['memberPrice']);\n\n\n\nfunction generateNewRecurringData(recurringInfo, newPrice) {\n    let newRecurringInfo = {\n        recurringID: \"\",\n        storeID: recurringInfo['storeID'],\n        storePackageID: storePackageInfo['storePackageID'],\n        creditCardID: recurringInfo['creditCardID'],\n        referenceNo: recurringInfo['referenceNo'],\n        recurringInfo: {\n            recurringNo: recurringInfo['recurringInfo']['recurringNo'],\n            recurringAmount: newPrice,\n            recurringInterval: recurringInfo['recurringInfo']['recurringInterval'],\n            recurringPeriod: recurringInfo['recurringInfo']['recurringPeriod'],\n            allowAccumulate: recurringInfo['recurringInfo']['allowAccumulate'],\n            cardToken: recurringInfo['recurringInfo']['cardToken'],\n        },\n        verifyInfo: {\n            resultCode: recurringInfo['verifyInfo']['resultCode'],\n        },\n        createdAt: 0,\n        deletedAt: 0,\n        isDeleted: false\n    };\n\n    return newRecurringInfo\n}\n\n\n\nlet data = {\n    storeID: storeID,\n    currentRecurringInfo: currentRecurringInfo,\n    newRecurringInfo: newRecurringInfo\n};\n\nmsg.url = `${msg.apiUrl}recurring/recurringInfo/update`;\nmsg.payload = data;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["ef76acb5.dc9ae","27300774.541578"]]},{"id":"ef76acb5.dc9ae","type":"debug","z":"13cde19d.29391e","name":"UPDATE_RECURRING_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":580,"y":80,"wires":[]},{"id":"27300774.541578","type":"http request","z":"13cde19d.29391e","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["cf215e0f.00026"]]},{"id":"cf215e0f.00026","type":"debug","z":"13cde19d.29391e","name":"UPDATE_RECURRING_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":580,"y":120,"wires":[]},{"id":"e594a41b.257e08","type":"function","z":"d96c41e9.777ec","name":"GET_NEXT_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}/next`;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":80,"wires":[["45637ee0.67bfd","486fb955.83d198"]]},{"id":"45637ee0.67bfd","type":"http request","z":"d96c41e9.777ec","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["a76a960f.92cea8"]]},{"id":"a76a960f.92cea8","type":"debug","z":"d96c41e9.777ec","name":"GET_NEXT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"486fb955.83d198","type":"debug","z":"d96c41e9.777ec","name":"GET_NEXT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"73f1613a.74828","type":"function","z":"f41d9a37.a83158","name":"GET_STORE_PACKAGE_INFO","func":"const storePackageID = msg.recurringInfo.storePackageID;\n\nmsg.url = `${msg.apiUrl}storePackage/storePackageID/${storePackageID}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["8df9df6d.403bc","66a7c531.f760bc"]]},{"id":"8df9df6d.403bc","type":"debug","z":"f41d9a37.a83158","name":"GET_STORE_PACKAGE_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":620,"y":80,"wires":[]},{"id":"66a7c531.f760bc","type":"http request","z":"f41d9a37.a83158","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["6482b320.55372c"]]},{"id":"6482b320.55372c","type":"debug","z":"f41d9a37.a83158","name":"GET_STORE_PACKAGE_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":620,"y":120,"wires":[]},{"id":"5519f0af.23f52","type":"function-npm","z":"e2998060.c233b","name":"","func":"const nodemailer = require(\"nodemailer\");\n\nconst to = msg.emailTo;\nconst subject = msg.emailSubject;\nconst text = msg.emailText;\nconst html = msg.emailHtml || \"\";\nconst attachments = msg.emailAttachments || [];\n\nconst auth = {\n    type: 'oauth2',\n    user: 'it@arislab.ai',\n    clientId: '106153988399-agicdbnlkc842v0i7e4u2djgkcapvdpc.apps.googleusercontent.com',\n    clientSecret: 'yIOSSqjwwaptassF4MnTr5OT',\n    refreshToken: '1/Vqq7znVy3yXRNlR1NzBUxCs32Ltv7R-LjThOjcmqiMs'\n    // refreshToken: 'ya29.GluIB_CV15_XjVO1T1kxL-joMeehCdCl09wGe4k6JdbIRb0KgR6YpSwfeWIhr4Rg64mWjhmJIwY8IaVg0mDbBHB44E2RMFjHoXQpA54BZ7reKSIm0FT-A3nN2oji',\n};\n\nconst mailOptions = {\n    from: \"it@arislab.ai\",\n    to: to,\n    subject: subject,\n    text: text,\n    html: html,\n    attachments: attachments\n};\n\nconst transporter = nodemailer.createTransport({\n    service: 'gmail',\n    auth: auth,\n});\n\nlet payload = { \"status\": \"Sending email to: \" + to + \" with subject: \" + subject };\n\ntransporter.sendMail(mailOptions, (err, res) => {\n    if (err) {\n        node.error('Error while sending mail : ');\n        node.error(err);\n        payload['status'] = \"error\";\n        payload['details'] = err;\n    } else {\n        node.error('Send email successfully with options : ', mailOptions);\n        payload['status'] = \"success\";\n    }\n}); \n\nmsg.payload = payload;\n\nreturn msg; ","outputs":1,"noerr":0,"x":430,"y":120,"wires":[[]]},{"id":"155fa44a.749e9c","type":"function","z":"e2998060.c233b","name":"","func":"const to = msg.emailTo;\nconst subject = msg.emailSubject;\nconst text = msg.emailText;\nconst html = msg.emailHtml || \"\";\n\nmsg.payload = {\n    to: to,\n    subject: subject,\n    text: text,\n    html: html\n}\n\nmsg.headers = {\n    'Authorization': 'Basic b3JpZ2luQGNvbnZvbGFiLmFpOjFxYXpaQVEh'\n};\n\nmsg.url = \"https://cloud.convolab.ai/mail\";\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":300,"wires":[["26cc885.530bb78"]]},{"id":"26cc885.530bb78","type":"http request","z":"e2998060.c233b","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":440,"y":300,"wires":[[]]},{"id":"193aa81c.fa63e8","type":"debug","z":"b6c1c291.17b39","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":130,"y":380,"wires":[]},{"id":"21450675.05917a","type":"inject","z":"b6c1c291.17b39","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":400,"wires":[["a7a4452b.19d818"]]},{"id":"83b86178.0bedf","type":"http request","z":"b6c1c291.17b39","name":"GET_SERVER_STATUS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":710,"y":280,"wires":[["265fbb63.fd2974","c1323708.e7daf8"]]},{"id":"1476556e.02500b","type":"inject","z":"b6c1c291.17b39","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":500,"wires":[["e2c2d632.6cca88"]]},{"id":"265fbb63.fd2974","type":"debug","z":"b6c1c291.17b39","name":"GET_SERVER_STATUS_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":990,"y":280,"wires":[]},{"id":"b33b6302.71ecc","type":"inject","z":"b6c1c291.17b39","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":300,"wires":[["5c412871.84dfb8"]]},{"id":"6fd4d1f5.f0b14","type":"comment","z":"b6c1c291.17b39","name":"GET_SERVER_STATUS","info":"","x":160,"y":240,"wires":[]},{"id":"6802b76a.72d528","type":"comment","z":"b6c1c291.17b39","name":"CHECK_SERVER_STATUS","info":"","x":170,"y":640,"wires":[]},{"id":"ab4401b.b996a","type":"link out","z":"b6c1c291.17b39","name":"GET_SERVER_STATUS_OUT","links":["6e85ca18.f79294"],"x":995,"y":320,"wires":[]},{"id":"6e85ca18.f79294","type":"link in","z":"b6c1c291.17b39","name":"GET_SERVER_STATUS_IN","links":["ab4401b.b996a","e644172c.1bc248"],"x":75,"y":700,"wires":[["643d4a90.3737a4"]]},{"id":"5c412871.84dfb8","type":"change","z":"b6c1c291.17b39","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://dev-arislab-core-servicestatus-svc.dev.svc.cluster.local:1150/status","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":340,"wires":[["83b86178.0bedf"]]},{"id":"a7a4452b.19d818","type":"change","z":"b6c1c291.17b39","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"https://api-alpha.arislab.ai/status","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"kuber_status_url","pt":"msg","to":"http://alpha-arislab-core-servicestatus-svc.uat.svc.cluster.local:1150/status","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":440,"wires":[["83b86178.0bedf"]]},{"id":"e2c2d632.6cca88","type":"change","z":"b6c1c291.17b39","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1150/status","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"kuber_status_url","pt":"msg","to":"http://prod-arislab-core-servicestatus-svc.production.svc.cluster.local:1150/status","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":540,"wires":[["83b86178.0bedf"]]},{"id":"c1323708.e7daf8","type":"function","z":"b6c1c291.17b39","name":"SAVE_RESPONSE_TO_CONTEXT_GLOBAL","func":"let env = msg.env;\nlet serverStatusCode;\nlet serverStatusResponse;\n\nif (typeof msg.statusCode === 'number') {\n    serverStatusCode = msg.statusCode;\n} else {\n    serverStatusCode = 999\n}\n\nif (typeof msg.payload === 'object') {\n    // node.error('1');\n    serverStatusResponse = msg.payload;\n} else {\n    serverStatusResponse = [];\n}\n\nif (\n    context.global.hasOwnProperty('serverStatus') === false\n) {\n    context.global['serverStatus'] = {};\n}\n\nif (\n    context.global.hasOwnProperty('currentServerStatus') === false\n) {\n    context.global['currentServerStatus'] = {};\n}\n\nif (\n    context.global.hasOwnProperty('NOTIFICATION_TIME_INTERVAL') === false\n) {\n    context.global['NOTIFICATION_TIME_INTERVAL'] = 1800000;\n}\n\nif (\n    context.global.hasOwnProperty('serverStatus') &&\n    !context.global['serverStatus'].hasOwnProperty(env)\n) {\n    // If this env never checked before, do this\n    serverStatusResponse = serverStatusResponse.map((service) => {\n        service['lastUpdated'] = Date.now();\n        return service;\n    });\n    \n    context.global['serverStatus'][env] = {};\n    context.global['serverStatus'][env]['statusCode'] = serverStatusCode;\n    context.global['serverStatus'][env]['statusList'] = serverStatusResponse;\n    context.global['serverStatus'][env]['lastUpdated'] = Date.now();\n}\n\ncontext.global['currentServerStatus'][env] = {};\ncontext.global['currentServerStatus'][env]['statusCode'] = serverStatusCode;\ncontext.global['currentServerStatus'][env]['statusList'] = serverStatusResponse;\ncontext.global['currentServerStatus'][env]['lastUpdated'] = Date.now();\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":320,"wires":[["ab4401b.b996a","5f0908ee.fb3798"]]},{"id":"643d4a90.3737a4","type":"function","z":"b6c1c291.17b39","name":"CHECK_SERVER_STATUSCODE","func":"let env = msg.env;\nlet serverStatus = context.global['serverStatus'][env];\nlet currentServerStatus = context.global['currentServerStatus'][env];\nlet NOTIFICATION_TIME_INTERVAL = context.global['NOTIFICATION_TIME_INTERVAL'];\n\nif ( currentServerStatus['statusCode'] !== serverStatus['statusCode'] ) {\n    // If status from current and first time is not matched, notify\n    node.error(\"SERVER HAS CHANGE STATUS.\");\n    return [msg, null];\n    \n} else {\n    if ( currentServerStatus['statusCode'] !== 200 ) {\n        if( currentServerStatus['lastUpdated'] - serverStatus['lastUpdated'] > NOTIFICATION_TIME_INTERVAL ) {\n            \n            /*\n                If status\n                - From current and first time status are equals\n                - Current status is OFFLINE\n                - Time between current and first time subtracted and still more than 30mins\n                Which means server still down, let's notify dev!\n            */\n            node.error(\"SERVER IS STILL DOWN. LET'S NOTIFY.\");\n            return [msg, null];\n        }\n    }\n    \n    // Otherwise, skip from notifying\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":280,"y":700,"wires":[["49c6c4b4.42381c","f1c517ba.4617b8"],["ba828c7a.c3255","c7c0464b.00e698"]]},{"id":"c7347cc4.af733","type":"function","z":"b6c1c291.17b39","name":"CHECK_RUNNING_SERVICES_IN_SERVER","func":"let env = msg.env;\n\nlet statusList = context.global['serverStatus'][env]['statusList'];\n\nlet offlineServiceList = statusList.filter((service) => {\n    return service.status === \"OFFLINE\";\n});\n\nmsg.payload = offlineServiceList;\n\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":1160,"wires":[["50e44a8d.0636f4","d1b81791.637238"]]},{"id":"922b7e62.b207b","type":"cronplus","z":"857f6a49.c4a9c8","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"every minute","payload":"","type":"str","expression":"* * * * *"}],"x":280,"y":240,"wires":[[]]},{"id":"30a14ecc.4c2c32","type":"exec","z":"857f6a49.c4a9c8","command":"chmod +x ./home/arislab-core/scripts/runLineNotify.sh && ./home/arislab-core/scripts/runLineNotify.sh","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"TRIGGER_LINE_NOTIFY","x":440,"y":400,"wires":[["324f722b.e5715e"],["b965b938.e4c808"],["18c92528.ae8deb"]]},{"id":"1765cf6c.c7f741","type":"inject","z":"857f6a49.c4a9c8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":400,"wires":[["30a14ecc.4c2c32"]]},{"id":"324f722b.e5715e","type":"debug","z":"857f6a49.c4a9c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":730,"y":280,"wires":[]},{"id":"b965b938.e4c808","type":"debug","z":"857f6a49.c4a9c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":320,"wires":[]},{"id":"18c92528.ae8deb","type":"debug","z":"857f6a49.c4a9c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":380,"wires":[]},{"id":"c29da6c6.a03668","type":"cronplus","z":"b6c1c291.17b39","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"every minute","payload":"","type":"str","expression":"* * * * *"}],"x":140,"y":420,"wires":[[]]},{"id":"66256579.7cf19c","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":80,"wires":[["6c836f10.5b988"]]},{"id":"a3e6e20f.1901","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":220,"wires":[["46386056.ab3bc"]]},{"id":"eb25ae5d.e1721","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":360,"wires":[["1539e47f.f0c2ec"]]},{"id":"a308a7d7.f49708","type":"comment","z":"a926ea52.1ac368","name":"DEV","info":"","x":450,"y":40,"wires":[]},{"id":"702d9070.914df","type":"comment","z":"a926ea52.1ac368","name":"ALPHA","info":"","x":450,"y":180,"wires":[]},{"id":"eb249470.187018","type":"comment","z":"a926ea52.1ac368","name":"PROD","info":"","x":450,"y":320,"wires":[]},{"id":"438337.95518cc8","type":"cronplus","z":"a926ea52.1ac368","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 8AM","payload":"","type":"str","expression":"0 8 * * *"},{"topic":"Every 4PM","payload":"","type":"str","expression":"0 16 * * *"},{"topic":"Every 12PM","payload":"","type":"str","expression":"0 12 * * *"}],"x":160,"y":220,"wires":[[]]},{"id":"6c836f10.5b988","type":"change","z":"a926ea52.1ac368","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/findOrdersByStatus?status=PENDING","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":120,"wires":[["fd981f0f.a548b"]]},{"id":"46386056.ab3bc","type":"change","z":"a926ea52.1ac368","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/findOrdersByStatus?status=PENDING","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":260,"wires":[["fd981f0f.a548b"]]},{"id":"1539e47f.f0c2ec","type":"change","z":"a926ea52.1ac368","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/findOrdersByStatus?status=PENDING","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":400,"wires":[["fd981f0f.a548b"]]},{"id":"11ac7e86.49f9d1","type":"http request","z":"a926ea52.1ac368","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1115,"y":120,"wires":[["881b5719.9583f8","a77dca7d.ede068"]]},{"id":"881b5719.9583f8","type":"debug","z":"a926ea52.1ac368","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1535,"y":80,"wires":[]},{"id":"a77dca7d.ede068","type":"function","z":"a926ea52.1ac368","name":"SAVE_TO_MSG_OBJ","func":"msg.orderList = msg.payload;\nmsg.orderListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1040,"y":160,"wires":[["5d64393e.0bfc38","c50b785d.877728"]]},{"id":"6f2eec81.219e04","type":"debug","z":"a926ea52.1ac368","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2600,"y":220,"wires":[]},{"id":"75fd0e7e.84c64","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":560,"wires":[["d0d8bf39.2afc5"]]},{"id":"d0d8bf39.2afc5","type":"function","z":"a926ea52.1ac368","name":"debug context.global","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":600,"wires":[["4c5747d3.98f118"]]},{"id":"4c5747d3.98f118","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":480,"y":640,"wires":[]},{"id":"3a3cbf4e.2bd72","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":560,"wires":[["2c3550b5.90f0d"]]},{"id":"2c3550b5.90f0d","type":"function","z":"a926ea52.1ac368","name":"reset context.global","func":"delete context.global['currentData'];\ndelete context.global['resultCheck'];\n\nmsg.payload = context.global;\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":600,"wires":[["d320298a.807ac8"]]},{"id":"d320298a.807ac8","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":180,"y":640,"wires":[]},{"id":"54fbdf5.b02722","type":"function","z":"a926ea52.1ac368","name":"PASSING_EACH_ORDER_TO_CHECK","func":"const mapped_store_token = msg.mapped_store_token;\n\nlet orderList = msg.orderList;\nlet orderListStatusCode = msg.orderListStatusCode;\n\nconst findTokenFromMappedObj = (storeID, list_mapped_store_token) => {\n    // node.error('Finding store id ' + storeID + ' from mapped store token list');\n    return list_mapped_store_token.find((item) => {\n        return item['storeID'].includes(storeID);\n    });\n}\n// node.error(orderList);\nif (orderListStatusCode === 200) {\n    orderList.forEach((order, index) => {\n        setTimeout(() => {\n            const resultTokenFromMappedObj = findTokenFromMappedObj(order['storeID'], mapped_store_token);\n            \n            // node.error('resultTokenFromMappedObj');\n            // node.error(resultTokenFromMappedObj);\n            \n            msg.gbPayAccountObj = {};\n            msg.gbPayAccountObj['found'] = false;\n            \n            if (resultTokenFromMappedObj && Object.keys(resultTokenFromMappedObj).length > 0) {\n                // node.error(`Token founded, putting secret key to msg obj...`);\n                \n                msg.gbPayAccountObj = {};\n                msg.gbPayAccountObj = resultTokenFromMappedObj;\n                msg.gbPayAccountObj['found'] = true;\n            }\n            \n            msg.payload = order;\n            node.send(msg);\n        }, 2000 * index);\n    });\n}","outputs":1,"noerr":0,"x":1750,"y":160,"wires":[["8a36612c.5d88f","a066acec.72409"]]},{"id":"a066acec.72409","type":"function","z":"a926ea52.1ac368","name":"CHECK_WITH_REFNO","func":"msg.currentOrder = msg.payload;\n\nlet order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\n// let gbPayLink = order['paymentInfo']['gbPayLink'];\n// let gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2050,"y":160,"wires":[["5236d7ee.ecf1b8","121f485e.533338"]]},{"id":"5236d7ee.ecf1b8","type":"debug","z":"a926ea52.1ac368","name":"CHECK_WITH_REFNO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2070,"y":120,"wires":[]},{"id":"b0fb9085.a629e","type":"switch","z":"a926ea52.1ac368","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1580,"y":380,"wires":[["9098492d.c98ca8","43d0c972.b59348"],["6e509cb2.754a74"]]},{"id":"bb2acab4.14ce58","type":"function","z":"a926ea52.1ac368","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2050,"y":200,"wires":[["2808cd61.0e96f2","121f485e.533338"]]},{"id":"53db94b0.c1baec","type":"switch","z":"a926ea52.1ac368","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1700,"y":420,"wires":[["14a53225.e74cce"],["8a6e34c5.b3cf18"]]},{"id":"8a6e34c5.b3cf18","type":"function","z":"a926ea52.1ac368","name":"Can't find REF_NO and LINK_NO 😢","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${orderID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)","outputs":1,"noerr":0,"x":1990,"y":440,"wires":[[]]},{"id":"8cb6fcaa.79a94","type":"link in","z":"a926ea52.1ac368","name":"LINK_NO_IN","links":["14a53225.e74cce"],"x":1895,"y":200,"wires":[["bb2acab4.14ce58"]]},{"id":"14a53225.e74cce","type":"link out","z":"a926ea52.1ac368","name":"LINK_NO_OUT","links":["8cb6fcaa.79a94"],"x":1855,"y":400,"wires":[]},{"id":"2808cd61.0e96f2","type":"debug","z":"a926ea52.1ac368","name":"CHECK_WITH_LINKNO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2070,"y":240,"wires":[]},{"id":"121f485e.533338","type":"function","z":"a926ea52.1ac368","name":"SET_HEADERS","func":"const gbPayAccountObj = msg.gbPayAccountObj;\n\n// var SECRET_KEY = \"PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\";\nvar SECRET_KEY = \"\";\n\nif (gbPayAccountObj['found']) {\n    SECRET_KEY = gbPayAccountObj['secret_key'];\n}\n\nmsg.headers = {}\n// msg.headers['Authorization'] = \"Basic UHdwUkFWaW1BSURGN0VFZTRpTFdoaDExTThFT2FBY3o6\";\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nmsg.url = \"https://api.gbprimepay.com/v1/check_status_txn\";\n\nreturn msg;","outputs":1,"noerr":0,"x":2320,"y":180,"wires":[["c408a633.28aa18","d88b6945.274a18"]]},{"id":"b671db19.161478","type":"function","z":"a926ea52.1ac368","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"const isCreditCard = (obj) => {\n    return obj.hasOwnProperty('cardNo');\n}\n\nconst checkPaymentInfo = (obj) => {\n    let paymentMethod;\n    let gbResponseStatus = obj['status'];\n    let paymentStatus = \"PENDING\";\n    let gbpReferenceNo = obj['gbpReferenceNo'];\n    if (isCreditCard(obj)) {\n        paymentMethod = \"CREDIT_CARD\";\n        \n        if (gbResponseStatus === 'S' || gbResponseStatus === 'A') {\n            paymentStatus = \"SUCCESS\";\n        } else if (gbResponseStatus === 'G') {\n            paymentStatus = \"PENDING\";\n        } else if (gbResponseStatus === 'D') {\n            paymentStatus = \"FAIL\";\n        }\n    } else {\n        paymentMethod = \"QR_CODE\";\n        \n        if (gbResponseStatus === 'S') {\n            paymentStatus = \"SUCCESS\";\n        } else if (gbResponseStatus === 'G' || gbResponseStatus === 'A') {\n            paymentStatus = \"PENDING\";\n        } else if (gbResponseStatus === 'D') {\n            paymentStatus = \"FAIL\";\n        }\n    }\n    \n    // if (isCreditCard(obj) && paymentMethod === 'S' || paymentMethod === 'A') {\n    //     paymentMethod = \"CREDIT_CARD\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'S') {\n    //     paymentMethod = \"QR_CODE\";\n    //     // paymentMethod = \"PAID\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'A') {\n    //     // paymentMethod = \"CREDIT_CARD\";\n    //     // paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'D') {\n    //     paymentMethod = \"DECLINE\";\n    //     paymentStatus = \"FAIL\";\n    // } else if (paymentMethod === 'G') {\n    //     // paymentMethod = \"QR_CODE\";\n    //     paymentStatus = \"PENDING\";\n    // }\n    \n    return {\n        \"paymentMethod\": paymentMethod,\n        \"paymentStatus\": paymentStatus,\n        \"gbpReferenceNo\": gbpReferenceNo\n    }\n}\n\nlet gbResponseObj = msg.payload;\nmsg.gbResponseObj = gbResponseObj;\n\nlet apiUrl = msg.apiUrl;\n\nlet currentOrder = msg.currentOrder;\nlet storeID = currentOrder['storeID'];\nlet orderDocID = currentOrder['orderDocID'];\nlet paymentMethod;\nlet gbpReferenceNo;\n\nif (gbResponseObj.hasOwnProperty('txn')) {\n    // paymentMethod = gbResponseObj['txn']['status'];\n    // gbpReferenceNo = gbResponseObj['txn']['gbpReferenceNo'];\n    \n    const resultCheckPaymentInfo = checkPaymentInfo(gbResponseObj['txn']);\n    \n    if (Object.keys(resultCheckPaymentInfo).length > 0) {\n        paymentMethod = resultCheckPaymentInfo['paymentMethod'];\n        paymentStatus = resultCheckPaymentInfo['paymentStatus'];\n        gbpReferenceNo = resultCheckPaymentInfo['gbpReferenceNo'];\n    }\n    \n    // if (gbResponseObj['txn'].hasOwnProperty('cardNo')) {\n    //     paymentMethod = \"CREDIT_CARD\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'S') {\n    //     paymentMethod = \"QR_CODE\";\n    //     // paymentMethod = \"PAID\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'A') {\n    //     paymentMethod = \"CREDIT_CARD\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'D') {\n    //     paymentMethod = \"DECLINE\";\n    //     paymentStatus = \"FAIL\";\n    // } else if (paymentMethod === 'G') {\n    //     paymentMethod = \"QR_CODE\";\n    // }\n}\n\nif (gbResponseObj.hasOwnProperty('txns')) {\n    const resultFilterTXNS = gbResponseObj['txns'].find((txn) => {\n        return currentOrder.orderDocID === txn.merchantDefined2;\n    });\n    \n    if (Object.keys(resultFilterTXNS).length > 0) {\n        const resultCheckPaymentInfo = checkPaymentInfo(resultFilterTXNS);\n        \n        if (Object.keys(resultCheckPaymentInfo).length > 0) {\n            paymentMethod = resultCheckPaymentInfo['paymentMethod'];\n            paymentStatus = resultCheckPaymentInfo['paymentStatus'];\n            gbpReferenceNo = resultCheckPaymentInfo['gbpReferenceNo'];\n        }\n    }\n}\n// let paymentCompletedOn = paymentResponseObj.paymentCompletedOn;\n\n// var paymentStatus = \"PENDING\";\n\ncurrentOrder['resultPaymentStatus'] = paymentStatus;\nmsg.currentOrder = currentOrder;\n\n// let customerInfo = paymentResponseObj.customerInfo;\n\nlet url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\n\nmsg.url = url;\nmsg.payload = {\n    \"paymentInfo\": {\n        \"method\": paymentMethod,\n        \"status\": paymentStatus,\n        \"details\": gbpReferenceNo,\n        // \"paymentCompletedOn\": paymentCompletedOn,\n        \"isFromBatchCheck\": true,\n        \"batchCheckTimestamp\": Date.now(),\n        \"paymentCompletedOn\": Date.now()\n    }\n}\n\n// msg.payload = {\n//     \"paymentInfo\": {\n//         \"method\": paymentMethod,\n//         \"status\": \"SUCCESS\",\n//         \"details\": gbpReferenceNo,\n//         \"paymentCompletedOn\": paymentCompletedOn,\n//         \"isFromBatchCheck\": true,\n//         \"batchCheckTimestamp\": Date.now(),\n//         \"gbPaymentDetails\": {\n//             \"customerName\": customerInfo.customerName,\n//             \"customerEmail\": customerInfo.customerEmail,\n//             \"customerAddress\": customerInfo.customerAddress,\n//             \"customerTelephone\": customerInfo.customerTelephone\n//         }\n//     }\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":2000,"y":300,"wires":[["672e0787.1a5fa8"]]},{"id":"672e0787.1a5fa8","type":"debug","z":"a926ea52.1ac368","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2400,"y":300,"wires":[]},{"id":"4f0a3b3d.5c13e4","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2270,"y":340,"wires":[]},{"id":"5f0908ee.fb3798","type":"debug","z":"b6c1c291.17b39","name":"SAVE_RESPONSE_TO_CONTEXT_GLOBAL_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1150,"y":360,"wires":[]},{"id":"49c6c4b4.42381c","type":"debug","z":"b6c1c291.17b39","name":"CHECK_SERVER_STATUSCODE_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":640,"wires":[]},{"id":"50e44a8d.0636f4","type":"debug","z":"b6c1c291.17b39","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":1280,"wires":[]},{"id":"d1b81791.637238","type":"switch","z":"b6c1c291.17b39","name":"IS_SERVICE_DOWN?","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1160,"y":1220,"wires":[["9c52663a.80a508"],["fb582b6d.699ff8"]]},{"id":"9c52663a.80a508","type":"function","z":"b6c1c291.17b39","name":"","func":"const capitalizeFirstLetter = (message) => {\n    return message.charAt(0).toUpperCase() + message.slice(1);\n}\n\nlet env = msg.env.toUpperCase();\nlet offlineServiceList = msg.payload;\nlet allStatusList = context.global['serverStatus'][msg.env]['statusList'];\nlet tempMessage = `[${env}] อุ๊บส์... Service: `;\n\nofflineServiceList.forEach((service, index) => {\n    node.error(`Service: ${service['serviceName']} offline`);\n    if (index > 0) {\n        tempMessage += `, ${capitalizeFirstLetter(service['serviceName'])}`\n    } else {\n        tempMessage += `${capitalizeFirstLetter(service['serviceName'])}`\n    }\n});\n\ntempMessage += ' พังไปแล้ว ทีม Dev มาตรวจสอบให้ที \\n\\n';\ntempMessage += `===== ${env} Service =====\\n`\n\nallStatusList.forEach((service) => {\n    let statusIcon = \"\";\n    let feelingIcon = \"\";\n    if (service.status.toUpperCase() === \"ONLINE\") {\n        statusIcon = \"✔\";\n        feelingIcon = \"😊\";\n    } else {\n        statusIcon = \"❌\";\n        feelingIcon = \"👿\";\n    }\n    tempMessage += `${statusIcon} ${capitalizeFirstLetter(service['serviceName'])}: ${service['status'].toUpperCase()} ${feelingIcon} \\n`\n})\n\nmsg.messageToNotify = {\n    message: tempMessage,\n    stickerPackageId: 1,\n    stickerId: 16\n}\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":1200,"wires":[[]]},{"id":"fb582b6d.699ff8","type":"function","z":"b6c1c291.17b39","name":"","func":"// node.error('ALL IS WELL');\n\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":1240,"wires":[[]]},{"id":"e10cc70c.2c66f8","type":"comment","z":"b6c1c291.17b39","name":"TRIGGER_LINE_NOTIFY","info":"","x":170,"y":1060,"wires":[]},{"id":"420e60b1.72f52","type":"link in","z":"b6c1c291.17b39","name":"NOTIFY_IN","links":["70f8949.13ef36c","965c63e9.02555"],"x":255,"y":1100,"wires":[["f2a5a95.47f9758"]]},{"id":"70f8949.13ef36c","type":"link out","z":"b6c1c291.17b39","name":"NOTIFY_OUT","links":["420e60b1.72f52","293db432.f1fbbc"],"x":1235,"y":680,"wires":[]},{"id":"f2a5a95.47f9758","type":"function","z":"b6c1c291.17b39","name":"SET_HEADERS","func":"const TOKEN = \"A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc\";\n\nlet messageToNotify = msg.messageToNotify;\n\nmsg.headers = {\n    \"Content-Type\": \"application/x-www-form-urlencoded\",\n    \"Authorization\": `Bearer ${TOKEN}`,\n    // \"Cache-Control\": \"no-cache\"\n}\nmsg.payload = messageToNotify;\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":1140,"wires":[["11e07f99.10eaa","7ea07d42.13c594"]]},{"id":"ae01014c.9bac","type":"debug","z":"b6c1c291.17b39","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":590,"y":1200,"wires":[]},{"id":"73f075a6.430d0c","type":"inject","z":"b6c1c291.17b39","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":1120,"wires":[["2fac36ca.a764ea"]]},{"id":"11e07f99.10eaa","type":"debug","z":"b6c1c291.17b39","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":350,"y":1180,"wires":[]},{"id":"965c63e9.02555","type":"link out","z":"b6c1c291.17b39","name":"NOTIFY_OUT","links":["420e60b1.72f52","293db432.f1fbbc"],"x":1115,"y":940,"wires":[]},{"id":"ba828c7a.c3255","type":"debug","z":"b6c1c291.17b39","name":"CHECK_SERVER_STATUSCODE_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":760,"wires":[]},{"id":"f1c517ba.4617b8","type":"function","z":"b6c1c291.17b39","name":"NOTIFY_FOR_SERVER_STATUS_BY_HTTP_STATUS_CODE","func":"let env = msg.env\nlet envUppercase = msg.env.toUpperCase();\nlet serverStatus = context.global['serverStatus'][env];\nlet currentServerStatus = context.global['currentServerStatus'][env];\n\nif (currentServerStatus['statusCode'] === 200) {\n    // If current server status is online (200), do notify \"SERVER IS BACK!!!\"\n    node.error('SERVER IS BACK!')\n    \n    msg.messageToNotify = {\n        message: `[${envUppercase}] เย้!!! SERVER กลับมามีสถานะเป็น Online แล้ว`,\n        stickerPackageId: 1,\n        stickerId: 103\n    }    \n    \n    return [msg, null];\n} else {\n    // Otherwise, do notify \"SERVER DOWN\"\n    node.error('SERVER DOWN')\n    \n    msg.messageToNotify = {\n        message: `[${envUppercase}] แย่แล้ว!!! ตรวจพบว่า SERVER มีสถานะเป็น Offline รีบแก้ไขด่วน`,\n        stickerPackageId: 1,\n        stickerId: 16\n    }\n    \n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":700,"y":680,"wires":[["70f8949.13ef36c","1945b738.ef71a9","74e7f6ad.b89728"],["70f8949.13ef36c","1945b738.ef71a9"]]},{"id":"2fac36ca.a764ea","type":"function","z":"b6c1c291.17b39","name":"","func":"msg.messageToNotify = {\n    message: \"testttt\",\n    stickerPackageId: 1,\n    stickerId: 16\n}\nreturn msg;","outputs":1,"noerr":0,"x":130,"y":1180,"wires":[["f2a5a95.47f9758","fbe1d355.df7eb"]]},{"id":"7ea07d42.13c594","type":"http request","z":"b6c1c291.17b39","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://notify-api.line.me/api/notify","tls":"","proxy":"","authType":"","x":550,"y":1140,"wires":[["ae01014c.9bac"]]},{"id":"fbe1d355.df7eb","type":"debug","z":"b6c1c291.17b39","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":270,"y":1220,"wires":[]},{"id":"1945b738.ef71a9","type":"function","z":"b6c1c291.17b39","name":"UPDATE CURRENT SERVER STATUS TO FIRST SERVER STATUS","func":"let env = msg.env;\n\n// node.error(\"ENV === \"+env);\n// node.error(\"context.global['currentServerStatus'][env]['statusCode'] === \"+context.global['currentServerStatus'][env]['statusCode']);\n// node.error(\"context.global['currentServerStatus'][env]['lastUpdated'] === \"+context.global['currentServerStatus'][env]['lastUpdated']);\n// node.error(\"context.global['serverStatus'][env]['statusCode'] === \"+context.global['serverStatus'][env]['statusCode']);\n// node.error(\"context.global['serverStatus'][env]['lastUpdated'] === \"+context.global['serverStatus'][env]['lastUpdated']);\n\n\ncontext.global['serverStatus'][env]['statusCode'] = context.global['currentServerStatus'][env]['statusCode'];\ncontext.global['serverStatus'][env]['lastUpdated'] = context.global['currentServerStatus'][env]['lastUpdated'];\n\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":780,"wires":[[]]},{"id":"c7c0464b.00e698","type":"function","z":"b6c1c291.17b39","name":"SERVER STILL OKAY OR IT'S NOT TIME TO NOTIFY","func":"let env = msg.env;\nlet currentServerStatus = context.global['currentServerStatus'][env];\nif( currentServerStatus['statusCode'] === 200 ) {\n    // node.error(\"SERVER IS STILL ONLINE, DON'T NOTIFY ANYTHING.\");\n    return [msg, null];\n} else {\n    // node.error(\"SERVER IS STILL DOWN, BUT IT IS NOT TIME TO NOTIFY.\");\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":680,"y":720,"wires":[["1945b738.ef71a9","74e7f6ad.b89728"],[]]},{"id":"e5b11e76.834fc","type":"comment","z":"b6c1c291.17b39","name":"CHECK_SERVICE_STATUS","info":"","x":180,"y":880,"wires":[]},{"id":"74e7f6ad.b89728","type":"link out","z":"b6c1c291.17b39","name":"CHECK_SERVICE_OUT","links":["9b4d3a14.9be7b8"],"x":1035,"y":740,"wires":[]},{"id":"9b4d3a14.9be7b8","type":"link in","z":"b6c1c291.17b39","name":"CHECK_SERVICE_IN","links":["74e7f6ad.b89728"],"x":75,"y":960,"wires":[["4d98eb45.170724"]]},{"id":"4d98eb45.170724","type":"function","z":"b6c1c291.17b39","name":"CHECK_RUNNING_SERVICES_IN_SERVER","func":"let env = msg.env;\n\nconst NOT_NOTIFY_SERVICE_NAME_LIST = ['rvpTLS'];\n\nlet statusList = context.global['serverStatus'][env]['statusList'];\nlet currentStatusList = context.global['currentServerStatus'][env]['statusList'];\nlet NOTIFICATION_TIME_INTERVAL = context.global['NOTIFICATION_TIME_INTERVAL'];\n\nlet offlineService = [];\nlet backToOnlineService = [];\nlet updateStatusList = [];\n\ncurrentStatusList.forEach((currentStatusInfo, index) => {\n\n    const lastStatus = statusList.find(service => service.serviceName === currentStatusInfo.serviceName);\n    \n    if ( NOT_NOTIFY_SERVICE_NAME_LIST.indexOf(lastStatus.serviceName) > -1 ) {\n        updateStatusList[index] = currentStatusInfo;\n        updateStatusList[index]['lastUpdated'] = Date.now()\n    }\n                \n    if( currentStatusInfo.status.toLocaleUpperCase() === \"ONLINE\" ) {\n        if( lastStatus.status === \"OFFLINE\" ) {\n            // node.error('online')\n            backToOnlineService.push( currentStatusInfo.serviceName );\n        }\n        \n        updateStatusList[index] = currentStatusInfo;\n        updateStatusList[index]['lastUpdated'] = Date.now()\n\n    } else {\n\n        if( lastStatus.status === \"ONLINE\" ) {\n            // node.error('last status ONLINE')\n            updateStatusList[index] = currentStatusInfo;\n            updateStatusList[index]['lastUpdated'] = Date.now()\n            // updateStatusList[index]['status'] = currentStatusInfo['status'];\n            // updateStatusList[index]['lastUpdated'] = currentStatusInfo['lastUpdated'];\n\n            if( NOT_NOTIFY_SERVICE_NAME_LIST.indexOf(lastStatus.serviceName) === -1 ) {\n                // node.error('offline 1');\n                offlineService.push( lastStatus.serviceName );\n            }\n        \n        } else {\n            // node.error('last status !== ONLINE')\n            if( lastStatus.hasOwnProperty('lastUpdated') && lastStatus.lastUpdated ) {\n                // node.error(`lastStatus.hasOwnProperty('lastUpdated') && lastStatus.lastUpdated `)\n                if( (currentStatusInfo.lastUpdated - lastStatus.lastUpdated) > NOTIFICATION_TIME_INTERVAL ) {\n                    // node.error(`currentStatusInfo.lastUpdated - lastStatus.lastUpdated) > NOTIFICATION_TIME_INTERVAL`)\n                    updateStatusList[index] = currentStatusInfo;\n                    updateStatusList[index]['lastUpdated'] = Date.now()\n                    // updateStatusList[index]['status'] = currentStatusInfo['status'];\n                    // updateStatusList[index]['lastUpdated'] = currentStatusInfo['lastUpdated'];\n                    \n                    if( NOT_NOTIFY_SERVICE_NAME_LIST.indexOf(lastStatus.serviceName) === -1 ) {\n                        // node.error('offline 2');\n                        offlineService.push( lastStatus.serviceName );\n                    }\n\n                } else {\n                    updateStatusList[index] = lastStatus;\n                }\n            } else {\n                updateStatusList[index] = currentStatusInfo;\n                updateStatusList[index]['lastUpdated'] = Date.now()\n                // updateStatusList[index]['status'] = currentStatusInfo['status'];\n                // updateStatusList[index]['lastUpdated'] = currentStatusInfo['lastUpdated'];\n            }\n\n        }\n\n    }\n});\n\nmsg.updateStatusList = updateStatusList;\nif (offlineService.length > 0 || backToOnlineService.length > 0 ) {\n    msg.offlineService = offlineService;\n    msg.backToOnlineService = backToOnlineService;\n    // node.error('offline > 0')\n    return [msg, null];\n} else {\n    // node.error('offline < 0')\n    return [null, msg];\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// let offlineServiceList = statusList.filter((service) => {\n//     return service.status === \"OFFLINE\";\n// });\n\n// msg.payload = offlineServiceList;\n\n// return msg;","outputs":2,"noerr":0,"x":310,"y":960,"wires":[["d75fc4be.e9f4e8","f8ba8d8b.57039"],["7085a74d.2fb518","d75fc4be.e9f4e8"]]},{"id":"7085a74d.2fb518","type":"function","z":"b6c1c291.17b39","name":"SERVICE STILL OKAY OR IT'S NOT TIME TO NOTIFY","func":"// let env = msg.env;\n// let currentServerStatus = context.global['currentServerStatus'][env];\n// if( currentServerStatus['statusCode'] === 200 ) {\n//     node.error(\"SERVER IS STILL ONLINE, DON'T NOTIFY ANYTHING.\");\n//     return [msg, null];\n// } else {\n//     node.error(\"SERVER IS STILL DOWN, BUT IT IS NOT TIME TO NOTIFY.\");\n//     return [null, msg];\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":980,"wires":[[]]},{"id":"f8ba8d8b.57039","type":"function","z":"b6c1c291.17b39","name":"NOTIFY_FOR_SERVICE_STATUS","func":"let env = msg.env\nlet envUppercase = msg.env.toUpperCase();\n\nvar offlineService = msg.offlineService;\nvar backToOnlineService = msg.backToOnlineService;\n\n\nif( offlineService.length > 0 ) {\n    \n    msg.messageToNotify = {\n        message: `[${envUppercase}] Tech Team จ๋า Service: ${offlineService.join(', ')} ดับไปแล้ว ช่วยเช็คให้ด้วยน้าาาาา`,\n        stickerPackageId: 1,\n        stickerId: 16\n    }\n    msg.offlineService = [];\n    \n    return [msg, null];\n}\n\nif( backToOnlineService.length >0 ) {\n\n    msg.messageToNotify = {\n        message: `[${envUppercase}] Service: ${backToOnlineService.join(', ')} กลับมาใช้งานได้ตามปกติแล้ว ดีใจ!!!`,\n        stickerPackageId: 1,\n        stickerId: 120\n    }\n    msg.backToOnlineService = [];\n    \n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":680,"y":940,"wires":[["965c63e9.02555","e7642f91.1b7e9"],["965c63e9.02555","e7642f91.1b7e9"]]},{"id":"d75fc4be.e9f4e8","type":"debug","z":"b6c1c291.17b39","name":"CHECK_SERVICE_STATUSCODE_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":1040,"wires":[]},{"id":"e7642f91.1b7e9","type":"function","z":"b6c1c291.17b39","name":"UPDATE CURRENT SERVICE STATUS TO FIRST SERVICE STATUS","func":"let env = msg.env;\n\ncontext.global['serverStatus'][env]['statusList'] = msg.updateStatusList;\n\nreturn msg;","outputs":1,"noerr":0,"x":1220,"y":1060,"wires":[[]]},{"id":"ad1caf3a.a19bb","type":"inject","z":"b6c1c291.17b39","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":100,"wires":[["45e9f21f.dcc54c"]]},{"id":"45e9f21f.dcc54c","type":"function","z":"b6c1c291.17b39","name":"CHECK_CONTEXT_GLOBAL","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":140,"wires":[["83fa8f1a.48c3b"]]},{"id":"77748f3f.8bd85","type":"inject","z":"b6c1c291.17b39","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":100,"wires":[["78685896.721168"]]},{"id":"78685896.721168","type":"function","z":"b6c1c291.17b39","name":"REMOVE_CONTEXT_GLOBAL","func":"delete context.global['serverStatus'];\ndelete context.global['currentServerStatus'];\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":140,"wires":[[]]},{"id":"83fa8f1a.48c3b","type":"debug","z":"b6c1c291.17b39","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":170,"y":180,"wires":[]},{"id":"6b9b8120.a6bb","type":"inject","z":"b6c1c291.17b39","name":"API","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1050,"y":80,"wires":[["b066bab0.5f1a88"]]},{"id":"b066bab0.5f1a88","type":"function","z":"b6c1c291.17b39","name":"CHANGE_SERVER_STATUS","func":"let payload = msg.payload;\n\ncontext.global['serverStatus']['alpha']['statusList'][payload]['status'] = \"OFFLINE\";\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":100,"wires":[["f74bfa59.760c38"]]},{"id":"f74bfa59.760c38","type":"debug","z":"b6c1c291.17b39","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1210,"y":140,"wires":[]},{"id":"5fafe031.a557","type":"inject","z":"b6c1c291.17b39","name":"SECURESITE","topic":"","payload":"2","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1030,"y":120,"wires":[["b066bab0.5f1a88"]]},{"id":"add11e0a.bccee","type":"comment","z":"b6c1c291.17b39","name":"INJECT","info":"","x":110,"y":40,"wires":[]},{"id":"d41fbc4c.ee57","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":1030,"y":120,"wires":[]},{"id":"d956e741.579cb8","type":"debug","z":"c0036ad7.2ae908","name":"handleVerifyQRCode_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":230,"y":200,"wires":[]},{"id":"cc5a404.0d2d8c","type":"function","z":"c0036ad7.2ae908","name":"INIT_PAYLOAD","func":"msg.headers = {\n    \"Content-type\" : \"multipart/form-data\"\n}\n\nlet reqPayload = msg.payload;\nmsg.payload = {\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo'],\n    \"amount\": reqPayload['amount']\n}\n\nnode.log('Verifying QRCode with payload: ' + JSON.stringify(msg.payload));\n\n// msg.url = \"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode\";\n// msg.method = \"POST\";\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":60,"wires":[["c1c8b353.766f5","89936ff7.33d5"]]},{"id":"64913f62.9f9c9","type":"www-request-multipart","z":"c0036ad7.2ae908","name":"","method":"POST","ret":"obj","url":"","follow-redirects":false,"tls":"","x":810,"y":60,"wires":[["d41fbc4c.ee57","f444d932.4e8358"]]},{"id":"c1c8b353.766f5","type":"debug","z":"c0036ad7.2ae908","name":"handleVerifyQRCode_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":370,"y":120,"wires":[]},{"id":"963b06d9.9e9f98","type":"httpInMultipart","z":"c0036ad7.2ae908","name":"","url":"/handleVerifyQRCode","method":"post","fields":"[{\"name\": \"referenceNo\"}, {\"name\": \"gbpReferenceNo\"}, {\"name\": \"amount\"}]","swaggerDoc":"","x":180,"y":60,"wires":[["cc5a404.0d2d8c","d956e741.579cb8"]]},{"id":"e4f6e44c.75f7a8","type":"change","z":"c0036ad7.2ae908","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":100,"wires":[["64913f62.9f9c9"]]},{"id":"89936ff7.33d5","type":"change","z":"c0036ad7.2ae908","name":"BETA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":140,"wires":[["64913f62.9f9c9"]]},{"id":"f444d932.4e8358","type":"debug","z":"c0036ad7.2ae908","name":"handleVerifyQRCode_debug3","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":1110,"y":60,"wires":[]},{"id":"b0bb079b.286408","type":"http in","z":"c0036ad7.2ae908","name":"","url":"/liveEventCode","method":"get","upload":false,"swaggerDoc":"","x":150,"y":400,"wires":[["aea35bb2.95d5c8","d06e205e.fee6f"]]},{"id":"e1ecc94a.447e98","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":930,"y":600,"wires":[]},{"id":"966d958e.de79f8","type":"function","z":"c0036ad7.2ae908","name":"DEV","func":"let code = msg.payload.code.toUpperCase();\n\nmsg.url = `http://console.internal.arislab.ai:1780/api/event/code/${code}`;\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":440,"wires":[["aa2ea65.cdcd358"]]},{"id":"aea35bb2.95d5c8","type":"debug","z":"c0036ad7.2ae908","name":"liveEventCode_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":390,"y":580,"wires":[]},{"id":"aa2ea65.cdcd358","type":"http request","z":"c0036ad7.2ae908","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":930,"y":440,"wires":[["e1ecc94a.447e98","330e4f2e.ec4ba"]]},{"id":"330e4f2e.ec4ba","type":"debug","z":"c0036ad7.2ae908","name":"liveEventCode_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1070,"y":380,"wires":[]},{"id":"7f16808d.f55bb","type":"function","z":"c0036ad7.2ae908","name":"ALPHA","func":"let code = msg.payload.code.toUpperCase();\n\nmsg.url = `http://console.cb-alpha.arislab.ai:1780/api/event/code/${code}`;\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":480,"wires":[["aa2ea65.cdcd358"]]},{"id":"7413c070.a23fc","type":"function","z":"c0036ad7.2ae908","name":"BETA","func":"let code = msg.payload.code.toUpperCase();\n\nmsg.url = `http://console.cb-beta.arislab.ai:1780/api/event/code/${code}`;\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":520,"wires":[["aa2ea65.cdcd358"]]},{"id":"8b1a3500.b3c688","type":"switch","z":"c0036ad7.2ae908","name":"split by env","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":410,"y":480,"wires":[["966d958e.de79f8"],["7f16808d.f55bb"],["7413c070.a23fc"],["7413c070.a23fc"]]},{"id":"d06e205e.fee6f","type":"switch","z":"c0036ad7.2ae908","name":"with ?code querystring or not","property":"payload.code","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":400,"wires":[["8b1a3500.b3c688"],["d44bceb2.3328d"]]},{"id":"5d26120d.472f9c","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":810,"y":380,"wires":[]},{"id":"d44bceb2.3328d","type":"function","z":"c0036ad7.2ae908","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Code must not by empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":380,"wires":[["5d26120d.472f9c"]]},{"id":"94ec7e3b.6edf8","type":"http in","z":"c0036ad7.2ae908","name":"","url":"/getStreamingVideo","method":"get","upload":false,"swaggerDoc":"","x":170,"y":720,"wires":[["ba7ed24c.b03eb","161775b2.491e4a"]]},{"id":"8a7bc90.f7b1138","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":1190,"y":700,"wires":[]},{"id":"ba7ed24c.b03eb","type":"switch","z":"c0036ad7.2ae908","name":"with ?code querystring or not","property":"payload.code","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":660,"wires":[["7d2d30ce.05c39"],["c343b8e3.71db38"]]},{"id":"c343b8e3.71db38","type":"function","z":"c0036ad7.2ae908","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Code must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":880,"wires":[["dfb30ea.7ed29f"]]},{"id":"dfb30ea.7ed29f","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":730,"y":880,"wires":[]},{"id":"161775b2.491e4a","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":170,"y":860,"wires":[]},{"id":"7d2d30ce.05c39","type":"switch","z":"c0036ad7.2ae908","name":"with ?ip querystring or not","property":"payload.ip","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":700,"wires":[["b04a2882.560bd8"],["8c644bcf.301218"]]},{"id":"8c644bcf.301218","type":"function","z":"c0036ad7.2ae908","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"IP must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":820,"wires":[["dfb30ea.7ed29f"]]},{"id":"b04a2882.560bd8","type":"function","z":"c0036ad7.2ae908","name":"","func":"let code = msg.payload.code;\nlet ip = msg.payload.ip\nmsg.payload = {\n    url: `http://${ip}/live/${code}.flv`\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":680,"wires":[["e65e75b4.f9b308","8a7bc90.f7b1138"]]},{"id":"e65e75b4.f9b308","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":760,"wires":[]},{"id":"444f1a25.728924","type":"http in","z":"f527f707.d5a028","name":"","url":"/cloneProduct","method":"post","upload":false,"swaggerDoc":"","x":210,"y":100,"wires":[["8e3d8f8a.05198"]]},{"id":"ebb1b5a.4590848","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":710,"y":300,"wires":[]},{"id":"8e3d8f8a.05198","type":"function","z":"f527f707.d5a028","name":"Check required fields","func":"let payload = msg.payload;\n\nif (\n    payload.hasOwnProperty('source') &&\n    payload.hasOwnProperty('target') &&\n    payload.hasOwnProperty('env')\n) {\n    return [msg, null];\n} else {\n    msg.statusCode = 400;\n    msg.payload = {\n        message: \"Missing required fields (source, target or env). Please check and try again\"\n    };\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":460,"y":120,"wires":[["f6a9a09.3d64c6"],["ebb1b5a.4590848"]]},{"id":"aeb8715.cfbbb9","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":1110,"y":60,"wires":[]},{"id":"1a77f0b.e0c470f","type":"function","z":"f527f707.d5a028","name":"echo payload back","func":"let payload = msg.payload;\n\nmsg.payload = payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":180,"wires":[[]]},{"id":"f6a9a09.3d64c6","type":"switch","z":"f527f707.d5a028","name":"env splitter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":730,"y":80,"wires":[["4a063a8a.4dab94"],[],[]]},{"id":"4a063a8a.4dab94","type":"change","z":"f527f707.d5a028","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":60,"wires":[["aeb8715.cfbbb9"]]},{"id":"f33cb36c.ad25e","type":"inject","z":"f527f707.d5a028","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":760,"y":180,"wires":[["4ba3ecd8.250594"]]},{"id":"6c26fbaa.cc36d4","type":"http request","z":"f527f707.d5a028","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1020,"y":280,"wires":[["4c3d53a7.026c8c"]]},{"id":"4c3d53a7.026c8c","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1200,"y":380,"wires":[]},{"id":"4ba3ecd8.250594","type":"function","z":"f527f707.d5a028","name":"","func":"const CREDENTIALS = {\n    \"user\": \"elastic\",\n    \"pass\": \"Ptox6rGdRdhr5gajOIZBXZQn\"\n}\n\nconst HOST = `${CREDENTIALS['user']}:${CREDENTIALS['pass']}@893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243`;\nconst INDEX = 'arislab-platform';\nconst TYPE = 'product';\n\nmsg.url = `https://${HOST}/${INDEX}/${TYPE}/_search?size=500`;\nmsg.method = \"GET\"\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":180,"wires":[["6c26fbaa.cc36d4"]]},{"id":"143caa28.2ff066","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":890,"y":180,"wires":[]},{"id":"16463094.9c6d1f","type":"function","z":"c0036ad7.2ae908","name":"ALWAYS_APPROVE","func":"let reqPayload = msg.payload;\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n}\n\nmsg.payload = {\n    \"resultCode\": \"00\",\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo']\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":180,"wires":[["143caa28.2ff066","d976f1b6.3f5d8"]]},{"id":"d976f1b6.3f5d8","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":240,"wires":[]},{"id":"2c9769c8.230726","type":"change","z":"c0036ad7.2ae908","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":60,"wires":[["64913f62.9f9c9"]]},{"id":"c7c2c864.7e9308","type":"http in","z":"f527f707.d5a028","name":"","url":"/setupDroplet","method":"get","upload":false,"swaggerDoc":"","x":170,"y":460,"wires":[["ed5b7bbf.5024a8"]]},{"id":"a263e692.ca0168","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":1270,"y":600,"wires":[]},{"id":"ee5d3b18.09f0f8","type":"function","z":"f527f707.d5a028","name":"Init file content and filename","func":"let env = msg.env\n\nmsg.payload = `\n\n#!/bin/sh\n\n# Install npm\necho \"⏳ Installing npm...\"\nsudo apt update\napt -y install npm\n\n# Install NodeJS 8.x\necho \"⏳ Installing nodejs...\"\ncurl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -\napt -y install nodejs\n\n# Install yarn\necho \"⏳ Installing yarn...\"\ncurl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -\necho \"deb https://dl.yarnpkg.com/debian/ stable main\" | sudo tee /etc/apt/sources.list.d/yarn.list\napt-get -y install yarn\n\n# Install typescript\necho \"⏳ Installing typescript...\"\napt -y install node-typescript\n\n# Install ffmpeg\necho \"⏳ Installing ffmpeg..\"\nsudo add-apt-repository -y ppa:jonathonf/ffmpeg-4\nsudo apt -y install ffmpeg\n\n# Install libxcomposite\necho \"⏳ Installing libxcomposite...\"\napt-get -y install libxcomposite-dev && apt-get -y install libxtst6 && apt-get -y install libnss3-dev && apt-get -y install libatk1.0-0 && apt-get -y install libatk-bridge2.0-0 && apt -y install libgtk-3-0\n\n# Setup git\necho \"⏳ Cloning arislab-core...\"\ngit config --global credential.helper store\ncd /home && git clone --single-branch --branch ${env} https://6c30008265a798b84ea651f287646de07bbd98a6@github.com/arislab/arislab-core.git && cd arislab-core\n\necho \"⏳ Creating .env.production file...\"\ncurl https://manage.arislab.ai/createEnvFile?env=${env} >> .env.production\n\nsudo mv package.json _package.json\nsudo mv no_platform-package.json package.json\n\necho \"⏳ Starting all services...\"\nnpm install && npm run-script prod\n\n`;\nmsg.filename = `/setupDroplet_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":500,"wires":[["2c69e241.6b5b2e","5af822f.5849cdc"]]},{"id":"dbf5612f.bb3fb","type":"file in","z":"f527f707.d5a028","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":1270,"y":540,"wires":[["d7d767c5.2676c8"]]},{"id":"d7d767c5.2676c8","type":"change","z":"f527f707.d5a028","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":600,"wires":[["a263e692.ca0168","3ee8958b.6df31a"]]},{"id":"2c69e241.6b5b2e","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":460,"wires":[]},{"id":"3ee8958b.6df31a","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":640,"wires":[]},{"id":"5af822f.5849cdc","type":"file","z":"f527f707.d5a028","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1270,"y":500,"wires":[["61b56ab6.830bf4"]]},{"id":"61b56ab6.830bf4","type":"function","z":"f527f707.d5a028","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":540,"wires":[["dbf5612f.bb3fb"]]},{"id":"5370c86f.80b4f8","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":150,"y":740,"wires":[]},{"id":"ed5b7bbf.5024a8","type":"switch","z":"f527f707.d5a028","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":460,"wires":[["8f4806e.52d04f8"],["ea6ceea8.a397b"]]},{"id":"ea6ceea8.a397b","type":"change","z":"f527f707.d5a028","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":180,"y":700,"wires":[["5370c86f.80b4f8"]]},{"id":"4857e49f.788c6c","type":"http in","z":"f527f707.d5a028","name":"","url":"/createEnvFile","method":"get","upload":false,"swaggerDoc":"","x":170,"y":840,"wires":[["760e99a8.f57688"]]},{"id":"760e99a8.f57688","type":"switch","z":"f527f707.d5a028","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":840,"wires":[["d8f34677.a66078"],["880cb08c.0f7e9"]]},{"id":"8f4806e.52d04f8","type":"switch","z":"f527f707.d5a028","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":530,"y":600,"wires":[["1b48b8cc.49f427"],["f321c5c1.48c7a8"],["106d5bf0.f83884"]]},{"id":"1b48b8cc.49f427","type":"change","z":"f527f707.d5a028","name":"dev","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":480,"wires":[["ee5d3b18.09f0f8"]]},{"id":"f321c5c1.48c7a8","type":"change","z":"f527f707.d5a028","name":"alpha","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":520,"wires":[["ee5d3b18.09f0f8"]]},{"id":"106d5bf0.f83884","type":"change","z":"f527f707.d5a028","name":"beta","rules":[{"t":"set","p":"env","pt":"msg","to":"master","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":560,"wires":[["ee5d3b18.09f0f8"]]},{"id":"d8f34677.a66078","type":"switch","z":"f527f707.d5a028","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":430,"y":960,"wires":[["589b2694.c95968"],["5a234184.35011"],["a669b149.fd447"]]},{"id":"153455bc.3f242a","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":950,"y":860,"wires":[]},{"id":"880cb08c.0f7e9","type":"change","z":"f527f707.d5a028","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":820,"wires":[["153455bc.3f242a"]]},{"id":"725837df.4ee068","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":1150,"y":1080,"wires":[]},{"id":"39587d86.dfb742","type":"file in","z":"f527f707.d5a028","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":950,"y":1040,"wires":[["2c3dbb3d.9da544"]]},{"id":"2c3dbb3d.9da544","type":"change","z":"f527f707.d5a028","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":1080,"wires":[["725837df.4ee068","7ecba489.6ffadc"]]},{"id":"168161ac.219a8e","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":900,"wires":[]},{"id":"7ecba489.6ffadc","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":1160,"wires":[]},{"id":"d1f46d73.ab446","type":"file","z":"f527f707.d5a028","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":950,"y":960,"wires":[["c37fb8d8.bccd58"]]},{"id":"c37fb8d8.bccd58","type":"function","z":"f527f707.d5a028","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1000,"wires":[["39587d86.dfb742"]]},{"id":"589b2694.c95968","type":"function","z":"f527f707.d5a028","name":"dev","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='dev-arislab-platform'\nnes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-dev'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://dev.arislab.ai/'\nAPI_URL='https://dev.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab-dev.auth0.com'\nAUTH0_CLIENT_ID='Jqr8WyfSYqgiw1NgRlQ2f0UJLi8aWOgb'\nAUTH0_CLIENT_SECRET='ciGvXGgVeMBIGXJHRAYTfCkIS5Bk6HnfaUbif1bf-HUZnaPiPTRVNvqgOjK2tmPT'\nAUTH0_SAML_IDP_CERT_FILE='arislab-dev.pem'\n#AUTH0_DOMAIN='arislab.auth0.com'\n#AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\n#AUTH0_CLIENT_SECRET='WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\n#AUTH0_SAML_IDP_CERT_FILE='arislab.pem'\nPACKAGE_URL='https://manage-uat.arislab.ai/getPlatformPackage?packageName=default'\nCALCULATE_STORE_PACKAGE_URL='https://manage-uat.arislab.ai/calculateStorePackage'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://dev.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://dev.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\n#LOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_DESTINATION='rapid7'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\nRAPID7_LOG_TOKEN='1255309c-e9b5-4ef7-9d98-5bf6eac596e6'\n\n#LINE\nSERVER_NAME='DEV'\nENABLE_NOTIFICATION=true\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\nMSG_HOST_LIST='http://msg-aws-sea01.convolab.ai,http://hooks.eu-gb.mybluemix.net,https://msg.convolab.ai'\nMSG_REFRESH_PATH='aris-uat'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='Ky2haeDb1LnsULwQrT4Vxw0A14WrjQc7ZqcVb+80Vy1qHnU00WHgGqQ95IVFuOu0K0h4BsyR+qV9LGA/nLq+PIH00VD+AtDfZteVOEA6/al1C+wwFqlQbB3sq9h6AknCbyf1fO/Gz/N6UltVeiJ+XeX2D1w='\nGB_PAY_SECRET_KEY='TLLWgLJwSql5VHXoMB2px1n4BCEhATMo'\nGB_PAY_GATEWAY='https://api.globalprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n#GB_PAY_ADMIN_ARISLAB_ACCOUNT\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_TOKEN='Ky2haeDb1LnsULwQrT4Vxw0A14WrjQc7ZqcVb+80Vy1qHnU00WHgGqQ95IVFuOu0K0h4BsyR+qV9LGA/nLq+PIH00VD+AtDfZteVOEA6/al1C+wwFqlQbB3sq9h6AknCbyf1fO/Gz/N6UltVeiJ+XeX2D1w='\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_PUBLIC_KEY='QnlexEQDVeUd41p4uO9xjfXbwYtJMp2C'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_SECRET_KEY='TLLWgLJwSql5VHXoMB2px1n4BCEhATMo'\nRECURRING_BACKGROUND_URL='https://manage-uat.arislab.ai/recurringResultDev'\nRECURRING_PERIOD='01'\n\n#WITHDRAW_MODE\nWITHDRAW_MODE=\"REALTIME\"\n#WITHDRAW_MODE=\"ON_TIME\"\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":920,"wires":[["d1f46d73.ab446"]]},{"id":"5a234184.35011","type":"function","z":"f527f707.d5a028","name":"alpha","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='alpha-arislab-platform'\n#nes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\nnes='elastic:g4Xz31uTb8seR3t7jKRgKkj1@bbba64697ea14e0884759935a8d425f7.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-uat'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\n\n#RVP\nWEB_URL='https://alpha.arislab.ai/'\nAPI_URL='https://alpha.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab.auth0.com'\nAUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nAUTH0_CLIENT_SECRET='ADW2KScxB32-WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\nAUTH0_SAML_IDP_CERT_FILE='arislab.pem'\nPACKAGE_URL='https://manage-uat.arislab.ai/getPlatformPackage?packageName=default'\nCALCULATE_STORE_PACKAGE_URL='https://manage-uat.arislab.ai/calculateStorePackage'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://alpha.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://alpha.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\n#LOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_DESTINATION='rapid7'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\nRAPID7_LOG_TOKEN='4ce91516-f85a-4b81-9168-3a6622c10c29'\n\n#LINE\nSERVER_NAME='ALPHA'\nENABLE_NOTIFICATION=true\n#LINE_NOTIFY_TOKEN='2830X9j2EqirUrFnxtHHd0Sli7edHKpvlhTVnAm3zuJ'\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\nMSG_HOST_LIST='http://msg-aws-sea01.convolab.ai,http://hooks.eu-gb.mybluemix.net,https://msg.convolab.ai'\nMSG_REFRESH_PATH='aris-uat'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz'\nGB_PAY_GATEWAY='https://api.gbprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n#GB_PAY_ADMIN_ARISLAB_ACCOUNT\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_TOKEN='AWN1mGuLXY7A3FD3OWL9MAVmKzY0oP8MCaO7C3iEK03QgvKwL+GlPn1Kkaoqqe/Ep8UFWzUKOa0feq+909lxm+MdpPYHrWh5XlC/NIe28/FMOtCkpG7g+WBRFB3sARN1nZUGOjiny0FHlA8AYM8PQ2s/Bydi3RzTlgJ9IphUs98CsN2e'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_PUBLIC_KEY='eG4ue6BHyLT6YxgtYISdIadzSu7G61Ns'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_SECRET_KEY='hRsWqup2Z0WkarOu45QJqUuQsaglCgDL'\nRECURRING_BACKGROUND_URL='https://manage-uat.arislab.ai/recurringResultUat'\nRECURRING_PERIOD='01'\n\n#WITHDRAW_MODE\nWITHDRAW_MODE=\"REALTIME\"\n#WITHDRAW_MODE=\"ON_TIME\"\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":960,"wires":[["d1f46d73.ab446"]]},{"id":"a669b149.fd447","type":"function","z":"f527f707.d5a028","name":"beta","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='arislab-platform'\n#nes='elastic:Ptox6rGdRdhr5gajOIZBXZQn@893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243'\nnes='elastic:FsOUZKwsn82xjCg4t1VJwA73@82910fa177334487bcc84bf9355a7aa3.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-prod'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://beta.arislab.ai/'\nAPI_URL='https://beta.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab.auth0.com'\nAUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nAUTH0_CLIENT_SECRET='ADW2KScxB32-WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\nAUTH0_SAML_IDP_CERT_FILE='arislab.pem'\nPACKAGE_URL='https://manage.arislab.ai/getPlatformPackage?packageName=default'\nCALCULATE_STORE_PACKAGE_URL='https://manage.arislab.ai/calculateStorePackage'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://beta.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://beta.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\n#LOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_DESTINATION='rapid7'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\nRAPID7_LOG_TOKEN='174097a7-7a98-415f-bae8-e3eb01902d76'\n\n#LINE\nSERVER_NAME='PRODUCTION'\nENABLE_NOTIFICATION=true\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\nMSG_HOST_LIST='http://msg-aws-sea01.convolab.ai,http://hooks.eu-gb.mybluemix.net,https://msg.convolab.ai'\nMSG_REFRESH_PATH='aris'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz'\nGB_PAY_GATEWAY='https://api.gbprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n#GB_PAY_ADMIN_ARISLAB_ACCOUNT\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_TOKEN='AWN1mGuLXY7A3FD3OWL9MAVmKzY0oP8MCaO7C3iEK03QgvKwL+GlPn1Kkaoqqe/Ep8UFWzUKOa0feq+909lxm+MdpPYHrWh5XlC/NIe28/FMOtCkpG7g+WBRFB3sARN1nZUGOjiny0FHlA8AYM8PQ2s/Bydi3RzTlgJ9IphUs98CsN2e'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_PUBLIC_KEY='eG4ue6BHyLT6YxgtYISdIadzSu7G61Ns'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_SECRET_KEY='hRsWqup2Z0WkarOu45QJqUuQsaglCgDL'\nRECURRING_BACKGROUND_URL='https://manage.arislab.ai/recurringResult'\nRECURRING_PERIOD='01'\n\n#WITHDRAW_MODE\nWITHDRAW_MODE=\"REALTIME\"\n#WITHDRAW_MODE=\"ON_TIME\"\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1000,"wires":[["d1f46d73.ab446"]]},{"id":"ca734c6c.a912","type":"inject","z":"8913cd6.260d13","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":100,"wires":[["fff971c4.36e9e"]]},{"id":"bdfdb1a4.10f7c","type":"inject","z":"8913cd6.260d13","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":240,"wires":[["90c92f60.088af"]]},{"id":"83f181e9.7a9e1","type":"inject","z":"8913cd6.260d13","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":380,"wires":[["204f1e9f.dea052"]]},{"id":"9647b951.00e4b8","type":"comment","z":"8913cd6.260d13","name":"DEV","info":"","x":390,"y":60,"wires":[]},{"id":"86eb8527.348338","type":"comment","z":"8913cd6.260d13","name":"ALPHA","info":"","x":390,"y":200,"wires":[]},{"id":"dd1ee59b.888448","type":"comment","z":"8913cd6.260d13","name":"PROD","info":"","x":390,"y":340,"wires":[]},{"id":"c0fceb36.524f98","type":"cronplus","z":"8913cd6.260d13","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 22:30","payload":"","type":"str","expression":"0 30 22 * * * *"}],"x":100,"y":240,"wires":[[]]},{"id":"fff971c4.36e9e","type":"change","z":"8913cd6.260d13","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":140,"wires":[["4f644972.b81f58"]]},{"id":"90c92f60.088af","type":"change","z":"8913cd6.260d13","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":280,"wires":[["4f644972.b81f58"]]},{"id":"204f1e9f.dea052","type":"change","z":"8913cd6.260d13","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":420,"wires":[["4f644972.b81f58"]]},{"id":"b53561.66049aa","type":"http request","z":"8913cd6.260d13","name":"GET_ALL_UNVERIFIED_BANK_RECORDS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1050,"y":140,"wires":[["6b8b9697.77ce88","a1f78995.f04838"]]},{"id":"6b8b9697.77ce88","type":"debug","z":"8913cd6.260d13","name":"GET_ALL_UNVERIFIED_BANK_RECORDS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1200,"y":100,"wires":[]},{"id":"a1f78995.f04838","type":"function","z":"8913cd6.260d13","name":"SAVE_PAYLOAD_TO_MSG_OBJ","func":"msg.bankRecordList = msg.payload;\nmsg.bankRecordListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":200,"wires":[["8676fc98.8e961"]]},{"id":"8676fc98.8e961","type":"function","z":"8913cd6.260d13","name":"PASSING_EACH_BANK_RECORD_TO_CHECK","func":"let bankRecordList = msg.bankRecordList;\nlet bankRecordListStatusCode = msg.bankRecordListStatusCode;\n\nif (bankRecordListStatusCode === 200) {\n    bankRecordList.forEach((bankRecord, index) => {\n        setTimeout(() => {\n            msg.bankRecord = bankRecord;\n            node.send(msg);\n        }, 2000 * index)\n    });\n}","outputs":1,"noerr":0,"x":1070,"y":240,"wires":[["b8a6db3e.96d4c8"]]},{"id":"b8a6db3e.96d4c8","type":"function","z":"8913cd6.260d13","name":"CREATE_OBJECT_FOR_CHECK","func":"let bankRecord = msg.bankRecord;\nmsg.currentBankRecord = bankRecord;\n\nlet bankAccount = bankRecord.accountInfo.accountNumber.replace(/\\-/g, \"\");\nlet bankCode = bankRecord.accountInfo.bank.bankCode;\nlet amount = 1;\nlet timeline = 1;\n\nmsg.payload = {\n    bankAccount: bankAccount,\n    bankCode: bankCode,\n    amount: amount,\n    timeline: timeline\n}\n\nnode.error(`Process bank account. Name: ${bankRecord.accountInfo.accountName}, Number: ${bankRecord.accountInfo.accountNumber}`);\nnode.error(`Request of bank number: ${bankRecord.accountInfo.accountNumber} with body: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1440,"y":240,"wires":[["5f1420c4.291c2","2e1e6827.a34828"]]},{"id":"5f1420c4.291c2","type":"function","z":"8913cd6.260d13","name":"SET_HEADERS","func":"msg.headers = {}\nmsg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":280,"wires":[["6262e50c.3e778c"]]},{"id":"6262e50c.3e778c","type":"http request","z":"8913cd6.260d13","name":"GB Pay for Prod","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":1620,"y":280,"wires":[["6cc03e42.0c6a7","bd4dad31.73c04"]]},{"id":"2e1e6827.a34828","type":"debug","z":"8913cd6.260d13","name":"CREATE_OBJECT_FOR_CHECK_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1580,"y":200,"wires":[]},{"id":"6cc03e42.0c6a7","type":"debug","z":"8913cd6.260d13","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1950,"y":220,"wires":[]},{"id":"510a5228.57400c","type":"switch","z":"8913cd6.260d13","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2000,"y":300,"wires":[["97daed54.89649"],["43e274d0.9e967c"]]},{"id":"97daed54.89649","type":"function","z":"8913cd6.260d13","name":"VERIFIED_BANK_ACCOUNT","func":"let apiUrl = msg.apiUrl;\nlet gbpayResponse = msg.payload;\nlet currentBankRecord = msg.currentBankRecord;\nlet updatedBankRecord = currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\n\nnode.error(`Bank account ${currentBankRecord.accountInfo.accountNumber} is Verified. Update data to bank record: ${verifyID}.`);\n\nupdatedBankRecord.isVerified = true;\nupdatedBankRecord.verifiedAt = Date.now();\nupdatedBankRecord.verifyInfo.referenceNo = gbpayResponse.referenceNo;\n\nlet url = `${apiUrl}/bankRecord/verifyID/${verifyID}/update`;\n\nmsg.url = url;\nmsg.payload = updatedBankRecord;\n\nreturn msg;","outputs":1,"noerr":0,"x":2270,"y":280,"wires":[["b56034e7.ac7178","a9a490e8.adde2"]]},{"id":"b56034e7.ac7178","type":"http request","z":"8913cd6.260d13","name":"UPDATE_BANK_RECORD","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2260,"y":320,"wires":[["ef9f099a.5be3a8","376b56db.f1226a"]]},{"id":"ef9f099a.5be3a8","type":"function","z":"8913cd6.260d13","name":"PREPARE_LOAD_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet currentBankRecord = msg.currentBankRecord;\nlet storeID = currentBankRecord.storeID;\n\nnode.error(`Get payment info from storeID: ${storeID}.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.url = url;\ndelete msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":2290,"y":360,"wires":[["27b393ff.678dfc"]]},{"id":"376b56db.f1226a","type":"debug","z":"8913cd6.260d13","name":"RESULT_UPDATE_BANK_RECORD_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2630,"y":320,"wires":[]},{"id":"27b393ff.678dfc","type":"http request","z":"8913cd6.260d13","name":"GET_PAYMENT_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2240,"y":400,"wires":[["9fb6c91f.3c51e8","a7aa4a3f.b6efa8"]]},{"id":"9fb6c91f.3c51e8","type":"debug","z":"8913cd6.260d13","name":"RESULT_GET_PAYMENT_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2620,"y":400,"wires":[]},{"id":"a7aa4a3f.b6efa8","type":"function","z":"8913cd6.260d13","name":"CHECK_PAYMENT_INFO","func":"let storeInfo = msg.payload;\nlet paymentInfo = storeInfo.storeInfo.paymentInfo;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyBankAccountInfo = currentBankRecord.accountInfo;\n\n\nif( \n    (verifyBankAccountInfo.accountNumber === paymentInfo.accountNumber) &&\n    (verifyBankAccountInfo.bank.bankCode === paymentInfo.bank.bankCode)\n) {\n    msg.storeInfo = storeInfo;\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":2260,"y":460,"wires":[["8e43df6d.303cf"],["2c7f7045.af66d"]]},{"id":"8e43df6d.303cf","type":"function","z":"8913cd6.260d13","name":"PREPARE_UPDATE_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet updateData = msg.storeInfo;\nlet storeID = updateData.storeID;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nlet verifyInfo = {\n    isVerified: true,\n    verifyID: verifyID\n};\n\nupdateData.storeInfo.paymentInfo.verifyInfo = verifyInfo;\n\nnode.error(`Bank account ${displayAccount} match with payment info of storeID: ${storeID}. Update verify info.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}/update`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.url = url;\nmsg.payload = updateData;\n\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":440,"wires":[["c302d7d6.13a9c8","1e8de8a8.7aff27"]]},{"id":"c302d7d6.13a9c8","type":"http request","z":"8913cd6.260d13","name":"UPDATE_PAYMENT_INFO","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2640,"y":480,"wires":[["8db7ca75.b01b38"]]},{"id":"1e8de8a8.7aff27","type":"debug","z":"8913cd6.260d13","name":"PREPARE_UPDATE_PAYMENT_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3080,"y":440,"wires":[]},{"id":"a9a490e8.adde2","type":"debug","z":"8913cd6.260d13","name":"VERIFIED_BANK_ACCOUNT_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2610,"y":280,"wires":[]},{"id":"8db7ca75.b01b38","type":"debug","z":"8913cd6.260d13","name":"RESULT_UPDATE_PAYMENT_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3070,"y":480,"wires":[]},{"id":"43e274d0.9e967c","type":"function","z":"8913cd6.260d13","name":"NOT_VERIFY_BANK_ACCOUNT","func":"// node.error(msg)\nlet resultCode = msg.payload.resultCode;\nlet errorStatus = '';\n\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nswitch( resultCode ) {\n    case \"01\":\n        errorStatus = \"Balance is not enough\";\n        break;\n    case \"02\":\n        errorStatus = \"Bank account not found\";\n        break;\n    case \"90\":\n        errorStatus = \"System error\";\n        break;\n    default:\n        errorStatus = \"Unknown error\";\n}\n\nnode.error(`Can't check status of bank account ${displayAccount} , because \"${errorStatus}\". Skipping...`);\n","outputs":1,"noerr":0,"x":1920,"y":360,"wires":[[]]},{"id":"a595a2d7.db61","type":"function","z":"8913cd6.260d13","name":"TEST_POST_TO_GB_PAY","func":"msg.headers = {}\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n\n// msg.payload = {\n//     bankAccount: \"0018906546\",\n//     bankCode: \"004\",\n//     amount: 1,\n//     timeline: 1\n// }\n\n\nmsg.payload = {\n    bankAccount: \"0243687292\",\n    bankCode: \"025\",\n    amount: 1,\n    timeline: 1\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":720,"wires":[["a2ecbf73.a6f51","834c14ca.f41768"]]},{"id":"834c14ca.f41768","type":"http request","z":"8913cd6.260d13","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.globalprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":950,"y":720,"wires":[["acfe3b30.5b9ad8"]]},{"id":"b7b67923.280268","type":"inject","z":"8913cd6.260d13","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":500,"y":720,"wires":[["a595a2d7.db61"]]},{"id":"acfe3b30.5b9ad8","type":"debug","z":"8913cd6.260d13","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1210,"y":720,"wires":[]},{"id":"a2ecbf73.a6f51","type":"debug","z":"8913cd6.260d13","name":"POST_DATA_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":780,"wires":[]},{"id":"2c7f7045.af66d","type":"function","z":"8913cd6.260d13","name":"NOT_MATCH_WITH_PAYMENT_INFO","func":"// node.error(msg)\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nnode.error(`Bank account ${displayAccount} not match with payment info. Skipping...`);\n","outputs":1,"noerr":0,"x":2300,"y":520,"wires":[[]]},{"id":"fd35b8e7.4f2b68","type":"http request","z":"8913cd6.260d13","name":"GB Pay for Test","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.globalprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":1620,"y":320,"wires":[["6cc03e42.0c6a7","bd4dad31.73c04"]]},{"id":"a8975af4.135e38","type":"inject","z":"8913cd6.260d13","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":840,"wires":[["579e9205.21173c"]]},{"id":"579e9205.21173c","type":"function","z":"8913cd6.260d13","name":"debug context.global","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":880,"wires":[["a3249cb8.b7331"]]},{"id":"a3249cb8.b7331","type":"debug","z":"8913cd6.260d13","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":540,"y":920,"wires":[]},{"id":"fb56e41f.ddcab8","type":"inject","z":"8913cd6.260d13","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":840,"wires":[["c2749b34.4b2a88"]]},{"id":"c2749b34.4b2a88","type":"function","z":"8913cd6.260d13","name":"reset context.global","func":"delete context.global['currentData'];\ndelete context.global['resultCheck'];\n\nmsg.payload = context.global;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":880,"wires":[["a169cd30.f5f3a"]]},{"id":"a169cd30.f5f3a","type":"debug","z":"8913cd6.260d13","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":240,"y":920,"wires":[]},{"id":"b80e97b6.6fd188","type":"function","z":"a926ea52.1ac368","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":2290,"y":380,"wires":[["37cfb9a8.f63706","76e4a295.0bea6c"],["d68c5600.f04b28"]]},{"id":"5bd65c86.063ed4","type":"http request","z":"a926ea52.1ac368","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":600,"y":940,"wires":[["d827f2a0.6a36b"]]},{"id":"37cfb9a8.f63706","type":"debug","z":"a926ea52.1ac368","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2770,"y":340,"wires":[]},{"id":"15a1e6f4.5ac9c9","type":"http in","z":"f527f707.d5a028","name":"","url":"/createPlatformEnvFile","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1200,"wires":[["4875e4e.cd98e1c"]]},{"id":"4875e4e.cd98e1c","type":"switch","z":"f527f707.d5a028","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":1200,"wires":[["8515b528.e0f448"],["b2e9620d.77e38"]]},{"id":"8515b528.e0f448","type":"switch","z":"f527f707.d5a028","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":430,"y":1320,"wires":[["e71a79cf.fe1e68"],["fb778d28.26e0d"],["64d3c0f2.17a07"]]},{"id":"3169eb62.c517e4","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":850,"y":1240,"wires":[]},{"id":"b2e9620d.77e38","type":"change","z":"f527f707.d5a028","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":880,"y":1200,"wires":[["3169eb62.c517e4"]]},{"id":"ae41e25b.d413d","type":"file in","z":"f527f707.d5a028","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":950,"y":1400,"wires":[["54e0f491.3c147c"]]},{"id":"54e0f491.3c147c","type":"change","z":"f527f707.d5a028","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":1440,"wires":[["352d1b26.339404","c34ae8ba.1a8a68"]]},{"id":"88940ab7.329b08","type":"file","z":"f527f707.d5a028","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":950,"y":1320,"wires":[["887cef5d.1df52"]]},{"id":"887cef5d.1df52","type":"function","z":"f527f707.d5a028","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1360,"wires":[["ae41e25b.d413d"]]},{"id":"e71a79cf.fe1e68","type":"function","z":"f527f707.d5a028","name":"dev","func":"let env = msg.env\n\nmsg.payload = `\n\nREACT_APP_PLATFORM_FACEBOOK_APP_ID='502170539988549'\nREACT_APP_FACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\nREACT_APP_DEFAULT_GPPAY_TOKEN=\"yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT\"\nREACT_APP_WEB_URL='https://dev.arislab.ai/'\nREACT_APP_API_URL='https://dev.arislab.ai/api/'\nREACT_APP_MEDIA_URL='https://dev.arislab.ai/'\nREACT_APP_API_HOST='localhost'\nREACT_APP_API_PORT=1780\nREACT_APP_PLATFORM_HOST='localhost'\nREACT_APP_PLATFORM_PORT=3000\nREACT_APP_MEDIA_HOST='localhost'\nREACT_APP_MEDIA_PORT=8000\nREACT_APP_MEDIA_WEB_HOST='localhost'\nREACT_APP_MEDIA_WEB_PORT=4080\nREACT_APP_AUTH0_DOMAIN='arislab-dev.auth0.com'\nREACT_APP_AUTH0_CLIENT_ID='Jqr8WyfSYqgiw1NgRlQ2f0UJLi8aWOgb'\nREACT_APP_CONTACT_TEL_NUMBER='0612866328'\nREACT_APP_CONTACT_TEL_NUMBER_DISPLAY='061-286-6328'\nREACT_APP_CONTACT_EMAIL='contactus@arislab.ai'\nREACT_APP_FACEBOOK_URL='https://www.facebook.com/arislablive/'\nREACT_APP_LINE_URL='http://nav.cx/6oXLR5S'\nREACT_APP_INSTAGRAM_URL=''\nREACT_APP_MEDIUM_URL=''\nREACT_APP_CREATED_YEAR=2019\nREACT_APP_ANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nREACT_APP_IOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\nREACT_APP_GTM_ID='GTM-KQL8VMV'\nREACT_APP_TO_GBPAY_EMAIL='admin@arislab.ai'\nREACT_APP_MANAGE_URL='https://manage-uat.arislab.ai'\n\n#GB_PAY\nREACT_APP_GB_PAY_FEE=20\nREACT_APP_GB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/platform_env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1280,"wires":[["88940ab7.329b08"]]},{"id":"fb778d28.26e0d","type":"function","z":"f527f707.d5a028","name":"alpha","func":"let env = msg.env\n\nmsg.payload = `\n\nREACT_APP_PLATFORM_FACEBOOK_APP_ID='502170539988549'\nREACT_APP_FACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\nREACT_APP_DEFAULT_GPPAY_TOKEN=\"yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT\"\nREACT_APP_WEB_URL='https://alpha.arislab.ai/'\nREACT_APP_API_URL='https://alpha.arislab.ai/api/'\nREACT_APP_MEDIA_URL='https://alpha.arislab.ai/'\nREACT_APP_API_HOST='localhost'\nREACT_APP_API_PORT=1780\nREACT_APP_PLATFORM_HOST='localhost'\nREACT_APP_PLATFORM_PORT=3000\nREACT_APP_MEDIA_HOST='localhost'\nREACT_APP_MEDIA_PORT=8000\nREACT_APP_MEDIA_WEB_HOST='localhost'\nREACT_APP_MEDIA_WEB_PORT=4080\nREACT_APP_AUTH0_DOMAIN='arislab.auth0.com'\nREACT_APP_AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nREACT_APP_CONTACT_TEL_NUMBER='0612866328'\nREACT_APP_CONTACT_TEL_NUMBER_DISPLAY='061-286-6328'\nREACT_APP_CONTACT_EMAIL='contactus@arislab.ai'\nREACT_APP_FACEBOOK_URL='https://www.facebook.com/arislablive/'\nREACT_APP_LINE_URL='http://nav.cx/6oXLR5S'\nREACT_APP_INSTAGRAM_URL=''\nREACT_APP_MEDIUM_URL=''\nREACT_APP_CREATED_YEAR=2019\nREACT_APP_ANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nREACT_APP_IOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\nREACT_APP_GTM_ID='GTM-KQL8VMV'\nREACT_APP_TO_GBPAY_EMAIL='it@gbprimepay.com'\nREACT_APP_MANAGE_URL='https://manage-uat.arislab.ai'\n\n#GB_PAY\nREACT_APP_GB_PAY_FEE=20\nREACT_APP_GB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/platform_env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1320,"wires":[["88940ab7.329b08"]]},{"id":"64d3c0f2.17a07","type":"function","z":"f527f707.d5a028","name":"beta","func":"let env = msg.env\n\nmsg.payload = `\n\nREACT_APP_PLATFORM_FACEBOOK_APP_ID='502170539988549'\nREACT_APP_FACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\nREACT_APP_DEFAULT_GPPAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nREACT_APP_WEB_URL='https://beta.arislab.ai/'\nREACT_APP_API_URL='https://beta.arislab.ai/api/'\nREACT_APP_MEDIA_URL='https://beta.arislab.ai/'\nREACT_APP_API_HOST='localhost'\nREACT_APP_API_PORT=1780\nREACT_APP_PLATFORM_HOST='localhost'\nREACT_APP_PLATFORM_PORT=3000\nREACT_APP_MEDIA_HOST='localhost'\nREACT_APP_MEDIA_PORT=8000\nREACT_APP_MEDIA_WEB_HOST='localhost'\nREACT_APP_MEDIA_WEB_PORT=4080\nREACT_APP_AUTH0_DOMAIN='arislab.auth0.com'\nREACT_APP_AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nREACT_APP_CONTACT_TEL_NUMBER='0612866328'\nREACT_APP_CONTACT_TEL_NUMBER_DISPLAY='061-286-6328'\nREACT_APP_CONTACT_EMAIL='contactus@arislab.ai'\nREACT_APP_FACEBOOK_URL='https://www.facebook.com/arislablive/'\nREACT_APP_INSTAGRAM_URL=''\nREACT_APP_MEDIUM_URL=''\nREACT_APP_CREATED_YEAR=2019\nREACT_APP_ANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nREACT_APP_IOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\nREACT_APP_GTM_ID='GTM-P7JB4DT'\nREACT_APP_TO_GBPAY_EMAIL='it@gbprimepay.com'\nREACT_APP_MANAGE_URL='https://manage.arislab.ai'\n\n#GB_PAY\nREACT_APP_GB_PAY_FEE=20\nREACT_APP_GB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/platform_env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1360,"wires":[["88940ab7.329b08"]]},{"id":"c34ae8ba.1a8a68","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":1520,"wires":[]},{"id":"352d1b26.339404","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":1150,"y":1440,"wires":[]},{"id":"4f644972.b81f58","type":"function","z":"8913cd6.260d13","name":"SET_TIME_INTERVAL","func":"var intervalDay = 5;\nvar startTime = Date.now() - (24*60*60*intervalDay*1000);\nvar endTime = Date.now();\n\nmsg.url+= `&start=${startTime}&stop=${endTime}`;\nnode.error(msg.url);\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":140,"wires":[["b53561.66049aa"]]},{"id":"fd981f0f.a548b","type":"function","z":"a926ea52.1ac368","name":"SET_TIME_INTERVAL","func":"node.error('Running reconcile...');\n\nvar intervalDay = 1;\nvar startTime = Date.now() - (24*60*60*1000*intervalDay);\nvar endTime = Date.now();\n\nmsg.url+= `&startDate=${startTime}&endDate=${endTime}`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\n//node.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":754,"y":120,"wires":[["11ac7e86.49f9d1"]]},{"id":"9b347253.f5c66","type":"http in","z":"a926ea52.1ac368","name":"","url":"/test","method":"post","upload":false,"swaggerDoc":"","x":140,"y":780,"wires":[["54a3f300.d1d69c","424f56b3.8ead68"]]},{"id":"4f84d653.018c18","type":"http response","z":"a926ea52.1ac368","name":"","statusCode":"","headers":{},"x":540,"y":780,"wires":[]},{"id":"54a3f300.d1d69c","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.payload = {\n    \"resultCode\": \"00\"\n};\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":760,"wires":[["4f84d653.018c18"]]},{"id":"424f56b3.8ead68","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":390,"y":820,"wires":[]},{"id":"7a2f223.9516edc","type":"http in","z":"1db78bed.51e4f4","name":"","url":"/_calculateGbpayPaymentFee","method":"post","upload":false,"swaggerDoc":"","x":180,"y":140,"wires":[["aa38e4ba.f263f8","69d9be67.00d01"]]},{"id":"f0d4236a.8275f","type":"http response","z":"1db78bed.51e4f4","name":"","statusCode":"","headers":{},"x":450,"y":260,"wires":[]},{"id":"aa38e4ba.f263f8","type":"function","z":"1db78bed.51e4f4","name":"SET_FEE_PERCENTAGE","func":"let payloadData = msg.payload;\nlet nuser = payloadData.nuser;\nlet paymentInfo = payloadData.paymentInfo;\n\nvar feePercentage = {\n    \"DEV\": {\n        // \"CREDIT_CARD\": 3.103,\n        // \"QR_CODE\": 0.642\n        \"CREDIT_CARD\": 2.9,\n        \"QR_CODE\": 1\n    },\n    \"ALPHA\": {\n        // \"CREDIT_CARD\": 3.103,\n        // \"QR_CODE\": 0.642\n        \"CREDIT_CARD\": 2.9,\n        \"QR_CODE\": 1\n    },\n    \"PROD\": {\n        // \"CREDIT_CARD\": 3.103,\n        // \"QR_CODE\": 0.642\n        \"CREDIT_CARD\": 2.9,\n        \"QR_CODE\": 1\n    },\n};\n\nlet env = \"\";\nswitch(nuser) {\n    case \"arislab-dev\":\n        env = \"DEV\";\n        break;\n    case \"arislab-uat\":\n        env = \"ALPHA\";\n        break;\n    default:\n        env = \"PROD\";\n}\n\nmsg.payload = {\n    \"feePercentageData\": feePercentage[env],\n    \"paymentInfo\": paymentInfo\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":140,"wires":[["3287dbe3.9b39c4","34c87a18.211956"]]},{"id":"69d9be67.00d01","type":"debug","z":"1db78bed.51e4f4","name":"REQUEST_POST_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":490,"y":60,"wires":[]},{"id":"3287dbe3.9b39c4","type":"debug","z":"1db78bed.51e4f4","name":"SET_FEE_PERCENTAGE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":860,"y":140,"wires":[]},{"id":"de54eae.6827c18","type":"function","z":"1db78bed.51e4f4","name":"CALCULATE_PAYMENT_FEE","func":"let payloadData = msg.payload;\nlet feePercentage = payloadData.feePercentage;\nlet paymentMethod = payloadData.paymentMethod;\nlet amount = Number(payloadData.amount);\n\nlet fee = Number( parseFloat((amount * feePercentage) / 100).toFixed(2) );\nlet totalAmount = amount - fee;\n\nmsg.payload = {\n    \"paymentMethod\": paymentMethod,\n    \"amount\": amount,\n    \"fee\": fee,\n    \"totalAmount\": totalAmount\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":220,"wires":[["5e8acfc4.f05ab","f0d4236a.8275f"]]},{"id":"34c87a18.211956","type":"function","z":"1db78bed.51e4f4","name":"CHECK_PAYMENT_METHOD","func":"let payloadData = msg.payload;\nlet feePercentageData = payloadData.feePercentageData;\nlet paymentInfo = payloadData.paymentInfo;\n\nlet paymentMethod = \"\";\nif( paymentInfo.hasOwnProperty('cardNo') && paymentInfo.cardNo.length > 0 ) {\n    paymentMethod = \"CREDIT_CARD\";\n} else {\n    paymentMethod = \"QR_CODE\";\n}\n\nmsg.payload = {\n    \"feePercentage\": feePercentageData[paymentMethod],\n    \"paymentMethod\": paymentMethod,\n    \"amount\": paymentInfo.amount\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":180,"wires":[["88659963.08fce8","de54eae.6827c18"]]},{"id":"88659963.08fce8","type":"debug","z":"1db78bed.51e4f4","name":"CHECK_PAYMENT_METHOD_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":870,"y":180,"wires":[]},{"id":"5e8acfc4.f05ab","type":"debug","z":"1db78bed.51e4f4","name":"CALCULATE_PAYMENT_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":870,"y":220,"wires":[]},{"id":"d68c5600.f04b28","type":"function","z":"a926ea52.1ac368","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nnode.error(`Recipient type of this order (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`)","outputs":1,"noerr":0,"x":2745,"y":580,"wires":[[]]},{"id":"d827f2a0.6a36b","type":"debug","z":"a926ea52.1ac368","name":"INSERT_FUNDS_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":960,"y":940,"wires":[]},{"id":"e48229d4.6e91f8","type":"http request","z":"a926ea52.1ac368","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2705,"y":500,"wires":[["4493ce0e.ee512"]]},{"id":"76e4a295.0bea6c","type":"function","z":"a926ea52.1ac368","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2725,"y":380,"wires":[["833da023.3386f","61cd1728.c71188"]]},{"id":"833da023.3386f","type":"http request","z":"a926ea52.1ac368","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2685,"y":420,"wires":[["7b907333.45da3c","ee1a37e8.a0a348"]]},{"id":"61cd1728.c71188","type":"debug","z":"a926ea52.1ac368","name":"PREPARE_CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3165,"y":380,"wires":[]},{"id":"7b907333.45da3c","type":"debug","z":"a926ea52.1ac368","name":"CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3135,"y":420,"wires":[]},{"id":"ee1a37e8.a0a348","type":"function","z":"a926ea52.1ac368","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2735,"y":460,"wires":[["ad90aa70.87b7f8","e48229d4.6e91f8"]]},{"id":"ad90aa70.87b7f8","type":"debug","z":"a926ea52.1ac368","name":"PREPARE_INSERT_FUND_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3185,"y":460,"wires":[]},{"id":"4493ce0e.ee512","type":"debug","z":"a926ea52.1ac368","name":"INSERT_FUNDS_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3145,"y":500,"wires":[]},{"id":"bdf484aa.3133f8","type":"function","z":"a926ea52.1ac368","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    let apiUrl = msg.apiUrl;\n    let url = `${apiUrl}/fundsTransaction/new`;\n    \n    let storeID = currentOrder['storeID'];\n    let amount = currentOrder['summary']['grandTotal'];\n    let orderID = currentOrder['orderID'];\n    let customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\n    msg.url = url;\n    msg.payload = {\n        \"storeID\": storeID,\n    \t\"amount\": amount,\n    \t\"actualAmount\": amount,\n    \t\"fee\": 0,\n    \t\"type\": \"DEPOSIT\",\n    \t\"orderInfo\": {\n        \t\"orderID\": orderID,\n            \"customerName\": customerName\n    \t},\n    \t\"createdAt\": Date.now(),\n    \t\"isDeleted\": false,\n    \t\"deletedAt\": 0\n    }\n\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":250,"y":940,"wires":[[],[]]},{"id":"d6e18e5f.368f3","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":2390,"y":120,"wires":[]},{"id":"30db0d1.2e117f2","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1690,"y":180,"wires":[]},{"id":"20430bec.3e7c14","type":"function","z":"c0036ad7.2ae908","name":"INIT_PAYLOAD","func":"msg.headers = {\n    \"Content-type\" : \"multipart/form-data\"\n}\n\nlet reqPayload = msg.payload;\nmsg.payload = {\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo'],\n    \"amount\": reqPayload['amount']\n}\n\n// msg.url = \"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode\";\n// msg.method = \"POST\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1780,"y":60,"wires":[["893cf5fd.4d3988","63516779.447e68"]]},{"id":"5714fee9.5d93f","type":"www-request-multipart","z":"c0036ad7.2ae908","name":"","method":"POST","ret":"obj","url":"","follow-redirects":false,"tls":"","x":2170,"y":60,"wires":[["d6e18e5f.368f3","665212e.34403ec"]]},{"id":"893cf5fd.4d3988","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1790,"y":120,"wires":[]},{"id":"4dd4dd28.ab9d24","type":"httpInMultipart","z":"c0036ad7.2ae908","name":"","url":"/tHandleVerifyQRCode","method":"post","fields":"[{\"name\": \"referenceNo\"}, {\"name\": \"gbpReferenceNo\"}, {\"name\": \"amount\"}]","swaggerDoc":"","x":1540,"y":60,"wires":[["20430bec.3e7c14","30db0d1.2e117f2"]]},{"id":"e539bc43.beb43","type":"change","z":"c0036ad7.2ae908","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1980,"y":100,"wires":[["5714fee9.5d93f"]]},{"id":"75c187ba.e3a398","type":"change","z":"c0036ad7.2ae908","name":"BETA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1970,"y":140,"wires":[["5714fee9.5d93f"]]},{"id":"665212e.34403ec","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2390,"y":60,"wires":[]},{"id":"47a78a68.be82c4","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":2250,"y":180,"wires":[]},{"id":"43011006.44365","type":"function","z":"c0036ad7.2ae908","name":"ALWAYS_APPROVE","func":"let reqPayload = msg.payload;\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n}\n\nmsg.payload = {\n    \"resultCode\": \"00\",\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo']\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2020,"y":180,"wires":[["47a78a68.be82c4","9c03ff31.aeca3"]]},{"id":"9c03ff31.aeca3","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2210,"y":240,"wires":[]},{"id":"63516779.447e68","type":"change","z":"c0036ad7.2ae908","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1970,"y":60,"wires":[["5714fee9.5d93f"]]},{"id":"71ff5f1.93041a","type":"template","z":"cb20a881.1311f8","name":"","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\">\n    <title></title>\n    <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\">\n</head>\n\n<body>\n    <div class=\"container\">\n        <h3>Reconcile</h3>\n        <div class=\"row\">\n            <div class=\"col-md-3\">\n                <div class=\"form-group\">\n                    <label for=\"webform_gbpayToken\">GBPay Token</label>\n                    <input type=\"text\" class=\"form-control\" id=\"webform_gbpayToken\" placeholder=\"GBPay Token\"\n                        autocomplete=\"off\" />\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"webform_gbpaySecretKey\">GBPay Secret Key</label>\n                    <input type=\"text\" class=\"form-control\" id=\"webform_gbpaySecretKey\" placeholder=\"GBPay Secret Key\" />\n                </div>\n                <button type=\"submit\" class=\"btn btn-primary btn-block\" id=\"btnSearchStore\">Search</button>\n            </div>\n    \n            <div class=\"col-md-9\">\n                <div class=\"form-group\" id=\"storeListSection\">\n                    <label for=\"storeList\">Select store</label>\n                    <select class=\"form-control\" id=\"storeListDropdown\" onchange=\"handleDropdownChange(this)\">\n                        <option hidden>-- Choose Store --</option>\n                    </select>\n                </div>\n                \n                <div class=\"form-group\" id=\"processingSection\">\n                    <button type=\"submit\" class=\"btn btn-primary btn-block\" id=\"btnSubmitWebForm\">Submit</button>\n    \n                    <div class=\"alert alert-warning mt-3\" id=\"processingMsg\" role=\"alert\">\n                        กรุณารอสักครู่ ระบบกำลังทำการประมวลผล\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js\"></script>\n    <script>\n        let reconcilePayload = {};\n        const btnSubmit = document.querySelector('#btnSubmitWebForm');\n        const btnSearch = document.querySelector('#btnSearchStore');\n        const processingMsg = document.querySelector('#processingMsg');\n        const storeListSection = document.querySelector('#storeListSection');\n        const storeListDropdown = document.getElementById('storeListDropdown');\n\n        const handleDropdownChange = (e) => {\n            console.log(`[handleDropdownChange] e`, e.value)\n            let dropdownSelectedValue = e.value;\n            reconcilePayload['storeID'] = dropdownSelectedValue;\n            btnSubmit.style.display = \"block\";\n        }\n\n        storeListSection.style.display = \"none\";\n        storeListDropdown.style.display = \"none\";\n        processingMsg.style.display = \"none\";\n        btnSubmit.style.display = \"none\";\n\n        btnSearch.addEventListener('click', function (e) {\n            e.preventDefault();\n\n            btnSearch.textContent = \"Searching...\"\n            btnSearch.setAttribute('disabled', true);\n\n            const token = document.querySelector('#webform_gbpayToken').value;\n\n            axios.post('/searchStoreAPI', {\n                token: token\n            })\n                .then(function (response) {\n                    console.log(response);\n                    reconcilePayload['token'] = token;\n                    response['data'].forEach((item, index) => {\n                        let option = document.createElement(\"option\");\n                        option.text = `${item['storeID']} ${item['storeInfo']['businessProfile']['accountDetails']['name']}`;\n                        option.value = item['storeID'];\n                        storeListDropdown.appendChild(option);\n\n                        if (index === response['data'].length - 1) {\n                            storeListSection.style.display = \"block\";\n                            storeListDropdown.style.display = \"block\";\n                            btnSearch.textContent = \"Search\"\n                            btnSearch.removeAttribute('disabled');\n                        }\n                    });\n                })\n                .catch(function (error) {\n                    console.log(error);\n                });\n        });\n\n        btnSubmit.addEventListener('click', function (e) {\n            e.preventDefault();\n\n            btnSubmit.textContent = \"Processing...\"\n            btnSubmit.setAttribute('disabled', true);\n\n            processingMsg.style.display = \"block\";\n\n            const token = document.querySelector('#webform_gbpayToken').value;\n            const secret_key = document.querySelector('#webform_gbpaySecretKey').value;\n\n            reconcilePayload['secret_key'] = secret_key;\n\n            axios.post('/reconcileAPI', {\n                token: reconcilePayload['token'],\n                secret_key: reconcilePayload['secret_key'],\n                storeID: reconcilePayload['storeID']\n            })\n                .then(function (response) {\n                    console.log(response);\n                })\n                .catch(function (error) {\n                    console.log(error);\n                });\n        });\n    </script>\n</body>\n\n</html> ","output":"str","x":400,"y":120,"wires":[["e3c3095a.13f3e8"]]},{"id":"48270059.8b1ae","type":"http in","z":"cb20a881.1311f8","name":"","url":"/reconcile","method":"get","upload":false,"swaggerDoc":"","x":200,"y":120,"wires":[["71ff5f1.93041a"]]},{"id":"e3c3095a.13f3e8","type":"http response","z":"cb20a881.1311f8","name":"","statusCode":"","headers":{},"x":570,"y":120,"wires":[]},{"id":"e01fb498.17b0f8","type":"comment","z":"cb20a881.1311f8","name":"Reconcile UI","info":"","x":190,"y":80,"wires":[]},{"id":"dc563fbf.38b1","type":"comment","z":"cb20a881.1311f8","name":"Reconcile API","info":"","x":190,"y":180,"wires":[]},{"id":"c03e37f9.2f0748","type":"http in","z":"cb20a881.1311f8","name":"","url":"/reconcileAPI","method":"post","upload":false,"swaggerDoc":"","x":210,"y":420,"wires":[["698da27.7e8be5c","c14a0f02.93976"]]},{"id":"8e8f7126.405f5","type":"http response","z":"cb20a881.1311f8","name":"","statusCode":"","headers":{},"x":910,"y":440,"wires":[]},{"id":"9b5533ac.2d4ee","type":"change","z":"cb20a881.1311f8","name":"","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"{\"message\":\"Missing required fields\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":440,"wires":[["8e8f7126.405f5"]]},{"id":"698da27.7e8be5c","type":"function","z":"cb20a881.1311f8","name":"CHECK_REQUIRED_FIELDS","func":"if (\n    msg.payload.hasOwnProperty('token') &&\n    msg.payload.hasOwnProperty('secret_key') &&\n    msg.payload.hasOwnProperty('storeID')\n) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":480,"y":420,"wires":[["bb8ccd77.2130a"],["9b5533ac.2d4ee"]]},{"id":"fafda6ce.650598","type":"link out","z":"cb20a881.1311f8","name":"RECONCILE_API_DEV_OUT","links":["b7a16e0b.56bd7","48d54ea8.7d49a"],"x":875,"y":400,"wires":[]},{"id":"9a1c1ccd.58203","type":"http response","z":"cb20a881.1311f8","name":"","statusCode":"","headers":{},"x":950,"y":120,"wires":[]},{"id":"da7c4375.6116","type":"function","z":"cb20a881.1311f8","name":"","func":"let payload = msg.payload;\n\nmsg.secret_key = payload['secret_key'];\nmsg.token = payload['token'];\nmsg.statusCode = 200;\nmsg.payload = {\n    secret_key: msg.secret_key,\n    token: msg.token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":120,"wires":[["9a1c1ccd.58203"]]},{"id":"c14a0f02.93976","type":"debug","z":"cb20a881.1311f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":400,"y":380,"wires":[]},{"id":"48d54ea8.7d49a","type":"link in","z":"cb20a881.1311f8","name":"RECONCILE_API_DEV_IN","links":["82338e5f.c3527","d6774712.37b528","a20282af.26816","fafda6ce.650598"],"x":55,"y":620,"wires":[["5a452929.567a88"]]},{"id":"38208d64.46efa2","type":"link in","z":"cb20a881.1311f8","name":"RECONCILE_API_UAT_IN","links":["5fabbb08.41bb24","b37ee536.d09808"],"x":55,"y":760,"wires":[[]]},{"id":"c73a416f.d83b7","type":"link in","z":"cb20a881.1311f8","name":"RECONCILE_API_PROD_IN","links":["f3d17c5c.9e7e3","d725bb8c.dc8348"],"x":55,"y":900,"wires":[[]]},{"id":"5d79a545.68b43c","type":"inject","z":"cb20a881.1311f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":580,"wires":[["5a452929.567a88"]]},{"id":"ef20b6ea.d71f28","type":"inject","z":"cb20a881.1311f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":720,"wires":[["92a6704b.e42ab"]]},{"id":"fdd12ba.835a0d8","type":"inject","z":"cb20a881.1311f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":860,"wires":[["2f66c9cf.dc8326"]]},{"id":"f9bc5923.56c0a8","type":"comment","z":"cb20a881.1311f8","name":"DEV","info":"","x":170,"y":540,"wires":[]},{"id":"23457bab.2550f4","type":"comment","z":"cb20a881.1311f8","name":"ALPHA","info":"","x":170,"y":680,"wires":[]},{"id":"ed586a6f.54f2b8","type":"comment","z":"cb20a881.1311f8","name":"PROD","info":"","x":170,"y":820,"wires":[]},{"id":"5a452929.567a88","type":"change","z":"cb20a881.1311f8","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":170,"y":620,"wires":[["a31774ba.999f78"]]},{"id":"92a6704b.e42ab","type":"change","z":"cb20a881.1311f8","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":180,"y":760,"wires":[["a31774ba.999f78"]]},{"id":"2f66c9cf.dc8326","type":"change","z":"cb20a881.1311f8","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":170,"y":900,"wires":[["a31774ba.999f78"]]},{"id":"5a8db9cf.402f88","type":"http request","z":"cb20a881.1311f8","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":520,"y":740,"wires":[["e6fbaf26.3acfd","cdc43ce3.9723d"]]},{"id":"e6fbaf26.3acfd","type":"debug","z":"cb20a881.1311f8","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":740,"wires":[]},{"id":"cdc43ce3.9723d","type":"function","z":"cb20a881.1311f8","name":"SAVE_TO_MSG_OBJ","func":"msg.orderList = msg.payload;\nmsg.orderListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":780,"wires":[["84be85fb.9f8628"]]},{"id":"9e88a46.a42fc58","type":"http request","z":"cb20a881.1311f8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_status_txn","tls":"","proxy":"","authType":"","x":1050,"y":880,"wires":[["70c4116a.60c7a","17cc6deb.2a1822"]]},{"id":"70c4116a.60c7a","type":"debug","z":"cb20a881.1311f8","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1340,"y":880,"wires":[]},{"id":"84be85fb.9f8628","type":"function","z":"cb20a881.1311f8","name":"PASSING_EACH_ORDER_TO_CHECK","func":"let orderList = msg.orderList;\nlet orderListStatusCode = msg.orderListStatusCode;\n\nif (orderListStatusCode === 200) {\n    orderList.forEach((order, index) => {\n        setTimeout(() => {\n            msg.payload = order;\n            node.send(msg);\n        }, 2000 * index);\n    });\n}","outputs":1,"noerr":0,"x":490,"y":820,"wires":[["fa223a1c.b786e8"]]},{"id":"fa223a1c.b786e8","type":"function","z":"cb20a881.1311f8","name":"CHECK_WITH_REFNO","func":"msg.currentOrder = msg.payload;\n\nlet order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":820,"wires":[["18ced4cd.8bd9db","214d411f.b9560e"]]},{"id":"18ced4cd.8bd9db","type":"debug","z":"cb20a881.1311f8","name":"CHECK_WITH_REFNO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":780,"wires":[]},{"id":"17cc6deb.2a1822","type":"switch","z":"cb20a881.1311f8","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":980,"wires":[["e641d2f9.e0ec"],["800704ad.82f848"]]},{"id":"c14a7d9c.d03bf","type":"function","z":"cb20a881.1311f8","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":860,"wires":[["bbef4857.9be768","214d411f.b9560e"]]},{"id":"800704ad.82f848","type":"switch","z":"cb20a881.1311f8","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":1080,"wires":[["15cf0fda.5ab08"],["7cfca87b.e6e6e8"]]},{"id":"7cfca87b.e6e6e8","type":"function","z":"cb20a881.1311f8","name":"Can't find REF_NO and LINK_NO 😢","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${orderID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)","outputs":1,"noerr":0,"x":730,"y":1100,"wires":[[]]},{"id":"858be4f3.5ae098","type":"link in","z":"cb20a881.1311f8","name":"LINK_NO_IN","links":["15cf0fda.5ab08"],"x":635,"y":860,"wires":[["c14a7d9c.d03bf"]]},{"id":"15cf0fda.5ab08","type":"link out","z":"cb20a881.1311f8","name":"LINK_NO_OUT","links":["858be4f3.5ae098"],"x":595,"y":1060,"wires":[]},{"id":"bbef4857.9be768","type":"debug","z":"cb20a881.1311f8","name":"CHECK_WITH_LINKNO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":900,"wires":[]},{"id":"214d411f.b9560e","type":"function","z":"cb20a881.1311f8","name":"SET_HEADERS","func":"// var SECRET_KEY = \"PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\";\nvar SECRET_KEY = msg.userWebformInfo['secret_key']\nmsg.headers = {}\n// msg.headers['Authorization'] = \"Basic UHdwUkFWaW1BSURGN0VFZTRpTFdoaDExTThFT2FBY3o6\";\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":840,"wires":[["9e88a46.a42fc58"]]},{"id":"e641d2f9.e0ec","type":"function","z":"cb20a881.1311f8","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"let gbResponseObj = msg.payload;\n\nlet apiUrl = msg.apiUrl;\n\nlet currentOrder = msg.currentOrder;\nlet storeID = currentOrder['storeID'];\nlet orderDocID = currentOrder['orderDocID'];\nlet paymentMethod = gbResponseObj['txn']['status'];\nlet gbpReferenceNo = gbResponseObj['txn']['gbpReferenceNo'];\n// let paymentCompletedOn = paymentResponseObj.paymentCompletedOn;\n\nvar paymentStatus = \"PENDING\";\n\nif (paymentMethod === 'S') {\n    // paymentMethod = \"QR_PAYMENT\";\n    paymentMethod = \"PAID\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'A') {\n    paymentMethod = \"CREDIT_CARD\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'D') {\n    paymentMethod = \"DECLINE\";\n    paymentStatus = \"FAIL\";\n} else if (paymentMethod === 'G') {\n    paymentMethod = \"QR_PAYMENT\";\n}\n\ncurrentOrder['resultPaymentStatus'] = paymentStatus;\nmsg.currentOrder = currentOrder;\n\n// let customerInfo = paymentResponseObj.customerInfo;\n\nlet url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.url = url;\nmsg.payload = {\n    \"paymentInfo\": {\n        \"method\": paymentMethod,\n        \"status\": paymentStatus,\n        \"details\": gbpReferenceNo,\n        // \"paymentCompletedOn\": paymentCompletedOn,\n        \"isFromBatchCheck\": true,\n        \"batchCheckTimestamp\": Date.now()\n    }\n}\n\n// msg.payload = {\n//     \"paymentInfo\": {\n//         \"method\": paymentMethod,\n//         \"status\": \"SUCCESS\",\n//         \"details\": gbpReferenceNo,\n//         \"paymentCompletedOn\": paymentCompletedOn,\n//         \"isFromBatchCheck\": true,\n//         \"batchCheckTimestamp\": Date.now(),\n//         \"gbPaymentDetails\": {\n//             \"customerName\": customerInfo.customerName,\n//             \"customerEmail\": customerInfo.customerEmail,\n//             \"customerAddress\": customerInfo.customerAddress,\n//             \"customerTelephone\": customerInfo.customerTelephone\n//         }\n//     }\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":960,"wires":[["1ae7670b.be5b39","79ca5b7e.138be4"]]},{"id":"79ca5b7e.138be4","type":"http request","z":"cb20a881.1311f8","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":670,"y":1000,"wires":[["356fd2ad.504ebe","d75a3df1.cde4f"]]},{"id":"1ae7670b.be5b39","type":"debug","z":"cb20a881.1311f8","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1140,"y":960,"wires":[]},{"id":"356fd2ad.504ebe","type":"debug","z":"cb20a881.1311f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1010,"y":1000,"wires":[]},{"id":"d75a3df1.cde4f","type":"function","z":"cb20a881.1311f8","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":1030,"y":1040,"wires":[["299b4598.341c7a","4acff85b.813728"],["469f11e2.55b06"]]},{"id":"299b4598.341c7a","type":"debug","z":"cb20a881.1311f8","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1510,"y":1000,"wires":[]},{"id":"9fca28c2.769568","type":"function","z":"cb20a881.1311f8","name":"SET_TIME_INTERVAL","func":"var intervalDay = 1;\nvar startTime = Math.floor(Date.now() / 1000) - (24 * 60 * 60 * intervalDay);\nvar endTime = Math.floor(Date.now() / 1000);\n\nmsg.url += `&startDate=${startTime}&endDate=${endTime}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":700,"wires":[["5a8db9cf.402f88"]]},{"id":"469f11e2.55b06","type":"function","z":"cb20a881.1311f8","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nnode.error(`Recipient type of this order (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`)","outputs":1,"noerr":0,"x":1485,"y":1240,"wires":[[]]},{"id":"2136d9f1.a5e1f6","type":"http request","z":"cb20a881.1311f8","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1445,"y":1160,"wires":[["45859d9d.fa5274"]]},{"id":"4acff85b.813728","type":"function","z":"cb20a881.1311f8","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let currentOrder = msg.currentOrder;\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": currentOrder['orderID']\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":1450,"y":1040,"wires":[["b5a775bd.071c78","40c36180.1662a"]]},{"id":"b5a775bd.071c78","type":"http request","z":"cb20a881.1311f8","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1425,"y":1080,"wires":[["93ba28ce.28d328","ce7d3a3a.39b6e8"]]},{"id":"40c36180.1662a","type":"debug","z":"cb20a881.1311f8","name":"PREPARE_CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1890,"y":1040,"wires":[]},{"id":"93ba28ce.28d328","type":"debug","z":"cb20a881.1311f8","name":"CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1875,"y":1080,"wires":[]},{"id":"ce7d3a3a.39b6e8","type":"function","z":"cb20a881.1311f8","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1475,"y":1120,"wires":[["45670e31.fafd1"]]},{"id":"45670e31.fafd1","type":"debug","z":"cb20a881.1311f8","name":"PREPARE_INSERT_FUND_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1925,"y":1120,"wires":[]},{"id":"45859d9d.fa5274","type":"debug","z":"cb20a881.1311f8","name":"INSERT_FUNDS_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1885,"y":1160,"wires":[]},{"id":"bb8ccd77.2130a","type":"function","z":"cb20a881.1311f8","name":"INIT_MSG_OBJ","func":"let payload = msg.payload;\n\nmsg.secret_key = payload['secret_key'];\nmsg.token = payload['token'];\nmsg.storeID = payload['storeID'];\nmsg.userWebformInfo = {\n    secret_key: msg.secret_key,\n    storeID: msg.storeID,\n    token: msg.token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":400,"wires":[["d725bb8c.dc8348"]]},{"id":"a31774ba.999f78","type":"function","z":"cb20a881.1311f8","name":"FIND_STORE_DETAIL_BY_GIVEN_BODY","func":"const token = msg.userWebformInfo['token'];\nconst storeID = msg.userWebformInfo['storeID'];\nconst apiUrl = msg.apiUrl;\n\nmsg.payload = [\n    {\n    \t\"fieldName\": \"storeInfo.paymentInfo.gbPayInfo.token\",\n    \t\"fieldValue\": token\n    },\n    {\n    \t\"fieldName\": \"storeID\",\n    \t\"fieldValue\": storeID\n    }\n];\n\nmsg.url = `${apiUrl}/utility/findStoreByCustomFields`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":580,"wires":[["58b7f480.ffca5c"]]},{"id":"58b7f480.ffca5c","type":"http request","z":"cb20a881.1311f8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":410,"y":620,"wires":[["e25e6634.1ad928","afb0662b.03a338"]]},{"id":"e25e6634.1ad928","type":"function","z":"cb20a881.1311f8","name":"SET_REQUEST_URL","func":"const apiUrl = msg.apiUrl;\nconst responsePayload = msg.payload;\nconst storeID = responsePayload[0]['storeID'];\n\nmsg.url = `${apiUrl}/order/findOrdersByStatus?status=PENDING&storeID=${storeID}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":660,"wires":[["9fca28c2.769568"]]},{"id":"afb0662b.03a338","type":"debug","z":"cb20a881.1311f8","name":"RESULT_FIND_STORE_DETAIL_BY_GIVEN_BODY","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":620,"wires":[]},{"id":"f6e82976.153738","type":"http in","z":"cb20a881.1311f8","name":"","url":"/searchStoreAPI","method":"post","upload":false,"swaggerDoc":"","x":220,"y":240,"wires":[["bd5b33c8.4944d","9ed0801c.649cb"]]},{"id":"bd5b33c8.4944d","type":"function","z":"cb20a881.1311f8","name":"CHECK_REQUIRED_FIELDS","func":"if (\n    msg.payload.hasOwnProperty('token')\n) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":480,"y":240,"wires":[["7f58c118.f0c7f"],["106fd4b8.a9681b"]]},{"id":"106fd4b8.a9681b","type":"change","z":"cb20a881.1311f8","name":"","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"{\"message\":\"Missing required fields\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":340,"wires":[["d41b48f2.8bd6d8"]]},{"id":"d41b48f2.8bd6d8","type":"http response","z":"cb20a881.1311f8","name":"","statusCode":"","headers":{},"x":910,"y":340,"wires":[]},{"id":"4b885720.adca48","type":"change","z":"cb20a881.1311f8","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":910,"y":180,"wires":[["17448fd9.fdc"]]},{"id":"bedc729.f14069","type":"change","z":"cb20a881.1311f8","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":220,"wires":[[]]},{"id":"f023b760.9beb08","type":"change","z":"cb20a881.1311f8","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":910,"y":260,"wires":[[]]},{"id":"17448fd9.fdc","type":"function","z":"cb20a881.1311f8","name":"FIND_STOREID_BY_GIVEN_TOKEN","func":"const token = msg.searchStore['token'];\nconst apiUrl = msg.apiUrl;\n\nmsg.payload = [{\n\t\"fieldName\": \"storeInfo.paymentInfo.gbPayInfo.token\",\n\t\"fieldValue\": token\n}];\n\nmsg.url = `${apiUrl}/utility/findStoreByCustomFields`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":1170,"y":180,"wires":[["f6559c22.6f58b"]]},{"id":"f6559c22.6f58b","type":"http request","z":"cb20a881.1311f8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1090,"y":220,"wires":[["fd615638.e30988","6db028cd.9c1eb8"]]},{"id":"fd615638.e30988","type":"debug","z":"cb20a881.1311f8","name":"RESULT_FIND_STOREID_BY_GIVEN_TOKEN","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1380,"y":220,"wires":[]},{"id":"6db028cd.9c1eb8","type":"http response","z":"cb20a881.1311f8","name":"","statusCode":"","headers":{},"x":1070,"y":260,"wires":[]},{"id":"9ed0801c.649cb","type":"debug","z":"cb20a881.1311f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":410,"y":200,"wires":[]},{"id":"7f58c118.f0c7f","type":"function","z":"cb20a881.1311f8","name":"INIT_MSG_OBJ","func":"let payload = msg.payload;\n\nmsg.token = payload['token'];\nmsg.searchStore = {\n    token: msg.token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":220,"wires":[["f023b760.9beb08"]]},{"id":"8a3e78d7.e25398","type":"switch","z":"cb20a881.1311f8","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1170,"y":420,"wires":[["a20282af.26816"],["b37ee536.d09808"],["d725bb8c.dc8348"]]},{"id":"a20282af.26816","type":"link out","z":"cb20a881.1311f8","name":"RECONCILE_API_DEV_OUT","links":["b7a16e0b.56bd7","48d54ea8.7d49a"],"x":1355,"y":380,"wires":[]},{"id":"b37ee536.d09808","type":"link out","z":"cb20a881.1311f8","name":"RECONCILE_API_UAT_OUT","links":["d24a81f7.4fea2","38208d64.46efa2"],"x":1355,"y":420,"wires":[]},{"id":"d725bb8c.dc8348","type":"link out","z":"cb20a881.1311f8","name":"RECONCILE_API_PROD_OUT","links":["b313eae.9848b18","c73a416f.d83b7"],"x":1355,"y":460,"wires":[]},{"id":"3b446cbf.02bbc4","type":"inject","z":"2928f438.efbd8c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":120,"wires":[["eddc9e51.f1847"]]},{"id":"7d723b22.a9c214","type":"inject","z":"2928f438.efbd8c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":260,"wires":[["f1595a11.1cfe28"]]},{"id":"aebbcfd1.6cbac","type":"inject","z":"2928f438.efbd8c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":400,"wires":[["c9aeb5aa.8d5068"]]},{"id":"6ccb6f91.c72e4","type":"comment","z":"2928f438.efbd8c","name":"DEV","info":"","x":130,"y":80,"wires":[]},{"id":"d131df17.8ba2","type":"comment","z":"2928f438.efbd8c","name":"ALPHA","info":"","x":130,"y":220,"wires":[]},{"id":"14029354.dcf79d","type":"comment","z":"2928f438.efbd8c","name":"PROD","info":"","x":130,"y":360,"wires":[]},{"id":"eddc9e51.f1847","type":"change","z":"2928f438.efbd8c","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":160,"wires":[["c8d17924.1d2228"]]},{"id":"f1595a11.1cfe28","type":"change","z":"2928f438.efbd8c","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":140,"y":300,"wires":[[]]},{"id":"c9aeb5aa.8d5068","type":"change","z":"2928f438.efbd8c","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":440,"wires":[[]]},{"id":"ebc50da6.7a379","type":"inject","z":"2928f438.efbd8c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":760,"y":40,"wires":[["b9dc7be6.bd8468"]]},{"id":"fb1349b2.f6ae18","type":"http request","z":"91f0dfd1.af154","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":530,"y":160,"wires":[["9923657c.170b18","412f1965.fa0288"]]},{"id":"f73febcf.dc0f28","type":"function","z":"91f0dfd1.af154","name":"INIT_REQUEST","func":"const FB_ACCESS_TOKEN = msg.FB_ACCESS_TOKEN;\nconst INPUT_TOKEN = msg.TOKEN_TO_VALIDATE;\n\nmsg.url = `https://graph.facebook.com/debug_token?input_token=${INPUT_TOKEN}&access_token=${FB_ACCESS_TOKEN}`\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":200,"wires":[["fb1349b2.f6ae18","d3c48bbf.fc9b48"]]},{"id":"d3c48bbf.fc9b48","type":"debug","z":"91f0dfd1.af154","name":"VALIDATE_PAGE_TOKEN_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":380,"wires":[]},{"id":"9923657c.170b18","type":"debug","z":"91f0dfd1.af154","name":"VALIDATE_PAGE_TOKEN_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"b9dc7be6.bd8468","type":"subflow:91f0dfd1.af154","z":"2928f438.efbd8c","name":"","env":[],"x":970,"y":40,"wires":[[]]},{"id":"e4c59588.9070e8","type":"function","z":"6e6d961d.724ba8","name":"INIT_REQUEST_FOR_GETTING_SALES_CHANNEL","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/sales_channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"regexp\":{\n      \"channels.facebook\": \".+\"\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["8be0efae.667df","3ea0c112.42959e"]]},{"id":"8be0efae.667df","type":"debug","z":"6e6d961d.724ba8","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":140,"wires":[]},{"id":"fd140124.65856","type":"debug","z":"6e6d961d.724ba8","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":180,"wires":[]},{"id":"f6c44500.6a5d48","type":"debug","z":"6e6d961d.724ba8","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":220,"wires":[]},{"id":"afe7e948.bf6988","type":"change","z":"6e6d961d.724ba8","name":"","rules":[{"t":"set","p":"arisSalesChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["f6c44500.6a5d48"]]},{"id":"c8d17924.1d2228","type":"subflow:6e6d961d.724ba8","z":"2928f438.efbd8c","name":"","env":[],"x":470,"y":120,"wires":[["7ac87b7c.0720f4"]]},{"id":"fd8b6d35.7e127","type":"function","z":"bca86633.b71988","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":140,"wires":[["a82df53b.47c978","608e3925.ad6888"]]},{"id":"a82df53b.47c978","type":"debug","z":"bca86633.b71988","name":"GET_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":140,"wires":[]},{"id":"16684aa.7f062b5","type":"debug","z":"bca86633.b71988","name":"GET_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":180,"wires":[]},{"id":"5cbc75ec.91e53c","type":"debug","z":"bca86633.b71988","name":"GET_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":220,"wires":[]},{"id":"9bb4998d.40d7c8","type":"change","z":"bca86633.b71988","name":"","rules":[{"t":"set","p":"njoinChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["5cbc75ec.91e53c"]]},{"id":"7ac87b7c.0720f4","type":"subflow:bca86633.b71988","z":"2928f438.efbd8c","name":"","env":[],"x":450,"y":160,"wires":[["2273eb9.11abc14"]]},{"id":"cca87a5b.dd2798","type":"debug","z":"2928f438.efbd8c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":200,"wires":[]},{"id":"3ea0c112.42959e","type":"http request","z":"6e6d961d.724ba8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":230,"y":180,"wires":[["fd140124.65856","afe7e948.bf6988"]]},{"id":"608e3925.ad6888","type":"http request","z":"bca86633.b71988","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["16684aa.7f062b5","9bb4998d.40d7c8"]]},{"id":"2273eb9.11abc14","type":"function","z":"2928f438.efbd8c","name":"ITERATE_OVER_ARIS_SALES_CHANNEL","func":"const arisSalesChannelList = msg.arisSalesChannelList.hits.hits;\n\narisSalesChannelList.forEach((channel, index) => {\n    setTimeout(() => {\n        msg.payload = channel;\n        msg.isLastIndex_arisSalesChannelList = false;\n        \n        if (index === arisSalesChannelList.length - 1) {\n            msg.isLastIndex_arisSalesChannelList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":480,"y":200,"wires":[["cca87a5b.dd2798","bfa231ba.566cb"]]},{"id":"bfa231ba.566cb","type":"subflow:1a02742f.665d2c","z":"2928f438.efbd8c","name":"","env":[],"x":450,"y":240,"wires":[["bedff1a.c92951","e419b6f2.0bd8e8"]]},{"id":"c154c2f9.e1d16","type":"function","z":"1a02742f.665d2c","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL_INFO","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nlet FB_ID = msg.payload._source.channels.facebook;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nnode.error('Getting facebook channel id: ' + FB_ID + ' from njoin');\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match\": {\n            \"id\": `facebook_${FB_ID}`\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":140,"wires":[["63a73bac.6019b4","2a5e047e.ac90fc"]]},{"id":"77124214.5209ec","type":"change","z":"1a02742f.665d2c","name":"","rules":[{"t":"set","p":"njoinChannelInfo","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":220,"wires":[["e485735a.cda99"]]},{"id":"63a73bac.6019b4","type":"http request","z":"1a02742f.665d2c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":180,"wires":[["77124214.5209ec","63824455.933c9c"]]},{"id":"2a5e047e.ac90fc","type":"debug","z":"1a02742f.665d2c","name":"GET_NJOIN_CHANNEL_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":140,"wires":[]},{"id":"63824455.933c9c","type":"debug","z":"1a02742f.665d2c","name":"GET_NJOIN_CHANNEL_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":180,"wires":[]},{"id":"e485735a.cda99","type":"debug","z":"1a02742f.665d2c","name":"GET_NJOIN_CHANNEL_INFO_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":220,"wires":[]},{"id":"bedff1a.c92951","type":"debug","z":"2928f438.efbd8c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":240,"wires":[]},{"id":"4c17e547.b2257c","type":"subflow:d9807e99.e20e","z":"6e6d961d.724ba8","name":"","env":[],"x":270,"y":100,"wires":[["e4c59588.9070e8"]]},{"id":"62473c4c.17c4b4","type":"subflow:d9807e99.e20e","z":"1a02742f.665d2c","name":"","env":[],"x":330,"y":100,"wires":[["c154c2f9.e1d16"]]},{"id":"fea93da1.f53df","type":"subflow:d9807e99.e20e","z":"bca86633.b71988","name":"","x":290,"y":100,"wires":[["fd8b6d35.7e127"]]},{"id":"e419b6f2.0bd8e8","type":"switch","z":"2928f438.efbd8c","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":500,"wires":[["219bb677.34c4ca"],["430bafd7.c3425"]]},{"id":"219bb677.34c4ca","type":"function","z":"2928f438.efbd8c","name":"ITERATE_OVER_FOUNDED_CHANNEL_INFO","func":"node.error(\" > 1\");\n\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":1360,"y":200,"wires":[["ed8f233.a5020e"]]},{"id":"d2294e2f.842f7","type":"subflow:4780809c.72938","z":"91f0dfd1.af154","name":"","env":[],"x":290,"y":80,"wires":[["f73febcf.dc0f28"]]},{"id":"412f1965.fa0288","type":"change","z":"91f0dfd1.af154","name":"","rules":[{"t":"set","p":"RESULT_VALIDATE_PAGE_TOKEN","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":160,"wires":[[]]},{"id":"14ddff10.a2e5a1","type":"subflow:91f0dfd1.af154","z":"2928f438.efbd8c","name":"","env":[],"x":1290,"y":260,"wires":[["2a08f544.a8738a","b6686fc7.7ede3"]]},{"id":"b6686fc7.7ede3","type":"debug","z":"2928f438.efbd8c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1710,"y":260,"wires":[]},{"id":"3d89e13f.3ab71e","type":"change","z":"2928f438.efbd8c","name":"","rules":[{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"njoinCurrentChannelToValidate","tot":"msg"},{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1700,"y":320,"wires":[["4f3d0ee2.5abcf"]]},{"id":"2a08f544.a8738a","type":"switch","z":"2928f438.efbd8c","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1290,"y":340,"wires":[["31311e2c.90e542"],["901c75c2.220048"]]},{"id":"ed8f233.a5020e","type":"change","z":"2928f438.efbd8c","name":"","rules":[{"t":"set","p":"njoinCurrentChannelToValidate","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1720,"y":200,"wires":[["14ddff10.a2e5a1"]]},{"id":"31311e2c.90e542","type":"function","z":"2928f438.efbd8c","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has valid token, setting page obj to temp_facebook_channel_config');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":320,"wires":[["3d89e13f.3ab71e"]]},{"id":"4f3d0ee2.5abcf","type":"debug","z":"2928f438.efbd8c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1890,"y":320,"wires":[]},{"id":"911e4fde.93a1b","type":"subflow:d9807e99.e20e","z":"e68aec6.b15961","name":"","env":[],"x":290,"y":120,"wires":[["eda73867.1a8598"]]},{"id":"eda73867.1a8598","type":"function","z":"e68aec6.b15961","name":"INIT_REQUEST_FOR_DELETING_CURRENT_NJOIN_CHANNEL_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst channelDocID = msg.njoinChannelDocID;\nconst url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}/_update`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\n// msg.payload = {\n//     \"doc\": {\n//         \"isDeleted\": true\n//     }\n// }\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["cff577af.bf26b8","ffe1af06.b1ec"]]},{"id":"ffe1af06.b1ec","type":"http request","z":"e68aec6.b15961","name":"","method":"DELETE","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":200,"wires":[["27fe846c.48359c","1ce3fbda.982724"]]},{"id":"27fe846c.48359c","type":"change","z":"e68aec6.b15961","name":"","rules":[{"t":"set","p":"resultDeleteCurrentNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":240,"wires":[["18336f97.32e16"]]},{"id":"3fcc71d0.66a0ce","type":"subflow:e68aec6.b15961","z":"2928f438.efbd8c","name":"","env":[],"x":1340,"y":420,"wires":[["2720fc48.b9b3c4","e234a7ba.6c2328"]]},{"id":"cff577af.bf26b8","type":"debug","z":"e68aec6.b15961","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":160,"wires":[]},{"id":"1ce3fbda.982724","type":"debug","z":"e68aec6.b15961","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":200,"wires":[]},{"id":"18336f97.32e16","type":"debug","z":"e68aec6.b15961","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":240,"wires":[]},{"id":"2720fc48.b9b3c4","type":"debug","z":"2928f438.efbd8c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1630,"y":420,"wires":[]},{"id":"e234a7ba.6c2328","type":"switch","z":"2928f438.efbd8c","name":"CHECK_ITERATE_OVER_NJOIN_IS_DONE","property":"isLastIndex_njoinChannelInfoList","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1350,"y":460,"wires":[["3817bffa.cef5a"]]},{"id":"3817bffa.cef5a","type":"function","z":"2928f438.efbd8c","name":"","func":"node.error('loop njoin channel list ended!');\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":500,"wires":[["dbd2b804.07c7f8","4851eab9.74f1d4"]]},{"id":"dbd2b804.07c7f8","type":"debug","z":"2928f438.efbd8c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1630,"y":500,"wires":[]},{"id":"34dde1ae.fc511e","type":"subflow:d9807e99.e20e","z":"1218c9db.594cf6","name":"","env":[],"x":230,"y":100,"wires":[["67c94112.25152"]]},{"id":"67c94112.25152","type":"function","z":"1218c9db.594cf6","name":"INIT_REQUEST_FOR_CREATING_NEW_NJOIN_CHANNEL","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst docID = msg.temp_facebook_channel_config['_source']['id'];\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\nconst url = `https://${nes}/njoin-${nuser}/channel/${docID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.payload = msg.temp_facebook_channel_config._source;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["9b47b055.8646d","7622d09f.d8fe4"]]},{"id":"7622d09f.d8fe4","type":"http request","z":"1218c9db.594cf6","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":180,"wires":[["c7f5ff51.66645","acd123e1.19b41"]]},{"id":"c7f5ff51.66645","type":"change","z":"1218c9db.594cf6","name":"","rules":[{"t":"set","p":"resultCreateNewNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":220,"wires":[["7cab7c96.ff3e04"]]},{"id":"9b47b055.8646d","type":"debug","z":"1218c9db.594cf6","name":"CREATE_NEW_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":140,"wires":[]},{"id":"acd123e1.19b41","type":"debug","z":"1218c9db.594cf6","name":"CREATE_NEW_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":180,"wires":[]},{"id":"7cab7c96.ff3e04","type":"debug","z":"1218c9db.594cf6","name":"CREATE_NEW_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":220,"wires":[]},{"id":"ebafbbe.72ded48","type":"subflow:1218c9db.594cf6","z":"2928f438.efbd8c","name":"","env":[],"x":1780,"y":560,"wires":[["dd87115f.4fd7e"]]},{"id":"dd87115f.4fd7e","type":"debug","z":"2928f438.efbd8c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2010,"y":560,"wires":[]},{"id":"c9885035.a21ea","type":"change","z":"2928f438.efbd8c","name":"","rules":[{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":360,"wires":[["3fcc71d0.66a0ce"]]},{"id":"4851eab9.74f1d4","type":"function","z":"2928f438.efbd8c","name":"TEMP_FACEBOOK_CHANNEL_IS_EMPTY_OR_NOT","func":"if (Object.keys(msg.temp_facebook_channel_config).length) {\n    return [msg, null];\n} else {\n    return [null, null];\n}","outputs":2,"noerr":0,"x":1380,"y":580,"wires":[["ebafbbe.72ded48"],["3894a973.621156"]]},{"id":"3894a973.621156","type":"function","z":"2928f438.efbd8c","name":"","func":"node.error('temp_facebook_channel_config is empty, skipping...');\nreturn msg;","outputs":1,"noerr":0,"x":1690,"y":600,"wires":[[]]},{"id":"901c75c2.220048","type":"function","z":"2928f438.efbd8c","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has invalid token, setting to njoinChannelDocID to delete');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":360,"wires":[["c9885035.a21ea"]]},{"id":"430bafd7.c3425","type":"function","z":"2928f438.efbd8c","name":"","func":"node.error('njoinChannelInfo is less than 0, skipping iteration...')\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":780,"wires":[[]]},{"id":"ecefcc80.04101","type":"inject","z":"3d002355.92967c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":140,"wires":[["146c08cd.c7c577"]]},{"id":"1907cd6e.aeea43","type":"inject","z":"3d002355.92967c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":280,"wires":[["fc8eef9b.fd373"]]},{"id":"a557fca1.d9b68","type":"inject","z":"3d002355.92967c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":420,"wires":[["5cf8f368.d7c7ec"]]},{"id":"d641d63.5b81328","type":"comment","z":"3d002355.92967c","name":"DEV","info":"","x":110,"y":100,"wires":[]},{"id":"571c35ff.07e40c","type":"comment","z":"3d002355.92967c","name":"ALPHA","info":"","x":110,"y":240,"wires":[]},{"id":"251e1cff.a71474","type":"comment","z":"3d002355.92967c","name":"PROD","info":"","x":110,"y":380,"wires":[]},{"id":"146c08cd.c7c577","type":"change","z":"3d002355.92967c","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":110,"y":180,"wires":[[]]},{"id":"fc8eef9b.fd373","type":"change","z":"3d002355.92967c","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":120,"y":320,"wires":[[]]},{"id":"5cf8f368.d7c7ec","type":"change","z":"3d002355.92967c","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":110,"y":460,"wires":[["ed85b855.8ddbc8"]]},{"id":"b1f2e623.576308","type":"inject","z":"3d002355.92967c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":740,"y":60,"wires":[["76ca8d38.0b1314"]]},{"id":"76ca8d38.0b1314","type":"subflow:91f0dfd1.af154","z":"3d002355.92967c","name":"","env":[],"x":950,"y":60,"wires":[[]]},{"id":"ed85b855.8ddbc8","type":"subflow:6e6d961d.724ba8","z":"3d002355.92967c","name":"","env":[],"x":450,"y":140,"wires":[["a1d0c7b3.511dc8","fd05b2b7.ced36"]]},{"id":"af24ae69.28887","type":"subflow:bca86633.b71988","z":"3d002355.92967c","name":"","env":[],"x":630,"y":1020,"wires":[[]]},{"id":"f3c15562.cd02e8","type":"debug","z":"3d002355.92967c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":950,"y":1060,"wires":[]},{"id":"701b9a5a.8c8294","type":"function","z":"3d002355.92967c","name":"ITERATE_OVER_ARIS_SALES_CHANNEL","func":"const arisSalesChannelList = msg.arisSalesChannelList.hits.hits;\n\narisSalesChannelList.forEach((channel, index) => {\n    setTimeout(() => {\n        msg.payload = channel;\n        msg.isLastIndex_arisSalesChannelList = false;\n        \n        if (index === arisSalesChannelList.length - 1) {\n            msg.isLastIndex_arisSalesChannelList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":670,"y":1060,"wires":[["f3c15562.cd02e8","90276228.6bb27"]]},{"id":"90276228.6bb27","type":"subflow:1a02742f.665d2c","z":"3d002355.92967c","name":"","env":[],"x":630,"y":1100,"wires":[["910a56e2.dcb2e8","98a55133.78253"]]},{"id":"910a56e2.dcb2e8","type":"debug","z":"3d002355.92967c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":950,"y":1100,"wires":[]},{"id":"98a55133.78253","type":"switch","z":"3d002355.92967c","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":630,"y":1200,"wires":[["617e1ad2.40b5c4"],["730cad3.c869854"]]},{"id":"617e1ad2.40b5c4","type":"function","z":"3d002355.92967c","name":"ITERATE_OVER_FOUNDED_CHANNEL_INFO","func":"node.error(\" > 1\");\n\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":1400,"y":820,"wires":[["1a6d90ef.4136df"]]},{"id":"6b300d26.6b4454","type":"subflow:91f0dfd1.af154","z":"3d002355.92967c","name":"","env":[],"x":1330,"y":880,"wires":[["5acb200d.2d66b","6b0442c3.299bcc"]]},{"id":"6b0442c3.299bcc","type":"debug","z":"3d002355.92967c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1750,"y":880,"wires":[]},{"id":"378b5470.46abbc","type":"change","z":"3d002355.92967c","name":"","rules":[{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"njoinCurrentChannelToValidate","tot":"msg"},{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":940,"wires":[["c47a9887.dc21a8"]]},{"id":"5acb200d.2d66b","type":"switch","z":"3d002355.92967c","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":960,"wires":[["9dc705bb.256308"],["7f99467a.75a018"]]},{"id":"1a6d90ef.4136df","type":"change","z":"3d002355.92967c","name":"","rules":[{"t":"set","p":"njoinCurrentChannelToValidate","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":820,"wires":[["6b300d26.6b4454"]]},{"id":"9dc705bb.256308","type":"function","z":"3d002355.92967c","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has valid token, setting page obj to temp_facebook_channel_config');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1550,"y":940,"wires":[["378b5470.46abbc"]]},{"id":"c47a9887.dc21a8","type":"debug","z":"3d002355.92967c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1930,"y":940,"wires":[]},{"id":"fa5acd47.d49e5","type":"subflow:e68aec6.b15961","z":"3d002355.92967c","name":"","env":[],"x":1380,"y":1040,"wires":[["1ca29a45.e8feb6","5f314574.3390cc"]]},{"id":"1ca29a45.e8feb6","type":"debug","z":"3d002355.92967c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1670,"y":1040,"wires":[]},{"id":"5f314574.3390cc","type":"switch","z":"3d002355.92967c","name":"CHECK_ITERATE_OVER_NJOIN_IS_DONE","property":"isLastIndex_njoinChannelInfoList","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1390,"y":1080,"wires":[["a4ad9dce.d818a"]]},{"id":"a4ad9dce.d818a","type":"function","z":"3d002355.92967c","name":"","func":"node.error('loop njoin channel list ended!');\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":1120,"wires":[["ce94826a.41b9e","52ad8dce.b81fd4"]]},{"id":"ce94826a.41b9e","type":"debug","z":"3d002355.92967c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1670,"y":1120,"wires":[]},{"id":"69845c08.1168b4","type":"subflow:1218c9db.594cf6","z":"3d002355.92967c","name":"","env":[],"x":1820,"y":1180,"wires":[["af382810.a213a8"]]},{"id":"af382810.a213a8","type":"debug","z":"3d002355.92967c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2050,"y":1180,"wires":[]},{"id":"1a9099b9.3e8d16","type":"change","z":"3d002355.92967c","name":"","rules":[{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1780,"y":980,"wires":[["fa5acd47.d49e5"]]},{"id":"52ad8dce.b81fd4","type":"function","z":"3d002355.92967c","name":"TEMP_FACEBOOK_CHANNEL_IS_EMPTY_OR_NOT","func":"if (Object.keys(msg.temp_facebook_channel_config).length) {\n    return [msg, null];\n} else {\n    return [null, null];\n}","outputs":2,"noerr":0,"x":1420,"y":1200,"wires":[["69845c08.1168b4"],["11ce76b4.d4bf19"]]},{"id":"11ce76b4.d4bf19","type":"function","z":"3d002355.92967c","name":"","func":"node.error('temp_facebook_channel_config is empty, skipping...');\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1220,"wires":[[]]},{"id":"7f99467a.75a018","type":"function","z":"3d002355.92967c","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has invalid token, setting to njoinChannelDocID to delete');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1550,"y":980,"wires":[["1a9099b9.3e8d16"]]},{"id":"730cad3.c869854","type":"function","z":"3d002355.92967c","name":"","func":"node.error('njoinChannelInfo is less than 0, skipping iteration...')\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":1400,"wires":[[]]},{"id":"a1d0c7b3.511dc8","type":"debug","z":"3d002355.92967c","name":"RESULT_ARIS_SALES_CHANNEL_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":140,"wires":[]},{"id":"fd05b2b7.ced36","type":"function","z":"3d002355.92967c","name":"INITIAL_INDEX_SALES_CHANNEL","func":"msg.indexSalesChannel = 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":180,"wires":[["24c5a2f0.fd2d9e"]]},{"id":"24c5a2f0.fd2d9e","type":"switch","z":"3d002355.92967c","name":"Index Sale Channel = salesChannelList length?","property":"indexSalesChannel","propertyType":"msg","rules":[{"t":"lt","v":"arisSalesChannelList.hits.hits.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":260,"wires":[["edc7b247.8bbbf"],["b1a5136e.06848"]]},{"id":"eabeb667.12d6d8","type":"comment","z":"3d002355.92967c","name":"Sales Channel LOOP","info":"","x":400,"y":220,"wires":[]},{"id":"edc7b247.8bbbf","type":"function","z":"3d002355.92967c","name":"INITIAL_SALES_CHANNEL_BEFORE_PROCESS","func":"let processIndex = msg.indexSalesChannel;\nlet processSalesChannel = msg.arisSalesChannelList.hits.hits[processIndex];\nmsg.payload = processSalesChannel;\nmsg.tempNjoinChannelInfo = {};\n//node.error(processSalesChannel);\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":320,"wires":[["821ef5bd.76d618"]]},{"id":"b1a5136e.06848","type":"function","z":"3d002355.92967c","name":"PROCESS_DONE","func":"node.error('End Sales Channel Loop. Process done.');\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":280,"wires":[[]]},{"id":"821ef5bd.76d618","type":"subflow:1a02742f.665d2c","z":"3d002355.92967c","name":"","env":[],"x":510,"y":360,"wires":[["81e88d6a.82de8","b5f293ce.aacfe"]]},{"id":"591a04d5.eaddec","type":"function","z":"3d002355.92967c","name":"INCREASE_INDEX_SALES_CHANNEL","func":"msg.indexSalesChannel++;\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":620,"wires":[["e54ec991.8a5508"]]},{"id":"e7c0a279.a0bc6","type":"link in","z":"3d002355.92967c","name":"","links":["d32a56dc.0e33e8"],"x":255,"y":260,"wires":[["24c5a2f0.fd2d9e"]]},{"id":"d32a56dc.0e33e8","type":"link out","z":"3d002355.92967c","name":"","links":["e7c0a279.a0bc6","3cc94b42.40c124"],"x":815,"y":620,"wires":[]},{"id":"81e88d6a.82de8","type":"debug","z":"3d002355.92967c","name":"RESULT_NJOIN_CHANNEL_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":360,"wires":[]},{"id":"b5f293ce.aacfe","type":"subflow:a67b3af.dcc66c8","z":"3d002355.92967c","name":"","env":[],"x":540,"y":400,"wires":[["591a04d5.eaddec"]]},{"id":"9206354c.a65d58","type":"switch","z":"a67b3af.dcc66c8","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":240,"wires":[["3654f424.0a2dfc"],["4a2ab3b4.82b1fc"]]},{"id":"3654f424.0a2dfc","type":"function","z":"a67b3af.dcc66c8","name":"","func":"node.error('njoinChannelInfo is equal 0, go next...');\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":40,"wires":[[]]},{"id":"4a2ab3b4.82b1fc","type":"function","z":"a67b3af.dcc66c8","name":"INITIAL_INDEX_NJOIN_CHANNEL","func":"node.error('njoinChannelInfo(s) are more than 0 : '+msg.njoinChannelInfo.hits.total);\n\nmsg.indexNjoinChannel = 0;\nmsg.njoinChannelList = msg.njoinChannelInfo.hits.hits;\n\nreturn msg;\n\n/*\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n*/","outputs":1,"noerr":0,"x":340,"y":300,"wires":[["e39bb2e5.ea693"]]},{"id":"db564baf.4aaa38","type":"comment","z":"a67b3af.dcc66c8","name":"Njoin Channel LOOP","info":"","x":290,"y":340,"wires":[]},{"id":"e39bb2e5.ea693","type":"switch","z":"a67b3af.dcc66c8","name":"Index Njoin Channel = njoinChannelList length?","property":"indexNjoinChannel","propertyType":"msg","rules":[{"t":"lt","v":"njoinChannelList.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":380,"wires":[["2394b0ab.f2ae9"],["1a6d60bb.a2d6df"]]},{"id":"18d41441.1b0e8c","type":"link in","z":"a67b3af.dcc66c8","name":"","links":["6c72cac0.636664"],"x":135,"y":380,"wires":[["e39bb2e5.ea693"]]},{"id":"2b412ba0.f2a014","type":"function","z":"a67b3af.dcc66c8","name":"INCREASE_INDEX_NJOIN_CHANNEL","func":"msg.indexNjoinChannel++;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":940,"wires":[["12e31e8.9cd68e2"]]},{"id":"6c72cac0.636664","type":"link out","z":"a67b3af.dcc66c8","name":"","links":["18d41441.1b0e8c"],"x":695,"y":940,"wires":[]},{"id":"1a6d60bb.a2d6df","type":"function","z":"a67b3af.dcc66c8","name":"END_LOOP","func":"node.error('End Njoin Channel Loop.');\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":240,"wires":[["33adfac6.1f2396"]]},{"id":"2394b0ab.f2ae9","type":"function","z":"a67b3af.dcc66c8","name":"INITIAL_NJOIN_CHANNEL_BEFORE_PROCESS","func":"let processIndex = msg.indexNjoinChannel;\nlet processNjoinChannel = msg.njoinChannelList[processIndex];\n//msg.payload = processNjoinChannel;\nmsg.processNjoinChannel = processNjoinChannel;\nmsg.TOKEN_TO_VALIDATE = processNjoinChannel._source.token;\nnode.error(processNjoinChannel);\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":440,"wires":[["34c5601b.44949"]]},{"id":"34c5601b.44949","type":"subflow:91f0dfd1.af154","z":"a67b3af.dcc66c8","name":"","env":[],"x":400,"y":480,"wires":[["a6a5bf64.42232","1e5b3119.58f3bf"]]},{"id":"a6a5bf64.42232","type":"debug","z":"a67b3af.dcc66c8","name":"RESULT_VALIDATE_PAGE_TOKEN_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":480,"wires":[]},{"id":"1e5b3119.58f3bf","type":"switch","z":"a67b3af.dcc66c8","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":400,"y":560,"wires":[["436f37f7.e05ca8"],["e5c75572.0132c8"]]},{"id":"436f37f7.e05ca8","type":"function","z":"a67b3af.dcc66c8","name":"PAGE_TOKEN_VALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is VALID.');\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":620,"wires":[["1c735bcf.b6b2b4"]]},{"id":"e5c75572.0132c8","type":"function","z":"a67b3af.dcc66c8","name":"PAGE_TOKEN_INVALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is INVALID. Prepare to DELETE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":620,"wires":[["1fd794f.a893c6b"]]},{"id":"1fd794f.a893c6b","type":"function","z":"a67b3af.dcc66c8","name":"SET_NJOIN_CHANNEL_DOC_ID","func":"node.error('Set njoin channel doc ID: '+msg.processNjoinChannel._id+' with Page Token: '+msg.processNjoinChannel._source.id+' to DELETE.');\nmsg.njoinChannelDocID = msg.processNjoinChannel._id;\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":820,"wires":[["fae7cc3d.c03c6"]]},{"id":"fae7cc3d.c03c6","type":"subflow:e68aec6.b15961","z":"a67b3af.dcc66c8","name":"","env":[],"x":480,"y":860,"wires":[["2b412ba0.f2a014"]]},{"id":"1c735bcf.b6b2b4","type":"switch","z":"a67b3af.dcc66c8","name":"Temp njoin channel is not empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":800,"y":680,"wires":[["4d77e158.7893f"],["1fd794f.a893c6b"]]},{"id":"4d77e158.7893f","type":"function","z":"a67b3af.dcc66c8","name":"Temp join channel is empty","func":"node.error('temp njoin channel is empty, so set njoin channel: '+msg.processNjoinChannel._source.id+' into temp njoin channel.');\nmsg.tempNjoinChannelInfo = msg.processNjoinChannel;\n\n//node.error(msg.tempNjoinChannelInfo);\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":740,"wires":[["1fd794f.a893c6b"]]},{"id":"33adfac6.1f2396","type":"switch","z":"a67b3af.dcc66c8","name":"Temp njoin channel is empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":300,"wires":[["17af835b.60a48d"],["54cb8a54.ce91b4"]]},{"id":"54cb8a54.ce91b4","type":"function","z":"a67b3af.dcc66c8","name":"INIT_PAGE_DATA_TO_CREATE","func":"msg.temp_facebook_channel_config = msg.tempNjoinChannelInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":360,"wires":[["80c579cf.c5b078"]]},{"id":"80c579cf.c5b078","type":"subflow:1218c9db.594cf6","z":"a67b3af.dcc66c8","name":"","env":[],"x":880,"y":400,"wires":[["3a568ddd.75d232","17af835b.60a48d"]]},{"id":"3a568ddd.75d232","type":"debug","z":"a67b3af.dcc66c8","name":"RESULT_CREATE_NJOIN_CHANNEL","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1290,"y":440,"wires":[]},{"id":"17af835b.60a48d","type":"function","z":"a67b3af.dcc66c8","name":"PROCESS_DONE","func":"node.error('Process DONE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":340,"wires":[[]]},{"id":"e54ec991.8a5508","type":"delay","z":"3d002355.92967c","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":710,"y":620,"wires":[["d32a56dc.0e33e8"]]},{"id":"12e31e8.9cd68e2","type":"delay","z":"a67b3af.dcc66c8","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":590,"y":940,"wires":[["6c72cac0.636664"]]},{"id":"c3460e4e.89c2","type":"inject","z":"e8022868.328888","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":120,"wires":[["a6c2bf07.bbf0f"]]},{"id":"e359b242.80802","type":"inject","z":"e8022868.328888","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":260,"wires":[["291b1f6c.3a62d"]]},{"id":"f84fc60.271bc38","type":"inject","z":"e8022868.328888","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":400,"wires":[["7bd8c1e8.8674"]]},{"id":"519e877b.35df88","type":"comment","z":"e8022868.328888","name":"DEV","info":"","x":130,"y":80,"wires":[]},{"id":"1f1ba482.e4c5cb","type":"comment","z":"e8022868.328888","name":"ALPHA","info":"","x":130,"y":220,"wires":[]},{"id":"3a6850ea.a0405","type":"comment","z":"e8022868.328888","name":"PROD","info":"","x":130,"y":360,"wires":[]},{"id":"a6c2bf07.bbf0f","type":"change","z":"e8022868.328888","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":160,"wires":[["6ae236e.4a8f1c8"]]},{"id":"291b1f6c.3a62d","type":"change","z":"e8022868.328888","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":140,"y":300,"wires":[[]]},{"id":"7bd8c1e8.8674","type":"change","z":"e8022868.328888","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":440,"wires":[[]]},{"id":"722c8842.6cd2e8","type":"subflow:bca86633.b71988","z":"e8022868.328888","name":"","env":[],"x":990,"y":120,"wires":[[]]},{"id":"2bf59644.d7c07a","type":"function","z":"7797e113.65218","name":"INIT_REQUEST_FOR_GETTING_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst storeID = msg.storeID\nconst url = `https://${nes}/${platform_index}/order/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        { \"match\": { \"storeID.keyword\": storeID } },\n        { \"match\": { \"userInfo.firstName.keyword\": \"\" } },\n        { \"match\": { \"userInfo.lastName.keyword\": \"\" } }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["600e5c74.4ecec4","423289da.39f338"]]},{"id":"600e5c74.4ecec4","type":"debug","z":"7797e113.65218","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":120,"wires":[]},{"id":"e37da551.291758","type":"debug","z":"7797e113.65218","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":160,"wires":[]},{"id":"fa3cc0f2.a4b3e","type":"debug","z":"7797e113.65218","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":200,"wires":[]},{"id":"54b00c9c.8e1b34","type":"change","z":"7797e113.65218","name":"","rules":[{"t":"set","p":"arisOrdersList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":200,"wires":[["fa3cc0f2.a4b3e"]]},{"id":"423289da.39f338","type":"http request","z":"7797e113.65218","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":210,"y":160,"wires":[["e37da551.291758","54b00c9c.8e1b34"]]},{"id":"4a822cb8.b6c324","type":"subflow:d9807e99.e20e","z":"7797e113.65218","name":"","env":[],"x":250,"y":80,"wires":[["2bf59644.d7c07a"]]},{"id":"3431e18.e43b51e","type":"subflow:7797e113.65218","z":"e8022868.328888","name":"","env":[],"x":670,"y":120,"wires":[["b345fbf5.569578"]]},{"id":"b345fbf5.569578","type":"debug","z":"e8022868.328888","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":80,"wires":[]},{"id":"6ae236e.4a8f1c8","type":"function","z":"e8022868.328888","name":"SET_STORE_ID_TO_FIND_ORDERS","func":"msg.storeID = \"e6593c83-b8eb-49c8-b725-12e99fda61bd\";\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":160,"wires":[["3431e18.e43b51e"]]},{"id":"be2eae17.cc2a4","type":"inject","z":"3d002355.92967c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":560,"wires":[["db7dbafa.1beb18"]]},{"id":"19a8f343.369bad","type":"comment","z":"3d002355.92967c","name":"TEST PROD","info":"","x":130,"y":520,"wires":[]},{"id":"db7dbafa.1beb18","type":"change","z":"3d002355.92967c","name":"TEST PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"test-arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"test-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":600,"wires":[[]]},{"id":"fc2e707d.fa82c","type":"ical-events","z":"7d797c29.c6e334","confignode":"df7b6a89.123188","cron":"50 8 * * *","name":"","offset":"","x":310,"y":220,"wires":[["4b8b7107.8cf34"],["f4b35288.e3e6f"]]},{"id":"8c8b3f58.25414","type":"ical-upcoming","z":"7d797c29.c6e334","confignode":"df7b6a89.123188","cron":"50 8 * * *","timeout":"30","timeoutUnits":"seconds","name":"","offset":"","endpreview":"","endpreviewUnits":"days","pastview":"","pastviewUnits":"days","trigger":"match","filter":"","x":330,"y":300,"wires":[["8b00a068.e6b83","1940354a.92b22b"]]},{"id":"3c54789a.a5cb08","type":"inject","z":"7d797c29.c6e334","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":280,"wires":[["fc2e707d.fa82c","8c8b3f58.25414"]]},{"id":"f4b35288.e3e6f","type":"debug","z":"7d797c29.c6e334","name":"event_trigger_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":540,"y":240,"wires":[]},{"id":"4b8b7107.8cf34","type":"debug","z":"7d797c29.c6e334","name":"event_trigger_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":540,"y":200,"wires":[]},{"id":"8b00a068.e6b83","type":"debug","z":"7d797c29.c6e334","name":"upcoming_events_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":350,"y":360,"wires":[]},{"id":"ec1b0459.354f98","type":"function","z":"7d797c29.c6e334","name":"SET_UPCOMING_EVENT_TO_MEMORY","func":"context.global['upcomingEvent'] = {};\ncontext.global['upcomingEvent']['eventList'] = msg.payload;\ncontext.global['upcomingEvent']['lastUpdated'] = Date.now();\n\nmsg.payload = context.global['upcomingEvent'];\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":340,"wires":[["20c5699c.df1006"]]},{"id":"8ee3bfd4.616ce","type":"inject","z":"7d797c29.c6e334","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":860,"wires":[["d2b8d560.ae0688"]]},{"id":"d2b8d560.ae0688","type":"function","z":"7d797c29.c6e334","name":"debug upcomingEvent","func":"msg.payload = context.global['upcomingEvent'];\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":880,"wires":[["e01c0378.ae73a"]]},{"id":"e01c0378.ae73a","type":"debug","z":"7d797c29.c6e334","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":690,"y":900,"wires":[]},{"id":"c2654be1.c0a3d8","type":"debug","z":"7d797c29.c6e334","name":"filter_upcoming_event_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1070,"y":300,"wires":[]},{"id":"517156e6.bead88","type":"http in","z":"7d797c29.c6e334","name":"","url":"/upcomingEvent","method":"get","upload":false,"swaggerDoc":"","x":140,"y":60,"wires":[["706a0eb9.4ed0f"]]},{"id":"7d44d3dd.23c9ac","type":"http response","z":"7d797c29.c6e334","name":"","statusCode":"","headers":{},"x":490,"y":60,"wires":[]},{"id":"706a0eb9.4ed0f","type":"function","z":"7d797c29.c6e334","name":"get_upcoming_event_debug","func":"msg.payload = context.global['upcomingEvent'];\n\nmsg.statusCode = 200;\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":60,"wires":[["7d44d3dd.23c9ac","9d50fb21.5ef098"]]},{"id":"9d50fb21.5ef098","type":"debug","z":"7d797c29.c6e334","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":490,"y":100,"wires":[]},{"id":"20c5699c.df1006","type":"debug","z":"7d797c29.c6e334","name":"set_upcoming_event_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1060,"y":340,"wires":[]},{"id":"1940354a.92b22b","type":"function-npm","z":"7d797c29.c6e334","name":"FILTER_UPCOMING_EVENT_IN_NEXT_24_HOURS","func":"const moment = require('moment');\n\nconst startDate = moment().format();\nconst endDate = moment().add(1, 'days').format();\n\nlet eventList = msg.payload;\n\neventList = eventList\n    .filter((event, index) => {\n        event.eventStart = moment(event.eventStart).format();\n        return event.eventStart >= startDate && event.eventStart <= endDate;\n    })\n    .map((event, index) => {\n        event.eventStart = moment(event.eventStart).add(7, 'hours');\n        event.eventEnd = moment(event.eventEnd).add(7, 'hours');\n        return event;\n    })\n    .sort((a, b) => {\n        return (a.eventStart > b.eventStart) ? 1 : ((b.eventStart > a.eventStart) ? -1 : 0)\n    });\n\n\nmsg.payload = eventList;\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":300,"wires":[["c2654be1.c0a3d8","ec1b0459.354f98"]]},{"id":"80e1bc33.ea371","type":"comment","z":"7d797c29.c6e334","name":"TRIGGER_LINE_NOTIFY","info":"","x":290,"y":640,"wires":[]},{"id":"b6430691.75fde8","type":"function","z":"7d797c29.c6e334","name":"SET_HEADERS","func":"const TOKEN = \"yD1dkEa3ZZTk9t2G4xCqbyXuBM2NqRxfRwrbT2RTTQq\";\n\nlet messageToNotify = msg.messageToNotify;\n\nmsg.headers = {\n    \"Content-Type\": \"application/x-www-form-urlencoded\",\n    \"Authorization\": `Bearer ${TOKEN}`,\n    // \"Cache-Control\": \"no-cache\"\n}\nmsg.payload = messageToNotify;\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":720,"wires":[["bf92835f.3a47","b5b42e4.90463d"]]},{"id":"691f9ac0.115724","type":"debug","z":"7d797c29.c6e334","name":"line_notify_http_req_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":760,"wires":[]},{"id":"79f1fd4d.e02ba4","type":"inject","z":"7d797c29.c6e334","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":700,"wires":[["c5042c07.095de"]]},{"id":"bf92835f.3a47","type":"debug","z":"7d797c29.c6e334","name":"set_line_notify_headers_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":550,"y":760,"wires":[]},{"id":"c5042c07.095de","type":"function","z":"7d797c29.c6e334","name":"","func":"msg.messageToNotify = {\n    message: \"Upcoming Event: \",\n    stickerPackageId: 1,\n    stickerId: 16\n}\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":760,"wires":[["b6430691.75fde8","e1ca725f.492cb"]]},{"id":"b5b42e4.90463d","type":"http request","z":"7d797c29.c6e334","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://notify-api.line.me/api/notify","tls":"","proxy":"","authType":"","x":750,"y":720,"wires":[["691f9ac0.115724"]]},{"id":"e1ca725f.492cb","type":"debug","z":"7d797c29.c6e334","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":390,"y":800,"wires":[]},{"id":"e3253ca.37f9ac","type":"cronplus","z":"7d797c29.c6e334","name":"","outputField":"payload","timeZone":"","options":[{"topic":"every 9am","payload":"","type":"str","expression":"0 9 * * *"}],"x":120,"y":500,"wires":[["17e3ebf1.1f9744"]]},{"id":"17e3ebf1.1f9744","type":"function","z":"7d797c29.c6e334","name":"SET_MESSAGE_BODY","func":"const eventList = context.global['upcomingEvent']['eventList'];\nlet upcomingEvent = \"\";\n\neventList.forEach((event, index) => {\n    event.eventStart = event.eventStart.toString().replace(\" GMT+0000\", \"\");\n    event.eventEnd = event.eventEnd.toString().replace(\" GMT+0000\", \"\");\n    upcomingEvent += `\\n - 📅 *${event.event}* ⏰ ${event.eventStart} ~ ${event.eventEnd} \\n` \n});\n\nmsg.messageToNotify = {\n    message: `\\n ${upcomingEvent}`,\n    stickerPackageId: 2,\n    stickerId: 527\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":500,"wires":[["88ee5722.f6d988","b0d53a60.00bd18"]]},{"id":"88ee5722.f6d988","type":"debug","z":"7d797c29.c6e334","name":"set_message_body_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":520,"wires":[]},{"id":"b0d53a60.00bd18","type":"function","z":"7d797c29.c6e334","name":"CHECK_LENGTH_OF_EVENT_LIST","func":"const eventList = context.global['upcomingEvent']['eventList'];\n\nif (eventList.length > 0) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":550,"y":600,"wires":[["b6430691.75fde8"],["dc1dafc8.719f5"]]},{"id":"dc1dafc8.719f5","type":"function","z":"7d797c29.c6e334","name":"","func":"node.error('No upcoming event, skipping notify')\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":620,"wires":[[]]},{"id":"31d770bb.0dcf8","type":"http in","z":"e8be7382.4fff","name":"","url":"/ghWebhook","method":"post","upload":false,"swaggerDoc":"","x":160,"y":60,"wires":[["692663c8.d1cc5c","bcec2ca2.901e4","abbab0fd.35702"]]},{"id":"bcec2ca2.901e4","type":"http response","z":"e8be7382.4fff","name":"","statusCode":"","headers":{},"x":450,"y":60,"wires":[]},{"id":"692663c8.d1cc5c","type":"debug","z":"e8be7382.4fff","name":"ghWebhook_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":180,"wires":[]},{"id":"abbab0fd.35702","type":"function","z":"e8be7382.4fff","name":"EVENT_SPLITTER","func":"msg.currentEvent = msg.payload\n\nif (msg.currentEvent.hasOwnProperty(\"pull_request\")) {\n    return [msg, null];\n} else {\n    return [null, msg]\n}","outputs":2,"noerr":0,"x":350,"y":280,"wires":[["ed76dc5f.e7653"],[]]},{"id":"ed76dc5f.e7653","type":"function","z":"e8be7382.4fff","name":"PULL_REQUEST_EVENT_NOTIFY","func":"node.error(\"Pull Request Event\");\n\nconst currentEvent = msg.currentEvent;\n\nmsg.payload = {\n    \"type\": \"pull_request\",\n    \"action\": \"opened\",\n    \"url\": currentEvent['pull_request']['url'],\n    \"title\": currentEvent['pull_request']['title'],\n    \"repository\": currentEvent['repository']['name'],\n    \"sender\": currentEvent['sender']['login']\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":280,"wires":[["6db9081.28e35f8"]]},{"id":"6db9081.28e35f8","type":"debug","z":"e8be7382.4fff","name":"pr_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":420,"wires":[]},{"id":"c50b785d.877728","type":"function","z":"a926ea52.1ac368","name":"GET_DISTINCT_STORE_ID_FROM_ORDERS","func":"const orderList = msg.orderList;\n\nconst distinctStoreList = [...new Set(orderList.map(order => order.storeID))];\n\nmsg.distinctStoreList = distinctStoreList;\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":200,"wires":[["2c5eb36.5306f4c","243803f4.0ad5ac"]]},{"id":"5d64393e.0bfc38","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":160,"wires":[]},{"id":"2c5eb36.5306f4c","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":200,"wires":[]},{"id":"28fba0ef.8bbec","type":"function","z":"a926ea52.1ac368","name":"SET_BODY_FOR_GET_TOKEN_LIST","func":"const apiUrl = msg.apiUrl;\n\nconst distinctStoreList = msg.distinctStoreList;\n\nmsg.url = `${apiUrl}/storeConfig/tokenList`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.payload = {\n    \"storeList\": distinctStoreList\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":400,"wires":[["3c06622d.34735e"]]},{"id":"3c06622d.34735e","type":"http request","z":"a926ea52.1ac368","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1010,"y":440,"wires":[["e1a989ea.c6d928","e48d2c81.826bc"]]},{"id":"e1a989ea.c6d928","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":440,"wires":[]},{"id":"243803f4.0ad5ac","type":"function","z":"a926ea52.1ac368","name":"SET_BODY_TO_GET_GB_PAY_ACCOUNT_LIST","func":"const apiUrl = msg.apiUrl;\n\nconst distinctStoreList = msg.distinctStoreList;\n\nmsg.url = `${apiUrl}/gbpayAccount/all`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":260,"wires":[["58cad93b.5d98e8"]]},{"id":"58cad93b.5d98e8","type":"http request","z":"a926ea52.1ac368","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1010,"y":300,"wires":[["fb4e610f.7dbcf","5f7063fa.89a3fc"]]},{"id":"fb4e610f.7dbcf","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":300,"wires":[]},{"id":"5f7063fa.89a3fc","type":"change","z":"a926ea52.1ac368","name":"","rules":[{"t":"set","p":"gbPayAccountList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":340,"wires":[["28fba0ef.8bbec"]]},{"id":"e48d2c81.826bc","type":"change","z":"a926ea52.1ac368","name":"","rules":[{"t":"set","p":"storeTokenList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":480,"wires":[["ef076eaa.05f0b"]]},{"id":"ef076eaa.05f0b","type":"function","z":"a926ea52.1ac368","name":"SET_MAPPED_STORE_TOKEN","func":"const gbPayAccountList = msg.gbPayAccountList;\n\nlet tempPayload = [];\n\nconst findTokenFromGBPayAccountList = (token, list) => {\n    return list.find((listItem) => {\n        return listItem['gbPayAccountInfo']['token'] === token;\n    });\n}\n\nif (msg.payload && msg.payload.length > 0) {\n    msg.payload.splice(1);\n    msg.payload.forEach((payload) => {\n        const storeList = payload['STORE_ID']['buckets'].map((store) => {\n            return store['key'];\n        });\n        \n        const resultFilterTokenFromList = findTokenFromGBPayAccountList(payload['key'], gbPayAccountList);\n        \n        if (resultFilterTokenFromList) {\n            tempPayload.push({\n                \"storeID\": storeList,\n                \"token\": resultFilterTokenFromList['gbPayAccountInfo']['token'],\n                \"secret_key\": resultFilterTokenFromList['gbPayAccountInfo']['secret_key']\n            });\n        }\n        \n    });\n}\n\nmsg.mapped_store_token = tempPayload;\n\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":580,"wires":[["f0c2dff6.a06d6","54fbdf5.b02722"]]},{"id":"f0c2dff6.a06d6","type":"debug","z":"a926ea52.1ac368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1310,"y":620,"wires":[]},{"id":"8a36612c.5d88f","type":"debug","z":"a926ea52.1ac368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1930,"y":80,"wires":[]},{"id":"d88b6945.274a18","type":"http request","z":"a926ea52.1ac368","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2310,"y":220,"wires":[["6f2eec81.219e04","b0fb9085.a629e"]]},{"id":"5f5f8af.8bbd574","type":"http request","z":"a926ea52.1ac368","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_status_txn","tls":"","proxy":"","authType":"basic","x":2450,"y":80,"wires":[[]]},{"id":"c408a633.28aa18","type":"debug","z":"a926ea52.1ac368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2490,"y":160,"wires":[]},{"id":"90fe3ea2.7503a","type":"http in","z":"e1d0a067.d26ac","name":"","url":"/logReceiver","method":"post","upload":false,"swaggerDoc":"","x":420,"y":200,"wires":[["e556212d.1c1c4","69b37ce0.31cfb4"]]},{"id":"e3289f6f.d932a","type":"http response","z":"e1d0a067.d26ac","name":"","statusCode":"","headers":{},"x":840,"y":200,"wires":[]},{"id":"e556212d.1c1c4","type":"debug","z":"e1d0a067.d26ac","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":820,"y":280,"wires":[]},{"id":"69b37ce0.31cfb4","type":"function","z":"e1d0a067.d26ac","name":"","func":"msg.payload = Buffer.from(msg.payload);\nmsg.payload = msg.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":200,"wires":[["e3289f6f.d932a","97556a37.c98de8"]]},{"id":"97556a37.c98de8","type":"debug","z":"e1d0a067.d26ac","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":810,"y":240,"wires":[]},{"id":"5adadb49.1e8b04","type":"http in","z":"f527f707.d5a028","name":"","url":"/createHomepageEnvFile","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1620,"wires":[["cb0aa40d.3fdc98"]]},{"id":"cb0aa40d.3fdc98","type":"switch","z":"f527f707.d5a028","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":1620,"wires":[["411f85a2.5e44ec"],["e9dcca42.a0ca48"]]},{"id":"411f85a2.5e44ec","type":"switch","z":"f527f707.d5a028","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":470,"y":1740,"wires":[["2e548a3a.e98dc6"],["8b5686d1.cd1258"],["57cc99e6.45c2b8"]]},{"id":"89867807.9cb2e8","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":990,"y":1640,"wires":[]},{"id":"e9dcca42.a0ca48","type":"change","z":"f527f707.d5a028","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":1600,"wires":[["89867807.9cb2e8"]]},{"id":"23838088.8e822","type":"http response","z":"f527f707.d5a028","name":"","statusCode":"","headers":{},"x":1190,"y":1860,"wires":[]},{"id":"d52eb63f.0e04f8","type":"file in","z":"f527f707.d5a028","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":990,"y":1820,"wires":[["ab51b6bc.4ea508"]]},{"id":"ab51b6bc.4ea508","type":"change","z":"f527f707.d5a028","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":1860,"wires":[["23838088.8e822","8740a34a.bbd57"]]},{"id":"89308fef.16306","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":1680,"wires":[]},{"id":"8740a34a.bbd57","type":"debug","z":"f527f707.d5a028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":1940,"wires":[]},{"id":"fef12be1.030f88","type":"file","z":"f527f707.d5a028","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":990,"y":1740,"wires":[["cdae4968.724bf8"]]},{"id":"cdae4968.724bf8","type":"function","z":"f527f707.d5a028","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":1780,"wires":[["d52eb63f.0e04f8"]]},{"id":"2e548a3a.e98dc6","type":"function","z":"f527f707.d5a028","name":"dev","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='dev-arislab-platform'\nnes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-dev'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://dev.arislab.ai/'\nAPI_URL='https://dev.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab-dev.auth0.com'\nAUTH0_CLIENT_ID='Jqr8WyfSYqgiw1NgRlQ2f0UJLi8aWOgb'\nAUTH0_CLIENT_SECRET='ciGvXGgVeMBIGXJHRAYTfCkIS5Bk6HnfaUbif1bf-HUZnaPiPTRVNvqgOjK2tmPT'\nAUTH0_SAML_IDP_CERT_FILE='arislab-dev.pem'\n#AUTH0_DOMAIN='arislab.auth0.com'\n#AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\n#AUTH0_CLIENT_SECRET='WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\n#AUTH0_SAML_IDP_CERT_FILE='arislab.pem'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://dev.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://dev.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\nLOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\n\n#LINE\nSERVER_NAME='DEV'\nENABLE_NOTIFICATION=true\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='TLLWgLJwSql5VHXoMB2px1n4BCEhATMo'\nGB_PAY_GATEWAY='https://api.globalprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1700,"wires":[["fef12be1.030f88"]]},{"id":"8b5686d1.cd1258","type":"function","z":"f527f707.d5a028","name":"alpha","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='alpha-arislab-platform'\nnes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-uat'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\n\n#RVP\nWEB_URL='https://alpha.arislab.ai/'\nAPI_URL='https://alpha.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab.auth0.com'\nAUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nAUTH0_CLIENT_SECRET='ADW2KScxB32-WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\nAUTH0_SAML_IDP_CERT_FILE='arislab.pem'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://alpha.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://alpha.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\nLOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\n\n#LINE\nSERVER_NAME='ALPHA'\nENABLE_NOTIFICATION=true\n#LINE_NOTIFY_TOKEN='2830X9j2EqirUrFnxtHHd0Sli7edHKpvlhTVnAm3zuJ'\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz'\nGB_PAY_GATEWAY='https://api.gbprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1740,"wires":[["fef12be1.030f88"]]},{"id":"57cc99e6.45c2b8","type":"function","z":"f527f707.d5a028","name":"beta","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='arislab-platform'\nnes='elastic:Ptox6rGdRdhr5gajOIZBXZQn@893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243'\n\n#FB APP\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://landing.arislab.ai/'\nAPI_URL='https://landing.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nHOMEPAGE_HOST='localhost'\nHOMEPAGE_PORT=5000\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n\n#LOG\nLOG_DESTINATION='/home/arislab.ai/arislab-console/console/public/logs'\nLOG_FOLDER='/home/arislab.ai/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1780,"wires":[["fef12be1.030f88"]]},{"id":"99400a8c.1bb7b8","type":"change","z":"2880ede8.a08db2","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":160,"wires":[["28f3dc2a.2d7c04"]]},{"id":"84108a95.b4eca8","type":"change","z":"2880ede8.a08db2","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":200,"wires":[["28f3dc2a.2d7c04"]]},{"id":"b8487f4a.799b3","type":"change","z":"2880ede8.a08db2","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":240,"wires":[["28f3dc2a.2d7c04"]]},{"id":"28f3dc2a.2d7c04","type":"function","z":"2880ede8.a08db2","name":"SET_ORDER_ID_TO_API","func":"msg.url+= `?orderID=${msg.orderDocID}`;\n\nnode.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":160,"wires":[["ad1a6e30.ddd0f"]]},{"id":"4946dbb4.b11a24","type":"http in","z":"2880ede8.a08db2","name":"","url":"/checkSingleOrderStatus","method":"get","upload":false,"swaggerDoc":"","x":140,"y":160,"wires":[["d5236a35.7bafe8"]]},{"id":"86cdbfcf.6a437","type":"function","z":"2880ede8.a08db2","name":"","func":"let orderDocID = msg.payload.orderDocID;\n\nmsg.orderDocID = orderDocID;\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":160,"wires":[["b8487f4a.799b3"]]},{"id":"d5236a35.7bafe8","type":"switch","z":"2880ede8.a08db2","name":"with ?orderDocID querystring or not","property":"payload.orderDocID","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":160,"wires":[["86cdbfcf.6a437"],["46effe2a.bb142"]]},{"id":"46effe2a.bb142","type":"function","z":"2880ede8.a08db2","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Order ID must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":200,"wires":[["f9116b1.4689998"]]},{"id":"f9116b1.4689998","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":370,"y":240,"wires":[]},{"id":"ad1a6e30.ddd0f","type":"http request","z":"2880ede8.a08db2","name":"GET_ORDER","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1080,"y":200,"wires":[["9da745.2c7fa8b8"]]},{"id":"9da745.2c7fa8b8","type":"function","z":"2880ede8.a08db2","name":"SAVE_ORDER_TO_MSG_OBJ","func":"msg.orderInfo = msg.payload;\nmsg.orderInfo['orderDocID'] = msg.orderDocID;\nmsg.storeID = msg.orderInfo.storeID;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":240,"wires":[["6601bd97.a64284"]]},{"id":"6601bd97.a64284","type":"function","z":"2880ede8.a08db2","name":"SET_BODY_TO_GET_STORE_INFO","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/businessProfile/storeID/${msg.storeID}/`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":1490,"y":160,"wires":[["ae38d391.9bbb5"]]},{"id":"ae38d391.9bbb5","type":"http request","z":"2880ede8.a08db2","name":"GET_STORE_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1440,"y":200,"wires":[["68e93639.454e88"]]},{"id":"da86c425.a51558","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":4150,"y":380,"wires":[]},{"id":"68e93639.454e88","type":"function","z":"2880ede8.a08db2","name":"SAVE_STORE_TO_MSG_OBJ","func":"msg.storeInfo = msg.payload;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1470,"y":240,"wires":[["c3bc363c.1c39d8"]]},{"id":"b6ba9409.f3c3d8","type":"http request","z":"2880ede8.a08db2","name":"GET_GB_ACCOUNT","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1840,"y":200,"wires":[["770b7a04.a4b984"]]},{"id":"c3bc363c.1c39d8","type":"function","z":"2880ede8.a08db2","name":"SET_BODY_TO_GET_GB_ACCOUNT","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/gbpayAccount/findByToken`;\nmsg.payload = {\n    \"token\": msg.storeInfo.storeInfo.paymentInfo.gbPayInfo.token\n};\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1890,"y":160,"wires":[["b6ba9409.f3c3d8"]]},{"id":"770b7a04.a4b984","type":"function","z":"2880ede8.a08db2","name":"SAVE_GB_ACCOUNT_TO_MSG_OBJ","func":"msg.gbPayAccountObj = msg.payload.gbPayAccountInfo;\nmsg.gbPayAccountObj.found = true;\n\nmsg.currentOrder = msg.orderInfo;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1890,"y":240,"wires":[["dc253ed1.482c1"]]},{"id":"dc253ed1.482c1","type":"function","z":"2880ede8.a08db2","name":"CHECK_WITH_REFNO","func":"let order = msg.orderInfo;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\n// let gbPayLink = order['paymentInfo']['gbPayLink'];\n// let gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2330,"y":160,"wires":[["4ddd21ce.98845"]]},{"id":"4ddd21ce.98845","type":"function","z":"2880ede8.a08db2","name":"SET_HEADERS","func":"const gbPayAccountObj = msg.gbPayAccountObj;\n\nvar SECRET_KEY = \"\";\n\nif (gbPayAccountObj['found']) {\n    SECRET_KEY = gbPayAccountObj['secret_key'];\n}\n\nmsg.headers = {}\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nmsg.url = \"https://api.gbprimepay.com/v1/check_status_txn\";\n\n// node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":180,"wires":[["f01973e.e47ff9"]]},{"id":"f01973e.e47ff9","type":"http request","z":"2880ede8.a08db2","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2670,"y":220,"wires":[["f957cb02.18ccf8","2e19dd97.e850b2"]]},{"id":"775f726b.906c6c","type":"function","z":"2880ede8.a08db2","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2330,"y":220,"wires":[["4ddd21ce.98845"]]},{"id":"f957cb02.18ccf8","type":"switch","z":"2880ede8.a08db2","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2680,"y":280,"wires":[["b832a46c.bc81c8"],["dee413da.631fb"]]},{"id":"b832a46c.bc81c8","type":"function","z":"2880ede8.a08db2","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"let gbResponseObj = msg.payload;\nmsg.gbResponseObj = gbResponseObj;\n\nlet apiUrl = msg.apiUrl;\n\nlet currentOrder = msg.currentOrder;\nlet storeID = currentOrder['storeID'];\nlet orderDocID = currentOrder['orderDocID'];\nlet paymentMethod = gbResponseObj['txn']['status'];\nlet gbpReferenceNo = gbResponseObj['txn']['gbpReferenceNo'];\n// let paymentCompletedOn = paymentResponseObj.paymentCompletedOn;\n\n\nvar paymentStatus = \"PENDING\";\n\nif( gbResponseObj['txn'].hasOwnProperty('cardNo') ) {\n    paymentMethod = \"CREDIT_CARD\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'S') {\n    paymentMethod = \"QR_CODE\";\n    // paymentMethod = \"PAID\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'A') {\n    paymentMethod = \"CREDIT_CARD\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'D') {\n    paymentMethod = \"DECLINE\";\n    paymentStatus = \"FAIL\";\n} else if (paymentMethod === 'G') {\n    paymentMethod = \"QR_CODE\";\n    paymentStatus = \"SUCCESS\";\n}\n\ncurrentOrder['resultPaymentStatus'] = paymentStatus;\nmsg.currentOrder = currentOrder;\n\n// let customerInfo = paymentResponseObj.customerInfo;\n\nlet url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.url = url;\nmsg.payload = {\n    \"paymentInfo\": {\n        \"method\": paymentMethod,\n        \"status\": paymentStatus,\n        \"details\": gbpReferenceNo,\n        // \"paymentCompletedOn\": paymentCompletedOn,\n        \"isFromBatchCheck\": true,\n        \"batchCheckTimestamp\": Date.now(),\n        \"gbPaymentDetails\": {\n            \"customerName\": gbResponseObj['txn']['customerName'],\n            \"customerEmail\": gbResponseObj['txn']['customerEmail'],\n            // \"customerAddress\": gbResponseObj['txn']['customerName'],\n            // \"customerTelephone\": gbResponseObj['txn']['customerName']\n        }\n    }\n}\n\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":3140,"y":260,"wires":[["cdcc39f1.f1b8c8"]]},{"id":"8bf7af95.99c91","type":"function","z":"2880ede8.a08db2","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":3450,"y":300,"wires":[["e2e75ce4.b6f8b"],["af32fdfc.40638"]]},{"id":"dee413da.631fb","type":"switch","z":"2880ede8.a08db2","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2760,"y":340,"wires":[["67861493.f72c3c"],["f0cd494b.ccf228"]]},{"id":"f0cd494b.ccf228","type":"function","z":"2880ede8.a08db2","name":"Can't find REF_NO and LINK_NO 😢","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${orderID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)","outputs":1,"noerr":0,"x":2970,"y":400,"wires":[[]]},{"id":"67861493.f72c3c","type":"link out","z":"2880ede8.a08db2","name":"LINK_NO_OUT","links":["d4c24441.d948c8","157c055c.d842db","35430b44.daf734"],"x":2915,"y":320,"wires":[]},{"id":"35430b44.daf734","type":"link in","z":"2880ede8.a08db2","name":"","links":["67861493.f72c3c"],"x":2175,"y":220,"wires":[[]]},{"id":"af32fdfc.40638","type":"function","z":"2880ede8.a08db2","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nnode.error(`Recipient type of this order (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`)","outputs":1,"noerr":0,"x":3520,"y":360,"wires":[[]]},{"id":"3f99194c.91aca6","type":"http request","z":"2880ede8.a08db2","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3920,"y":380,"wires":[["da86c425.a51558"]]},{"id":"e2e75ce4.b6f8b","type":"function","z":"2880ede8.a08db2","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":3940,"y":260,"wires":[["ef0d5864.f7d938"]]},{"id":"ef0d5864.f7d938","type":"http request","z":"2880ede8.a08db2","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3900,"y":300,"wires":[["da1eb9b0.0f5908"]]},{"id":"da1eb9b0.0f5908","type":"function","z":"2880ede8.a08db2","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":3950,"y":340,"wires":[["3f99194c.91aca6"]]},{"id":"cdcc39f1.f1b8c8","type":"http request","z":"2880ede8.a08db2","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3080,"y":300,"wires":[["8bf7af95.99c91"]]},{"id":"74b194c7.518cec","type":"subflow:399766a6.56b85a","z":"54db45d9.f3c69c","name":"","env":[],"x":630,"y":300,"wires":[["c9a8c752.09d298","74f17847.37b038"]]},{"id":"4953bbe1.134124","type":"inject","z":"54db45d9.f3c69c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":180,"wires":[["4d6b8fdd.8ebed"]]},{"id":"40f3a2fa.e232cc","type":"inject","z":"54db45d9.f3c69c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":320,"wires":[["65789f51.e8656"]]},{"id":"2710065e.3926fa","type":"inject","z":"54db45d9.f3c69c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":460,"wires":[["213d4a13.3b5fc6"]]},{"id":"186808ff.fed737","type":"comment","z":"54db45d9.f3c69c","name":"DEV","info":"","x":330,"y":140,"wires":[]},{"id":"23b0523a.6cd5ee","type":"comment","z":"54db45d9.f3c69c","name":"ALPHA","info":"","x":330,"y":280,"wires":[]},{"id":"80b59977.5b0708","type":"comment","z":"54db45d9.f3c69c","name":"PROD","info":"","x":330,"y":420,"wires":[]},{"id":"4d6b8fdd.8ebed","type":"change","z":"54db45d9.f3c69c","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":220,"wires":[[]]},{"id":"65789f51.e8656","type":"change","z":"54db45d9.f3c69c","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":360,"wires":[[]]},{"id":"213d4a13.3b5fc6","type":"change","z":"54db45d9.f3c69c","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":500,"wires":[["74b194c7.518cec"]]},{"id":"a11aa5cb.1d8a98","type":"function","z":"399766a6.56b85a","name":"INIT_REQUEST_FOR_GETTING_UNENRICHED_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/order/_search?size=100`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"exists\": {\n            \"field\": \"userInfo.firstName\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.firstName.keyword\": \"\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.lastName.keyword\": \"\"\n          }\n        }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":180,"wires":[["555cdfab.a183b","f28dfa8c.f232e8"]]},{"id":"555cdfab.a183b","type":"debug","z":"399766a6.56b85a","name":"GET_UNENRICHED_ORDERS_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":180,"wires":[]},{"id":"9342acce.76168","type":"debug","z":"399766a6.56b85a","name":"GET_UNENRICHED_ORDERS_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":220,"wires":[]},{"id":"a1424acf.1772b8","type":"debug","z":"399766a6.56b85a","name":"GET_UNENRICHED_ORDERS_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":260,"wires":[]},{"id":"15bd8a50.652d36","type":"change","z":"399766a6.56b85a","name":"","rules":[{"t":"set","p":"unenrichedOrders","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":260,"wires":[["a1424acf.1772b8"]]},{"id":"f28dfa8c.f232e8","type":"http request","z":"399766a6.56b85a","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":330,"y":220,"wires":[["9342acce.76168","15bd8a50.652d36"]]},{"id":"93ccb0ea.659a6","type":"subflow:d9807e99.e20e","z":"399766a6.56b85a","name":"","env":[],"x":370,"y":140,"wires":[["a11aa5cb.1d8a98"]]},{"id":"c9a8c752.09d298","type":"debug","z":"54db45d9.f3c69c","name":"GET_UNENRICHED_ORDERS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":990,"y":300,"wires":[]},{"id":"61c36277.ecae2c","type":"function","z":"8e9669d8.a92928","name":"INIT_REQUEST_FOR_GETTING_USER_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst userPSID = msg.userPSID;\nconst url = `https://${nes}/njoin-${nuser}/user/${userPSID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.userInfo = {\n    \"firstName\": \"\",\n    \"lastName\": \"\"\n};\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["d7ee9aff.32e948","3d9c2a7c.cd6cc6"]]},{"id":"d7ee9aff.32e948","type":"debug","z":"8e9669d8.a92928","name":"GET_USER_INFO_BY_PSID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":140,"wires":[]},{"id":"3c2e8914.ca26e6","type":"debug","z":"8e9669d8.a92928","name":"GET_USER_INFO_BY_PSID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":180,"wires":[]},{"id":"5ba5f761.6f7cc8","type":"debug","z":"8e9669d8.a92928","name":"GET_USER_INFO_BY_PSID_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":680,"wires":[]},{"id":"dfd66170.da834","type":"change","z":"8e9669d8.a92928","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload._source.info.facebook.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload._source.info.facebook.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":560,"wires":[["5ba5f761.6f7cc8"]]},{"id":"88716218.7cfaa","type":"subflow:d9807e99.e20e","z":"8e9669d8.a92928","name":"","env":[],"x":290,"y":100,"wires":[["61c36277.ecae2c"]]},{"id":"74f17847.37b038","type":"function","z":"54db45d9.f3c69c","name":"ITERATE_OVER_UNENRICHED_ORDERS","func":"const unenrichedOrdersList = msg.unenrichedOrders.hits.hits;\n\nunenrichedOrdersList.forEach((order, index) => {\n    setTimeout(() => {\n        msg.UnenrichedOrderDocID = order._id;\n        msg.currentUnenrichedOrder = order._source;\n        msg.userPSID = order._source.userID;\n        node.send(msg);\n    }, 500 * index);\n});","outputs":1,"noerr":0,"x":660,"y":340,"wires":[["61332d3c.055f44"]]},{"id":"61332d3c.055f44","type":"subflow:8e9669d8.a92928","z":"54db45d9.f3c69c","name":"","env":[],"x":620,"y":380,"wires":[["62aa82ef.6f104c","e760997c.2fee18"]]},{"id":"62aa82ef.6f104c","type":"debug","z":"54db45d9.f3c69c","name":"GET_USER_INFO_BY_PSID_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":980,"y":380,"wires":[]},{"id":"3d9c2a7c.cd6cc6","type":"http request","z":"8e9669d8.a92928","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["3c2e8914.ca26e6","7e34e594.4d0d3c"]]},{"id":"2f92dae2.1928e6","type":"subflow:d9807e99.e20e","z":"1819ea43.73b6e6","name":"","env":[],"x":350,"y":180,"wires":[["82b59f21.f417c"]]},{"id":"82b59f21.f417c","type":"function","z":"1819ea43.73b6e6","name":"INIT_REQUEST_UPDATE_ORDER","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst docID = msg.UnenrichedOrderDocID;\n\nconst url = `https://${nes}/${platform_index}/order/${docID}/_update`;\n\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nconst updateBody = msg.UnenrichedOrderUpdateBody;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nmsg.payload = {\n    \"doc\": {\n        \"userInfo\": {\n            \"firstName\": updateBody['firstName'],\n            \"lastName\": updateBody['lastName']\n        }\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":220,"wires":[["2e65c707.574318","4d6404e6.142edc"]]},{"id":"2e65c707.574318","type":"http request","z":"1819ea43.73b6e6","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":310,"y":260,"wires":[["9da94ab.157bfb8"]]},{"id":"11b1157b.b0855b","type":"subflow:1819ea43.73b6e6","z":"54db45d9.f3c69c","name":"","env":[],"x":610,"y":500,"wires":[["50b18628.cdb6e8"]]},{"id":"4d6404e6.142edc","type":"debug","z":"1819ea43.73b6e6","name":"UPDATE_ORDER_BY_ID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":790,"y":220,"wires":[]},{"id":"9da94ab.157bfb8","type":"debug","z":"1819ea43.73b6e6","name":"UPDATE_ORDER_BY_ID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":260,"wires":[]},{"id":"50b18628.cdb6e8","type":"function","z":"54db45d9.f3c69c","name":"","func":"if (msg.payload.result === \"updated\") {\n    node.error('Update userID: ' + msg.userPSID + ' of orderID: ' + msg.currentUnenrichedOrder.orderID + ' successful')\n}\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":540,"wires":[[]]},{"id":"e760997c.2fee18","type":"function","z":"54db45d9.f3c69c","name":"","func":"msg.UnenrichedOrderUpdateBody = msg.userInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":440,"wires":[["11b1157b.b0855b"]]},{"id":"7e34e594.4d0d3c","type":"function","z":"8e9669d8.a92928","name":"CHECK_USER_IS_UNDEFINED","func":"const sourceObj = msg.payload._source;\nconst fbName = sourceObj.info.facebook.name;\nconst fbPSID = sourceObj.info.facebook.id;\nconst pageToken = sourceObj.info._channel.config.token;\n\nif (\n    fbName === \"undefined undefined\" &&\n    sourceObj.info.facebook.hasOwnProperty('first_name') === false &&\n    sourceObj.info.facebook.hasOwnProperty('last_name') === false\n) {\n    node.error('This user info is un-enriched, re-enriching..');\n    msg.enrichPSID = fbPSID;\n    msg.enrichToken = pageToken;\n    return [msg, null];\n} else {\n    node.error('This user info is already enriched')\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":310,"y":340,"wires":[["60a093c1.da856c"],["dfd66170.da834"]]},{"id":"60a093c1.da856c","type":"subflow:ad109f4f.2bbca","z":"8e9669d8.a92928","name":"","env":[],"x":590,"y":280,"wires":[["47b9481d.361e78","89e9aa61.ca84f8"]]},{"id":"47b9481d.361e78","type":"debug","z":"8e9669d8.a92928","name":"enrich_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"fefa89b3.c78958","type":"change","z":"8e9669d8.a92928","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":380,"wires":[[]]},{"id":"89e9aa61.ca84f8","type":"function","z":"8e9669d8.a92928","name":"CHECK_ENRICH_RESPONSE","func":"const reqResponse = msg.payload;\n\nif (\n    reqResponse.hasOwnProperty('first_name') &&\n    reqResponse.hasOwnProperty('last_name')\n) {\n    node.error('Enrich user successful');\n    return [msg, null];\n} else {\n    node.error('Error while enriching user: ');\n    node.error(reqResponse);\n    return [msg, null];\n}","outputs":2,"noerr":0,"x":660,"y":340,"wires":[["fefa89b3.c78958"],[]]},{"id":"90a9c5cf.e51198","type":"cronplus","z":"54db45d9.f3c69c","name":"","outputField":"payload","timeZone":"","options":[{"topic":"Every 5AM","payload":"","type":"str","expression":"0 5 * * *"}],"x":100,"y":320,"wires":[["213d4a13.3b5fc6"]]},{"id":"e4ab3bfb.f20668","type":"cronplus","z":"3ab4a75f.ad0fa8","name":"","outputField":"payload","timeZone":"","options":[{"topic":"Every 6AM","payload":"","type":"str","expression":"0 6 * * *"},{"topic":"Every 12PM","payload":"","type":"str","expression":"0 12 * * *"},{"topic":"Every 6PM","payload":"","type":"str","expression":"0 18 * * *"}],"x":80,"y":220,"wires":[[]]},{"id":"e34ce52e.b8f558","type":"inject","z":"3ab4a75f.ad0fa8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":80,"wires":[["b086f233.8041d"]]},{"id":"ed10bfd6.01b4d","type":"inject","z":"3ab4a75f.ad0fa8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":220,"wires":[["a1393e8c.bf88b"]]},{"id":"33f2727c.286cae","type":"inject","z":"3ab4a75f.ad0fa8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":360,"wires":[["8c90753a.d2d268"]]},{"id":"5c5bd506.1693cc","type":"comment","z":"3ab4a75f.ad0fa8","name":"DEV","info":"","x":270,"y":40,"wires":[]},{"id":"fe911d22.728a1","type":"comment","z":"3ab4a75f.ad0fa8","name":"ALPHA","info":"","x":270,"y":180,"wires":[]},{"id":"578fdfeb.32fd4","type":"comment","z":"3ab4a75f.ad0fa8","name":"PROD","info":"","x":270,"y":320,"wires":[]},{"id":"b086f233.8041d","type":"change","z":"3ab4a75f.ad0fa8","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":120,"wires":[["b95fbb0b.dc9ec8"]]},{"id":"a1393e8c.bf88b","type":"change","z":"3ab4a75f.ad0fa8","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":260,"wires":[["b95fbb0b.dc9ec8"]]},{"id":"8c90753a.d2d268","type":"change","z":"3ab4a75f.ad0fa8","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":400,"wires":[["b95fbb0b.dc9ec8"]]},{"id":"2f8e5205.1e902e","type":"function","z":"bf305289.c33db","name":"INIT_REQUEST_FOR_UPDATING_FIELD_WITH_SCRIPT","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst type = msg.updateType;\nconst url = `https://${nes}/${platform_index}/${type}/_update_by_query`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\nconst query = JSON.parse(msg.updateQuery);\nconst script = JSON.parse(msg.updateScript);\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nlet tempPayload = {};\ntempPayload['query'] = query;\ntempPayload['script'] = script;\n\nmsg.payload = JSON.stringify(tempPayload);\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["7c701d9f.398484","eb5acf2a.24e27"]]},{"id":"9ca4ec7f.d8909","type":"change","z":"bf305289.c33db","name":"","rules":[{"t":"set","p":"resultUpdateFieldWithScript","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":240,"wires":[["840750e0.630e2"]]},{"id":"7c701d9f.398484","type":"http request","z":"bf305289.c33db","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":200,"wires":[["9ca4ec7f.d8909","ae60b6.73d41f48"]]},{"id":"29c40792.f747f8","type":"subflow:d9807e99.e20e","z":"bf305289.c33db","name":"","env":[],"x":330,"y":120,"wires":[["2f8e5205.1e902e","b14ec3ed.76a93"]]},{"id":"f5eebb40.bf2878","type":"comment","z":"bf305289.c33db","name":"Params: updateType / updateQuery / updateScript","info":"**msg.updateType:** Type to update\n**msg.updateQuery:** Query to execute\n**msg.updateScript:** Script to execute","x":390,"y":60,"wires":[]},{"id":"88c136aa.4f0768","type":"subflow:bf305289.c33db","z":"3ab4a75f.ad0fa8","name":"","env":[],"x":1090,"y":220,"wires":[[]]},{"id":"cf1c2d64.98204","type":"function","z":"3ab4a75f.ad0fa8","name":"[STORE] SET_FILTERDATE_FIELD","func":"msg.updateType = \"store\";\nmsg.updateQuery = JSON.stringify({\n    \"bool\": {\n        \"must_not\": [\n            { \"exists\": { \"field\": \"filterDate\" } }\n        ]\n    }\n});\n\nmsg.updateScript = JSON.stringify({\n    \"source\": \"ctx._source.filterDate = ctx._source.createdAt\",\n    \"lang\": \"painless\"\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":220,"wires":[["88c136aa.4f0768"]]},{"id":"b14ec3ed.76a93","type":"debug","z":"bf305289.c33db","name":"UPDATE_FIELD_WITH_SCRIPT_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":120,"wires":[]},{"id":"eb5acf2a.24e27","type":"debug","z":"bf305289.c33db","name":"UPDATE_FIELD_WITH_SCRIPT_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":160,"wires":[]},{"id":"ae60b6.73d41f48","type":"debug","z":"bf305289.c33db","name":"UPDATE_FIELD_WITH_SCRIPT_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":200,"wires":[]},{"id":"840750e0.630e2","type":"debug","z":"bf305289.c33db","name":"UPDATE_FIELD_WITH_SCRIPT_debug4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":240,"wires":[]},{"id":"9f8b1436.a54138","type":"function","z":"3ab4a75f.ad0fa8","name":"[PRODUCT] SET_FILTERDATE_FIELD","func":"msg.updateType = \"product\";\nmsg.updateQuery = JSON.stringify({\n    \"bool\": {\n        \"must_not\": [\n            { \"exists\": { \"field\": \"filterDate\" } }\n        ]\n    }\n});\n\nmsg.updateScript = JSON.stringify({\n    \"source\": \"if (ctx._source.containsKey(\\\"productInfo\\\") && ctx._source.productInfo.containsKey(\\\"createAt\\\")) { ctx._source.filterDate = ctx._source.productInfo.createAt }\",\n    \"lang\": \"painless\"\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":260,"wires":[["b36bab6b.050718"]]},{"id":"99bc8504.c7db88","type":"function","z":"3ab4a75f.ad0fa8","name":"[ORDER] SET_FILTERDATE_FIELD","func":"msg.updateType = \"order\";\nmsg.updateQuery = JSON.stringify({\n    \"bool\": {\n        \"must_not\": [\n            { \"exists\": { \"field\": \"filterDate\" } }\n        ]\n    }\n});\n\nmsg.updateScript = JSON.stringify({\n    \"source\": \"ctx._source.filterDate = ctx._source.orderDate\",\n    \"lang\": \"painless\"\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":300,"wires":[["8ffef14a.c395d"]]},{"id":"b36bab6b.050718","type":"subflow:bf305289.c33db","z":"3ab4a75f.ad0fa8","name":"","env":[],"x":1090,"y":260,"wires":[[]]},{"id":"8ffef14a.c395d","type":"subflow:bf305289.c33db","z":"3ab4a75f.ad0fa8","name":"","env":[],"x":1090,"y":300,"wires":[[]]},{"id":"b95fbb0b.dc9ec8","type":"function","z":"3ab4a75f.ad0fa8","name":"","func":"node.error('Updating fields...')\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":260,"wires":[["99bc8504.c7db88","9f8b1436.a54138","cf1c2d64.98204"]]},{"id":"6e509cb2.754a74","type":"function","z":"a926ea52.1ac368","name":"","func":"node.error(`Can't check order, error:`);\nnode.error(msg.payload)\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":520,"wires":[["df2163b.919daa"]]},{"id":"a1c5e4ed.f38ba8","type":"http in","z":"bd1a26e8.d70568","name":"","url":"/getPlatformPackage","method":"get","upload":false,"swaggerDoc":"","x":150,"y":120,"wires":[["57115763.9128f8"]]},{"id":"2d8029c4.fcecc6","type":"function","z":"bd1a26e8.d70568","name":"CHECK_QUERY_PARAMS","func":"let packageName = msg.payload.packageName;\nlet data;\n\nif( typeof packageName == 'undefined' ) {\n    data = msg.PACKAGE_LIST;\n} else {\n    packageName = packageName.toUpperCase();\n    if( msg.PACKAGE_NAME_INDEX.hasOwnProperty(packageName) ) {\n        let index = msg.PACKAGE_NAME_INDEX[packageName];\n        data = msg.PACKAGE_LIST[index];\n    } else {\n        data = msg.PACKAGE_LIST;\n    }\n}\n\n\nmsg.statusCode = 200;\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":160,"wires":[["cbe5108f.7552"]]},{"id":"cbe5108f.7552","type":"http response","z":"bd1a26e8.d70568","name":"","statusCode":"","headers":{},"x":630,"y":160,"wires":[]},{"id":"57115763.9128f8","type":"function","z":"bd1a26e8.d70568","name":"SET_ALL_PACKAGE","func":"\nconst PACKAGE_LIST = [\n    {\n        \"name\": \"Free Trial\",\n        \"code\": \"000\",\n        \"description\": \"1 Month\",\n        \"isSubscribePackage\": false,\n        \"memberPrice\": 0,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"FIX\",\n            \"billingDate\": 0\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 0,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Beginner\",\n        \"code\": \"001\",\n        \"description\": \"\",\n        \"isSubscribePackage\": false,\n        \"memberPrice\": 0,\n        \"activeDays\": 36500,\n        \"billingInfo\": {\n            \"billingType\": \"\",\n            \"billingDate\": 0\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Standard\",\n        \"code\": \"002\",\n        \"description\": \"\",\n        \"isSubscribePackage\": true,\n        \"memberPrice\": 990,\n        //\"memberPrice\": 20,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"MONTHLY\",\n            \"billingDate\": 1\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 3,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Pro\",\n        \"code\": \"003\",\n        \"description\": \"\",\n        \"isSubscribePackage\": true,\n        \"memberPrice\": 4900,\n        //\"memberPrice\": 40,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"MONTHLY\",\n            \"billingDate\": 1\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 1,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Expert\",\n        \"code\": \"004\",\n        \"description\": \"\",\n        \"isSubscribePackage\": true,\n        \"memberPrice\": 9900,\n        //\"memberPrice\": 60,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"MONTHLY\",\n            \"billingDate\": 1\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 0,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    }\n];\n\nconst PACKAGE_NAME_INDEX = {\n    \"DEFAULT\": 0,\n    \"FREE\": 0,\n    \"FREE TRIAL\": 0,\n    \"BEGINNER\": 1,\n    \"STANDARD\": 2,\n    \"PRO\": 3,\n    \"EXPERT\": 4\n};\n\n\nmsg.PACKAGE_LIST = PACKAGE_LIST;\nmsg.PACKAGE_NAME_INDEX = PACKAGE_NAME_INDEX;\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":120,"wires":[["2d8029c4.fcecc6"]]},{"id":"359f0553.a07a9a","type":"http in","z":"1db78bed.51e4f4","name":"","url":"/_calculateServiceFee","method":"post","upload":false,"swaggerDoc":"","x":160,"y":400,"wires":[["3b2c8cb4.0ab304","c1f6d19e.c8c78"]]},{"id":"3b2c8cb4.0ab304","type":"function","z":"1db78bed.51e4f4","name":"SET_DEFAULT_FEE_PERCENTAGE","func":"let payloadData = msg.payload;\nlet nuser = payloadData.nuser;\nlet paymentInfo = payloadData.paymentInfo;\nlet storeID = payloadData.storeID;\n\nvar feePercentage = {\n    \"DEV\": {\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        },\n        \"apiUrl\": \"http://console.internal.arislab.ai:1780/api\"\n    },\n    \"ALPHA\": {\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        },\n        \"apiUrl\": \"http://console.cb-alpha.arislab.ai:1780/api\"\n    },\n    \"PROD\": {\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        },\n        \"apiUrl\": \"http://console.cb-beta.arislab.ai:1780/api\"\n    },\n};\n\nlet env = \"\";\nswitch(nuser) {\n    case \"arislab-dev\":\n        env = \"DEV\";\n        break;\n    case \"arislab-uat\":\n        env = \"ALPHA\";\n        break;\n    default:\n        env = \"PROD\";\n}\n\n\nmsg.defaultFeeInfo = feePercentage[env][\"feeInfo\"];\nmsg.apiUrl = feePercentage[env][\"apiUrl\"];\nmsg.storeID = storeID;\nmsg.paymentInfo = paymentInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":400,"wires":[["bfa2168b.30cbd8","cae4d769.957a18"]]},{"id":"c1f6d19e.c8c78","type":"debug","z":"1db78bed.51e4f4","name":"REQUEST_POST_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":490,"y":340,"wires":[]},{"id":"bfa2168b.30cbd8","type":"debug","z":"1db78bed.51e4f4","name":"SET_DEFAULT_FEE_PERCENTAGE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":400,"wires":[]},{"id":"cae4d769.957a18","type":"function","z":"1db78bed.51e4f4","name":"GET_CURRENT_STORE_PACKAGE","func":"let storeID = msg.storeID;\n\nlet requestUrl = `${msg.apiUrl}/storePackage/storeID/${storeID}/current`;\nmsg.url = requestUrl;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":440,"wires":[["31032489.5abccc"]]},{"id":"31032489.5abccc","type":"http request","z":"1db78bed.51e4f4","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":470,"y":480,"wires":[["20ffe442.f23b6c","e8a12096.441ef"]]},{"id":"30f55d96.f4b1b2","type":"http response","z":"1db78bed.51e4f4","name":"","statusCode":"","headers":{},"x":450,"y":640,"wires":[]},{"id":"20ffe442.f23b6c","type":"debug","z":"1db78bed.51e4f4","name":"RESULT_CURRENT_STORE_PACKAGE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":930,"y":480,"wires":[]},{"id":"8348f527.0140f8","type":"function","z":"1db78bed.51e4f4","name":"CHECK_PAYMENT_KEY_DATA","func":"let paymentInfo = msg.paymentInfo;\nlet paymentKeyData = \"\";\n\nif( paymentInfo.hasOwnProperty('cardNo') && paymentInfo.cardNo.length > 0 ) {\n    paymentKeyData = \"creditCardService\";\n    paymentMethod = \"CREDIT_CARD\";\n} else {\n    paymentKeyData = \"qrCodeService\";\n    paymentMethod = \"QR_CODE\";\n}\n\nmsg.paymentKeyData = paymentKeyData;\nmsg.paymentMethod = paymentMethod;\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":560,"wires":[["e8baff06.bd83f","4996eda6.c1fb34"]]},{"id":"e8a12096.441ef","type":"function","z":"1db78bed.51e4f4","name":"SET_PACKAGE_FEE_INFO","func":"let payloadData = msg.payload;\nlet packageFeeInfo;\n\nif( payloadData.length > 0 ) {\n    packageFeeInfo = payloadData[0]['packageInfo']['feeInfo'];\n} else {\n    packageFeeInfo = msg.defaultFeeInfo;\n}\n\nmsg.packageFeeInfo = packageFeeInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":520,"wires":[["8348f527.0140f8","722996e4.f268e8"]]},{"id":"e8baff06.bd83f","type":"function","z":"1db78bed.51e4f4","name":"CALCULATE_PAYMENT_FEE","func":"let paymentKeyData = msg.paymentKeyData;\nlet paymentMethod = msg.paymentMethod;\nlet packageFeeInfo = msg.packageFeeInfo;\nlet paymentInfo = msg.paymentInfo;\n\nlet amount = Number(paymentInfo.amount);\nlet paymentGatewayFeeInfo = {};\nlet feeList = [];\nlet fee = 0;\n\n\nfunction calculateFee(feeType, packageFeeInfo) {\n    let returnObj = {};\n    if( packageFeeInfo.hasOwnProperty(feeType) ) {\n        returnObj = packageFeeInfo[feeType];\n        \n        let charge = returnObj['charge'];\n        let amountCharge = 0;\n        if( returnObj['chargeType'] === \"PERCENT\" ) {\n            amountCharge = Number( parseFloat((amount * charge) / 100).toFixed(2) );\n        } else {\n            amountCharge = Number( parseFloat(amount - charge) );\n        }\n        \n        \n        returnObj['serviceType'] = ( feeType === \"service\" ) ? \"SERVICE_FEE\" : \"PAYMENT_GATEWAY_FEE\" ;\n        returnObj['amountCharge'] = amountCharge;\n    }\n    \n    return returnObj;\n}\n\nlet serviceFeeInfo = calculateFee('service', packageFeeInfo);\nlet paymentFeeInfo = calculateFee(paymentKeyData, packageFeeInfo);\n\nif( serviceFeeInfo.hasOwnProperty('amountCharge') ) {\n    fee+= serviceFeeInfo['amountCharge'];\n    feeList.push(serviceFeeInfo);\n}\n    \nif( paymentFeeInfo.hasOwnProperty('amountCharge') ) {\n    fee+= paymentFeeInfo['amountCharge'];\n    feeList.push(paymentFeeInfo);\n}\n\n\n// if( packageFeeInfo.hasOwnProperty('service') ) {\n//     let serviceFeeInfo = packageFeeInfo['service'];\n//     let charge = serviceFeeInfo['charge'];\n//     let amountCharge = 0;\n//     if( serviceFeeInfo['chargeType'] === \"PERCENT\" ) {\n//         amountCharge = Number( parseFloat((amount * charge) / 100).toFixed(2) );\n//     } else {\n//         amountCharge = Number( parseFloat(amount - charge) );\n//     }\n    \n//     fee+= amountCharge;\n    \n//     serviceFeeInfo['serviceType'] = \"SERVICE_FEE\";\n//     serviceFeeInfo['amountCharge'] = amountCharge;\n// }\n\nlet totalAmount = amount - fee;\n\nmsg.payload = {\n    \"paymentMethod\": paymentMethod,\n    \"amount\": amount,\n    \"fee\": fee,\n    \"feeList\": feeList,\n    \"totalAmount\": totalAmount\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":600,"wires":[["30f55d96.f4b1b2","78439888.81b878","75441c89.ad9e94"]]},{"id":"722996e4.f268e8","type":"debug","z":"1db78bed.51e4f4","name":"SET_PACKAGE_FEE_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":520,"wires":[]},{"id":"4996eda6.c1fb34","type":"debug","z":"1db78bed.51e4f4","name":"CHECK_PAYMENT_KEY_DATA_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":900,"y":560,"wires":[]},{"id":"78439888.81b878","type":"debug","z":"1db78bed.51e4f4","name":"CALCULATE_PAYMENT_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":600,"wires":[]},{"id":"75441c89.ad9e94","type":"debug","z":"1db78bed.51e4f4","name":"RESPONSE_CALULATE_SERVICE_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":930,"y":640,"wires":[]},{"id":"2ec16a48.5f1036","type":"function","z":"2880ede8.a08db2","name":"PREPARE_CALCULATE_SERVICE_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateServiceFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    },\n    \"storeID\": currentOrder['storeID']\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":3800,"y":560,"wires":[["4fa1ae28.fa48a"]]},{"id":"4fa1ae28.fa48a","type":"http request","z":"2880ede8.a08db2","name":"CALCULATE_SERVICE_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3770,"y":600,"wires":[["93176fe5.5c1ee"]]},{"id":"93176fe5.5c1ee","type":"function","z":"2880ede8.a08db2","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"feeList\": resultCalculate['feeList'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":3810,"y":640,"wires":[[]]},{"id":"9e58c086.3e85a","type":"function","z":"a926ea52.1ac368","name":"PREPARE_CALCULATE_SERVICE_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateServiceFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    },\n    \"storeID\": currentOrder['storeID']\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2840,"y":760,"wires":[["d4a77db3.fd012"]]},{"id":"d4a77db3.fd012","type":"http request","z":"a926ea52.1ac368","name":"CALCULATE_SERVICE_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2810,"y":800,"wires":[["80805395.7f178"]]},{"id":"80805395.7f178","type":"function","z":"a926ea52.1ac368","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"feeList\": resultCalculate['feeList'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":2850,"y":840,"wires":[[]]},{"id":"2bf11500.8030bc","type":"comment","z":"2880ede8.a08db2","name":"New calculate service fee","info":"","x":3750,"y":520,"wires":[]},{"id":"2d50dd0d.164ec2","type":"comment","z":"a926ea52.1ac368","name":"New calculate service fee","info":"","x":2790,"y":720,"wires":[]},{"id":"16b3a421.0e296c","type":"inject","z":"e9d0b6f8.aa9d68","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":100,"wires":[["eaf80304.4d308"]]},{"id":"b46a871f.5f5cf8","type":"inject","z":"e9d0b6f8.aa9d68","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":240,"wires":[["11f15248.ed7ede"]]},{"id":"997ab077.ae096","type":"inject","z":"e9d0b6f8.aa9d68","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":380,"wires":[["f4019a1e.1d6c18"]]},{"id":"ed746780.db1818","type":"comment","z":"e9d0b6f8.aa9d68","name":"DEV","info":"","x":150,"y":60,"wires":[]},{"id":"bace579d.c6a648","type":"comment","z":"e9d0b6f8.aa9d68","name":"ALPHA","info":"","x":150,"y":200,"wires":[]},{"id":"d8f6f062.85feb","type":"comment","z":"e9d0b6f8.aa9d68","name":"PROD","info":"","x":150,"y":340,"wires":[]},{"id":"eaf80304.4d308","type":"change","z":"e9d0b6f8.aa9d68","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":140,"wires":[["ef0e28e2.ff7788"]]},{"id":"11f15248.ed7ede","type":"change","z":"e9d0b6f8.aa9d68","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":160,"y":280,"wires":[["ef0e28e2.ff7788"]]},{"id":"f4019a1e.1d6c18","type":"change","z":"e9d0b6f8.aa9d68","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":420,"wires":[["ef0e28e2.ff7788"]]},{"id":"fc99e032.d61b7","type":"function","z":"e9d0b6f8.aa9d68","name":"SET_ALL_PACKAGE_INTO_MSG","func":"let packageList = msg.payload;\n\nnode.error(\"Get all package: \");\nnode.error(packageList);\nmsg.PACKAGE_LIST = packageList;\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":180,"wires":[["78de1cc6.48b1f4"]]},{"id":"e6a739dc.97e7c8","type":"function","z":"e9d0b6f8.aa9d68","name":"SET_ALL_STORE_INTO_MSG","func":"let storeList = msg.payload;\n\nnode.error(\"Get all store: \");\nnode.error(storeList);\nmsg.STORE_LIST = storeList;\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":260,"wires":[["13c50d09.1720e3"]]},{"id":"78de1cc6.48b1f4","type":"subflow:d3d9dfef.e84f3","z":"e9d0b6f8.aa9d68","name":"GET_ALL_STORE","env":[],"x":450,"y":220,"wires":[["e6a739dc.97e7c8"]]},{"id":"ef0e28e2.ff7788","type":"subflow:e3259a63.dffef8","z":"e9d0b6f8.aa9d68","name":"GET_ALL_PACKAGE","env":[],"x":460,"y":140,"wires":[["fc99e032.d61b7"]]},{"id":"13c50d09.1720e3","type":"function","z":"e9d0b6f8.aa9d68","name":"INITIAL_INDEX_STORE","func":"msg.indexStore = 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":140,"wires":[["880c28ea.06da98"]]},{"id":"880c28ea.06da98","type":"switch","z":"e9d0b6f8.aa9d68","name":"Index Store = STORE_LIST length?","property":"indexStore","propertyType":"msg","rules":[{"t":"lt","v":"STORE_LIST.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":940,"y":180,"wires":[["4b8df087.c687d"],["6fbbaa41.17e054"]]},{"id":"2bcca560.dfcdda","type":"comment","z":"e9d0b6f8.aa9d68","name":"STORE LOOP","info":"","x":870,"y":100,"wires":[]},{"id":"b5c7ae2c.591ce","type":"function","z":"e9d0b6f8.aa9d68","name":"INCREASE_INDEX_STORE","func":"msg.indexStore++;\nreturn msg;","outputs":1,"noerr":0,"x":920,"y":940,"wires":[["5073179d.a034d8"]]},{"id":"5073179d.a034d8","type":"delay","z":"e9d0b6f8.aa9d68","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1150,"y":940,"wires":[["2847179c.bf72a8"]]},{"id":"2847179c.bf72a8","type":"link out","z":"e9d0b6f8.aa9d68","name":"","links":["67bf543f.af10fc","3cc94b42.40c124"],"x":1275,"y":940,"wires":[]},{"id":"67bf543f.af10fc","type":"link in","z":"e9d0b6f8.aa9d68","name":"","links":["2847179c.bf72a8"],"x":755,"y":180,"wires":[["880c28ea.06da98"]]},{"id":"6fbbaa41.17e054","type":"function","z":"e9d0b6f8.aa9d68","name":"END_STORE_LOOP","func":"node.error(\"End LOOP.\");\n\nreturn msg;","outputs":1,"noerr":0,"x":1280,"y":120,"wires":[[]]},{"id":"4b8df087.c687d","type":"function","z":"e9d0b6f8.aa9d68","name":"INITIAL_PROCESS_STORE","func":"let processStore = msg.STORE_LIST[msg.indexStore];\nmsg.processStore = processStore;\n\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":220,"wires":[["6207b2a3.75d57c"]]},{"id":"f16181aa.be314","type":"function","z":"e9d0b6f8.aa9d68","name":"Has current store package","func":"node.error(`storeID: ${msg.processStore['storeID']} has current store package, 😃 ✔️ go next.....`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1360,"y":300,"wires":[["3c79be18.42e262"]]},{"id":"af33462c.0fa148","type":"switch","z":"e9d0b6f8.aa9d68","name":"Process store has current store package?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1040,"y":320,"wires":[["f16181aa.be314"],["9c5f0384.7f77"]]},{"id":"9c5f0384.7f77","type":"function","z":"e9d0b6f8.aa9d68","name":"Hasn't got current store package","func":"node.error(`storeID: ${msg.processStore['storeID']} hasn't got current store package. ❌`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1370,"y":340,"wires":[["f64fef06.49867"]]},{"id":"6207b2a3.75d57c","type":"subflow:8c824985.837028","z":"e9d0b6f8.aa9d68","name":"GET_CURRENT_STORE_PACKAGE","env":[],"x":990,"y":260,"wires":[["af33462c.0fa148"]]},{"id":"55c1b957.dd2cc8","type":"link in","z":"e9d0b6f8.aa9d68","name":"","links":["3c79be18.42e262","3477d1c0.183d2e"],"x":755,"y":940,"wires":[["b5c7ae2c.591ce"]]},{"id":"3c79be18.42e262","type":"link out","z":"e9d0b6f8.aa9d68","name":"","links":["3cc94b42.40c124","55c1b957.dd2cc8"],"x":1655,"y":300,"wires":[]},{"id":"80d579d3.59bf08","type":"switch","z":"e9d0b6f8.aa9d68","name":"Current store has store package?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1800,"y":560,"wires":[["f7021265.de024"],["6cb74c8b.0e87e4"]]},{"id":"a95fbe2c.3cef7","type":"subflow:b4ba47fc.ef5b78","z":"e9d0b6f8.aa9d68","name":"GET_ALL_STORE_PACKAGE","env":[],"x":1750,"y":500,"wires":[["80d579d3.59bf08"]]},{"id":"6cb74c8b.0e87e4","type":"function","z":"e9d0b6f8.aa9d68","name":"Hasn't got any store package","func":"let packageList = msg.PACKAGE_LIST;\n\nlet newPackageIndex = 0;\nlet diffDate = 0;\n\nlet processStore = msg.processStore;\nif( processStore.hasOwnProperty('createdAt') ) {\n    let createdAt = processStore['createdAt'];\n    let packageObj = packageList[newPackageIndex];\n    let nowDate = Date.now();\n    diffDate = (nowDate - createdAt) / 86400000;\n    if( diffDate > packageObj.activeDays ) {\n        newPackageIndex = 1;\n    }\n    \n}\n\nnode.error(`storeID: ${msg.processStore['storeID']} hasn't got any store package. Current store is \"NEW\" store..... 🆕`);\n\nmsg.newPackageIndex = newPackageIndex;\nreturn msg;","outputs":1,"noerr":0,"x":2100,"y":580,"wires":[["c1f401b1.27a39"]]},{"id":"f7021265.de024","type":"function","z":"e9d0b6f8.aa9d68","name":"Has some store package","func":"let packageList = msg.PACKAGE_LIST;\nlet newPackageIndex = 1;\n\nnode.error(`storeID: ${msg.processStore['storeID']} has some store package. Current store is \"Actived\" store..... 👨💻`);\n\nmsg.newPackageIndex = newPackageIndex;\nreturn msg;","outputs":1,"noerr":0,"x":2090,"y":540,"wires":[["c1f401b1.27a39"]]},{"id":"fed68eca.c864f","type":"function","z":"e9d0b6f8.aa9d68","name":"INIT_NEW_PACKAGE","func":"let packageList = msg.PACKAGE_LIST;\nlet newPackageIndex = msg.newPackageIndex;\n\nnode.error(`➕ Create new package of store: ${msg.processStore['storeID']} with body:`);\nnode.error(packageList[newPackageIndex]);\n\nmsg.newPackage = packageList[newPackageIndex];\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":680,"wires":[["c714ee5a.e0718"]]},{"id":"71ffc8f0.e4a148","type":"http in","z":"bd1a26e8.d70568","name":"","url":"/calculateStorePackage","method":"post","upload":false,"swaggerDoc":"","x":160,"y":280,"wires":[["30839980.24adf6"]]},{"id":"30839980.24adf6","type":"switch","z":"bd1a26e8.d70568","name":"","property":"payload.newPackageObj","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":280,"wires":[["9ecbdfce.fd896"],["b13f4c92.5b1a5"]]},{"id":"c8ba8513.c52dc8","type":"http response","z":"bd1a26e8.d70568","name":"","statusCode":"","headers":{},"x":770,"y":280,"wires":[]},{"id":"b13f4c92.5b1a5","type":"function","z":"bd1a26e8.d70568","name":"Not found packageObj","func":"let data = {};\n\nmsg.statusCode = 400;\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":300,"wires":[["c8ba8513.c52dc8"]]},{"id":"9ecbdfce.fd896","type":"function","z":"bd1a26e8.d70568","name":"Found package","func":"let newPackageObj = msg.payload.newPackageObj;\nlet currentPackageObj = msg.payload.currentPackageObj;\nlet isActiveNow = msg.payload.isActiveNow;\nlet currentDate = (msg.payload.currentDate && msg.payload.currentDate.length > 0) ? new Date(msg.payload.currentDate).getTime() : Date.now() - (1000 * 10) ;\n\nlet chargePrice = 0;\nlet activeDate = currentDate;\nlet expiryDate = currentDate;\n\n// function changeCurrentHourToTimeStamp(currentDate) {\n//     return ( (new Date(currentDate).getHours() * 60 * 60 * 1000) + (new Date(currentDate).getMinutes() * 60 * 1000) + (new Date(currentDate).getSeconds() * 1000) );\n// }\n\n// function calculateActiveDate(packageObj, currentDate) {\n//     let billingType = packageObj.billingInfo.billingType; \n//     let billingDate = packageObj.billingInfo.billingDate;\n\n//     let activeDate = currentDate;\n//     if( billingType.length > 0 ) {\n//         switch( billingType ) {\n//             case \"WEEKLY\":\n//                 activeDate = currentDate + ( ( (6 - new Date(currentDate).getDay()) + billingDate) * 24 * 60 * 60 * 1000);\n//                 break;\n//             case \"MONTHLY\":\n//                 let nextMonth = new Date(currentDate).getMonth() + 1;\n//                 let year = new Date(currentDate).getFullYear();\n//                 if( nextMonth > 11 ) {\n//                     nextMonth = 0;\n//                     year = year + 1;\n//                 }\n//                 activeDate = new Date(year, nextMonth, billingDate, new Date(currentDate).getHours(), new Date(currentDate).getMinutes(), new Date(currentDate).getSeconds()).getTime();\n//                 break;\n//             case \"YEARLY\":\n//                 activeDate = new Date(new Date(currentDate).getFullYear() + 1, 0, billingDate, new Date(currentDate).getHours(), new Date(currentDate).getMinutes(), new Date(currentDate).getSeconds()).getTime();\n//                 break;\n//             default:\n//                 activeDate = currentDate;\n//         }\n//     }\n\n//     return activeDate;\n// }\n\n// function calculateExpiryDate(packageObj, currentDate, activeDate) {\n//     let billingType = packageObj.billingInfo.billingType; \n//     let billingDate = packageObj.billingInfo.billingDate;\n\n//     let expiryDate = Date.now();\n//     if( billingType.length > 0 ) {\n//         switch( billingType ) {\n//             case \"WEEKLY\":\n//                 expiryDate = activeDate + ( ( (6 - new Date(activeDate).getDay()) + billingDate) * 24 * 60 * 60 * 1000);\n//                 break;\n//             case \"MONTHLY\":\n//                 let nextMonth = new Date(activeDate).getMonth() + 1;\n//                 let year = new Date(activeDate).getFullYear();\n//                 if( nextMonth > 11 ) {\n//                     nextMonth = 0;\n//                     year = year + 1;\n//                 }\n//                 activeDate = new Date(year, nextMonth, billingDate, 0, 0, 1).getTime();\n//                 break;\n//             case \"YEARLY\":\n//                 activeDate = new Date(new Date(activeDate).getFullYear() + 1, 0, billingDate, 0, 0, 1).getTime();\n//                 break;\n//             default:\n//                 activeDate = Date.now();\n//         }\n//     } else {\n//         expiryDate = activeDate + ( packageObj.activeDays * 24 * 60 * 60 * 1000);\n//     }\n\n//     return expiryDate;\n// }\n\n\nfunction calculateNextCircleDate(packageObj, startDate) {\n    let billingType = packageObj.billingInfo.billingType; \n    let billingDate = packageObj.billingInfo.billingDate;\n\n    let nextStartDate = startDate;\n    if( billingType.length > 0 ) {\n        switch( billingType ) {\n            case \"WEEKLY\":\n                nextStartDate = startDate + ( ( (6 - new Date(startDate).getDay()) + billingDate) * 24 * 60 * 60 * 1000);\n                break;\n            case \"MONTHLY\":\n                let nextMonth = new Date(startDate).getMonth() + 1;\n                let year = new Date(startDate).getFullYear();\n                if( nextMonth > 11 ) {\n                    nextMonth = 0;\n                    year = year + 1;\n                }\n                nextStartDate = new Date(year, nextMonth, billingDate, new Date(startDate).getHours(), new Date(startDate).getMinutes(), new Date(startDate).getSeconds()).getTime();\n                break;\n            case \"YEARLY\":\n                nextStartDate = new Date(new Date(startDate).getFullYear() + 1, 0, billingDate, new Date(startDate).getHours(), new Date(startDate).getMinutes(), new Date(startDate).getSeconds()).getTime();\n                break;\n            case \"FIX\":\n                nextStartDate = startDate + ( packageObj.activeDays * 24 * 60 * 60 * 1000);\n                break;\n            default:\n                nextStartDate = startDate;\n        }\n    } else {\n        nextStartDate = startDate + ( packageObj.activeDays * 24 * 60 * 60 * 1000);\n    }\n\n    return nextStartDate;\n}\n\nfunction calculateChargePrice(currentDate, activeDate, newPackageObj, currentPackageObj) {\n    let billingType = newPackageObj.billingInfo.billingType; \n    // let billingDate = newPackageObj.billingInfo.billingDate;\n\n    let newMemberPrice = 0;\n    let currentMemberPrice = currentPackageObj && currentPackageObj.hasOwnProperty('memberPrice') ? currentPackageObj.memberPrice : 0 ;\n    if(newPackageObj.memberPrice > currentMemberPrice) {\n        newMemberPrice = newPackageObj.memberPrice - currentMemberPrice;\n    }\n\n    let chargePrice = 0;\n    if( billingType.length > 0 ) {\n        let lastDayOfMonth;\n        let lastDayOfYear;\n        switch( billingType ) {\n            case \"WEEKLY\":\n                chargePrice = (newMemberPrice / 7) * ( (activeDate - currentDate) / 86400 );\n                break;\n            case \"MONTHLY\":\n                lastDayOfMonth = new Date(new Date(currentDate).getFullYear(), new Date(currentDate).getMonth() + 1, 0).getDate();\n                chargePrice = (newMemberPrice / lastDayOfMonth) * ( (activeDate - currentDate) / 86400000 );               \n                break;\n            case \"YEARLY\":\n                lastDayOfYear = new Date(new Date(currentDate).getFullYear() + 1, 0, 0).getDate();\n                chargePrice = (newMemberPrice / lastDayOfYear) * ( (activeDate - currentDate) / 86400 );\n                break;\n            default:\n                chargePrice = newMemberPrice * ( (activeDate - currentDate) / 86400 );\n        }\n    } else {\n        chargePrice = newMemberPrice;\n    }\n\n    return chargePrice;\n}\n\n\nif( newPackageObj.isSubscribePackage ) {\n    if( isActiveNow === \"false\" || isActiveNow === false ) {\n        // activeDate = calculateActiveDate(newPackageObj, currentDate);\n        activeDate = calculateNextCircleDate(currentPackageObj, currentDate);\n        expiryDate = calculateNextCircleDate(newPackageObj, activeDate);\n        chargePrice = newPackageObj.memberPrice;\n    } else {\n        activeDate = currentDate;\n        expiryDate = calculateNextCircleDate(newPackageObj, activeDate);\n        chargePrice = calculateChargePrice(activeDate, expiryDate, newPackageObj, currentPackageObj);\n    }\n    // expiryDate = calculateExpiryDate(newPackageObj.billingInfo.billingType, newPackageObj.billingInfo.billingDate, currentDate, activeDate);\n} else {\n    chargePrice = newPackageObj.memberPrice;\n    if( isActiveNow === \"false\" || isActiveNow === false ) {\n        // activeDate = this.calculateActiveDate(newPackageObj, currentDate);\n        activeDate = calculateNextCircleDate(currentPackageObj, currentDate);\n    } else {\n        activeDate = currentDate;\n    }\n    expiryDate = activeDate + ( newPackageObj.activeDays * 24 * 60 * 60 * 1000);\n}\n\n\nmsg.statusCode = 200;\nmsg.payload = {\n    \"chargePrice\": Number( (Math.round(chargePrice * 100) / 100).toFixed(2) ),\n    \"activeDate\": activeDate,\n    \"expiryDate\": expiryDate\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":260,"wires":[["c8ba8513.c52dc8"]]},{"id":"874b1951.f7f088","type":"function-npm","z":"bd1a26e8.d70568","name":"","func":"var moment = require('moment');\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":460,"wires":[[]]},{"id":"c1f401b1.27a39","type":"link out","z":"e9d0b6f8.aa9d68","name":"","links":["3cc94b42.40c124","5b168e3b.f854d"],"x":2275,"y":560,"wires":[]},{"id":"5b168e3b.f854d","type":"link in","z":"e9d0b6f8.aa9d68","name":"","links":["c1f401b1.27a39","7bddd64f.7df488"],"x":795,"y":680,"wires":[["fed68eca.c864f"]]},{"id":"b151d657.b4d798","type":"function","z":"e9d0b6f8.aa9d68","name":"INIT_NEW_PACKAGE","func":"let packageData = msg.payload;\n\nlet storePackageData = {\n    \"storeID\": msg.processStore['storeID'],\n    \"packageInfo\": msg.newPackage,\n    // \"chargePrice\": packageData.chargePrice,\n    \"status\": \"ACTIVE\",\n    \"createdAt\": Date.now(),\n    \"activeDate\": packageData.activeDate,\n    \"updatedAt\": 0,\n    \"expiryDate\": packageData.expiryDate\n};\n\nnode.error(`➕ Create store package of store: ${msg.processStore['storeID']} with body:`);\nnode.error(storePackageData);\n\nmsg.storePackageData = storePackageData;\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":760,"wires":[["d57a9147.905e3"]]},{"id":"c714ee5a.e0718","type":"subflow:e6bec180.90507","z":"e9d0b6f8.aa9d68","name":"","env":[],"x":970,"y":720,"wires":[["b151d657.b4d798"]]},{"id":"d1a8ef7.b20141","type":"change","z":"96714785.e18a48","name":"ALPHA","rules":[{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":360,"y":320,"wires":[["9de3794a.2a7f58"]]},{"id":"9263f0b1.49864","type":"change","z":"96714785.e18a48","name":"BETA","rules":[{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":360,"wires":[["9de3794a.2a7f58"]]},{"id":"cf8400a2.2adef","type":"change","z":"96714785.e18a48","name":"DEV","rules":[{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":280,"wires":[["9de3794a.2a7f58"]]},{"id":"291f6eea.c84102","type":"httpInMultipart","z":"96714785.e18a48","name":"","url":"/recurringResultDev","method":"post","fields":"[]","swaggerDoc":"","x":150,"y":280,"wires":[["cf8400a2.2adef","76c8fbda.9d0d54"]]},{"id":"d40ef265.57cfe","type":"httpInMultipart","z":"96714785.e18a48","name":"","url":"/recurringResultUat","method":"post","fields":"[]","swaggerDoc":"","x":150,"y":320,"wires":[["d1a8ef7.b20141","76c8fbda.9d0d54"]]},{"id":"4fcfaf66.6ccaf","type":"httpInMultipart","z":"96714785.e18a48","name":"","url":"/recurringResult","method":"post","fields":"[{\"name\": \"referenceNo\"}, {\"name\": \"gbpReferenceNo\"}, {\"name\": \"amount\"}, {\"name\": \"recurringNo\"}]","swaggerDoc":"","x":140,"y":360,"wires":[["9263f0b1.49864","76c8fbda.9d0d54"]]},{"id":"76c8fbda.9d0d54","type":"debug","z":"96714785.e18a48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":350,"y":440,"wires":[]},{"id":"9de3794a.2a7f58","type":"function","z":"96714785.e18a48","name":"SAVE_TO_recurringResult","func":"const reqPayload = msg.payload;\nmsg.recurringResult = reqPayload;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":320,"wires":[["1c736ac.e254d95","38bc6876.3e5908"]]},{"id":"e4c34a1f.ecb728","type":"switch","z":"96714785.e18a48","name":"Found Recurring??","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1090,"y":320,"wires":[["2684262e.4b4cea"],["d9cc03aa.25686"]]},{"id":"e9f0d521.b7c4d8","type":"subflow:ad739067.50319","z":"96714785.e18a48","name":"GET_RECURRING_INFO","env":[],"x":850,"y":320,"wires":[["e4c34a1f.ecb728"]]},{"id":"d9cc03aa.25686","type":"function","z":"96714785.e18a48","name":"Not found recurring","func":"node.error(`Not found recurring!! Process done.`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":340,"wires":[["90a658c4.2b4848"]]},{"id":"2684262e.4b4cea","type":"function","z":"96714785.e18a48","name":"SAVE_TO_recurringInfo","func":"msg.recurringInfo = msg.payload[0];\nmsg.STORE_ID = msg.recurringInfo.storeID;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1330,"y":300,"wires":[["eaf806c6.945928"]]},{"id":"f5c32615.213548","type":"switch","z":"96714785.e18a48","name":"Found Store Package??","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1930,"y":300,"wires":[["edb6707d.f47d4"],["fe17abcc.c7cb98"]]},{"id":"edb6707d.f47d4","type":"function","z":"96714785.e18a48","name":"SAVE_TO_storePackageInfo","func":"const recurringResult = msg.recurringResult;\nconst recurringStatus = ( recurringResult.resultCode === \"00\" ) ? \"SUCCESS\" : \"FALSE\" ;\nconst storePackageInfo = msg.payload[0];\n\nfunction getDate(dateObj) {\n    return dateObj.getFullYear()+'-'+(dateObj.getMonth()+1)+'-'+dateObj.getDate();\n}\n\n\n\nconst todayDate = getDate(new Date());\nconst expiryDate = getDate(new Date(storePackageInfo.expiryDate));\n\nmsg.storePackageInfo = storePackageInfo;\nmsg.recurringStatus = recurringStatus;\nmsg.todayDate = todayDate;\nmsg.expiryDate = expiryDate;\n\nreturn msg;","outputs":1,"noerr":0,"x":2200,"y":280,"wires":[["2d11c0a1.6cd07"]]},{"id":"fe17abcc.c7cb98","type":"function","z":"96714785.e18a48","name":"Not found store package","func":"node.error(`Not found store package!! Process done.`);\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":320,"wires":[["4197a043.d8ba8"]]},{"id":"7672d8cc.2fa248","type":"switch","z":"96714785.e18a48","name":"Is expiryDate","property":"expiryDate","propertyType":"msg","rules":[{"t":"eq","v":"todayDate","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2710,"y":140,"wires":[["7924d216.e6b8ac"],["479dd19.355a83"]]},{"id":"479dd19.355a83","type":"subflow:41dfc406.754afc","z":"96714785.e18a48","name":"","env":[],"x":2980,"y":160,"wires":[["cf311131.fe723"]]},{"id":"7924d216.e6b8ac","type":"function","z":"96714785.e18a48","name":"SET_PACKAGE_TO_MSG","func":"const packageInfo = msg.storePackageInfo.packageInfo;\nmsg.packageInfo = packageInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":2980,"y":20,"wires":[["c1a26c3c.4ffa2"]]},{"id":"2d11c0a1.6cd07","type":"switch","z":"96714785.e18a48","name":"Recurring success??","property":"recurringResult.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2460,"y":280,"wires":[["7672d8cc.2fa248"],["a91a5430.bf8ed8"]]},{"id":"1c736ac.e254d95","type":"http response","z":"96714785.e18a48","name":"","statusCode":"200","headers":{},"x":760,"y":440,"wires":[]},{"id":"f0bce1b8.e346d","type":"link in","z":"96714785.e18a48","name":"","links":["90a658c4.2b4848","4197a043.d8ba8","f0b9f843.201698","8338b09c.99b","5eb8ab2b.c1d194"],"x":535,"y":440,"wires":[["1c736ac.e254d95"]]},{"id":"90a658c4.2b4848","type":"link out","z":"96714785.e18a48","name":"","links":["f0bce1b8.e346d"],"x":1455,"y":340,"wires":[]},{"id":"4197a043.d8ba8","type":"link out","z":"96714785.e18a48","name":"","links":["f0bce1b8.e346d"],"x":2355,"y":320,"wires":[]},{"id":"f0b9f843.201698","type":"link out","z":"96714785.e18a48","name":"","links":["f0bce1b8.e346d"],"x":3495,"y":180,"wires":[]},{"id":"a91a5430.bf8ed8","type":"function","z":"96714785.e18a48","name":"SET_PACKAGE_INACTIVE","func":"let storePackageInfo = msg.storePackageInfo;\nstorePackageInfo['status'] = \"INACTIVE\";\nstorePackageInfo['updatedAt'] = Date.now();\n\nmsg.storePackageInfo = storePackageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":2720,"y":300,"wires":[["292714e1.e001bc"]]},{"id":"292714e1.e001bc","type":"subflow:7c855960.2e0268","z":"96714785.e18a48","name":"","env":[],"x":2730,"y":340,"wires":[["46790bba.ca9d04"]]},{"id":"46790bba.ca9d04","type":"subflow:41dfc406.754afc","z":"96714785.e18a48","name":"","env":[],"x":2760,"y":380,"wires":[["37eb843c.98dc3c"]]},{"id":"6c7af979.940878","type":"function","z":"96714785.e18a48","name":"SET_PACKAGE_TO_MSG","func":"let packageInfo = msg.payload;\n\nmsg.packageInfo = packageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":2720,"y":460,"wires":[["480e41f6.72f03"]]},{"id":"37eb843c.98dc3c","type":"subflow:7f331021.1cff8","z":"96714785.e18a48","name":"","env":[],"x":2730,"y":420,"wires":[["6c7af979.940878"]]},{"id":"8538e3bd.ce2d9","type":"function","z":"96714785.e18a48","name":"UPDATE_STORE_PACKAGE_DATA","func":"const calculatePackageInfo = msg.payload;\nconst packageInfo = msg.packageInfo;\n\nconst newStorePackageInfo = {\n    storePackageID: \"\",\n    storeID: msg.STORE_ID,\n    packageInfo: packageInfo,\n    status: \"ACTIVE\",\n    createdAt: Date.now(),\n    updatedAt: 0,\n    activeDate: calculatePackageInfo.activeDate,\n    expiryDate: calculatePackageInfo.expiryDate\n};\n\nmsg.storePackageInfo = newStorePackageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":2750,"y":540,"wires":[["5c927d2f.ed4174"]]},{"id":"480e41f6.72f03","type":"subflow:27c70303.21f51c","z":"96714785.e18a48","name":"","env":[],"x":2710,"y":500,"wires":[["8538e3bd.ce2d9"]]},{"id":"8338b09c.99b","type":"link out","z":"96714785.e18a48","name":"","links":["f0bce1b8.e346d"],"x":2895,"y":580,"wires":[]},{"id":"5c927d2f.ed4174","type":"subflow:1fcbb17.3f98d4f","z":"96714785.e18a48","name":"","env":[],"x":2720,"y":580,"wires":[["8338b09c.99b"]]},{"id":"c1a26c3c.4ffa2","type":"subflow:27c70303.21f51c","z":"96714785.e18a48","name":"","env":[],"x":2970,"y":60,"wires":[["38b29b4b.ccd744"]]},{"id":"38b29b4b.ccd744","type":"function","z":"96714785.e18a48","name":"UPDATE_STORE_PACKAGE_DATA","func":"const calculatePackageInfo = msg.payload;\nlet storePackageInfo = msg.storePackageInfo;\n\nstorePackageInfo['expiryDate'] = calculatePackageInfo.expiryDate;\n\nmsg.storePackageInfo = storePackageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":3010,"y":100,"wires":[["c422ee7a.a0a82"]]},{"id":"c422ee7a.a0a82","type":"subflow:7c855960.2e0268","z":"96714785.e18a48","name":"","env":[],"x":3370,"y":20,"wires":[["f0a65e8.25d2ea"]]},{"id":"f0a65e8.25d2ea","type":"subflow:41dfc406.754afc","z":"96714785.e18a48","name":"","env":[],"x":3400,"y":60,"wires":[["5eb8ab2b.c1d194"]]},{"id":"5eb8ab2b.c1d194","type":"link out","z":"96714785.e18a48","name":"","links":["f0bce1b8.e346d"],"x":3255,"y":100,"wires":[]},{"id":"7c05185b.f3f798","type":"function","z":"fa642309.a8d4a","name":"INSERT_STORE_PACKAGE","func":"msg.url = `${msg.apiUrl}/storePackage/new`;\nmsg.payload = msg.storePackageData;\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":80,"wires":[["30103626.2b17ea","54ff7c8e.5bf354"]]},{"id":"30103626.2b17ea","type":"http request","z":"fa642309.a8d4a","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["22373add.222e06"]]},{"id":"22373add.222e06","type":"debug","z":"fa642309.a8d4a","name":"INSERT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":590,"y":120,"wires":[]},{"id":"54ff7c8e.5bf354","type":"debug","z":"fa642309.a8d4a","name":"INSERT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":590,"y":80,"wires":[]},{"id":"d57a9147.905e3","type":"subflow:fa642309.a8d4a","z":"e9d0b6f8.aa9d68","name":"","env":[],"x":960,"y":800,"wires":[["24e7254b.a029ba"]]},{"id":"24e7254b.a029ba","type":"switch","z":"e9d0b6f8.aa9d68","name":"Insert store package success?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1010,"y":860,"wires":[["87e6beed.6efd8"],["833ae640.f31d98"]]},{"id":"87e6beed.6efd8","type":"function","z":"e9d0b6f8.aa9d68","name":"Insert success","func":"node.error(`Insert store package of storeID: ${msg.processStore['storeID']} success. New store package id is ${msg.payload}..... ✔️`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":840,"wires":[["b5c7ae2c.591ce"]]},{"id":"833ae640.f31d98","type":"function","z":"e9d0b6f8.aa9d68","name":"Insert fail","func":"node.error(`Fail to insert store package of storeID: ${msg.processStore['storeID']}. Something went wrong..... ❌`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1240,"y":880,"wires":[["b5c7ae2c.591ce"]]},{"id":"6d6c60d3.f308","type":"http in","z":"1db78bed.51e4f4","name":"","url":"/calculateGbpayPaymentFee","method":"post","upload":false,"swaggerDoc":"","x":180,"y":180,"wires":[["aa38e4ba.f263f8","69d9be67.00d01"]]},{"id":"6f6b8303.0b79bc","type":"http in","z":"1db78bed.51e4f4","name":"","url":"/calculateServiceFee","method":"post","upload":false,"swaggerDoc":"","x":150,"y":440,"wires":[["c1f6d19e.c8c78","3b2c8cb4.0ab304"]]},{"id":"38bc6876.3e5908","type":"delay","z":"96714785.e18a48","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":760,"y":260,"wires":[["e9f0d521.b7c4d8"]]},{"id":"cf311131.fe723","type":"function","z":"96714785.e18a48","name":"Check charging is pro rate?","func":"const recurringResult = msg.recurringResult;\nconst storePackageInfo = msg.storePackageInfo;\n\nif( Number(recurringResult.amount) !== Number(storePackageInfo.packageInfo.memberPrice) ) {\n    node.error(\"This recurring is 'Pro Rate', must update recurring amount to GB Pay.....\");\n    return [msg, null];\n} else {\n    node.error(\"This recurring is normal charging, not thing to do.\");\n    return [null, msg];\n}\n\nreturn msg;","outputs":2,"noerr":0,"x":3300,"y":160,"wires":[["d3bd7f6.606ea8"],["f0b9f843.201698"]]},{"id":"d3bd7f6.606ea8","type":"subflow:13cde19d.29391e","z":"96714785.e18a48","name":"","env":[],"x":3590,"y":140,"wires":[["f0b9f843.201698"]]},{"id":"786be975.4a3178","type":"switch","z":"e9d0b6f8.aa9d68","name":"Current store has next store package?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1430,"y":440,"wires":[["bad88e6a.3ec5d"],["77833076.b16bc"]]},{"id":"f64fef06.49867","type":"subflow:d96c41e9.777ec","z":"e9d0b6f8.aa9d68","name":"","env":[],"x":1380,"y":380,"wires":[["786be975.4a3178"]]},{"id":"bad88e6a.3ec5d","type":"function","z":"e9d0b6f8.aa9d68","name":"Has next store package","func":"node.error(`storeID: ${msg.processStore['storeID']} has next store package, 😃 ✔️ go next.....`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":420,"wires":[["3c79be18.42e262"]]},{"id":"77833076.b16bc","type":"function","z":"e9d0b6f8.aa9d68","name":"Hasn't got next store package","func":"node.error(`storeID: ${msg.processStore['storeID']} hasn't got next store package. ❌`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1750,"y":460,"wires":[["a95fbe2c.3cef7"]]},{"id":"424cad1e.ec9eb4","type":"inject","z":"c0036ad7.2ae908","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":300,"wires":[["a7de3724.7b8338"]]},{"id":"a7de3724.7b8338","type":"function","z":"c0036ad7.2ae908","name":"","func":"let obj = {\"key\": \"val\"};\nnode.log('test log')\nnode.log('test log obj:'+ JSON.stringify(obj))\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":300,"wires":[[]]},{"id":"2e19dd97.e850b2","type":"debug","z":"2880ede8.a08db2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2850,"y":220,"wires":[]},{"id":"eaf806c6.945928","type":"subflow:f41d9a37.a83158","z":"96714785.e18a48","name":"","env":[],"x":1610,"y":300,"wires":[["f5c32615.213548"]]},{"id":"ac34e2d1.fe82b","type":"http in","z":"2880ede8.a08db2","name":"","url":"/changeOrderStatus","method":"post","upload":false,"swaggerDoc":"","x":130,"y":460,"wires":[["3a38befa.aeba82"]]},{"id":"3a38befa.aeba82","type":"switch","z":"2880ede8.a08db2","name":"with ?orderID querystring or not","property":"payload.result","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":460,"wires":[["3b0dbec5.dac452"],["c5f76aa8.310398"]]},{"id":"c5f76aa8.310398","type":"function","z":"2880ede8.a08db2","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Webhook result must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":500,"wires":[["951860d6.1a7e5"]]},{"id":"951860d6.1a7e5","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":330,"y":540,"wires":[]},{"id":"312a10c4.593bb","type":"function","z":"2880ede8.a08db2","name":"","func":"let webhookResponse = msg.payload.result;\n\nmsg.webhookResponse = webhookResponse;\nmsg.ORDER_DOC_ID = webhookResponse.merchantDefined2;\nmsg.AMOUNT = webhookResponse.amount;\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":420,"wires":[["4a44bff6.f6b56"]]},{"id":"1975997b.760157","type":"change","z":"2880ede8.a08db2","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":420,"wires":[["ed3b0a1e.f05498"]]},{"id":"a8110300.f52c2","type":"change","z":"2880ede8.a08db2","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":460,"wires":[["ed3b0a1e.f05498"]]},{"id":"4a44bff6.f6b56","type":"change","z":"2880ede8.a08db2","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":500,"wires":[["ed3b0a1e.f05498"]]},{"id":"ed3b0a1e.f05498","type":"function","z":"2880ede8.a08db2","name":"SET_ORDER_ID_TO_API","func":"msg.url+= `?orderID=${msg.ORDER_DOC_ID}`;\n\nnode.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":420,"wires":[["d6b266e3.c44ea8"]]},{"id":"d6b266e3.c44ea8","type":"http request","z":"2880ede8.a08db2","name":"GET_ORDER","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1220,"y":460,"wires":[["32ed2ced.15e8b4","cb7df8b0.122a98"]]},{"id":"f62db99b.536368","type":"function","z":"2880ede8.a08db2","name":"SAVE_ORDER_TO_MSG_OBJ","func":"msg.orderInfo = msg.payload;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":420,"wires":[["247be36c.56451c"]]},{"id":"67eb728f.818f8c","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":1530,"y":540,"wires":[]},{"id":"247be36c.56451c","type":"switch","z":"2880ede8.a08db2","name":"order status us PENDING","property":"orderInfo.paymentInfo.status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1590,"y":460,"wires":[["c96f702.4b66e9"],["7dfc987d.5a5418"]]},{"id":"7dfc987d.5a5418","type":"function","z":"2880ede8.a08db2","name":"SAVE_ORDER_TO_MSG_OBJ","func":"let result = {\n    result: \"This order status is SUCCESS.\",\n    orderInfo: msg.orderInfo\n};\n\nmsg.payload = result;\n\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":500,"wires":[["67eb728f.818f8c"]]},{"id":"3b0dbec5.dac452","type":"switch","z":"2880ede8.a08db2","name":"result code == 00","property":"payload.result.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":440,"wires":[["312a10c4.593bb"],["17d040a3.2aba8f"]]},{"id":"17d040a3.2aba8f","type":"function","z":"2880ede8.a08db2","name":"","func":"msg.statusCode = 200;\nmsg.payload = {\n    \"message\": \"Result code != '00'\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":480,"wires":[["9bed0f6e.c5e1b"]]},{"id":"9bed0f6e.c5e1b","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":650,"y":520,"wires":[]},{"id":"c96f702.4b66e9","type":"function","z":"2880ede8.a08db2","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"const orderInfo = msg.orderInfo;\nconst webhookResponse = msg.webhookResponse;\n\nconst storeID = orderInfo.storeID;\nconst orderDocID = msg.ORDER_DOC_ID;\n\nlet updateData = orderInfo;\n\nupdateData['orderDocID'] = orderDocID;\nif( webhookResponse.hasOwnProperty('cardNo') ) {\n    updateData['paymentInfo']['method'] = \"CREDIT_CARD\";\n    msg.PAYMENT_METHOD = \"CREDIT_CARD\";\n} else {\n    updateData['paymentInfo']['method'] = \"QR_CODE\";\n    msg.PAYMENT_METHOD = \"QR_CODE\";\n}\n\nif( webhookResponse.hasOwnProperty(\"gbpReferenceNo\") ) {\n    updateData['paymentInfo']['details'] = webhookResponse['gbpReferenceNo'];\n}\nif( webhookResponse.hasOwnProperty(\"customerName\") ) {\n    updateData['paymentInfo']['gbPaymentDetails']['customerName'] = webhookResponse['customerName'];\n}\nif( webhookResponse.hasOwnProperty(\"customerEmail\") ) {\n    updateData['paymentInfo']['gbPaymentDetails']['customerEmail'] = webhookResponse['customerEmail'];\n}\nupdateData['paymentInfo']['status'] = \"SUCCESS\";\nupdateData['paymentInfo']['isFromBatchCheck'] = true;\nupdateData['paymentInfo']['batchCheckTimestamp'] = Date.now();\nupdateData['paymentInfo']['paymentCompletedOn'] = Date.now();\n\nconst apiUrl = msg.apiUrl;\nconst url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.url = url;\nmsg.payload = updateData;\nmsg.orderInfo = updateData;\n\n// node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1980,"y":440,"wires":[["eea8c1b6.2848b","fd59c0d4.478c4"]]},{"id":"fd59c0d4.478c4","type":"http request","z":"2880ede8.a08db2","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1920,"y":480,"wires":[["a4920ccf.b8961"]]},{"id":"3e6539a0.1687e6","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":2130,"y":740,"wires":[]},{"id":"a4920ccf.b8961","type":"function","z":"2880ede8.a08db2","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let orderInfo = msg.orderInfo;\nlet recipientAccountType = orderInfo['recipientAccountType'];\nlet paymentStatus = orderInfo['paymentInfo']['status'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":2330,"y":480,"wires":[["23cbfc1.b3f6604"],["46f5dbb8.be5194"]]},{"id":"46f5dbb8.be5194","type":"function","z":"2880ede8.a08db2","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet orderInfo = msg.orderInfo;\nlet orderID = orderInfo['orderID'];\nnode.error(`Recipient type of this orderDocID: ${msg.ORDER_DOC_ID}, orderID: (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`);\n\nreturn msg;","outputs":1,"noerr":0,"x":2340,"y":520,"wires":[["fede5b40.9d4388"]]},{"id":"23cbfc1.b3f6604","type":"function","z":"2880ede8.a08db2","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let nuser = 'arislab-prod';\nif( msg.hasOwnProperty('nuser') ) {\n    nuser = msg.nuser;\n}\n\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": nuser,\n    \"paymentInfo\": msg.webhookResponse\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2740,"y":460,"wires":[["59949f69.e5ddb"]]},{"id":"32ed2ced.15e8b4","type":"switch","z":"2880ede8.a08db2","name":"Found order","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1210,"y":500,"wires":[["f62db99b.536368"],["f8ffcf90.6389e"]]},{"id":"f8ffcf90.6389e","type":"function","z":"2880ede8.a08db2","name":"","func":"msg.statusCode = 501;\nmsg.payload = {\n    \"message\": \"Not found orderID: \"+msg.ORDER_ID\n}\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":540,"wires":[["6fb7c34b.dad23c"]]},{"id":"6fb7c34b.dad23c","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":1190,"y":580,"wires":[]},{"id":"66e7a7e3.f8d958","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":2990,"y":660,"wires":[]},{"id":"8becf705.ed4138","type":"http request","z":"2880ede8.a08db2","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2720,"y":580,"wires":[["b012d360.eaaf7"]]},{"id":"59949f69.e5ddb","type":"http request","z":"2880ede8.a08db2","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2700,"y":500,"wires":[["59cb2d18.0c8d74"]]},{"id":"59cb2d18.0c8d74","type":"function","z":"2880ede8.a08db2","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet orderInfo = msg.orderInfo;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nlet storeID = orderInfo['storeID'];\nlet amount = msg.AMOUNT;\nlet orderID = orderInfo['orderID'];\nlet customerName = orderInfo['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":2750,"y":540,"wires":[["8becf705.ed4138"]]},{"id":"b012d360.eaaf7","type":"function","z":"2880ede8.a08db2","name":"SAVE_FUNDS_TRANSACTION_ID","func":"msg.FUNDS_TRANSACTION_ID = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":2720,"y":620,"wires":[["fede5b40.9d4388"]]},{"id":"fede5b40.9d4388","type":"function","z":"2880ede8.a08db2","name":"PROCESS_RESULT","func":"msg.FUNDS_TRANSACTION_ID;\n\nlet result = {};\nresult['orderDocID'] = msg.ORDER_DOC_ID;\nif( msg.hasOwnProperty('FUNDS_TRANSACTION_ID') ) {\n    result['fundsTransactionID'] = msg.FUNDS_TRANSACTION_ID;\n} else {\n    result['fundsTransactionID'] = \"\";\n}\nresult['orderInfo'] = msg.orderInfo;\n\nmsg.payload = result;\n\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":660,"wires":[["66e7a7e3.f8d958"]]},{"id":"cb7df8b0.122a98","type":"debug","z":"2880ede8.a08db2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1380,"y":620,"wires":[]},{"id":"eea8c1b6.2848b","type":"debug","z":"2880ede8.a08db2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2250,"y":440,"wires":[]},{"id":"bd4dad31.73c04","type":"function","z":"8913cd6.260d13","name":"RESULT","func":"let currentBankRecord = msg.currentBankRecord;\n\nnode.error(`Response of bank number ${currentBankRecord.accountInfo.accountNumber} is: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1820,"y":300,"wires":[["510a5228.57400c"]]},{"id":"5692980b.992808","type":"inject","z":"e3110c85.6a04a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":80,"wires":[["8a22c6e8.8e15c8"]]},{"id":"e42cb820.03c4f8","type":"inject","z":"e3110c85.6a04a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":220,"wires":[["426833a2.cc96ec"]]},{"id":"2a265732.063628","type":"inject","z":"e3110c85.6a04a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":360,"wires":[["5b1c2b27.525884"]]},{"id":"c0c89c1d.c35fd","type":"comment","z":"e3110c85.6a04a","name":"DEV","info":"","x":390,"y":40,"wires":[]},{"id":"5abe4d61.4727c4","type":"comment","z":"e3110c85.6a04a","name":"ALPHA","info":"","x":390,"y":180,"wires":[]},{"id":"e76366fa.4491e8","type":"comment","z":"e3110c85.6a04a","name":"PROD","info":"","x":390,"y":320,"wires":[]},{"id":"194dc34a.081e3d","type":"cronplus","z":"e3110c85.6a04a","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 22:30","payload":"","type":"str","expression":"0 30 22 * * * *"},{"topic":"10:30 AM","payload":"","type":"str","expression":"30 10 * * *"}],"x":100,"y":220,"wires":[["5b1c2b27.525884"]]},{"id":"8a22c6e8.8e15c8","type":"change","z":"e3110c85.6a04a","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":120,"wires":[["7d8608d3.cbf798"]]},{"id":"426833a2.cc96ec","type":"change","z":"e3110c85.6a04a","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":260,"wires":[["7d8608d3.cbf798"]]},{"id":"5b1c2b27.525884","type":"change","z":"e3110c85.6a04a","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":400,"wires":[["7d8608d3.cbf798"]]},{"id":"55431e99.18d24","type":"http request","z":"e3110c85.6a04a","name":"GET_ALL_UNVERIFIED_BANK_RECORDS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1050,"y":120,"wires":[["5034c0bd.87afb","64299ec3.585af"]]},{"id":"5034c0bd.87afb","type":"debug","z":"e3110c85.6a04a","name":"GET_ALL_UNVERIFIED_BANK_RECORDS_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1200,"y":80,"wires":[]},{"id":"64299ec3.585af","type":"function","z":"e3110c85.6a04a","name":"SAVE_PAYLOAD_TO_MSG_OBJ","func":"msg.bankRecordList = msg.payload;\nmsg.bankRecordListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":180,"wires":[["76ef4120.93cff"]]},{"id":"ec2cddb0.7706d","type":"function","z":"e3110c85.6a04a","name":"PASSING_EACH_BANK_RECORD_TO_CHECK","func":"let bankRecordList = msg.bankRecordList;\nlet bankRecordListStatusCode = msg.bankRecordListStatusCode;\n\nif (msg.counter < bankRecordList.length) {\n    msg.bankRecord = bankRecordList[msg.counter];\n}\n\nreturn msg\n/*if (bankRecordListStatusCode === 200) {\n    bankRecordList.forEach((bankRecord, index) => {\n        setTimeout(() => {\n            msg.bankRecord = bankRecord;\n            node.send(msg);\n        }, 2000 * index)\n    });\n}*/","outputs":1,"noerr":0,"x":1110,"y":340,"wires":[["546f15b9.7fb6cc"]]},{"id":"546f15b9.7fb6cc","type":"function","z":"e3110c85.6a04a","name":"CREATE_OBJECT_FOR_CHECK","func":"let bankRecord = msg.bankRecord;\nmsg.currentBankRecord = bankRecord;\n\nlet bankAccount = bankRecord.accountInfo.accountNumber.replace(/\\-/g, \"\");\nlet bankCode = bankRecord.accountInfo.bank.bankCode;\nlet amount = 1;\nlet timeline = 1;\n\nmsg.payload = {\n    bankAccount: bankAccount,\n    bankCode: bankCode,\n    amount: amount,\n    timeline: timeline\n}\n\nnode.error(`Process bank account. Name: ${bankRecord.accountInfo.accountName}, Number: ${bankRecord.accountInfo.accountNumber}`);\nnode.error(`Request of bank number: ${bankRecord.accountInfo.accountNumber} with body: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1440,"y":220,"wires":[["e435b2b9.08175","44ee8808.b9d3e8"]]},{"id":"e435b2b9.08175","type":"function","z":"e3110c85.6a04a","name":"SET_HEADERS","func":"//msg.headers = {}\n//msg.headers['Authorization'] = \"Basic PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\";\n//msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":280,"wires":[["a3247827.59e9e8"]]},{"id":"a3247827.59e9e8","type":"http request","z":"e3110c85.6a04a","name":"GB Pay for Prod","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_account","tls":"","proxy":"","authType":"basic","x":1620,"y":280,"wires":[["278bc181.5af8de","9b6c653e.ad1848"]]},{"id":"44ee8808.b9d3e8","type":"debug","z":"e3110c85.6a04a","name":"CREATE_OBJECT_FOR_CHECK_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1460,"y":160,"wires":[]},{"id":"278bc181.5af8de","type":"debug","z":"e3110c85.6a04a","name":"RESULT_CHECK_WITH_GB_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1950,"y":200,"wires":[]},{"id":"573dac69.5a6af4","type":"switch","z":"e3110c85.6a04a","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2000,"y":280,"wires":[["bf309f9f.4e63d"],["743c04ab.f239ac"]]},{"id":"bf309f9f.4e63d","type":"function","z":"e3110c85.6a04a","name":"VERIFIED_BANK_ACCOUNT","func":"let apiUrl = msg.apiUrl;\nlet gbpayResponse = msg.payload;\nlet currentBankRecord = msg.currentBankRecord;\nlet updatedBankRecord = currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\n\nnode.error(`Bank account ${currentBankRecord.accountInfo.accountNumber} is Verified. Update data to bank record: ${verifyID}.`);\n\nupdatedBankRecord.isVerified = true;\nupdatedBankRecord.verifiedAt = Date.now();\nupdatedBankRecord.verifyInfo.referenceNo = gbpayResponse.referenceNo;\n\nlet url = `${apiUrl}/bankRecord/verifyID/${verifyID}/update`;\n\nmsg.url = url;\nmsg.payload = updatedBankRecord;\n\nreturn msg;","outputs":1,"noerr":0,"x":2270,"y":260,"wires":[["124efdf5.752552","e3bf39f6.447288"]]},{"id":"124efdf5.752552","type":"http request","z":"e3110c85.6a04a","name":"UPDATE_BANK_RECORD","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2260,"y":300,"wires":[["1396ef7e.be2061","32523667.e1f5ca"]]},{"id":"1396ef7e.be2061","type":"function","z":"e3110c85.6a04a","name":"PREPARE_LOAD_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet currentBankRecord = msg.currentBankRecord;\nlet storeID = currentBankRecord.storeID;\n\nnode.error(`Get payment info from storeID: ${storeID}.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.url = url;\ndelete msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":2290,"y":340,"wires":[["eea00d9e.dae8c"]]},{"id":"32523667.e1f5ca","type":"debug","z":"e3110c85.6a04a","name":"RESULT_UPDATE_BANK_RECORD_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2630,"y":300,"wires":[]},{"id":"eea00d9e.dae8c","type":"http request","z":"e3110c85.6a04a","name":"GET_PAYMENT_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2240,"y":380,"wires":[["857b9ab3.8e2278","2ba82281.bb589e"]]},{"id":"857b9ab3.8e2278","type":"debug","z":"e3110c85.6a04a","name":"RESULT_GET_PAYMENT_INFO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2620,"y":380,"wires":[]},{"id":"2ba82281.bb589e","type":"function","z":"e3110c85.6a04a","name":"CHECK_PAYMENT_INFO","func":"let storeInfo = msg.payload;\nlet paymentInfo = storeInfo.storeInfo.paymentInfo;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyBankAccountInfo = currentBankRecord.accountInfo;\n\n\nif( \n    (verifyBankAccountInfo.accountNumber === paymentInfo.accountNumber) &&\n    (verifyBankAccountInfo.bank.bankCode === paymentInfo.bank.bankCode)\n) {\n    msg.storeInfo = storeInfo;\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":2260,"y":440,"wires":[["8771f053.bccc1"],["d53e6411.05c718"]]},{"id":"8771f053.bccc1","type":"function","z":"e3110c85.6a04a","name":"PREPARE_UPDATE_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet updateData = msg.storeInfo;\nlet storeID = updateData.storeID;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nlet verifyInfo = {\n    isVerified: true,\n    verifyID: verifyID\n};\n\nupdateData.storeInfo.paymentInfo.verifyInfo = verifyInfo;\n\nnode.error(`Bank account ${displayAccount} match with payment info of storeID: ${storeID}. Update verify info.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}/update`;\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nmsg.url = url;\nmsg.payload = updateData;\n\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":420,"wires":[["801d025a.08f08","98b62f40.1d071"]]},{"id":"801d025a.08f08","type":"http request","z":"e3110c85.6a04a","name":"UPDATE_PAYMENT_INFO","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2640,"y":460,"wires":[["c2301772.b047e8","4ae41018.02e84"]]},{"id":"98b62f40.1d071","type":"debug","z":"e3110c85.6a04a","name":"PREPARE_UPDATE_PAYMENT_INFO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3080,"y":420,"wires":[]},{"id":"e3bf39f6.447288","type":"debug","z":"e3110c85.6a04a","name":"VERIFIED_BANK_ACCOUNT_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2610,"y":260,"wires":[]},{"id":"c2301772.b047e8","type":"debug","z":"e3110c85.6a04a","name":"RESULT_UPDATE_PAYMENT_INFO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3070,"y":460,"wires":[]},{"id":"743c04ab.f239ac","type":"function","z":"e3110c85.6a04a","name":"NOT_VERIFY_BANK_ACCOUNT","func":"// node.error(msg)\nlet resultCode = msg.payload.resultCode;\nlet errorStatus = '';\n\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nswitch( resultCode ) {\n    case \"01\":\n        errorStatus = \"Balance is not enough\";\n        break;\n    case \"02\":\n        errorStatus = \"Bank account not found\";\n        break;\n    case \"90\":\n        errorStatus = \"System error\";\n        break;\n    default:\n        errorStatus = \"Unknown error\";\n}\n\nnode.error(`Can't check status of bank account ${displayAccount} , because \"${errorStatus}\". Skipping...`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1920,"y":340,"wires":[["4ae41018.02e84"]]},{"id":"b5957e07.7cd8","type":"function","z":"e3110c85.6a04a","name":"TEST_POST_TO_GB_PAY","func":"msg.headers = { Authorization: \"Basic PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\" }\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n\n// msg.payload = {\n//     bankAccount: \"0018906546\",\n//     bankCode: \"004\",\n//     amount: 1,\n//     timeline: 1\n// }\n\n\nmsg.payload = {\n    bankAccount: \"1615711908\",\n    bankCode: \"002\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":700,"wires":[["9cd827db.ba1508","b218ace7.b154b"]]},{"id":"b218ace7.b154b","type":"http request","z":"e3110c85.6a04a","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_account","tls":"","proxy":"","authType":"basic","x":950,"y":700,"wires":[["418baf87.957d3"]]},{"id":"30f8c66f.b935fa","type":"inject","z":"e3110c85.6a04a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":500,"y":700,"wires":[["b5957e07.7cd8"]]},{"id":"418baf87.957d3","type":"debug","z":"e3110c85.6a04a","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1210,"y":700,"wires":[]},{"id":"9cd827db.ba1508","type":"debug","z":"e3110c85.6a04a","name":"POST_DATA_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1000,"y":760,"wires":[]},{"id":"d53e6411.05c718","type":"function","z":"e3110c85.6a04a","name":"NOT_MATCH_WITH_PAYMENT_INFO","func":"// node.error(msg)\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nnode.error(`Bank account ${displayAccount} not match with payment info. Skipping...`);\n","outputs":1,"noerr":0,"x":2280,"y":500,"wires":[["4ae41018.02e84"]]},{"id":"1cb2dcab.8cc463","type":"http request","z":"e3110c85.6a04a","name":"GB Pay for Test","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.globalprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":1620,"y":340,"wires":[["278bc181.5af8de","9b6c653e.ad1848"]]},{"id":"eac2a046.b235d","type":"inject","z":"e3110c85.6a04a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":820,"wires":[["18faefdd.fcd57"]]},{"id":"18faefdd.fcd57","type":"function","z":"e3110c85.6a04a","name":"debug context.global","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":860,"wires":[["7dbadf1f.88185"]]},{"id":"7dbadf1f.88185","type":"debug","z":"e3110c85.6a04a","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":540,"y":900,"wires":[]},{"id":"d363c76c.742658","type":"inject","z":"e3110c85.6a04a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":820,"wires":[["6dec9186.fdd0c"]]},{"id":"6dec9186.fdd0c","type":"function","z":"e3110c85.6a04a","name":"reset context.global","func":"delete context.global['currentData'];\ndelete context.global['resultCheck'];\n\nmsg.payload = context.global;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":860,"wires":[["79ce2d8f.087a44"]]},{"id":"79ce2d8f.087a44","type":"debug","z":"e3110c85.6a04a","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":240,"y":900,"wires":[]},{"id":"7d8608d3.cbf798","type":"function","z":"e3110c85.6a04a","name":"SET_TIME_INTERVAL","func":"var intervalDay = 5;\nvar startTime = Date.now() - (24*60*60*intervalDay*1000);\nvar endTime = Date.now();\n\nmsg.url+= `&start=${startTime}&stop=${endTime}`;\nnode.error(msg.url);\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":120,"wires":[["55431e99.18d24"]]},{"id":"9b6c653e.ad1848","type":"function","z":"e3110c85.6a04a","name":"RESULT","func":"let currentBankRecord = msg.currentBankRecord;\n\nnode.error(`Response of bank number ${currentBankRecord.accountInfo.accountNumber} is: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1820,"y":280,"wires":[["573dac69.5a6af4"]]},{"id":"76ef4120.93cff","type":"function","z":"e3110c85.6a04a","name":"SET_COUNTER_FOR_LOOP","func":"msg.counter = 0;\nmsg.bankRecordListLength = msg.bankRecordList.length;\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":240,"wires":[["ec2cddb0.7706d"]]},{"id":"37ad97b5.25dd48","type":"switch","z":"e3110c85.6a04a","name":"counter < bankRecordListLength","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"bankRecordListLength","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":420,"wires":[["ec2cddb0.7706d"],[]]},{"id":"4ae41018.02e84","type":"function","z":"e3110c85.6a04a","name":"INCREASE_COUNTER","func":"msg.counter += 1;\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":520,"wires":[["37ad97b5.25dd48"]]},{"id":"f4fd5d13.74caa","type":"http in","z":"3f620e82.481e02","name":"","url":"/refreshPage","method":"get","upload":false,"swaggerDoc":"","x":230,"y":100,"wires":[["3bac199.7f7d2e6","14a3ea67.6000b6","d3ee6228.7e4c8","1c155fb7.95537"]]},{"id":"d364f6db.2864d8","type":"http response","z":"3f620e82.481e02","name":"","statusCode":"","headers":{},"x":650,"y":100,"wires":[]},{"id":"14a3ea67.6000b6","type":"http request","z":"3f620e82.481e02","name":"msg-aws-sea01.convolab.ai","method":"GET","ret":"obj","paytoqs":false,"url":"https://msg-aws-sea01.convolab.ai/aris/refresh","tls":"","proxy":"","authType":"","x":500,"y":140,"wires":[[]]},{"id":"d3ee6228.7e4c8","type":"http request","z":"3f620e82.481e02","name":"hooks.eu-gb.mybluemix.net","method":"GET","ret":"obj","paytoqs":false,"url":"https://hooks.eu-gb.mybluemix.net/aris/refresh","tls":"","proxy":"","authType":"","x":500,"y":180,"wires":[[]]},{"id":"1c155fb7.95537","type":"http request","z":"3f620e82.481e02","name":"msg.convolab.ai","method":"GET","ret":"obj","paytoqs":false,"url":"https://msg.convolab.ai/aris/refresh","tls":"","proxy":"","authType":"","x":460,"y":220,"wires":[[]]},{"id":"3bac199.7f7d2e6","type":"change","z":"3f620e82.481e02","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"result\":\"success\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":100,"wires":[["d364f6db.2864d8"]]},{"id":"1307181a.3e0ca8","type":"cronplus","z":"3f620e82.481e02","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 12AM","payload":"","type":"str","expression":"0 */12 * * *"}],"x":180,"y":180,"wires":[["3bac199.7f7d2e6","14a3ea67.6000b6","d3ee6228.7e4c8","1c155fb7.95537"]]},{"id":"df2163b.919daa","type":"debug","z":"a926ea52.1ac368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1890,"y":520,"wires":[]},{"id":"9683db11.5730b8","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1930,"y":580,"wires":[]},{"id":"f6272317.12c65","type":"http request","z":"a926ea52.1ac368","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1970,"y":360,"wires":[[]]},{"id":"6d8117b4.7972b8","type":"csv","z":"a926ea52.1ac368","name":"","sep":",","hdrin":"","hdrout":"","multi":"one","ret":"\\n","temp":"","skip":"0","x":1710,"y":620,"wires":[["9683db11.5730b8","6bb44fe0.b8b8c"]]},{"id":"6bb44fe0.b8b8c","type":"file","z":"a926ea52.1ac368","name":"","filename":"txn2.csv","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":1860,"y":660,"wires":[[]]},{"id":"9098492d.c98ca8","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1570,"y":260,"wires":[]},{"id":"43d0c972.b59348","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.payload = msg.payload.txn;\nreturn msg;","outputs":1,"noerr":0,"x":1550,"y":640,"wires":[["6d8117b4.7972b8"]]},{"id":"8c142abf.2d7278","type":"http in","z":"a926ea52.1ac368","name":"","url":"/txnres","method":"get","upload":false,"swaggerDoc":"","x":1580,"y":740,"wires":[["fd27381.1e1c9c8"]]},{"id":"fd27381.1e1c9c8","type":"file in","z":"a926ea52.1ac368","name":"","filename":"txn2.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1780,"y":800,"wires":[["7539d5ee.8a608c"]]},{"id":"7539d5ee.8a608c","type":"http response","z":"a926ea52.1ac368","name":"","statusCode":"","headers":{},"x":2010,"y":740,"wires":[]},{"id":"52705a51.e51244","type":"change","z":"2880ede8.a08db2","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/orderID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":770,"y":820,"wires":[["6ca00561.d7707c"]]},{"id":"24ac5808.a6dbb8","type":"change","z":"2880ede8.a08db2","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/orderID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":860,"wires":[["6ca00561.d7707c"]]},{"id":"f8ae3b1c.eb5618","type":"change","z":"2880ede8.a08db2","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/orderID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":770,"y":900,"wires":[["6ca00561.d7707c"]]},{"id":"6ca00561.d7707c","type":"function","z":"2880ede8.a08db2","name":"SET_ORDER_ID_TO_API","func":"msg.url+= `/${msg.orderID}`;\n\nnode.error('GET order info: '+msg.url);\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":820,"wires":[["39fa427d.9ec83e"]]},{"id":"f0b326c9.89f228","type":"http in","z":"2880ede8.a08db2","name":"","url":"/checkOrder","method":"get","upload":false,"swaggerDoc":"","x":100,"y":820,"wires":[["b037a10.645946"]]},{"id":"fc07f4c0.2d2ab8","type":"function","z":"2880ede8.a08db2","name":"","func":"let orderID = msg.payload.orderID;\n\nmsg.orderID = orderID;\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":820,"wires":[["f8ae3b1c.eb5618"]]},{"id":"b037a10.645946","type":"switch","z":"2880ede8.a08db2","name":"with ?orderID querystring or not","property":"payload.orderID","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":820,"wires":[["fc07f4c0.2d2ab8"],["90e3bed0.3db34"]]},{"id":"90e3bed0.3db34","type":"function","z":"2880ede8.a08db2","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Order ID must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":860,"wires":[["97759e19.92b87"]]},{"id":"97759e19.92b87","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":290,"y":900,"wires":[]},{"id":"39fa427d.9ec83e","type":"http request","z":"2880ede8.a08db2","name":"GET_ORDER","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1080,"y":860,"wires":[["dc255662.62c708"]]},{"id":"b2d83e38.fc91e","type":"function","z":"2880ede8.a08db2","name":"SAVE_ORDER_TO_MSG_OBJ","func":"msg.orderInfo = msg.payload[0];\nmsg.storeID = msg.orderInfo['storeID'];\n\nnode.error('Result from get order:');\nnode.error(msg.payload);\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":920,"wires":[["dc9b898.d47cc78"]]},{"id":"87e6141a.0075a8","type":"function","z":"2880ede8.a08db2","name":"CHECK_WITH_REFNO","func":"let order = msg.orderInfo;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\n// let gbPayLink = order['paymentInfo']['gbPayLink'];\n// let gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2430,"y":820,"wires":[["b9c34d1a.4137b"]]},{"id":"b9c34d1a.4137b","type":"function","z":"2880ede8.a08db2","name":"SET_HEADERS","func":"const gbPayAccountObj = msg.gbPayAccountObj;\n\nvar SECRET_KEY = \"\";\n\nif (gbPayAccountObj['found']) {\n    SECRET_KEY = gbPayAccountObj['secret_key'];\n}\n\nmsg.headers = {}\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nmsg.url = \"https://api.gbprimepay.com/v1/check_status_txn\";\n\n// node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":840,"wires":[["56f370d2.557a6"]]},{"id":"56f370d2.557a6","type":"http request","z":"2880ede8.a08db2","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2670,"y":880,"wires":[["c3b736b4.35b328"]]},{"id":"ccb8be47.452f4","type":"function","z":"2880ede8.a08db2","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2430,"y":880,"wires":[["b9c34d1a.4137b"]]},{"id":"c3b736b4.35b328","type":"switch","z":"2880ede8.a08db2","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2680,"y":940,"wires":[["bed1253a.b26ea8"],["25367855.4eb7a8"]]},{"id":"25367855.4eb7a8","type":"switch","z":"2880ede8.a08db2","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2760,"y":1000,"wires":[["fd0168f.6053298"],["6dde5b17.50ef14"]]},{"id":"6dde5b17.50ef14","type":"function","z":"2880ede8.a08db2","name":"Can't find REF_NO and LINK_NO 😢","func":"const ORDER_ID = msg.orderID;\n\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${ORDER_ID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)\n\nmsg.payload = {\n    \"orderID\": ORDER_ID,\n    \"method\": \"\",\n    \"status\": \"PENDING\",\n    \"order_info\": msg.orderInfo,\n    \"gb_response\": {}\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2970,"y":1060,"wires":[["b2999993.927428"]]},{"id":"fd0168f.6053298","type":"link out","z":"2880ede8.a08db2","name":"LINK_NO_OUT","links":["d4c24441.d948c8","157c055c.d842db","49e8ae58.83bce"],"x":2915,"y":980,"wires":[]},{"id":"49e8ae58.83bce","type":"link in","z":"2880ede8.a08db2","name":"","links":["fd0168f.6053298"],"x":2295,"y":940,"wires":[["ccb8be47.452f4"]]},{"id":"dc9b898.d47cc78","type":"function","z":"2880ede8.a08db2","name":"SET_BODY_TO_GET_STORE_INFO","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/businessProfile/storeID/${msg.storeID}/`;\nnode.error('GET store info: '+msg.url);\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1710,"y":820,"wires":[["1990c6bc.4a5409"]]},{"id":"1990c6bc.4a5409","type":"http request","z":"2880ede8.a08db2","name":"GET_STORE_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1660,"y":860,"wires":[["2354bc6e.f83c14"]]},{"id":"2354bc6e.f83c14","type":"function","z":"2880ede8.a08db2","name":"SAVE_STORE_TO_MSG_OBJ","func":"msg.storeInfo = msg.payload;\n\nnode.error('Result from get store:');\nnode.error(msg.payload);\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1690,"y":900,"wires":[["a3ad6ea1.c36fd"]]},{"id":"d04a25d5.4c3aa8","type":"http request","z":"2880ede8.a08db2","name":"GET_GB_ACCOUNT","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2040,"y":860,"wires":[["4e97387b.91fe68"]]},{"id":"a3ad6ea1.c36fd","type":"function","z":"2880ede8.a08db2","name":"SET_BODY_TO_GET_GB_ACCOUNT","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/gbpayAccount/findByToken`;\nmsg.payload = {\n    \"token\": msg.storeInfo.storeInfo.paymentInfo.gbPayInfo.token\n};\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nnode.error('GET gb account info: '+msg.url+' with body:');\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":2090,"y":820,"wires":[["d04a25d5.4c3aa8"]]},{"id":"4e97387b.91fe68","type":"function","z":"2880ede8.a08db2","name":"SAVE_GB_ACCOUNT_TO_MSG_OBJ","func":"msg.gbPayAccountObj = msg.payload.gbPayAccountInfo;\nmsg.gbPayAccountObj.found = true;\n\nmsg.currentOrder = msg.orderInfo;\n\nnode.error('Result from gb account store:');\nnode.error(msg.payload);\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":2090,"y":900,"wires":[["87e6141a.0075a8"]]},{"id":"dc255662.62c708","type":"switch","z":"2880ede8.a08db2","name":"Found order","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":940,"wires":[["b2d83e38.fc91e"],["e603ace9.7d138"]]},{"id":"e603ace9.7d138","type":"function","z":"2880ede8.a08db2","name":"","func":"msg.statusCode = 501;\nmsg.payload = {\n    \"message\": \"Not found orderID: \"+msg.orderID\n}\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":960,"wires":[["c5ea07ff.d3d6a8"]]},{"id":"c5ea07ff.d3d6a8","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":1230,"y":1000,"wires":[]},{"id":"bed1253a.b26ea8","type":"function","z":"2880ede8.a08db2","name":"Find reference no","func":"node.error('Result from gb pay:');\nnode.error(msg.payload);\n\nmsg.GB_RESPONSE = msg.payload.txn;\n\nreturn msg;","outputs":1,"noerr":0,"x":2910,"y":880,"wires":[["7aa6f8ee.61dd98"]]},{"id":"b2999993.927428","type":"http response","z":"2880ede8.a08db2","name":"","statusCode":"","headers":{},"x":3310,"y":880,"wires":[]},{"id":"7aa6f8ee.61dd98","type":"function","z":"2880ede8.a08db2","name":"Process response.","func":"let GB_RESPONSE = msg.GB_RESPONSE;\nconst ORDER_ID = msg.orderID;\n\nconst checkMerchantDefined1 = (ORDER_ID, responseObj) => {\n    return responseObj.hasOwnProperty('merchantDefined1') && ( (responseObj['merchantDefined1'] !== null && responseObj['merchantDefined1'] == ORDER_ID) || responseObj['merchantDefined1'] === null );\n}\n\nconst processResponse = (ORDER_ID, responseObj) => {\n    let returnObj = {\n        \"method\": \"\",\n        \"status\": \"\"\n    };\n\n    let paymentMethod = \"QR_CODE\";\n    let paymentStatus = \"PENDING\";\n    if( responseObj.hasOwnProperty('cardNo') ) {\n        paymentMethod = \"CREDIT_CARD\";\n    }\n\n    if( responseObj.hasOwnProperty('status') ) {\n        const responseStatus = responseObj['status'].toUpperCase();\n\n        if( checkMerchantDefined1(ORDER_ID, responseObj) ) {\n            if( responseStatus === \"S\" ) {\n                paymentStatus = \"SUCCESS\";\n            } else if ( responseStatus === \"G\" ) {\n                paymentStatus = \"PENDING\";\n            } else if ( responseStatus === \"D\" ) {\n                paymentStatus = \"FAIL\";\n            } else if ( responseStatus === \"A\" ) {\n                if( paymentMethod === \"CREDIT_CARD\" ) {\n                    paymentStatus = \"SUCCESS\";\n                } else {\n                    paymentStatus = \"PENDING\";\n                }\n            }\n\n            returnObj['gb_response'] = responseObj;\n        }\n        \n    }\n    returnObj['method'] = paymentMethod;\n    returnObj['status'] = paymentStatus;\n    \n    return returnObj;\n}\n\nlet response = {};\nif( Array.isArray(GB_RESPONSE) ) {\n    node.error('Found multi response.');\n    for(i=0; i<GB_RESPONSE.length; i++) {\n        const gbResponse = GB_RESPONSE[i];\n        if( gbResponse.hasOwnProperty('merchantDefined1') && gbResponse['merchantDefined1'] === ORDER_ID ) {\n            response = processResponse(ORDER_ID, gbResponse);\n            break;\n        }\n    }\n} else {\n    node.error('Found single response.');\n    response = processResponse(ORDER_ID, GB_RESPONSE);\n}\n\nmsg.payload = {\n    \"orderID\": ORDER_ID,\n    \"method\": response['method'],\n    \"status\": response['status'],\n    \"order_info\": msg.orderInfo,\n    \"gb_response\": response['gb_response']\n};\n\nnode.error(msg.payload);\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":3130,"y":880,"wires":[["b2999993.927428"]]},{"id":"5b284126.d3607","type":"function","z":"a926ea52.1ac368","name":"SET_PAYLOAD_FOR_WGET","func":"const url = msg.csvFileToGet;\nconst filename = msg.csvFilename;\n\n// msg.payload = `wget -O ${filename} ${url}`;\n// msg.payload = `wget ${url}`;\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":1580,"wires":[["4b66ffd4.36b55"]]},{"id":"f98fe1b0.09017","type":"csv","z":"a926ea52.1ac368","name":"","sep":",","hdrin":"","hdrout":"","multi":"one","ret":"\\n","temp":"","skip":"0","x":730,"y":1700,"wires":[["6d98882b.e61148"]]},{"id":"4b66ffd4.36b55","type":"http request","z":"a926ea52.1ac368","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":790,"y":1620,"wires":[["f98fe1b0.09017"]]},{"id":"33579f04.4a586","type":"file","z":"a926ea52.1ac368","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":750,"y":1800,"wires":[[]]},{"id":"6d98882b.e61148","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.filename = msg.csvFilename;\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":1740,"wires":[["33579f04.4a586"]]},{"id":"183a708e.d2573f","type":"function","z":"a926ea52.1ac368","name":"SET_EMAIL_BODY","func":"// const attachmentFilename = msg.csvFilename;\n\nmsg.emailTo = \"thatchanon@arislab.ai\";\nmsg.emailSubject = \"Daily order report: \" + Date.now();\nmsg.emailText = \"Here's your daily order report. \\n\";\nmsg.emailHtml = `<a href=\"https://www.google.com/\">Download daily report</a>`;\n// msg.emailAttachments = [\n//     {\n//         \"filename\": attachmentFilename,\n//         \"path\": `./${attachmentFilename}`\n//     }\n// ];\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":1640,"wires":[["bf53744b.4ce4f8"]]},{"id":"64300c23.c16c94","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":1580,"wires":[["183a708e.d2573f"]]},{"id":"fee52905.dff238","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":290,"y":1720,"wires":[]},{"id":"bf53744b.4ce4f8","type":"subflow:e2998060.c233b","z":"a926ea52.1ac368","name":"","env":[],"x":280,"y":1680,"wires":[["fee52905.dff238"]]},{"id":"58e44a33.4b8ac4","type":"csv","z":"a926ea52.1ac368","name":"data","sep":",","hdrin":true,"hdrout":false,"multi":"one","ret":"\\n","temp":"","skip":"0","x":1010,"y":1420,"wires":[["c0464250.21d9b"]]},{"id":"c0464250.21d9b","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1190,"y":1420,"wires":[]},{"id":"57ff33c.b5ee4cc","type":"http in","z":"353f8139.23f9ee","name":"","url":"/liveChecker","method":"get","upload":false,"swaggerDoc":"","x":330,"y":120,"wires":[["37b1ccc7.7b4394"]]},{"id":"51976f2a.0be21","type":"http response","z":"353f8139.23f9ee","name":"","statusCode":"","headers":{},"x":670,"y":140,"wires":[]},{"id":"37b1ccc7.7b4394","type":"template","z":"353f8139.23f9ee","name":"","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Live checker</title>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css\">\n</head>\n\n<body>\n    <div class=\"container\">\n        <h1>Live checker</h1>\n        <div class=\"row\">\n            <div class=\"col-md-12\">\n                <div class=\"form-group\">\n                    <input type=\"text\" class=\"form-control\" id=\"liveTitle\" placeholder=\"Live title\" />\n                    <span id=\"liveTitleStatus\"></span>\n                </div>\n                <!--<div class=\"form-group\">-->\n                <!--    <input type=\"text\" class=\"form-control\" id=\"liveDesc\" placeholder=\"Live description\" />-->\n                <!--    <span id=\"liveTitleDesc\"></span>-->\n                <!--</div>-->\n            </div>\n        </div>\n    </div>\n    <script type=\"text/javascript\">\n        const liveTitle = document.getElementById('liveTitle');\n        const liveTitleStatus = document.getElementById('liveTitleStatus');\n        \n        liveTitleStatus.innerText = \"\";\n        \n        const liveTitleHandler = function(e) {\n            let status = \"✅\";\n            if ((new TextEncoder().encode(e.target.value)).length > 254) {\n                status = \"❌\";\n            }\n            liveTitleStatus.innerText = status;\n        }\n        \n        liveTitle.addEventListener('input', liveTitleHandler);\n    </script>\n</body>\n\n</html>","output":"str","x":500,"y":260,"wires":[["51976f2a.0be21"]]},{"id":"c1f4934f.e212e","type":"function","z":"a926ea52.1ac368","name":"SET_EMAIL_BODY","func":"const attachmentFilename = msg.csvFilename;\nnode.error('completed')\nmsg.emailTo = \"admin@arislab.ai\";\nmsg.emailSubject = \"Daily order report: \" + msg.REPORT_DATE;\nmsg.emailText = \"Here's your daily order report. \\n\";\n//msg.emailHtml = `<a href=\"https://manage.arislab.ai/reconcile.csv\">Download daily report</a>`;\nmsg.emailHtml = `<a href=\"https://manage.arislab.ai/download?file=${msg.FILE_NAME}\">Download daily report</a>`;\n\n// msg.emailAttachments = [\n//     {\n//         \"filename\": attachmentFilename,\n//         \"path\": `./${attachmentFilename}`\n//     }\n// ];\n\nreturn msg;","outputs":1,"noerr":0,"x":3160,"y":1320,"wires":[["75322907.78e908"]]},{"id":"75322907.78e908","type":"subflow:e2998060.c233b","z":"a926ea52.1ac368","name":"","env":[],"x":3140,"y":1380,"wires":[["c03ee6ea.2fcec8"]]},{"id":"c03ee6ea.2fcec8","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":3390,"y":1400,"wires":[]},{"id":"fd96d491.36ecb8","type":"comment","z":"a926ea52.1ac368","name":"Automatically send yesterday order report to specified email","info":"","x":320,"y":1060,"wires":[]},{"id":"c0fa15fa.e378b8","type":"function-npm","z":"a926ea52.1ac368","name":"SET_START_AND_END_TIMESTAMP","func":"const moment = require(\"moment-timezone\");\n// const momentTZ = require(\"moment-timezone\");\n\nconst start = moment().tz(\"Asia/Bangkok\").subtract(1,'days').startOf('day').valueOf();\nconst end = moment().tz(\"Asia/Bangkok\").subtract(1,'days').endOf('day').valueOf();\n\nmsg.orderReportStartTimestamp = start;\nmsg.orderReportEndTimestamp = end;\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":1120,"wires":[["7ca85e84.0c5a7"]]},{"id":"7ca85e84.0c5a7","type":"function","z":"a926ea52.1ac368","name":"SET_URL_OF_CSV_FILE_TO_SEND","func":"const start = msg.orderReportStartTimestamp;\nconst end = msg.orderReportEndTimestamp;\nmsg.csvFileToGet = `https://admin-internal.arislab.ai/export/csv/order?selectedStoreID=&selectedStatus=&startDate=${start}&endDate=${end}`;\nmsg.csvFilename = `order_daily_report_${Date.now()}.csv`;\nmsg.url = `https://admin-internal.arislab.ai/export/csv/order?selectedStoreID=&selectedStatus=&startDate=${start}&endDate=${end}`;\nnode.error(msg.url)\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":1160,"wires":[["3cdd5d37.3cfaa2"]]},{"id":"11f9b55c.45466b","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1120,"wires":[[]]},{"id":"b61857b6.dcfd28","type":"cronplus","z":"a926ea52.1ac368","name":"","outputField":"payload","timeZone":"","options":[{"topic":"every 1AM","payload":"","type":"str","expression":"0 1 * * *"}],"x":140,"y":1180,"wires":[["c0fa15fa.e378b8"]]},{"id":"3cdd5d37.3cfaa2","type":"http request","z":"a926ea52.1ac368","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":710,"y":1140,"wires":[["74d3b240.063d7c"]]},{"id":"624d39d1.ae9f38","type":"csv","z":"a926ea52.1ac368","name":"data","sep":",","hdrin":true,"hdrout":false,"multi":"mult","ret":"\\n","temp":"","skip":"0","strings":true,"x":1050,"y":1140,"wires":[["1c95d157.fa9caf"]]},{"id":"bd56461d.e42fc8","type":"file","z":"a926ea52.1ac368","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":2430,"y":1200,"wires":[["78d11ec7.1bf83"]]},{"id":"74d3b240.063d7c","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.payload = msg.payload.replace(/[) ][\\n]/gm, \"\").replace(/\"\"/gm, \"-\");\nmsg.csv = []\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":1140,"wires":[["386f9dc.4db8d62","624d39d1.ae9f38"]]},{"id":"f9ac9260.5858a","type":"function","z":"a926ea52.1ac368","name":"","func":"if (msg.payload) {\n    if (msg.payload.hasOwnProperty('status')) {\n        msg.csvBody[msg.counter]['gbStatus'] = msg.payload['status'];\n    } else {\n        msg.csvBody[msg.counter]['gbStatus'] = \"No gbStatus\"\n    }\n} else {\n    msg.csvBody[msg.counter]['gbStatus'] = \"No gbStatus\";\n}\n\nmsg.url = `http://console.cb-beta.arislab.ai:1780/api/fundsTransaction/orderID/${msg.csvBody[msg.counter].orderID}`\n// msg.url = `http://console.internal.arislab.ai:1780/api/fundsTransaction/orderID/xxxyyy`\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJpc3MiOiJhcmlzbGFiaW8ifQ.yjpKHD9lqXpcUGAzervcyj7IFHhje88CGCZMbQ3UH8o\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":1870,"y":1140,"wires":[["4e24961e.45f238"]]},{"id":"1bde092e.2701d7","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":1280,"wires":[["7348b986.c70c08"]]},{"id":"acc01a9d.b921b8","type":"http request","z":"a926ea52.1ac368","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1650,"y":1140,"wires":[["45dadacc.452694","f9ac9260.5858a"]]},{"id":"1c95d157.fa9caf","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.csvHeader = [\n    \"orderDocID\",\n    \"storeID\",\n    \"referenceNo\",\n    \"orderID\",\n    \"orderDate\",\n    \"paymentCompletedOn\",\n    \"customerFBFullName\",\n    \"customerName\",\n    \"customerEmail\",\n    \"customerAddress\",\n    \"subDistrict\",\n    \"district\",\n    \"province\",\n    \"postalCode\",\n    \"customerTelephone\",\n    \"selectedProduct\",\n    \"productHashtag\",\n    \"productSKU\",\n    \"paymentStatus\",\n    \"paymentMethod\",\n    \"totalPrice\",\n    \"totalDeliveryCost\",\n    \"grandTotal\",\n    \"fee\",\n    \"afterFee\",\n    \"gbPayReferenceNo\",\n    \"gbPayLink\",\n    \"fbPageName\",\n    \"gbStatus\",\n    \"fundsTransactionStatus\"\n];\n\nmsg.csvBody = msg.payload;\nmsg.csvBodyLength = msg.csvBody.length;\nmsg.counter = 0;\nmsg.timeout = 2000;\nreturn msg;\n\n// msg.csv = msg.payload\n// msg.url = `http://manage.arislab.ai/checkOrder?orderID=${msg.csv.orderID}`\n// return msg;","outputs":1,"noerr":0,"x":1250,"y":1140,"wires":[["3d1ff54a.a6e6ea"]]},{"id":"7348b986.c70c08","type":"file","z":"a926ea52.1ac368","name":"","filename":"orders.csv","appendNewline":true,"createDir":false,"overwriteFile":"delete","encoding":"none","x":470,"y":1340,"wires":[[]]},{"id":"9d4db3e5.848bd","type":"csv","z":"a926ea52.1ac368","name":"data","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\n","temp":"","skip":"0","x":2290,"y":1200,"wires":[["bd56461d.e42fc8"]]},{"id":"fe0e9c20.19b42","type":"http in","z":"a926ea52.1ac368","name":"","url":"/reconcile.csv","method":"get","upload":false,"swaggerDoc":"","x":1650,"y":1340,"wires":[["3bc556b1.d0cc7a"]]},{"id":"3bc556b1.d0cc7a","type":"file in","z":"a926ea52.1ac368","name":"","filename":"orders.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1830,"y":1340,"wires":[["1268f5b0.3452aa"]]},{"id":"1268f5b0.3452aa","type":"http response","z":"a926ea52.1ac368","name":"","statusCode":"","headers":{"content-type":"text/csv"},"x":1990,"y":1340,"wires":[]},{"id":"8b854f44.c66bc","type":"function","z":"a926ea52.1ac368","name":"","func":"// msg.payload = msg.csvBody[msg.counter]\nnode.error(`Requesting @${msg.counter}/${msg.csvBody.length}`);\nmsg.url = `http://manage.arislab.ai/checkOrder?orderID=${msg.csvBody[msg.counter].orderID}`\nnode.error(`OrderID ${msg.csvBody[msg.counter].orderID}`)\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1140,"wires":[["acc01a9d.b921b8"]]},{"id":"3d1ff54a.a6e6ea","type":"switch","z":"a926ea52.1ac368","name":"switch","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"csvBody.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1430,"y":1220,"wires":[["8b854f44.c66bc"],["5152804d.b81f8","436844dc.c046bc"]]},{"id":"4ac9f7f9.5b6368","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.counter += 1;\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1300,"wires":[["3d1ff54a.a6e6ea"]]},{"id":"5152804d.b81f8","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.payload = msg.csvHeader;\nnode.error('Test');\nnode.error(msg.csvHeader);\n\nvar d = new Date();\nvar year = d.getFullYear();\nvar month = (100 + d.getMonth() + 1).toString().substring(1)\nvar day = (100 + d.getDate() - 1).toString().substring(1);\nmsg.REPORT_DATE = `${day}/${month}/${year}`;\nmsg.FILE_NAME = `reconcile_order_${year}_${month}_${day}.csv`;\nmsg.filename = `report/${msg.FILE_NAME}`;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2130,"y":1200,"wires":[["9d4db3e5.848bd"]]},{"id":"78d11ec7.1bf83","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.counter = 0;\nmsg.payload = [];\nnode.error('Set start loop');\nreturn msg;","outputs":1,"noerr":0,"x":2650,"y":1200,"wires":[["b5dda139.06793"]]},{"id":"b5dda139.06793","type":"switch","z":"a926ea52.1ac368","name":"","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"csvBody.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2810,"y":1200,"wires":[["4c89b990.f3d058"],["c1f4934f.e212e"]]},{"id":"317477f9.bfe8d8","type":"csv","z":"a926ea52.1ac368","name":"data","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\n","temp":"","skip":"0","x":3090,"y":1200,"wires":[["d9852549.182668"]]},{"id":"4c89b990.f3d058","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.payload = msg.csvBody[msg.counter];\nreturn msg;","outputs":1,"noerr":0,"x":2950,"y":1200,"wires":[["317477f9.bfe8d8"]]},{"id":"d9852549.182668","type":"file","z":"a926ea52.1ac368","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":3230,"y":1200,"wires":[["802fd02a.c5dcb"]]},{"id":"802fd02a.c5dcb","type":"function","z":"a926ea52.1ac368","name":"","func":"node.error(`Writing @${msg.counter}/${msg.csvBody.length}`)\nmsg.counter += 1;\nreturn msg;","outputs":1,"noerr":0,"x":2850,"y":1080,"wires":[["b5dda139.06793"]]},{"id":"ad4655ea.2bd298","type":"function","z":"a926ea52.1ac368","name":"","func":"msg.csv.push(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":1060,"wires":[[]]},{"id":"436844dc.c046bc","type":"debug","z":"a926ea52.1ac368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"csvBody","targetType":"msg","x":1670,"y":1260,"wires":[]},{"id":"386f9dc.4db8d62","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1070,"y":1260,"wires":[]},{"id":"4e24961e.45f238","type":"http request","z":"a926ea52.1ac368","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1890,"y":1080,"wires":[["615b0e5a.9133a","fe598b8c.196268"]]},{"id":"615b0e5a.9133a","type":"function","z":"a926ea52.1ac368","name":"","func":"\nif (msg.payload.length > 0) {\n    msg.csvBody[msg.counter]['fundsTransactionStatus'] = \"SUCCESS\";\n} else {\n    msg.csvBody[msg.counter]['fundsTransactionStatus'] = \"-\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2070,"y":1080,"wires":[["4ac9f7f9.5b6368"]]},{"id":"5d97dae6.731224","type":"switch","z":"a926ea52.1ac368","name":"","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"csvBody.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1430,"y":1040,"wires":[[],[]]},{"id":"7d889083.0b2c","type":"inject","z":"a926ea52.1ac368","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2980,"y":1260,"wires":[["c1f4934f.e212e"]]},{"id":"45dadacc.452694","type":"debug","z":"a926ea52.1ac368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1710,"y":1000,"wires":[]},{"id":"fe598b8c.196268","type":"debug","z":"a926ea52.1ac368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2090,"y":1000,"wires":[]},{"id":"cebe4eea.abc65","type":"http in","z":"4ae7f72e.33e4a8","name":"","url":"/download","method":"get","upload":false,"swaggerDoc":"","x":100,"y":100,"wires":[["57f0e6a3.e340a8"]]},{"id":"5f8e42df.73b1ac","type":"file in","z":"4ae7f72e.33e4a8","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":910,"y":60,"wires":[["59e33f92.4d131"]]},{"id":"59e33f92.4d131","type":"http response","z":"4ae7f72e.33e4a8","name":"","statusCode":"","headers":{},"x":1070,"y":60,"wires":[]},{"id":"57f0e6a3.e340a8","type":"switch","z":"4ae7f72e.33e4a8","name":"with ?file querystring or not","property":"payload.file","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":100,"wires":[["ea61d07e.c7a12"],["5199eabf.c2cf34"]]},{"id":"5199eabf.c2cf34","type":"change","z":"4ae7f72e.33e4a8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing file download, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":580,"y":180,"wires":[["84a15106.0c1b2"]]},{"id":"84a15106.0c1b2","type":"http response","z":"4ae7f72e.33e4a8","name":"","statusCode":"","headers":{},"x":550,"y":220,"wires":[]},{"id":"ea61d07e.c7a12","type":"function","z":"4ae7f72e.33e4a8","name":"CHECK_FILE_DOWNLOAD","func":"var fileName = msg.payload.file;\n\nlet foundFile = false;\nconst reconcilePattern = /^reconcile/g;\n\nif( reconcilePattern.test(fileName) ) {\n    foundFile = true;\n    msg.filename = `report/${fileName}`;\n    msg.headers = {\n        'Content-Type': 'text/csv',\n        'Content-Disposition': `attachment; filename=\"${fileName}\"`\n    };\n}\n\n\n\nif( foundFile ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":640,"y":80,"wires":[["5f8e42df.73b1ac"],["e5f41b16.836648"]]},{"id":"e5f41b16.836648","type":"change","z":"4ae7f72e.33e4a8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"file not found","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"404","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":160,"wires":[["bc2e4567.bae5a8"]]},{"id":"bc2e4567.bae5a8","type":"http response","z":"4ae7f72e.33e4a8","name":"","statusCode":"","headers":{},"x":830,"y":200,"wires":[]},{"id":"5674b220.070c9c","type":"http in","z":"c0036ad7.2ae908","name":"","url":"/getVoucherCode","method":"get","upload":false,"swaggerDoc":"","x":160,"y":1040,"wires":[["442256c2.e6e518"]]},{"id":"5d24cd6f.9f7984","type":"file in","z":"c0036ad7.2ae908","name":"","filename":"testVoucher.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":670,"y":1000,"wires":[["a141df54.82095"]]},{"id":"a141df54.82095","type":"function","z":"c0036ad7.2ae908","name":"","func":"let voucherArr = msg.payload.split(\"\\n\");\n\nmsg.payload = voucherArr[0];\n\nnode.error(\"Before splice \"+ voucherArr.length)\n\nvoucherArr.splice(0,1)\n\nnode.error(\"After splice \"+ voucherArr.length)\n\nlet voucherString = voucherArr.join('\\n')\n\nvoucherString = voucherString.replace(/\\n$/g,\"\")\n\nnode.error(voucherString)\n\ncontext.global.voucherString = voucherString\n\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":1040,"wires":[["684f1c8.66cdde4","4473f570.e8beac","f43cb2c9.fbc1a"]]},{"id":"4473f570.e8beac","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":1010,"y":960,"wires":[]},{"id":"684f1c8.66cdde4","type":"debug","z":"c0036ad7.2ae908","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1010,"y":1120,"wires":[]},{"id":"becf893.2bcdb78","type":"file","z":"c0036ad7.2ae908","name":"","filename":"testVoucher.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1340,"y":1000,"wires":[[]]},{"id":"1b575c2d.635034","type":"switch","z":"c0036ad7.2ae908","name":"","property":"payload.useFile","propertyType":"msg","rules":[{"t":"eq","v":"file1","vt":"str"},{"t":"eq","v":"file2","vt":"str"},{"t":"eq","v":"file3","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":490,"y":1040,"wires":[["5d24cd6f.9f7984"],["41c070a3.b5f81"],["d10b7517.67de08"],["d8d3c06d.e4093"]]},{"id":"41c070a3.b5f81","type":"file in","z":"c0036ad7.2ae908","name":"","filename":"testVoucher2.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":680,"y":1040,"wires":[["a141df54.82095"]]},{"id":"d10b7517.67de08","type":"file in","z":"c0036ad7.2ae908","name":"","filename":"testVoucher3.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":680,"y":1080,"wires":[["a141df54.82095"]]},{"id":"f43cb2c9.fbc1a","type":"switch","z":"c0036ad7.2ae908","name":"","property":"useFile","propertyType":"global","rules":[{"t":"eq","v":"file1","vt":"str"},{"t":"eq","v":"file2","vt":"str"},{"t":"eq","v":"file3","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1010,"y":1040,"wires":[["34b3c6a5.a2857a"],["36a5ec97.fbbfd4"],["d8a835b5.a394c8"]]},{"id":"442256c2.e6e518","type":"function","z":"c0036ad7.2ae908","name":"","func":"context.global.useFile = msg.payload.useFile;\nnode.error(msg.payload.useFile)\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":1040,"wires":[["1b575c2d.635034"]]},{"id":"2f574f3f.648f","type":"file","z":"c0036ad7.2ae908","name":"","filename":"testVoucher2.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1350,"y":1040,"wires":[[]]},{"id":"498f2646.aa84e8","type":"file","z":"c0036ad7.2ae908","name":"","filename":"testVoucher3.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1350,"y":1080,"wires":[[]]},{"id":"34b3c6a5.a2857a","type":"function","z":"c0036ad7.2ae908","name":"","func":"msg.payload = context.global.voucherString\nnode.error(msg)\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1000,"wires":[["becf893.2bcdb78"]]},{"id":"36a5ec97.fbbfd4","type":"function","z":"c0036ad7.2ae908","name":"","func":"msg.payload = context.global.voucherString\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1040,"wires":[["2f574f3f.648f"]]},{"id":"d8a835b5.a394c8","type":"function","z":"c0036ad7.2ae908","name":"","func":"msg.payload = context.global.voucherString\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1080,"wires":[["498f2646.aa84e8"]]},{"id":"d8d3c06d.e4093","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":650,"y":1120,"wires":[]},{"id":"f16d49e2.3c0b18","type":"http in","z":"c0036ad7.2ae908","name":"","url":"/vote","method":"post","upload":false,"swaggerDoc":"","x":130,"y":1180,"wires":[["cff8dd11.db9c"]]},{"id":"b6407d40.47802","type":"file in","z":"c0036ad7.2ae908","name":"","filename":"voteResult.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":480,"y":1180,"wires":[["e69ddd3e.63e61"]]},{"id":"cff8dd11.db9c","type":"function","z":"c0036ad7.2ae908","name":"","func":"context.global.voteNumber = msg.payload.voteNumber;\nnode.error(msg.payload.voteNumber)\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":1180,"wires":[["b6407d40.47802"]]},{"id":"e69ddd3e.63e61","type":"function","z":"c0036ad7.2ae908","name":"","func":"let voteArr = msg.payload.split(\"\\n\");\nlet hadVote = false;\nlet voteNumber = context.global.voteNumber;\nlet index = 0;\n\nvoteArr.splice(voteArr.length-1, 1)\n\nnode.error(voteArr)\n\nfor(let i=0;i < voteArr.length;i++){\n    if(voteArr[i].length > 0){\n        let voteObj = JSON.parse(voteArr[i])\n        if(voteObj.number == voteNumber){\n            hadVote = true\n            index = i\n        }\n    }\n}\n\nif(hadVote){\n    let voteObj = JSON.parse(voteArr[index])\n    let voteStr = JSON.stringify({\"number\": voteObj.number,\"value\": voteObj.value+1})\n    voteArr.splice(index,1)\n    voteArr.push(voteStr)\n}\nelse{\n    let voteStr = JSON.stringify({\"number\": voteNumber,\"value\": 1});\n    voteArr.push(voteStr)\n}\nlet voteArrStr = voteArr.join(\"\\n\")\nvoteArrStr = voteArrStr.replace(/\\n$/g,\"\")\nnode.error(voteArrStr)\n\nmsg.payload = voteArrStr\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":1180,"wires":[["f507cdb8.d0aa6","daeae593.070ed8"]]},{"id":"f507cdb8.d0aa6","type":"file","z":"c0036ad7.2ae908","name":"","filename":"voteResult.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":840,"y":1180,"wires":[[]]},{"id":"daeae593.070ed8","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":820,"y":1260,"wires":[]},{"id":"3ff67c20.f69114","type":"http in","z":"c0036ad7.2ae908","name":"","url":"/voteResult","method":"get","upload":false,"swaggerDoc":"","x":150,"y":1320,"wires":[["4255174f.51a3d8"]]},{"id":"4255174f.51a3d8","type":"file in","z":"c0036ad7.2ae908","name":"","filename":"voteResult.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":360,"y":1320,"wires":[["52a5047a.a3991c"]]},{"id":"52a5047a.a3991c","type":"http response","z":"c0036ad7.2ae908","name":"","statusCode":"","headers":{},"x":540,"y":1320,"wires":[]}]