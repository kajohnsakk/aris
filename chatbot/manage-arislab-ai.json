[{"id":"ab4af741.642ba8","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"47a19322.f1f68c","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"c7155c63.2294","type":"tab","label":"WEBFORM_RECONCILE","disabled":false,"info":""},{"id":"eb9ff6d6.6b53f8","type":"tab","label":"CHECK_GBPAY_PAYMENT_STATUS","disabled":false,"info":""},{"id":"e140dd9b.b381c","type":"tab","label":"CHECK_VERIFY_BANK_ACCOUNT","disabled":false,"info":""},{"id":"c80eab85.dafc88","type":"tab","label":"CHECK_VERIFY_BANK_ACCOUNT_API","disabled":false,"info":""},{"id":"d3a831f5.f8fec","type":"tab","label":"CALCULATE_GBPAY_PAYMENT_FEE","disabled":false,"info":""},{"id":"4667e2bc.3c826c","type":"tab","label":"SERVER_STATUS","disabled":false,"info":""},{"id":"4855adbb.ec1254","type":"tab","label":"SERVER_SIDE_MANAGEMENT","disabled":false,"info":""},{"id":"370ebe73.42de32","type":"tab","label":"UTILITIES","disabled":false,"info":""},{"id":"b29be39b.cf04","type":"tab","label":"FACEBOOK_TOKEN","disabled":false,"info":""},{"id":"457d904.813437","type":"tab","label":"FILL_MISSING_FB_NAME_IN_ORDERS","disabled":false,"info":""},{"id":"c2216cea.17f8b","type":"tab","label":"UNUSED","disabled":true,"info":""},{"id":"a80659c4.09c238","type":"tab","label":"CHECK_STORE_FACEBOOK_TOKEN","disabled":false,"info":""},{"id":"df1fdcc0.8c179","type":"tab","label":"RE-ENRICH_FB_USER","disabled":false,"info":""},{"id":"462d4e7.f271db","type":"tab","label":"EVENT_CALENDAR_NOTIFY","disabled":false,"info":""},{"id":"8ea5e8ac.227478","type":"tab","label":"GITHUB","disabled":false,"info":""},{"id":"9aca2020.7fe83","type":"tab","label":"AUTOMATICALLY_ADD_FILTERDATE_FIELD","disabled":false,"info":""},{"id":"bf8f440.22744c","type":"tab","label":"LAB","disabled":false,"info":""},{"id":"c4594cab.1347","type":"tab","label":"CHECK_SINGLE_ORDER_STATUS","disabled":false,"info":""},{"id":"7aca8d6b.5bd9a4","type":"tab","label":"GET_PLATFORM_PACKAGE","disabled":false,"info":""},{"id":"d45fe8d5.c48c98","type":"tab","label":"CHECK_CURRENT_STORE_PACKAGE","disabled":false,"info":""},{"id":"75afdbb7.002304","type":"tab","label":"RECURRING_RESULT","disabled":false,"info":""},{"id":"9505666a.550668","type":"tab","label":"REFRESH_PAGE","disabled":false,"info":""},{"id":"ea16a615.8ec0c8","type":"tab","label":"LIVE_FORMAT_CHECKER","disabled":false,"info":""},{"id":"2e6cb6a3.d0261a","type":"subflow","name":"GET_FB_APP_ACCESS_TOKEN","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"b30b84b3.8c2058"}]}],"out":[{"x":500,"y":260,"wires":[{"id":"157b2258.0c594e","port":0}]}],"env":[]},{"id":"6fc54630.9e45e8","type":"subflow","name":"VALIDATE_PAGE_TOKEN","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"7ce2574d.838c08"}]}],"out":[{"x":1120,"y":200,"wires":[{"id":"77489eb2.64015","port":0}]}],"env":[]},{"id":"2ef686e.a8e6d7a","type":"subflow","name":"GET_ARIS_SALES_CHANNEL_LIST","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"bd951dd7.94b98"}]}],"out":[{"x":580,"y":320,"wires":[{"id":"a8a26773.e837a8","port":0}]}],"env":[]},{"id":"ea889a74.d4c438","type":"subflow","name":"GET_NJOIN_CHANNEL_LIST","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"53477ad0.9ace64"}]}],"out":[{"x":660,"y":320,"wires":[{"id":"44a033c6.c4c62c","port":0}]}],"env":[]},{"id":"279aa9ae.249436","type":"subflow","name":"SET_ES_AUTH_HEADER","info":"","category":"","in":[{"x":100,"y":120,"wires":[{"id":"74b6167f.b18198"}]}],"out":[{"x":360,"y":180,"wires":[{"id":"74b6167f.b18198","port":0}]}],"env":[]},{"id":"2bcf6718.b54f38","type":"subflow","name":"GET_NJOIN_CHANNEL_INFO","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"89257795.6af4c8"}]}],"out":[{"x":940,"y":320,"wires":[{"id":"6b2a768a.869288","port":0}]}],"env":[]},{"id":"71817fe1.dd965","type":"subflow","name":"DELETE_CURRENT_NJOIN_CHANNEL","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"91d60135.67c4"}]}],"out":[{"x":520,"y":300,"wires":[{"id":"5ac95676.a2de78","port":0}]}],"env":[]},{"id":"ff7e6a86.ae4768","type":"subflow","name":"CREATE_NEW_NJOIN_CHANNEL","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"2706d3b7.1c3a5c"}]}],"out":[{"x":660,"y":300,"wires":[{"id":"25880265.756f9e","port":0}]}],"env":[]},{"id":"73de36c2.de6158","type":"subflow","name":"PROCESS_NJOIN_CHANNEL_OBJECT","info":"","category":"","in":[{"x":60,"y":240,"wires":[{"id":"23c3c584.1eb45a"}]}],"out":[{"x":1420,"y":240,"wires":[{"id":"82ca0a8.95398f8","port":0},{"id":"952364cd.a19258","port":0}]}],"env":[]},{"id":"d008370b.28b7c8","type":"subflow","name":"GET_ARIS_ORDERS","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"b75d96b4.6acb78"}]}],"out":[{"x":580,"y":280,"wires":[{"id":"fdb6c2.142d594","port":0}]}],"env":[]},{"id":"a32042d.f4eb9c","type":"subflow","name":"GET_UNENRICHED_ORDERS","info":"","category":"","in":[{"x":140,"y":140,"wires":[{"id":"c6fb46f7.521878"}]}],"out":[{"x":480,"y":340,"wires":[{"id":"a128720f.f3b28","port":0}]}],"env":[]},{"id":"fbff609.ad1a4a","type":"subflow","name":"GET_USER_INFO_BY_PSID","info":"","category":"","in":[{"x":80,"y":100,"wires":[{"id":"ba816316.9d15c"}]}],"out":[{"x":740,"y":560,"wires":[{"id":"8667281b.1d0fc8","port":0},{"id":"89e67016.cdecf","port":0}]}],"env":[]},{"id":"7a2a35cf.4fbf1c","type":"subflow","name":"UPDATE_ORDER_BY_ID","info":"","category":"","in":[{"x":140,"y":180,"wires":[{"id":"cc1af713.683bf8"}]}],"out":[{"x":640,"y":300,"wires":[{"id":"d98a52bf.e3ba7","port":0}]}],"env":[]},{"id":"ca31d962.2b9aa8","type":"subflow","name":"ENRICH_FB_USER","info":"","category":"","in":[{"x":120,"y":140,"wires":[{"id":"73403bfb.d41724"}]}],"out":[{"x":580,"y":360,"wires":[{"id":"41ce48ae.c02708","port":0}]}],"env":[]},{"id":"5c7430da.82093","type":"subflow","name":"UPDATE_FIELD_WITH_SCRIPT","info":"","category":"","in":[{"x":120,"y":120,"wires":[{"id":"6f3ef57f.08675c"}]}],"out":[{"x":720,"y":360,"wires":[{"id":"e2d5d54d.c60a98","port":0}]}],"env":[]},{"id":"3c2507c8.c9fd68","type":"subflow","name":"GET_ALL_STORE_INTO_MSG","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"cb745db0.84962"}]}],"out":[{"x":360,"y":160,"wires":[{"id":"87a6e948.eeb6e8","port":0}]}],"env":[]},{"id":"e6b945fb.d44a58","type":"subflow","name":"GET_ALL_PACKAGE","info":"","category":"","in":[{"x":20,"y":80,"wires":[{"id":"e670562d.b168c8"}]}],"out":[{"x":120,"y":160,"wires":[{"id":"fbb5da8b.4fcbf8","port":0}]}],"env":[]},{"id":"94013090.2d433","type":"subflow","name":"GET_CURRENT_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"9bf74f03.626a1"}]}],"out":[{"x":340,"y":160,"wires":[{"id":"af9be9ae.f068b8","port":0}]}],"env":[]},{"id":"69d4cd1.f737134","type":"subflow","name":"GET_ALL_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"31eeb038.bae76"}]}],"out":[{"x":340,"y":160,"wires":[{"id":"841b384d.e4f518","port":0}]}],"env":[]},{"id":"1124d39f.2d2f6c","type":"subflow","name":"GET_LAST_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"af4ac020.ecfb7"}]}],"out":[{"x":340,"y":120,"wires":[{"id":"772a3b73.f89244","port":0}]}],"env":[]},{"id":"1bda0cde.761773","type":"subflow","name":"CALCULATE_PACKAGE_DATA","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"5695fbc8.df19a4"}]}],"out":[{"x":340,"y":160,"wires":[{"id":"cee4e333.c905","port":0}]}],"env":[]},{"id":"c4bf3c42.2f2e7","type":"subflow","name":"INSERT_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"c463551e.bb9cd8"}]}],"out":[{"x":340,"y":120,"wires":[{"id":"babd26f.5a4aad8","port":0}]}],"env":[]},{"id":"2a7162e3.17b21e","type":"subflow","name":"CALCULATE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"c26b2df9.20ff"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"19df2776.ff1e79","port":0}]}],"env":[]},{"id":"e909bb98.e0f978","type":"subflow","name":"GET_BEGINNER_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"a62dae94.78dff"}]}],"out":[{"x":340,"y":220,"wires":[{"id":"96ab598b.60a428","port":0}]}],"env":[]},{"id":"489b834b.3efb9c","type":"subflow","name":"UPDATE_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"7d183b03.58f904"}]}],"out":[{"x":340,"y":180,"wires":[{"id":"56bafd0f.a998a4","port":0}]}],"env":[]},{"id":"af5887d6.e48a98","type":"subflow","name":"INSERT_RECURRING_TRANSACTION","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"f64fd8e4.dd6f58"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"f4b13978.40f868","port":0}]}],"env":[]},{"id":"afb3774d.dd33b8","type":"subflow","name":"GET_CURRENT_STORE_PACKAGE (2)","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"5281e056.b3daa"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"43f2222f.1d608c","port":0}]}],"env":[]},{"id":"56720de6.f1f724","type":"subflow","name":"GET_RECURRING_INFO","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"ca35db56.084398"}]}],"out":[{"x":340,"y":180,"wires":[{"id":"cb56fe44.cff11","port":0}]}],"env":[]},{"id":"1e4910df.6b424f","type":"subflow","name":"INSERT_STORE_PACKAGE (2)","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"c1efc62c.0ca4b8"}]}],"out":[{"x":340,"y":220,"wires":[{"id":"44b55cca.c79f04","port":0}]}],"env":[]},{"id":"fe4bb160.370d2","type":"subflow","name":"UPDATE_RECURRING_INFO","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"9ca3d916.dab548"}]}],"out":[{"x":360,"y":220,"wires":[{"id":"b5f4c3e4.2586a","port":0}]}],"env":[]},{"id":"a69a0811.f42928","type":"subflow","name":"GET_NEXT_STORE_PACKAGE","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"b6bd85d7.b31d78"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"92dd7399.a7db2","port":0}]}],"env":[]},{"id":"7c10c31.7d9cc3c","type":"subflow","name":"GET_STORE_PACKAGE_INFO","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"9b607aa2.efe028"}]}],"out":[{"x":340,"y":200,"wires":[{"id":"c21797.6ae98868","port":0}]}],"env":[]},{"id":"a3b720d7.727fa","type":"subflow","name":"SEND_EMAIL","info":"## **Parameters**\n\n - msg.emailTo\n - msg.emailSubject\n - msg.emailText","category":"","in":[{"x":280,"y":120,"wires":[{"id":"1722d358.98cc5d"}]}],"out":[{"x":580,"y":120,"wires":[{"id":"541f7090.d602","port":0}]}],"env":[]},{"id":"a17250b6.4d78f","type":"subflow","name":"VALIDATE_PAGE_TOKEN (2)","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"23deeb8.9085d14"}]}],"out":[{"x":1120,"y":200,"wires":[{"id":"4545a7f9.5ecc58","port":0}]}],"env":[]},{"id":"8a26c817.ca88c8","type":"subflow","name":"GET_ARIS_SALES_CHANNEL_LIST (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"5686ea66.630d84"}]}],"out":[{"x":580,"y":320,"wires":[{"id":"1a78bf09.3d8c21","port":0}]}],"env":[]},{"id":"8f943ed3.b8305","type":"subflow","name":"GET_NJOIN_CHANNEL_LIST (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"3a85e429.2f76cc"}]}],"out":[{"x":660,"y":320,"wires":[{"id":"bd459ca7.e8131","port":0}]}],"env":[]},{"id":"1d5e4154.f4c77f","type":"subflow","name":"GET_NJOIN_CHANNEL_INFO (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"7837e754.9df298"}]}],"out":[{"x":940,"y":320,"wires":[{"id":"36aee158.130fbe","port":0}]}],"env":[]},{"id":"eb94d442.a4d8f8","type":"subflow","name":"DELETE_CURRENT_NJOIN_CHANNEL (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"7ac2376.214a3c8"}]}],"out":[{"x":520,"y":300,"wires":[{"id":"2659e192.73c89e","port":0}]}],"env":[]},{"id":"5ef2d864.115918","type":"subflow","name":"CREATE_NEW_NJOIN_CHANNEL (2)","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"be43b972.57fc88"}]}],"out":[{"x":660,"y":300,"wires":[{"id":"b733c0e2.5885b","port":0}]}],"env":[]},{"id":"6c36ea94.094f04","type":"subflow","name":"PROCESS_NJOIN_CHANNEL_OBJECT (2)","info":"","category":"","in":[{"x":60,"y":240,"wires":[{"id":"fbaf0bdc.d50bc8"}]}],"out":[{"x":1420,"y":240,"wires":[{"id":"7f71dd0f.112fe4","port":0},{"id":"f9d11738.218278","port":0}]}],"env":[]},{"id":"dc4923b1.2b53a","type":"subflow","name":"GET_ARIS_ORDERS (2)","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"27d6ae25.0b8d72"}]}],"out":[{"x":580,"y":280,"wires":[{"id":"641c43ef.c8edfc","port":0}]}],"env":[]},{"id":"eaee04b7.92b4a8","type":"subflow","name":"GET_UNENRICHED_ORDERS (2)","info":"","category":"","in":[{"x":140,"y":140,"wires":[{"id":"359ad90b.8906e6"}]}],"out":[{"x":480,"y":340,"wires":[{"id":"2988a4ac.5c101c","port":0}]}],"env":[]},{"id":"9bfa29fe.7e3298","type":"subflow","name":"GET_USER_INFO_BY_PSID (2)","info":"","category":"","in":[{"x":80,"y":100,"wires":[{"id":"dc276f7f.59945"}]}],"out":[{"x":740,"y":560,"wires":[{"id":"3516f86d.60ecf8","port":0},{"id":"e2e05b0c.c4b4b8","port":0}]}],"env":[]},{"id":"6d5cace2.84fcb4","type":"subflow","name":"UPDATE_ORDER_BY_ID (2)","info":"","category":"","in":[{"x":140,"y":180,"wires":[{"id":"a6b4d3fe.7ec81"}]}],"out":[{"x":640,"y":300,"wires":[{"id":"67972704.0c6c88","port":0}]}],"env":[]},{"id":"c0c31daa.5965f","type":"subflow","name":"UPDATE_FIELD_WITH_SCRIPT (2)","info":"","category":"","in":[{"x":120,"y":120,"wires":[{"id":"9c1cb3a9.46669"}]}],"out":[{"x":720,"y":360,"wires":[{"id":"99b28daa.722c6","port":0}]}],"env":[]},{"id":"d8cc33e4.add7f","type":"subflow","name":"INSERT_STORE_PACKAGE (2) (2)","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"2e13cfed.f3d4b"}]}],"out":[{"x":340,"y":220,"wires":[{"id":"3049841b.0b25cc","port":0}]}],"env":[]},{"id":"9e9f59f3.bf8978","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_v99r9sg5ft1qqejb43aqu6tn1g%40group.calendar.google.com/private-435a6458c91797ccf3fdaa7cddea5ab8/basic.ics","username":"arislab","password":"","caldav":"false","name":"Event Calendar","replacedates":false},{"id":"a798470d.5fde08","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_8pfo12uk63ba97rkf3evppveds%40group.calendar.google.com/private-c2512834523ec09c96c6373c8cd6d403/basic.ics","username":"arislab","password":"","caldav":"false","name":"Test Event Calendar","replacedates":false},{"id":"475bb0fd.7209a","type":"aws-config-s3","z":""},{"id":"db05d877.b1ba08","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_v99r9sg5ft1qqejb43aqu6tn1g%40group.calendar.google.com/private-435a6458c91797ccf3fdaa7cddea5ab8/basic.ics","username":"arislab","password":"","caldav":"false","name":"Event Calendar","replacedates":false},{"id":"a1f9d47b.adebf8","type":"ical-config","z":"","url":"https://calendar.google.com/calendar/ical/arislab.ai_8pfo12uk63ba97rkf3evppveds%40group.calendar.google.com/private-c2512834523ec09c96c6373c8cd6d403/basic.ics","username":"arislab","password":"","caldav":"false","name":"Test Event Calendar","replacedates":false},{"id":"4b6db063.d794c","type":"aws-config-s3","z":""},{"id":"b30b84b3.8c2058","type":"function","z":"2e6cb6a3.d0261a","name":"GET_APP_ACCESS_TOKEN","func":"const FB_APP_ID = \"502170539988549\";\nconst FB_APP_SECRET = \"73fc7474f3879738ac173d845c473930\";\n\n// msg.headers = {};\n// msg.headers['Authorization'] = `NTAyMTcwNTM5OTg4NTQ5Og==`;\n\nmsg.url = \"https://graph.facebook.com/oauth/access_token?client_id=\" + FB_APP_ID + \"&client_secret=\" + FB_APP_SECRET + \"&grant_type=client_credentials\";\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["5473e153.b814e","dbc550d5.55188"]]},{"id":"4efe5f6d.e130e","type":"debug","z":"2e6cb6a3.d0261a","name":"GET_FB_APP_ACCESS_TOKEN_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":160,"wires":[]},{"id":"5473e153.b814e","type":"debug","z":"2e6cb6a3.d0261a","name":"GET_FB_APP_ACCESS_TOKEN_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":80,"wires":[]},{"id":"e52e87ff.613a98","type":"debug","z":"2e6cb6a3.d0261a","name":"GET_FB_APP_ACCESS_TOKEN_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":120,"wires":[]},{"id":"dbc550d5.55188","type":"http request","z":"2e6cb6a3.d0261a","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":230,"y":120,"wires":[["e52e87ff.613a98","157b2258.0c594e"]]},{"id":"157b2258.0c594e","type":"change","z":"2e6cb6a3.d0261a","name":"","rules":[{"t":"set","p":"FB_ACCESS_TOKEN","pt":"msg","to":"payload.access_token","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":160,"wires":[["4efe5f6d.e130e"]]},{"id":"673d4353.9f6fcc","type":"http request","z":"6fc54630.9e45e8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":530,"y":160,"wires":[["c2f0f8cf.b33448","77489eb2.64015"]]},{"id":"da120350.cea4d","type":"function","z":"6fc54630.9e45e8","name":"INIT_REQUEST","func":"const FB_ACCESS_TOKEN = msg.FB_ACCESS_TOKEN;\nconst INPUT_TOKEN = msg.TOKEN_TO_VALIDATE;\n\nmsg.url = `https://graph.facebook.com/debug_token?input_token=${INPUT_TOKEN}&access_token=${FB_ACCESS_TOKEN}`\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":200,"wires":[["673d4353.9f6fcc","7f59bb85.6df084"]]},{"id":"7f59bb85.6df084","type":"debug","z":"6fc54630.9e45e8","name":"VALIDATE_PAGE_TOKEN_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":380,"wires":[]},{"id":"c2f0f8cf.b33448","type":"debug","z":"6fc54630.9e45e8","name":"VALIDATE_PAGE_TOKEN_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"d0165edb.ae708","type":"function","z":"2ef686e.a8e6d7a","name":"INIT_REQUEST_FOR_GETTING_SALES_CHANNEL","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/sales_channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"regexp\":{\n      \"channels.facebook\": \".+\"\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["d74c618b.7e515","a27d8a15.f4a178"]]},{"id":"d74c618b.7e515","type":"debug","z":"2ef686e.a8e6d7a","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":140,"wires":[]},{"id":"b13c8f6d.1c2ab","type":"debug","z":"2ef686e.a8e6d7a","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":180,"wires":[]},{"id":"a0568d8c.ac4a6","type":"debug","z":"2ef686e.a8e6d7a","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":220,"wires":[]},{"id":"a8a26773.e837a8","type":"change","z":"2ef686e.a8e6d7a","name":"","rules":[{"t":"set","p":"arisSalesChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["a0568d8c.ac4a6"]]},{"id":"6080b4d1.88343c","type":"function","z":"ea889a74.d4c438","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":140,"wires":[["a8ea7cc1.e8ac5","e958a21f.21787"]]},{"id":"a8ea7cc1.e8ac5","type":"debug","z":"ea889a74.d4c438","name":"GET_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":140,"wires":[]},{"id":"4bb2b108.64876","type":"debug","z":"ea889a74.d4c438","name":"GET_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":180,"wires":[]},{"id":"ec16621e.b1a66","type":"debug","z":"ea889a74.d4c438","name":"GET_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":220,"wires":[]},{"id":"44a033c6.c4c62c","type":"change","z":"ea889a74.d4c438","name":"","rules":[{"t":"set","p":"njoinChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["ec16621e.b1a66"]]},{"id":"a27d8a15.f4a178","type":"http request","z":"2ef686e.a8e6d7a","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":230,"y":180,"wires":[["b13c8f6d.1c2ab","a8a26773.e837a8"]]},{"id":"e958a21f.21787","type":"http request","z":"ea889a74.d4c438","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["4bb2b108.64876","44a033c6.c4c62c"]]},{"id":"74b6167f.b18198","type":"function","z":"279aa9ae.249436","name":"","func":"let basicAuth;\n\nif (msg.env === \"dev\") {\n    basicAuth = \"ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\";\n} else if (msg.env === \"alpha\") {\n    basicAuth = \"ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\";\n} else if (msg.env === \"prod\") {\n    basicAuth = \"ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\";\n}\n\nmsg.ES_BASIC_AUTH_HEADER = basicAuth;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":140,"wires":[[]]},{"id":"5b64a98d.b94158","type":"function","z":"2bcf6718.b54f38","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL_INFO","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nlet FB_ID = msg.payload._source.channels.facebook;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nnode.error('Getting facebook channel id: ' + FB_ID + ' from njoin');\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match\": {\n            \"id\": `facebook_${FB_ID}`\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":140,"wires":[["2c67ca39.25b236","26e132c4.327a7e"]]},{"id":"6b2a768a.869288","type":"change","z":"2bcf6718.b54f38","name":"","rules":[{"t":"set","p":"njoinChannelInfo","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":220,"wires":[["feca46e1.bbfe38"]]},{"id":"2c67ca39.25b236","type":"http request","z":"2bcf6718.b54f38","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":180,"wires":[["6b2a768a.869288","a8f65745.385f88"]]},{"id":"26e132c4.327a7e","type":"debug","z":"2bcf6718.b54f38","name":"GET_NJOIN_CHANNEL_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":140,"wires":[]},{"id":"a8f65745.385f88","type":"debug","z":"2bcf6718.b54f38","name":"GET_NJOIN_CHANNEL_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":180,"wires":[]},{"id":"feca46e1.bbfe38","type":"debug","z":"2bcf6718.b54f38","name":"GET_NJOIN_CHANNEL_INFO_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":220,"wires":[]},{"id":"bd951dd7.94b98","type":"subflow:279aa9ae.249436","z":"2ef686e.a8e6d7a","name":"","env":[],"x":270,"y":100,"wires":[["d0165edb.ae708"]]},{"id":"89257795.6af4c8","type":"subflow:279aa9ae.249436","z":"2bcf6718.b54f38","name":"","env":[],"x":330,"y":100,"wires":[["5b64a98d.b94158"]]},{"id":"53477ad0.9ace64","type":"subflow:279aa9ae.249436","z":"ea889a74.d4c438","name":"","x":290,"y":100,"wires":[["6080b4d1.88343c"]]},{"id":"7ce2574d.838c08","type":"subflow:2e6cb6a3.d0261a","z":"6fc54630.9e45e8","name":"","env":[],"x":290,"y":80,"wires":[["da120350.cea4d"]]},{"id":"77489eb2.64015","type":"change","z":"6fc54630.9e45e8","name":"","rules":[{"t":"set","p":"RESULT_VALIDATE_PAGE_TOKEN","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":160,"wires":[[]]},{"id":"91d60135.67c4","type":"subflow:279aa9ae.249436","z":"71817fe1.dd965","name":"","env":[],"x":290,"y":120,"wires":[["b9e67ebf.373e2"]]},{"id":"b9e67ebf.373e2","type":"function","z":"71817fe1.dd965","name":"INIT_REQUEST_FOR_DELETING_CURRENT_NJOIN_CHANNEL_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst channelDocID = msg.njoinChannelDocID;\nconst url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}/_update`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\n// msg.payload = {\n//     \"doc\": {\n//         \"isDeleted\": true\n//     }\n// }\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["7223edf.b2f0714","32b655da.d56d3a"]]},{"id":"32b655da.d56d3a","type":"http request","z":"71817fe1.dd965","name":"","method":"DELETE","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":200,"wires":[["5ac95676.a2de78","21690cf9.e32c34"]]},{"id":"5ac95676.a2de78","type":"change","z":"71817fe1.dd965","name":"","rules":[{"t":"set","p":"resultDeleteCurrentNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":240,"wires":[["dd4e01f6.2cf3f"]]},{"id":"7223edf.b2f0714","type":"debug","z":"71817fe1.dd965","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":160,"wires":[]},{"id":"21690cf9.e32c34","type":"debug","z":"71817fe1.dd965","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":200,"wires":[]},{"id":"dd4e01f6.2cf3f","type":"debug","z":"71817fe1.dd965","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":240,"wires":[]},{"id":"2706d3b7.1c3a5c","type":"subflow:279aa9ae.249436","z":"ff7e6a86.ae4768","name":"","env":[],"x":230,"y":100,"wires":[["fccfae0d.11331"]]},{"id":"fccfae0d.11331","type":"function","z":"ff7e6a86.ae4768","name":"INIT_REQUEST_FOR_CREATING_NEW_NJOIN_CHANNEL","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst docID = msg.temp_facebook_channel_config['_source']['id'];\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\nconst url = `https://${nes}/njoin-${nuser}/channel/${docID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.payload = msg.temp_facebook_channel_config._source;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["2addd99.5c1bc26","eb0adc61.9c8d2"]]},{"id":"eb0adc61.9c8d2","type":"http request","z":"ff7e6a86.ae4768","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":180,"wires":[["25880265.756f9e","9a43737b.333ab"]]},{"id":"25880265.756f9e","type":"change","z":"ff7e6a86.ae4768","name":"","rules":[{"t":"set","p":"resultCreateNewNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":220,"wires":[["7821fbc2.2610e4"]]},{"id":"2addd99.5c1bc26","type":"debug","z":"ff7e6a86.ae4768","name":"CREATE_NEW_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":140,"wires":[]},{"id":"9a43737b.333ab","type":"debug","z":"ff7e6a86.ae4768","name":"CREATE_NEW_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":180,"wires":[]},{"id":"7821fbc2.2610e4","type":"debug","z":"ff7e6a86.ae4768","name":"CREATE_NEW_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":220,"wires":[]},{"id":"23c3c584.1eb45a","type":"switch","z":"73de36c2.de6158","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":240,"wires":[["82ca0a8.95398f8"],["e1459f95.7498e"]]},{"id":"82ca0a8.95398f8","type":"function","z":"73de36c2.de6158","name":"","func":"node.error('njoinChannelInfo is equal 0, go next...');\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":40,"wires":[[]]},{"id":"e1459f95.7498e","type":"function","z":"73de36c2.de6158","name":"INITIAL_INDEX_NJOIN_CHANNEL","func":"node.error('njoinChannelInfo(s) are more than 0 : '+msg.njoinChannelInfo.hits.total);\n\nmsg.indexNjoinChannel = 0;\nmsg.njoinChannelList = msg.njoinChannelInfo.hits.hits;\n\nreturn msg;\n\n/*\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n*/","outputs":1,"noerr":0,"x":340,"y":300,"wires":[["3acf75ff.95b6da"]]},{"id":"24e2cb9b.f21d74","type":"comment","z":"73de36c2.de6158","name":"Njoin Channel LOOP","info":"","x":290,"y":340,"wires":[]},{"id":"3acf75ff.95b6da","type":"switch","z":"73de36c2.de6158","name":"Index Njoin Channel = njoinChannelList length?","property":"indexNjoinChannel","propertyType":"msg","rules":[{"t":"lt","v":"njoinChannelList.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":380,"wires":[["73041be0.cff4d4"],["d0308713.d339b8"]]},{"id":"cd0703a6.885eb","type":"link in","z":"73de36c2.de6158","name":"","links":["5315a12a.79e77"],"x":135,"y":380,"wires":[["3acf75ff.95b6da"]]},{"id":"af4bffb.6e702","type":"function","z":"73de36c2.de6158","name":"INCREASE_INDEX_NJOIN_CHANNEL","func":"msg.indexNjoinChannel++;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":940,"wires":[["7222feff.1e81a"]]},{"id":"5315a12a.79e77","type":"link out","z":"73de36c2.de6158","name":"","links":["cd0703a6.885eb"],"x":695,"y":940,"wires":[]},{"id":"d0308713.d339b8","type":"function","z":"73de36c2.de6158","name":"END_LOOP","func":"node.error('End Njoin Channel Loop.');\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":240,"wires":[["73732aab.271524"]]},{"id":"73041be0.cff4d4","type":"function","z":"73de36c2.de6158","name":"INITIAL_NJOIN_CHANNEL_BEFORE_PROCESS","func":"let processIndex = msg.indexNjoinChannel;\nlet processNjoinChannel = msg.njoinChannelList[processIndex];\n//msg.payload = processNjoinChannel;\nmsg.processNjoinChannel = processNjoinChannel;\nmsg.TOKEN_TO_VALIDATE = processNjoinChannel._source.token;\nnode.error(processNjoinChannel);\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":440,"wires":[["a33a1a00.7a74c8"]]},{"id":"a33a1a00.7a74c8","type":"subflow:6fc54630.9e45e8","z":"73de36c2.de6158","name":"","env":[],"x":400,"y":480,"wires":[["ebaef477.358c48","90955fb0.7296"]]},{"id":"ebaef477.358c48","type":"debug","z":"73de36c2.de6158","name":"RESULT_VALIDATE_PAGE_TOKEN_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":480,"wires":[]},{"id":"90955fb0.7296","type":"switch","z":"73de36c2.de6158","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":400,"y":560,"wires":[["6d482a2d.7a3074"],["3f3a3d86.8f3392"]]},{"id":"6d482a2d.7a3074","type":"function","z":"73de36c2.de6158","name":"PAGE_TOKEN_VALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is VALID.');\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":620,"wires":[["9a6d1e8e.3d857"]]},{"id":"3f3a3d86.8f3392","type":"function","z":"73de36c2.de6158","name":"PAGE_TOKEN_INVALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is INVALID. Prepare to DELETE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":620,"wires":[["65a35470.3d328c"]]},{"id":"65a35470.3d328c","type":"function","z":"73de36c2.de6158","name":"SET_NJOIN_CHANNEL_DOC_ID","func":"node.error('Set njoin channel doc ID: '+msg.processNjoinChannel._id+' with Page Token: '+msg.processNjoinChannel._source.id+' to DELETE.');\nmsg.njoinChannelDocID = msg.processNjoinChannel._id;\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":820,"wires":[["b925ddc7.c00d1"]]},{"id":"b925ddc7.c00d1","type":"subflow:71817fe1.dd965","z":"73de36c2.de6158","name":"","env":[],"x":480,"y":860,"wires":[["af4bffb.6e702"]]},{"id":"9a6d1e8e.3d857","type":"switch","z":"73de36c2.de6158","name":"Temp njoin channel is not empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":800,"y":680,"wires":[["bc53633e.7b108"],["65a35470.3d328c"]]},{"id":"bc53633e.7b108","type":"function","z":"73de36c2.de6158","name":"Temp join channel is empty","func":"node.error('temp njoin channel is empty, so set njoin channel: '+msg.processNjoinChannel._source.id+' into temp njoin channel.');\nmsg.tempNjoinChannelInfo = msg.processNjoinChannel;\n\n//node.error(msg.tempNjoinChannelInfo);\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":740,"wires":[["65a35470.3d328c"]]},{"id":"73732aab.271524","type":"switch","z":"73de36c2.de6158","name":"Temp njoin channel is empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":300,"wires":[["952364cd.a19258"],["8ae6388c.0146e8"]]},{"id":"8ae6388c.0146e8","type":"function","z":"73de36c2.de6158","name":"INIT_PAGE_DATA_TO_CREATE","func":"msg.temp_facebook_channel_config = msg.tempNjoinChannelInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":360,"wires":[["6bf18925.5dde48"]]},{"id":"6bf18925.5dde48","type":"subflow:ff7e6a86.ae4768","z":"73de36c2.de6158","name":"","env":[],"x":880,"y":400,"wires":[["9849cef3.23d5c","952364cd.a19258"]]},{"id":"9849cef3.23d5c","type":"debug","z":"73de36c2.de6158","name":"RESULT_CREATE_NJOIN_CHANNEL","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1290,"y":440,"wires":[]},{"id":"952364cd.a19258","type":"function","z":"73de36c2.de6158","name":"PROCESS_DONE","func":"node.error('Process DONE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":340,"wires":[[]]},{"id":"7222feff.1e81a","type":"delay","z":"73de36c2.de6158","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":590,"y":940,"wires":[["5315a12a.79e77"]]},{"id":"7c6f9537.60899c","type":"function","z":"d008370b.28b7c8","name":"INIT_REQUEST_FOR_GETTING_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst storeID = msg.storeID\nconst url = `https://${nes}/${platform_index}/order/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        { \"match\": { \"storeID.keyword\": storeID } },\n        { \"match\": { \"userInfo.firstName.keyword\": \"\" } },\n        { \"match\": { \"userInfo.lastName.keyword\": \"\" } }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["7de94ce7.ca56d4","edb14267.381dd"]]},{"id":"7de94ce7.ca56d4","type":"debug","z":"d008370b.28b7c8","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":120,"wires":[]},{"id":"bea96f7e.a0c37","type":"debug","z":"d008370b.28b7c8","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":160,"wires":[]},{"id":"dede7c3b.5d9dd","type":"debug","z":"d008370b.28b7c8","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":200,"wires":[]},{"id":"fdb6c2.142d594","type":"change","z":"d008370b.28b7c8","name":"","rules":[{"t":"set","p":"arisOrdersList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":200,"wires":[["dede7c3b.5d9dd"]]},{"id":"edb14267.381dd","type":"http request","z":"d008370b.28b7c8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":210,"y":160,"wires":[["bea96f7e.a0c37","fdb6c2.142d594"]]},{"id":"b75d96b4.6acb78","type":"subflow:279aa9ae.249436","z":"d008370b.28b7c8","name":"","env":[],"x":250,"y":80,"wires":[["7c6f9537.60899c"]]},{"id":"619f5a77.85a894","type":"function","z":"a32042d.f4eb9c","name":"INIT_REQUEST_FOR_GETTING_UNENRICHED_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/order/_search?size=100`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"exists\": {\n            \"field\": \"userInfo.firstName\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.firstName.keyword\": \"\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.lastName.keyword\": \"\"\n          }\n        }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":180,"wires":[["6ac29578.95a2ec","1c5fe3a6.125b0c"]]},{"id":"6ac29578.95a2ec","type":"debug","z":"a32042d.f4eb9c","name":"GET_UNENRICHED_ORDERS_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":180,"wires":[]},{"id":"c902e784.f55788","type":"debug","z":"a32042d.f4eb9c","name":"GET_UNENRICHED_ORDERS_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":220,"wires":[]},{"id":"6fe0ab98.d130b4","type":"debug","z":"a32042d.f4eb9c","name":"GET_UNENRICHED_ORDERS_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":260,"wires":[]},{"id":"a128720f.f3b28","type":"change","z":"a32042d.f4eb9c","name":"","rules":[{"t":"set","p":"unenrichedOrders","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":260,"wires":[["6fe0ab98.d130b4"]]},{"id":"1c5fe3a6.125b0c","type":"http request","z":"a32042d.f4eb9c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":330,"y":220,"wires":[["c902e784.f55788","a128720f.f3b28"]]},{"id":"c6fb46f7.521878","type":"subflow:279aa9ae.249436","z":"a32042d.f4eb9c","name":"","env":[],"x":370,"y":140,"wires":[["619f5a77.85a894"]]},{"id":"df51780c.0c0ef8","type":"function","z":"fbff609.ad1a4a","name":"INIT_REQUEST_FOR_GETTING_USER_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst userPSID = msg.userPSID;\nconst url = `https://${nes}/njoin-${nuser}/user/${userPSID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.userInfo = {\n    \"firstName\": \"\",\n    \"lastName\": \"\"\n};\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["bc45e34c.235cc","ff019d87.d09"]]},{"id":"bc45e34c.235cc","type":"debug","z":"fbff609.ad1a4a","name":"GET_USER_INFO_BY_PSID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":140,"wires":[]},{"id":"3cfb4ec0.a2cd62","type":"debug","z":"fbff609.ad1a4a","name":"GET_USER_INFO_BY_PSID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":180,"wires":[]},{"id":"b7cd986f.2f1df8","type":"debug","z":"fbff609.ad1a4a","name":"GET_USER_INFO_BY_PSID_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":680,"wires":[]},{"id":"8667281b.1d0fc8","type":"change","z":"fbff609.ad1a4a","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload._source.info.facebook.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload._source.info.facebook.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":560,"wires":[["b7cd986f.2f1df8"]]},{"id":"ba816316.9d15c","type":"subflow:279aa9ae.249436","z":"fbff609.ad1a4a","name":"","env":[],"x":290,"y":100,"wires":[["df51780c.0c0ef8"]]},{"id":"ff019d87.d09","type":"http request","z":"fbff609.ad1a4a","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["3cfb4ec0.a2cd62","e9ba79b3.18c268"]]},{"id":"cc1af713.683bf8","type":"subflow:279aa9ae.249436","z":"7a2a35cf.4fbf1c","name":"","env":[],"x":350,"y":180,"wires":[["4a4e44f3.60216c"]]},{"id":"4a4e44f3.60216c","type":"function","z":"7a2a35cf.4fbf1c","name":"INIT_REQUEST_UPDATE_ORDER","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst docID = msg.UnenrichedOrderDocID;\n\nconst url = `https://${nes}/${platform_index}/order/${docID}/_update`;\n\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nconst updateBody = msg.UnenrichedOrderUpdateBody;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nmsg.payload = {\n    \"doc\": {\n        \"userInfo\": {\n            \"firstName\": updateBody['firstName'],\n            \"lastName\": updateBody['lastName']\n        }\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":220,"wires":[["d98a52bf.e3ba7","80cfe626.96a388"]]},{"id":"d98a52bf.e3ba7","type":"http request","z":"7a2a35cf.4fbf1c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":310,"y":260,"wires":[["b0f4b9d3.b14ed8"]]},{"id":"80cfe626.96a388","type":"debug","z":"7a2a35cf.4fbf1c","name":"UPDATE_ORDER_BY_ID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":790,"y":220,"wires":[]},{"id":"b0f4b9d3.b14ed8","type":"debug","z":"7a2a35cf.4fbf1c","name":"UPDATE_ORDER_BY_ID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":260,"wires":[]},{"id":"e9ba79b3.18c268","type":"function","z":"fbff609.ad1a4a","name":"CHECK_USER_IS_UNDEFINED","func":"const sourceObj = msg.payload._source;\nconst fbName = sourceObj.info.facebook.name;\nconst fbPSID = sourceObj.info.facebook.id;\nconst pageToken = sourceObj.info._channel.config.token;\n\nif (\n    fbName === \"undefined undefined\" &&\n    sourceObj.info.facebook.hasOwnProperty('first_name') === false &&\n    sourceObj.info.facebook.hasOwnProperty('last_name') === false\n) {\n    node.error('This user info is un-enriched, re-enriching..');\n    msg.enrichPSID = fbPSID;\n    msg.enrichToken = pageToken;\n    return [msg, null];\n} else {\n    node.error('This user info is already enriched')\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":310,"y":340,"wires":[["3e096c35.555ee4"],["8667281b.1d0fc8"]]},{"id":"73403bfb.d41724","type":"function","z":"ca31d962.2b9aa8","name":"","func":"const enrichPSID = msg.enrichPSID;\nconst enrichToken = msg.enrichToken;\nconst url = `https://graph.facebook.com/${enrichPSID}?fields=first_name,last_name&access_token=${enrichToken}`\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":140,"wires":[["658e8285.22f3dc","9497a5d7.0ce598"]]},{"id":"658e8285.22f3dc","type":"http request","z":"ca31d962.2b9aa8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":350,"y":180,"wires":[["41ce48ae.c02708","fff380aa.da44c"]]},{"id":"41ce48ae.c02708","type":"change","z":"ca31d962.2b9aa8","name":"","rules":[{"t":"set","p":"enrichFBResult","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":220,"wires":[["69aa3e06.32b3a"]]},{"id":"3e096c35.555ee4","type":"subflow:ca31d962.2b9aa8","z":"fbff609.ad1a4a","name":"","env":[],"x":590,"y":280,"wires":[["eb67e6fa.90bed8","1f95b0fb.08992f"]]},{"id":"9497a5d7.0ce598","type":"debug","z":"ca31d962.2b9aa8","name":"ENRICH_FB_USER_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":140,"wires":[]},{"id":"fff380aa.da44c","type":"debug","z":"ca31d962.2b9aa8","name":"ENRICH_FB_USER_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":180,"wires":[]},{"id":"69aa3e06.32b3a","type":"debug","z":"ca31d962.2b9aa8","name":"ENRICH_FB_USER_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":220,"wires":[]},{"id":"eb67e6fa.90bed8","type":"debug","z":"fbff609.ad1a4a","name":"enrich_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"89e67016.cdecf","type":"change","z":"fbff609.ad1a4a","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":380,"wires":[[]]},{"id":"1f95b0fb.08992f","type":"function","z":"fbff609.ad1a4a","name":"CHECK_ENRICH_RESPONSE","func":"const reqResponse = msg.payload;\n\nif (\n    reqResponse.hasOwnProperty('first_name') &&\n    reqResponse.hasOwnProperty('last_name')\n) {\n    node.error('Enrich user successful');\n    return [msg, null];\n} else {\n    node.error('Error while enriching user: ');\n    node.error(reqResponse);\n    return [msg, null];\n}","outputs":2,"noerr":0,"x":660,"y":340,"wires":[["89e67016.cdecf"],[]]},{"id":"5b94379c.73e458","type":"function","z":"5c7430da.82093","name":"INIT_REQUEST_FOR_UPDATING_FIELD_WITH_SCRIPT","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst type = msg.updateType;\nconst url = `https://${nes}/${platform_index}/${type}/_update_by_query`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\nconst query = JSON.parse(msg.updateQuery);\nconst script = JSON.parse(msg.updateScript);\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nlet tempPayload = {};\ntempPayload['query'] = query;\ntempPayload['script'] = script;\n\nmsg.payload = JSON.stringify(tempPayload);\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["32d09b17.ef7a14","4ff70f52.644ec"]]},{"id":"e2d5d54d.c60a98","type":"change","z":"5c7430da.82093","name":"","rules":[{"t":"set","p":"resultUpdateFieldWithScript","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":240,"wires":[["5860137f.411c1c"]]},{"id":"32d09b17.ef7a14","type":"http request","z":"5c7430da.82093","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":200,"wires":[["e2d5d54d.c60a98","a8dbd18d.31a13"]]},{"id":"6f3ef57f.08675c","type":"subflow:279aa9ae.249436","z":"5c7430da.82093","name":"","env":[],"x":330,"y":120,"wires":[["5b94379c.73e458","2141d711.06bda8"]]},{"id":"c66c8937.3f26d8","type":"comment","z":"5c7430da.82093","name":"Params: updateType / updateQuery / updateScript","info":"**msg.updateType:** Type to update\n**msg.updateQuery:** Query to execute\n**msg.updateScript:** Script to execute","x":390,"y":60,"wires":[]},{"id":"2141d711.06bda8","type":"debug","z":"5c7430da.82093","name":"UPDATE_FIELD_WITH_SCRIPT_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":120,"wires":[]},{"id":"4ff70f52.644ec","type":"debug","z":"5c7430da.82093","name":"UPDATE_FIELD_WITH_SCRIPT_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":160,"wires":[]},{"id":"a8dbd18d.31a13","type":"debug","z":"5c7430da.82093","name":"UPDATE_FIELD_WITH_SCRIPT_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":200,"wires":[]},{"id":"5860137f.411c1c","type":"debug","z":"5c7430da.82093","name":"UPDATE_FIELD_WITH_SCRIPT_debug4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":240,"wires":[]},{"id":"e670562d.b168c8","type":"function","z":"e6b945fb.d44a58","name":"GET_ALL_PACKAGE","func":"delete msg.payload;\nmsg.url = \"https://manage.arislab.ai/getPlatformPackage\";\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["fbb5da8b.4fcbf8","e33c98bf.a20c98"]]},{"id":"fbb5da8b.4fcbf8","type":"http request","z":"e6b945fb.d44a58","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":170,"y":120,"wires":[["e8e98bea.6f2998"]]},{"id":"e8e98bea.6f2998","type":"debug","z":"e6b945fb.d44a58","name":"GET_ALL_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":470,"y":120,"wires":[]},{"id":"cb745db0.84962","type":"function","z":"3c2507c8.c9fd68","name":"GET_ALL_STORE","func":"delete msg.payload;\nmsg.url = msg.apiUrl + \"/businessProfile/all\";\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":80,"wires":[["87a6e948.eeb6e8","f9b4ea76.b81fa8"]]},{"id":"87a6e948.eeb6e8","type":"http request","z":"3c2507c8.c9fd68","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["454a8813.eaeab8"]]},{"id":"454a8813.eaeab8","type":"debug","z":"3c2507c8.c9fd68","name":"GET_ALL_STORE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":460,"y":120,"wires":[]},{"id":"f9b4ea76.b81fa8","type":"debug","z":"3c2507c8.c9fd68","name":"GET_ALL_STORE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":460,"y":80,"wires":[]},{"id":"e33c98bf.a20c98","type":"debug","z":"e6b945fb.d44a58","name":"GET_ALL_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":470,"y":80,"wires":[]},{"id":"9bf74f03.626a1","type":"function","z":"94013090.2d433","name":"GET_CURRENT_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}/current`;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":80,"wires":[["af9be9ae.f068b8","9341510b.73189"]]},{"id":"af9be9ae.f068b8","type":"http request","z":"94013090.2d433","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["b9599f1a.b0edb"]]},{"id":"b9599f1a.b0edb","type":"debug","z":"94013090.2d433","name":"GET_CURRENT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":680,"y":120,"wires":[]},{"id":"9341510b.73189","type":"debug","z":"94013090.2d433","name":"GET_CURRENT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":680,"y":80,"wires":[]},{"id":"31eeb038.bae76","type":"function","z":"69d4cd1.f737134","name":"GET_ALL_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["841b384d.e4f518","61d74276.dd7c2c"]]},{"id":"841b384d.e4f518","type":"http request","z":"69d4cd1.f737134","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["ded3fed6.6d84e"]]},{"id":"ded3fed6.6d84e","type":"debug","z":"69d4cd1.f737134","name":"GET_ALL_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"61d74276.dd7c2c","type":"debug","z":"69d4cd1.f737134","name":"GET_ALL_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"af4ac020.ecfb7","type":"function","z":"1124d39f.2d2f6c","name":"GET_LAST_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}/last`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["772a3b73.f89244","1bac78c.489d487"]]},{"id":"772a3b73.f89244","type":"http request","z":"1124d39f.2d2f6c","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["b335b2d6.f715a"]]},{"id":"b335b2d6.f715a","type":"debug","z":"1124d39f.2d2f6c","name":"GET_LAST_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"1bac78c.489d487","type":"debug","z":"1124d39f.2d2f6c","name":"GET_LAST_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"5695fbc8.df19a4","type":"function","z":"1bda0cde.761773","name":"CALCULATE_PACKAGE_DATA","func":"msg.url = `https://manage.arislab.ai/calculateStorePackage`;\nmsg.payload = {\n    \"newPackageObj\": msg.newPackage,\n    \"isActiveNow\": true,\n    \"currentPackageObj\": {}\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["cee4e333.c905","1e66e70c.7155d9"]]},{"id":"cee4e333.c905","type":"http request","z":"1bda0cde.761773","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["5545979b.144138"]]},{"id":"5545979b.144138","type":"debug","z":"1bda0cde.761773","name":"CALCULATE_PACKAGE_DATA_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"1e66e70c.7155d9","type":"debug","z":"1bda0cde.761773","name":"CALCULATE_PACKAGE_DATA_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"c463551e.bb9cd8","type":"function","z":"c4bf3c42.2f2e7","name":"INSERT_STORE_PACKAGE","func":"const storePackageInfo = msg.storePackageInfo;\n\nmsg.url = `${msg.apiUrl}storePackage/new`;\nmsg.payload = storePackageInfo;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":80,"wires":[["f8fa6246.06806","babd26f.5a4aad8"]]},{"id":"f8fa6246.06806","type":"debug","z":"c4bf3c42.2f2e7","name":"INSERT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":570,"y":80,"wires":[]},{"id":"babd26f.5a4aad8","type":"http request","z":"c4bf3c42.2f2e7","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["35b1558e.8b86ba"]]},{"id":"35b1558e.8b86ba","type":"debug","z":"c4bf3c42.2f2e7","name":"INSERT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":120,"wires":[]},{"id":"c26b2df9.20ff","type":"function","z":"2a7162e3.17b21e","name":"CALCULATE_PACKAGE","func":"const packageInfo = msg.packageInfo;\n\nlet data = {\n    newPackageObj: packageInfo,\n    isActiveNow: true\n};\n\nmsg.url = `https://manage.arislab.ai/calculateStorePackage`;\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":80,"wires":[["60b8252f.6394dc","19df2776.ff1e79"]]},{"id":"60b8252f.6394dc","type":"debug","z":"2a7162e3.17b21e","name":"CALCULATE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":520,"y":80,"wires":[]},{"id":"19df2776.ff1e79","type":"http request","z":"2a7162e3.17b21e","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["f5fd7919.3e9268"]]},{"id":"f5fd7919.3e9268","type":"debug","z":"2a7162e3.17b21e","name":"CALCULATE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":520,"y":120,"wires":[]},{"id":"a62dae94.78dff","type":"function","z":"e909bb98.e0f978","name":"GET_BEGINNER_PACKAGE","func":"msg.url = `https://manage.arislab.ai/getPlatformPackage?packageName=beginner`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["96ab598b.60a428","9a2e7b55.b6f9d8"]]},{"id":"96ab598b.60a428","type":"http request","z":"e909bb98.e0f978","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["665d36d6.49c798"]]},{"id":"9a2e7b55.b6f9d8","type":"debug","z":"e909bb98.e0f978","name":"GET_BEGINNER_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":80,"wires":[]},{"id":"665d36d6.49c798","type":"debug","z":"e909bb98.e0f978","name":"GET_BEGINNER_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":120,"wires":[]},{"id":"7d183b03.58f904","type":"function","z":"489b834b.3efb9c","name":"UPDATE_STORE_PACKAGE","func":"const storePackageInfo = msg.storePackageInfo;\n\nmsg.url = `${msg.apiUrl}storePackage/storePackageID/${storePackageInfo.storePackageID}/update`;\nmsg.payload = storePackageInfo;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["ac22876f.22eb78","56bafd0f.a998a4"]]},{"id":"ac22876f.22eb78","type":"debug","z":"489b834b.3efb9c","name":"UPDATE_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":570,"y":80,"wires":[]},{"id":"56bafd0f.a998a4","type":"http request","z":"489b834b.3efb9c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["d29cb850.36e218"]]},{"id":"d29cb850.36e218","type":"debug","z":"489b834b.3efb9c","name":"UPDATE_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":570,"y":120,"wires":[]},{"id":"f64fd8e4.dd6f58","type":"function","z":"af5887d6.e48a98","name":"INSERT_RECURRING_TRANSACTION","func":"const storePackageInfo = msg.storePackageInfo;\nconst recurringResult = msg.recurringResult;\nconst recurringStatus = msg.recurringStatus;\n\nlet recurringTransaction = {\n    recurringTransactionID: \"\",\n    storePackageInfo: storePackageInfo,\n    recurringResult: recurringResult,\n    status: recurringStatus,\n    createdAt: Date.now()\n};\n\nmsg.url = `${msg.apiUrl}recurringTransaction/new`;\nmsg.payload = recurringTransaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["bee41134.afe39","f4b13978.40f868"]]},{"id":"bee41134.afe39","type":"debug","z":"af5887d6.e48a98","name":"INSERT_RECURRING_TRANSACTION_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":80,"wires":[]},{"id":"f4b13978.40f868","type":"http request","z":"af5887d6.e48a98","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["8d33cb8f.4059d8"]]},{"id":"8d33cb8f.4059d8","type":"debug","z":"af5887d6.e48a98","name":"INSERT_RECURRING_TRANSACTION_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":670,"y":120,"wires":[]},{"id":"5281e056.b3daa","type":"function","z":"afb3774d.dd33b8","name":"GET_CURRENT_STORE_PACKAGE","func":"const storeID = msg.recurringInfo.storeID;\n\nmsg.url = `${msg.apiUrl}storePackage/storeID/${storeID}/current`;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":80,"wires":[["b3089f6b.6a26b","43f2222f.1d608c"]]},{"id":"b3089f6b.6a26b","type":"debug","z":"afb3774d.dd33b8","name":"GET_CURRENT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":80,"wires":[]},{"id":"43f2222f.1d608c","type":"http request","z":"afb3774d.dd33b8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["232ef5a8.85321a"]]},{"id":"232ef5a8.85321a","type":"debug","z":"afb3774d.dd33b8","name":"GET_CURRENT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":640,"y":120,"wires":[]},{"id":"ca35db56.084398","type":"function","z":"56720de6.f1f724","name":"GET_RECURRING_INFO","func":"const recurringNo = msg.recurringResult.recurringNo;\n\nmsg.url = `${msg.apiUrl}recurring/recurringNo/${recurringNo}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":80,"wires":[["cb56fe44.cff11","3454466b.3a73aa"]]},{"id":"cb56fe44.cff11","type":"http request","z":"56720de6.f1f724","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["e05ca03e.dc729"]]},{"id":"3454466b.3a73aa","type":"debug","z":"56720de6.f1f724","name":"GET_RECURRING_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":520,"y":80,"wires":[]},{"id":"e05ca03e.dc729","type":"debug","z":"56720de6.f1f724","name":"GET_RECURRING_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":520,"y":120,"wires":[]},{"id":"c1efc62c.0ca4b8","type":"function","z":"1e4910df.6b424f","name":"INSERT_STORE_PACKAGE","func":"msg.url = `${msg.apiUrl}/storePackage/new`;\nmsg.payload = msg.storePackageData;\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":80,"wires":[["44b55cca.c79f04","fa2d3aa6.60bec8"]]},{"id":"44b55cca.c79f04","type":"http request","z":"1e4910df.6b424f","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["edb544d1.f183c8"]]},{"id":"edb544d1.f183c8","type":"debug","z":"1e4910df.6b424f","name":"INSERT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":590,"y":120,"wires":[]},{"id":"fa2d3aa6.60bec8","type":"debug","z":"1e4910df.6b424f","name":"INSERT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":590,"y":80,"wires":[]},{"id":"9ca3d916.dab548","type":"function","z":"fe4bb160.370d2","name":"UPDATE_RECURRING_INFO","func":"const storePackageInfo = msg.storePackageInfo;\nconst storeID = msg.STORE_ID;\nconst currentRecurringInfo = msg.recurringInfo;\nlet newRecurringInfo = generateNewRecurringData(msg.recurringInfo, storePackageInfo['packageInfo']['memberPrice']);\n\n\n\nfunction generateNewRecurringData(recurringInfo, newPrice) {\n    let newRecurringInfo = {\n        recurringID: \"\",\n        storeID: recurringInfo['storeID'],\n        storePackageID: storePackageInfo['storePackageID'],\n        creditCardID: recurringInfo['creditCardID'],\n        referenceNo: recurringInfo['referenceNo'],\n        recurringInfo: {\n            recurringNo: recurringInfo['recurringInfo']['recurringNo'],\n            recurringAmount: newPrice,\n            recurringInterval: recurringInfo['recurringInfo']['recurringInterval'],\n            recurringPeriod: recurringInfo['recurringInfo']['recurringPeriod'],\n            allowAccumulate: recurringInfo['recurringInfo']['allowAccumulate'],\n            cardToken: recurringInfo['recurringInfo']['cardToken'],\n        },\n        verifyInfo: {\n            resultCode: recurringInfo['verifyInfo']['resultCode'],\n        },\n        createdAt: 0,\n        deletedAt: 0,\n        isDeleted: false\n    };\n\n    return newRecurringInfo\n}\n\n\n\nlet data = {\n    storeID: storeID,\n    currentRecurringInfo: currentRecurringInfo,\n    newRecurringInfo: newRecurringInfo\n};\n\nmsg.url = `${msg.apiUrl}recurring/recurringInfo/update`;\nmsg.payload = data;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["d8ba857c.8ff0c8","b5f4c3e4.2586a"]]},{"id":"d8ba857c.8ff0c8","type":"debug","z":"fe4bb160.370d2","name":"UPDATE_RECURRING_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":580,"y":80,"wires":[]},{"id":"b5f4c3e4.2586a","type":"http request","z":"fe4bb160.370d2","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["e8fd850b.7eeca8"]]},{"id":"e8fd850b.7eeca8","type":"debug","z":"fe4bb160.370d2","name":"UPDATE_RECURRING_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":580,"y":120,"wires":[]},{"id":"b6bd85d7.b31d78","type":"function","z":"a69a0811.f42928","name":"GET_NEXT_STORE_PACKAGE","func":"let processStore = msg.processStore;\nlet storeID = processStore['storeID'];\nmsg.url = `${msg.apiUrl}/storePackage/storeID/${storeID}/next`;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":80,"wires":[["92dd7399.a7db2","4cb692b2.a4d63c"]]},{"id":"92dd7399.a7db2","type":"http request","z":"a69a0811.f42928","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["86932d46.60ff"]]},{"id":"86932d46.60ff","type":"debug","z":"a69a0811.f42928","name":"GET_NEXT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":600,"y":120,"wires":[]},{"id":"4cb692b2.a4d63c","type":"debug","z":"a69a0811.f42928","name":"GET_NEXT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":600,"y":80,"wires":[]},{"id":"9b607aa2.efe028","type":"function","z":"7c10c31.7d9cc3c","name":"GET_STORE_PACKAGE_INFO","func":"const storePackageID = msg.recurringInfo.storePackageID;\n\nmsg.url = `${msg.apiUrl}storePackage/storePackageID/${storePackageID}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["5097dd0f.3225c4","c21797.6ae98868"]]},{"id":"5097dd0f.3225c4","type":"debug","z":"7c10c31.7d9cc3c","name":"GET_STORE_PACKAGE_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":620,"y":80,"wires":[]},{"id":"c21797.6ae98868","type":"http request","z":"7c10c31.7d9cc3c","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["b7ddc7cf.586d28"]]},{"id":"b7ddc7cf.586d28","type":"debug","z":"7c10c31.7d9cc3c","name":"GET_STORE_PACKAGE_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":620,"y":120,"wires":[]},{"id":"b28bd79.6344428","type":"function-npm","z":"a3b720d7.727fa","name":"","func":"const nodemailer = require(\"nodemailer\");\n\nconst to = msg.emailTo;\nconst subject = msg.emailSubject;\nconst text = msg.emailText;\nconst html = msg.emailHtml || \"\";\nconst attachments = msg.emailAttachments || [];\n\nconst auth = {\n    type: 'oauth2',\n    user: 'it@arislab.ai',\n    clientId: '106153988399-agicdbnlkc842v0i7e4u2djgkcapvdpc.apps.googleusercontent.com',\n    clientSecret: 'yIOSSqjwwaptassF4MnTr5OT',\n    refreshToken: '1/Vqq7znVy3yXRNlR1NzBUxCs32Ltv7R-LjThOjcmqiMs'\n    // refreshToken: 'ya29.GluIB_CV15_XjVO1T1kxL-joMeehCdCl09wGe4k6JdbIRb0KgR6YpSwfeWIhr4Rg64mWjhmJIwY8IaVg0mDbBHB44E2RMFjHoXQpA54BZ7reKSIm0FT-A3nN2oji',\n};\n\nconst mailOptions = {\n    from: \"it@arislab.ai\",\n    to: to,\n    subject: subject,\n    text: text,\n    html: html,\n    attachments: attachments\n};\n\nconst transporter = nodemailer.createTransport({\n    service: 'gmail',\n    auth: auth,\n});\n\nlet payload = { \"status\": \"Sending email to: \" + to + \" with subject: \" + subject };\n\ntransporter.sendMail(mailOptions, (err, res) => {\n    if (err) {\n        node.error('Error while sending mail : ');\n        node.error(err);\n        payload['status'] = \"error\";\n        payload['details'] = err;\n    } else {\n        node.error('Send email successfully with options : ', mailOptions);\n        payload['status'] = \"success\";\n    }\n}); \n\nmsg.payload = payload;\n\nreturn msg; ","outputs":1,"noerr":0,"x":430,"y":120,"wires":[[]]},{"id":"1722d358.98cc5d","type":"function","z":"a3b720d7.727fa","name":"","func":"const to = msg.emailTo;\nconst subject = msg.emailSubject;\nconst text = msg.emailText;\nconst html = msg.emailHtml || \"\";\n\nmsg.payload = {\n    to: to,\n    subject: subject,\n    text: text,\n    html: html\n}\n\nmsg.headers = {\n    'Authorization': 'Basic b3JpZ2luQGNvbnZvbGFiLmFpOjFxYXpaQVEh'\n};\n\nmsg.url = \"https://cloud.convolab.ai/mail\";\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":300,"wires":[["541f7090.d602"]]},{"id":"541f7090.d602","type":"http request","z":"a3b720d7.727fa","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":440,"y":300,"wires":[[]]},{"id":"77b55869.99fee8","type":"debug","z":"4667e2bc.3c826c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":130,"y":380,"wires":[]},{"id":"49b594d4.f5a62c","type":"inject","z":"4667e2bc.3c826c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":400,"wires":[["34f5b676.30ebaa"]]},{"id":"a1ce7d3f.fb8ea","type":"http request","z":"4667e2bc.3c826c","name":"GET_SERVER_STATUS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":710,"y":280,"wires":[["5c912a81.e25d44","d5e19ce3.19546"]]},{"id":"bdc02eab.b9a67","type":"inject","z":"4667e2bc.3c826c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":500,"wires":[["9063e3fb.597bf"]]},{"id":"5c912a81.e25d44","type":"debug","z":"4667e2bc.3c826c","name":"GET_SERVER_STATUS_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":990,"y":280,"wires":[]},{"id":"8d2970d9.62df2","type":"inject","z":"4667e2bc.3c826c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":300,"wires":[["59e28ce3.cb78c4"]]},{"id":"e492066a.6fd788","type":"comment","z":"4667e2bc.3c826c","name":"GET_SERVER_STATUS","info":"","x":160,"y":240,"wires":[]},{"id":"a0c0a793.570ad8","type":"comment","z":"4667e2bc.3c826c","name":"CHECK_SERVER_STATUS","info":"","x":170,"y":640,"wires":[]},{"id":"7fd5f877.8f2118","type":"link out","z":"4667e2bc.3c826c","name":"GET_SERVER_STATUS_OUT","links":["57a5cd12.0a54f4"],"x":995,"y":320,"wires":[]},{"id":"57a5cd12.0a54f4","type":"link in","z":"4667e2bc.3c826c","name":"GET_SERVER_STATUS_IN","links":["7fd5f877.8f2118","e644172c.1bc248"],"x":75,"y":700,"wires":[["83bea18c.f63a2"]]},{"id":"59e28ce3.cb78c4","type":"change","z":"4667e2bc.3c826c","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://dev-arislab-core-servicestatus-svc.dev.svc.cluster.local:1150/status","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":340,"wires":[["a1ce7d3f.fb8ea"]]},{"id":"34f5b676.30ebaa","type":"change","z":"4667e2bc.3c826c","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1150/status","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"kuber_status_url","pt":"msg","to":"http://alpha-arislab-core-servicestatus-svc.uat.svc.cluster.local:1150/status","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":440,"wires":[["a1ce7d3f.fb8ea"]]},{"id":"9063e3fb.597bf","type":"change","z":"4667e2bc.3c826c","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1150/status","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"kuber_status_url","pt":"msg","to":"http://prod-arislab-core-servicestatus-svc.production.svc.cluster.local:1150/status","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":540,"wires":[["a1ce7d3f.fb8ea"]]},{"id":"d5e19ce3.19546","type":"function","z":"4667e2bc.3c826c","name":"SAVE_RESPONSE_TO_CONTEXT_GLOBAL","func":"let env = msg.env;\nlet serverStatusCode;\nlet serverStatusResponse;\n\nif (typeof msg.statusCode === 'number') {\n    serverStatusCode = msg.statusCode;\n} else {\n    serverStatusCode = 999\n}\n\nif (typeof msg.payload === 'object') {\n    // node.error('1');\n    serverStatusResponse = msg.payload;\n} else {\n    serverStatusResponse = [];\n}\n\nif (\n    context.global.hasOwnProperty('serverStatus') === false\n) {\n    context.global['serverStatus'] = {};\n}\n\nif (\n    context.global.hasOwnProperty('currentServerStatus') === false\n) {\n    context.global['currentServerStatus'] = {};\n}\n\nif (\n    context.global.hasOwnProperty('NOTIFICATION_TIME_INTERVAL') === false\n) {\n    context.global['NOTIFICATION_TIME_INTERVAL'] = 1800000;\n}\n\nif (\n    context.global.hasOwnProperty('serverStatus') &&\n    !context.global['serverStatus'].hasOwnProperty(env)\n) {\n    // If this env never checked before, do this\n    serverStatusResponse = serverStatusResponse.map((service) => {\n        service['lastUpdated'] = Date.now();\n        return service;\n    });\n    \n    context.global['serverStatus'][env] = {};\n    context.global['serverStatus'][env]['statusCode'] = serverStatusCode;\n    context.global['serverStatus'][env]['statusList'] = serverStatusResponse;\n    context.global['serverStatus'][env]['lastUpdated'] = Date.now();\n}\n\ncontext.global['currentServerStatus'][env] = {};\ncontext.global['currentServerStatus'][env]['statusCode'] = serverStatusCode;\ncontext.global['currentServerStatus'][env]['statusList'] = serverStatusResponse;\ncontext.global['currentServerStatus'][env]['lastUpdated'] = Date.now();\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":320,"wires":[["7fd5f877.8f2118","ed36f79d.6709f8"]]},{"id":"83bea18c.f63a2","type":"function","z":"4667e2bc.3c826c","name":"CHECK_SERVER_STATUSCODE","func":"let env = msg.env;\nlet serverStatus = context.global['serverStatus'][env];\nlet currentServerStatus = context.global['currentServerStatus'][env];\nlet NOTIFICATION_TIME_INTERVAL = context.global['NOTIFICATION_TIME_INTERVAL'];\n\nif ( currentServerStatus['statusCode'] !== serverStatus['statusCode'] ) {\n    // If status from current and first time is not matched, notify\n    node.error(\"SERVER HAS CHANGE STATUS.\");\n    return [msg, null];\n    \n} else {\n    if ( currentServerStatus['statusCode'] !== 200 ) {\n        if( currentServerStatus['lastUpdated'] - serverStatus['lastUpdated'] > NOTIFICATION_TIME_INTERVAL ) {\n            \n            /*\n                If status\n                - From current and first time status are equals\n                - Current status is OFFLINE\n                - Time between current and first time subtracted and still more than 30mins\n                Which means server still down, let's notify dev!\n            */\n            node.error(\"SERVER IS STILL DOWN. LET'S NOTIFY.\");\n            return [msg, null];\n        }\n    }\n    \n    // Otherwise, skip from notifying\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":280,"y":700,"wires":[["382eba75.46bc26","d3dd5d.8c58f2a"],["c2d07647.6e6c08","52aba04a.3ee63"]]},{"id":"f103bd4e.c8529","type":"function","z":"4667e2bc.3c826c","name":"CHECK_RUNNING_SERVICES_IN_SERVER","func":"let env = msg.env;\n\nlet statusList = context.global['serverStatus'][env]['statusList'];\n\nlet offlineServiceList = statusList.filter((service) => {\n    return service.status === \"OFFLINE\";\n});\n\nmsg.payload = offlineServiceList;\n\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":1160,"wires":[["27f4bfe6.b13c5","8f1a6d21.f1b43"]]},{"id":"d3bcad42.2f551","type":"cronplus","z":"c2216cea.17f8b","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"every minute","payload":"","type":"str","expression":"* * * * *"}],"x":280,"y":240,"wires":[[]]},{"id":"59636ef8.5f7bb","type":"exec","z":"c2216cea.17f8b","command":"chmod +x ./home/arislab-core/scripts/runLineNotify.sh && ./home/arislab-core/scripts/runLineNotify.sh","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"TRIGGER_LINE_NOTIFY","x":440,"y":400,"wires":[["d96cab7d.3e2588"],["17b637e1.a5ea28"],["799a596f.07aad8"]]},{"id":"3e843f69.78ef","type":"inject","z":"c2216cea.17f8b","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":400,"wires":[["59636ef8.5f7bb"]]},{"id":"d96cab7d.3e2588","type":"debug","z":"c2216cea.17f8b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":730,"y":280,"wires":[]},{"id":"17b637e1.a5ea28","type":"debug","z":"c2216cea.17f8b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":320,"wires":[]},{"id":"799a596f.07aad8","type":"debug","z":"c2216cea.17f8b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":380,"wires":[]},{"id":"a36e419a.e0c1f","type":"cronplus","z":"4667e2bc.3c826c","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"every minute","payload":"","type":"str","expression":"* * * * *"}],"x":140,"y":420,"wires":[[]]},{"id":"8f0c2eac.61a9e","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":80,"wires":[["f838dc26.fd54c"]]},{"id":"ae887706.2593c8","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":220,"wires":[["8e0348c6.c43688"]]},{"id":"93ef4365.4225","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":360,"wires":[["d78dab43.947b88"]]},{"id":"bf1dfb05.3685e8","type":"comment","z":"eb9ff6d6.6b53f8","name":"DEV","info":"","x":450,"y":40,"wires":[]},{"id":"b968c72b.7b6968","type":"comment","z":"eb9ff6d6.6b53f8","name":"ALPHA","info":"","x":450,"y":180,"wires":[]},{"id":"fe5091f0.4d0d","type":"comment","z":"eb9ff6d6.6b53f8","name":"PROD","info":"","x":450,"y":320,"wires":[]},{"id":"1512fea5.4004b1","type":"cronplus","z":"eb9ff6d6.6b53f8","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 8AM","payload":"","type":"str","expression":"0 8 * * *"},{"topic":"Every 4PM","payload":"","type":"str","expression":"0 16 * * *"},{"topic":"Every 12PM","payload":"","type":"str","expression":"0 12 * * *"}],"x":160,"y":220,"wires":[[]]},{"id":"f838dc26.fd54c","type":"change","z":"eb9ff6d6.6b53f8","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/findOrdersByStatus?status=PENDING","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":120,"wires":[["3da49335.29806c"]]},{"id":"8e0348c6.c43688","type":"change","z":"eb9ff6d6.6b53f8","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/findOrdersByStatus?status=PENDING","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":260,"wires":[["3da49335.29806c"]]},{"id":"d78dab43.947b88","type":"change","z":"eb9ff6d6.6b53f8","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/findOrdersByStatus?status=PENDING","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":400,"wires":[["3da49335.29806c"]]},{"id":"981c7f83.8d456","type":"http request","z":"eb9ff6d6.6b53f8","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1115,"y":120,"wires":[["c285c31a.65daa","5519101f.abeae"]]},{"id":"c285c31a.65daa","type":"debug","z":"eb9ff6d6.6b53f8","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1535,"y":80,"wires":[]},{"id":"5519101f.abeae","type":"function","z":"eb9ff6d6.6b53f8","name":"SAVE_TO_MSG_OBJ","func":"msg.orderList = msg.payload;\nmsg.orderListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1040,"y":160,"wires":[["b09d3b19.057c88","6ac17ba0.2eadf4"]]},{"id":"da693c9c.10df4","type":"debug","z":"eb9ff6d6.6b53f8","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2600,"y":220,"wires":[]},{"id":"548aebb8.a07684","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":460,"y":560,"wires":[["a3dd85f8.356f28"]]},{"id":"a3dd85f8.356f28","type":"function","z":"eb9ff6d6.6b53f8","name":"debug context.global","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":600,"wires":[["9837cf4c.81e5d"]]},{"id":"9837cf4c.81e5d","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":480,"y":640,"wires":[]},{"id":"208e9c37.a90814","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":560,"wires":[["e5f512ba.b2461"]]},{"id":"e5f512ba.b2461","type":"function","z":"eb9ff6d6.6b53f8","name":"reset context.global","func":"delete context.global['currentData'];\ndelete context.global['resultCheck'];\n\nmsg.payload = context.global;\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":600,"wires":[["94831aa4.5d6a38"]]},{"id":"94831aa4.5d6a38","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":180,"y":640,"wires":[]},{"id":"ed299938.d229d8","type":"function","z":"eb9ff6d6.6b53f8","name":"PASSING_EACH_ORDER_TO_CHECK","func":"const mapped_store_token = msg.mapped_store_token;\n\nlet orderList = msg.orderList;\nlet orderListStatusCode = msg.orderListStatusCode;\n\nconst findTokenFromMappedObj = (storeID, list_mapped_store_token) => {\n    // node.error('Finding store id ' + storeID + ' from mapped store token list');\n    return list_mapped_store_token.find((item) => {\n        return item['storeID'].includes(storeID);\n    });\n}\n// node.error(orderList);\nif (orderListStatusCode === 200) {\n    orderList.forEach((order, index) => {\n        setTimeout(() => {\n            const resultTokenFromMappedObj = findTokenFromMappedObj(order['storeID'], mapped_store_token);\n            \n            // node.error('resultTokenFromMappedObj');\n            // node.error(resultTokenFromMappedObj);\n            \n            msg.gbPayAccountObj = {};\n            msg.gbPayAccountObj['found'] = false;\n            \n            if (resultTokenFromMappedObj && Object.keys(resultTokenFromMappedObj).length > 0) {\n                // node.error(`Token founded, putting secret key to msg obj...`);\n                \n                msg.gbPayAccountObj = {};\n                msg.gbPayAccountObj = resultTokenFromMappedObj;\n                msg.gbPayAccountObj['found'] = true;\n            }\n            \n            msg.payload = order;\n            node.send(msg);\n        }, 2000 * index);\n    });\n}","outputs":1,"noerr":0,"x":1750,"y":160,"wires":[["cb75bfe6.b8629","71820e10.dfe0b"]]},{"id":"71820e10.dfe0b","type":"function","z":"eb9ff6d6.6b53f8","name":"CHECK_WITH_REFNO","func":"msg.currentOrder = msg.payload;\n\nlet order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\n// let gbPayLink = order['paymentInfo']['gbPayLink'];\n// let gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2050,"y":160,"wires":[["8c2d9821.8054e8","e586124b.88761"]]},{"id":"8c2d9821.8054e8","type":"debug","z":"eb9ff6d6.6b53f8","name":"CHECK_WITH_REFNO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2070,"y":120,"wires":[]},{"id":"bb809a8c.a363f8","type":"switch","z":"eb9ff6d6.6b53f8","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1580,"y":380,"wires":[["f621f509.52c928","2c505302.6af15c"],["d4aefec0.5c1d"]]},{"id":"16e3ac43.868674","type":"function","z":"eb9ff6d6.6b53f8","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2050,"y":200,"wires":[["e962007b.38ec3","e586124b.88761"]]},{"id":"a26bcc1e.6eecf","type":"switch","z":"eb9ff6d6.6b53f8","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1700,"y":420,"wires":[["29528c03.874d44"],["d5ab16c2.70aec8"]]},{"id":"d5ab16c2.70aec8","type":"function","z":"eb9ff6d6.6b53f8","name":"Can't find REF_NO and LINK_NO 😢","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${orderID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)","outputs":1,"noerr":0,"x":1990,"y":440,"wires":[[]]},{"id":"fda1c114.c49e7","type":"link in","z":"eb9ff6d6.6b53f8","name":"LINK_NO_IN","links":["29528c03.874d44"],"x":1895,"y":200,"wires":[["16e3ac43.868674"]]},{"id":"29528c03.874d44","type":"link out","z":"eb9ff6d6.6b53f8","name":"LINK_NO_OUT","links":["fda1c114.c49e7"],"x":1855,"y":400,"wires":[]},{"id":"e962007b.38ec3","type":"debug","z":"eb9ff6d6.6b53f8","name":"CHECK_WITH_LINKNO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2070,"y":240,"wires":[]},{"id":"e586124b.88761","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_HEADERS","func":"const gbPayAccountObj = msg.gbPayAccountObj;\n\n// var SECRET_KEY = \"PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\";\nvar SECRET_KEY = \"\";\n\nif (gbPayAccountObj['found']) {\n    SECRET_KEY = gbPayAccountObj['secret_key'];\n}\n\nmsg.headers = {}\n// msg.headers['Authorization'] = \"Basic UHdwUkFWaW1BSURGN0VFZTRpTFdoaDExTThFT2FBY3o6\";\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nmsg.url = \"https://api.gbprimepay.com/v1/check_status_txn\";\n\nreturn msg;","outputs":1,"noerr":0,"x":2320,"y":180,"wires":[["482c7ea2.c82c5","3a852bf2.184b74"]]},{"id":"f66291f5.16a88","type":"function","z":"eb9ff6d6.6b53f8","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"const isCreditCard = (obj) => {\n    return obj.hasOwnProperty('cardNo');\n}\n\nconst checkPaymentInfo = (obj) => {\n    let paymentMethod;\n    let gbResponseStatus = obj['status'];\n    let paymentStatus = \"PENDING\";\n    let gbpReferenceNo = obj['gbpReferenceNo'];\n    if (isCreditCard(obj)) {\n        paymentMethod = \"CREDIT_CARD\";\n        \n        if (gbResponseStatus === 'S' || gbResponseStatus === 'A') {\n            paymentStatus = \"SUCCESS\";\n        } else if (gbResponseStatus === 'G') {\n            paymentStatus = \"PENDING\";\n        } else if (gbResponseStatus === 'D') {\n            paymentStatus = \"FAIL\";\n        }\n    } else {\n        paymentMethod = \"QR_CODE\";\n        \n        if (gbResponseStatus === 'S') {\n            paymentStatus = \"SUCCESS\";\n        } else if (gbResponseStatus === 'G' || gbResponseStatus === 'A') {\n            paymentStatus = \"PENDING\";\n        } else if (gbResponseStatus === 'D') {\n            paymentStatus = \"FAIL\";\n        }\n    }\n    \n    // if (isCreditCard(obj) && paymentMethod === 'S' || paymentMethod === 'A') {\n    //     paymentMethod = \"CREDIT_CARD\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'S') {\n    //     paymentMethod = \"QR_CODE\";\n    //     // paymentMethod = \"PAID\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'A') {\n    //     // paymentMethod = \"CREDIT_CARD\";\n    //     // paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'D') {\n    //     paymentMethod = \"DECLINE\";\n    //     paymentStatus = \"FAIL\";\n    // } else if (paymentMethod === 'G') {\n    //     // paymentMethod = \"QR_CODE\";\n    //     paymentStatus = \"PENDING\";\n    // }\n    \n    return {\n        \"paymentMethod\": paymentMethod,\n        \"paymentStatus\": paymentStatus,\n        \"gbpReferenceNo\": gbpReferenceNo\n    }\n}\n\nlet gbResponseObj = msg.payload;\nmsg.gbResponseObj = gbResponseObj;\n\nlet apiUrl = msg.apiUrl;\n\nlet currentOrder = msg.currentOrder;\nlet storeID = currentOrder['storeID'];\nlet orderDocID = currentOrder['orderDocID'];\nlet paymentMethod;\nlet gbpReferenceNo;\n\nif (gbResponseObj.hasOwnProperty('txn')) {\n    // paymentMethod = gbResponseObj['txn']['status'];\n    // gbpReferenceNo = gbResponseObj['txn']['gbpReferenceNo'];\n    \n    const resultCheckPaymentInfo = checkPaymentInfo(gbResponseObj['txn']);\n    \n    if (Object.keys(resultCheckPaymentInfo).length > 0) {\n        paymentMethod = resultCheckPaymentInfo['paymentMethod'];\n        paymentStatus = resultCheckPaymentInfo['paymentStatus'];\n        gbpReferenceNo = resultCheckPaymentInfo['gbpReferenceNo'];\n    }\n    \n    // if (gbResponseObj['txn'].hasOwnProperty('cardNo')) {\n    //     paymentMethod = \"CREDIT_CARD\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'S') {\n    //     paymentMethod = \"QR_CODE\";\n    //     // paymentMethod = \"PAID\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'A') {\n    //     paymentMethod = \"CREDIT_CARD\";\n    //     paymentStatus = \"SUCCESS\";\n    // } else if (paymentMethod === 'D') {\n    //     paymentMethod = \"DECLINE\";\n    //     paymentStatus = \"FAIL\";\n    // } else if (paymentMethod === 'G') {\n    //     paymentMethod = \"QR_CODE\";\n    // }\n}\n\nif (gbResponseObj.hasOwnProperty('txns')) {\n    const resultFilterTXNS = gbResponseObj['txns'].find((txn) => {\n        return currentOrder.orderDocID === txn.merchantDefined2;\n    });\n    \n    if (Object.keys(resultFilterTXNS).length > 0) {\n        const resultCheckPaymentInfo = checkPaymentInfo(resultFilterTXNS);\n        \n        if (Object.keys(resultCheckPaymentInfo).length > 0) {\n            paymentMethod = resultCheckPaymentInfo['paymentMethod'];\n            paymentStatus = resultCheckPaymentInfo['paymentStatus'];\n            gbpReferenceNo = resultCheckPaymentInfo['gbpReferenceNo'];\n        }\n    }\n}\n// let paymentCompletedOn = paymentResponseObj.paymentCompletedOn;\n\n// var paymentStatus = \"PENDING\";\n\ncurrentOrder['resultPaymentStatus'] = paymentStatus;\nmsg.currentOrder = currentOrder;\n\n// let customerInfo = paymentResponseObj.customerInfo;\n\nlet url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\n\nmsg.url = url;\nmsg.payload = {\n    \"paymentInfo\": {\n        \"method\": paymentMethod,\n        \"status\": paymentStatus,\n        \"details\": gbpReferenceNo,\n        // \"paymentCompletedOn\": paymentCompletedOn,\n        \"isFromBatchCheck\": true,\n        \"batchCheckTimestamp\": Date.now(),\n        \"paymentCompletedOn\": Date.now()\n    }\n}\n\n// msg.payload = {\n//     \"paymentInfo\": {\n//         \"method\": paymentMethod,\n//         \"status\": \"SUCCESS\",\n//         \"details\": gbpReferenceNo,\n//         \"paymentCompletedOn\": paymentCompletedOn,\n//         \"isFromBatchCheck\": true,\n//         \"batchCheckTimestamp\": Date.now(),\n//         \"gbPaymentDetails\": {\n//             \"customerName\": customerInfo.customerName,\n//             \"customerEmail\": customerInfo.customerEmail,\n//             \"customerAddress\": customerInfo.customerAddress,\n//             \"customerTelephone\": customerInfo.customerTelephone\n//         }\n//     }\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":2000,"y":300,"wires":[["ccbbffbe.f22f9"]]},{"id":"ccbbffbe.f22f9","type":"debug","z":"eb9ff6d6.6b53f8","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2400,"y":300,"wires":[]},{"id":"ef2739ac.0d6e38","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2270,"y":340,"wires":[]},{"id":"ed36f79d.6709f8","type":"debug","z":"4667e2bc.3c826c","name":"SAVE_RESPONSE_TO_CONTEXT_GLOBAL_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1150,"y":360,"wires":[]},{"id":"382eba75.46bc26","type":"debug","z":"4667e2bc.3c826c","name":"CHECK_SERVER_STATUSCODE_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":640,"wires":[]},{"id":"27f4bfe6.b13c5","type":"debug","z":"4667e2bc.3c826c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":1280,"wires":[]},{"id":"8f1a6d21.f1b43","type":"switch","z":"4667e2bc.3c826c","name":"IS_SERVICE_DOWN?","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1160,"y":1220,"wires":[["c40750da.0fa54"],["105592b7.80c04d"]]},{"id":"c40750da.0fa54","type":"function","z":"4667e2bc.3c826c","name":"","func":"const capitalizeFirstLetter = (message) => {\n    return message.charAt(0).toUpperCase() + message.slice(1);\n}\n\nlet env = msg.env.toUpperCase();\nlet offlineServiceList = msg.payload;\nlet allStatusList = context.global['serverStatus'][msg.env]['statusList'];\nlet tempMessage = `[${env}] อุ๊บส์... Service: `;\n\nofflineServiceList.forEach((service, index) => {\n    node.error(`Service: ${service['serviceName']} offline`);\n    if (index > 0) {\n        tempMessage += `, ${capitalizeFirstLetter(service['serviceName'])}`\n    } else {\n        tempMessage += `${capitalizeFirstLetter(service['serviceName'])}`\n    }\n});\n\ntempMessage += ' พังไปแล้ว ทีม Dev มาตรวจสอบให้ที \\n\\n';\ntempMessage += `===== ${env} Service =====\\n`\n\nallStatusList.forEach((service) => {\n    let statusIcon = \"\";\n    let feelingIcon = \"\";\n    if (service.status.toUpperCase() === \"ONLINE\") {\n        statusIcon = \"✔\";\n        feelingIcon = \"😊\";\n    } else {\n        statusIcon = \"❌\";\n        feelingIcon = \"👿\";\n    }\n    tempMessage += `${statusIcon} ${capitalizeFirstLetter(service['serviceName'])}: ${service['status'].toUpperCase()} ${feelingIcon} \\n`\n})\n\nmsg.messageToNotify = {\n    message: tempMessage,\n    stickerPackageId: 1,\n    stickerId: 16\n}\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":1200,"wires":[[]]},{"id":"105592b7.80c04d","type":"function","z":"4667e2bc.3c826c","name":"","func":"// node.error('ALL IS WELL');\n\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":1240,"wires":[[]]},{"id":"c265d62c.ac96f8","type":"comment","z":"4667e2bc.3c826c","name":"TRIGGER_LINE_NOTIFY","info":"","x":170,"y":1060,"wires":[]},{"id":"68570f75.65ee7","type":"link in","z":"4667e2bc.3c826c","name":"NOTIFY_IN","links":["5a84a7e2.11d2c8","6c456a0a.f35104"],"x":255,"y":1100,"wires":[["5cc1d6dc.c80c88"]]},{"id":"5a84a7e2.11d2c8","type":"link out","z":"4667e2bc.3c826c","name":"NOTIFY_OUT","links":["68570f75.65ee7","293db432.f1fbbc"],"x":1235,"y":680,"wires":[]},{"id":"5cc1d6dc.c80c88","type":"function","z":"4667e2bc.3c826c","name":"SET_HEADERS","func":"const TOKEN = \"A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc\";\n\nlet messageToNotify = msg.messageToNotify;\n\nmsg.headers = {\n    \"Content-Type\": \"application/x-www-form-urlencoded\",\n    \"Authorization\": `Bearer ${TOKEN}`,\n    // \"Cache-Control\": \"no-cache\"\n}\nmsg.payload = messageToNotify;\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":1140,"wires":[["8d0df2b1.73647","e956c155.892f1"]]},{"id":"31eac670.2d7dfa","type":"debug","z":"4667e2bc.3c826c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":590,"y":1200,"wires":[]},{"id":"e4676712.b41b08","type":"inject","z":"4667e2bc.3c826c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":1120,"wires":[["433c7f03.3c2db"]]},{"id":"8d0df2b1.73647","type":"debug","z":"4667e2bc.3c826c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":350,"y":1180,"wires":[]},{"id":"6c456a0a.f35104","type":"link out","z":"4667e2bc.3c826c","name":"NOTIFY_OUT","links":["68570f75.65ee7","293db432.f1fbbc"],"x":1115,"y":940,"wires":[]},{"id":"c2d07647.6e6c08","type":"debug","z":"4667e2bc.3c826c","name":"CHECK_SERVER_STATUSCODE_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":760,"wires":[]},{"id":"d3dd5d.8c58f2a","type":"function","z":"4667e2bc.3c826c","name":"NOTIFY_FOR_SERVER_STATUS_BY_HTTP_STATUS_CODE","func":"let env = msg.env\nlet envUppercase = msg.env.toUpperCase();\nlet serverStatus = context.global['serverStatus'][env];\nlet currentServerStatus = context.global['currentServerStatus'][env];\n\nif (currentServerStatus['statusCode'] === 200) {\n    // If current server status is online (200), do notify \"SERVER IS BACK!!!\"\n    node.error('SERVER IS BACK!')\n    \n    msg.messageToNotify = {\n        message: `[${envUppercase}] เย้!!! SERVER กลับมามีสถานะเป็น Online แล้ว`,\n        stickerPackageId: 1,\n        stickerId: 103\n    }    \n    \n    return [msg, null];\n} else {\n    // Otherwise, do notify \"SERVER DOWN\"\n    node.error('SERVER DOWN')\n    \n    msg.messageToNotify = {\n        message: `[${envUppercase}] แย่แล้ว!!! ตรวจพบว่า SERVER มีสถานะเป็น Offline รีบแก้ไขด่วน`,\n        stickerPackageId: 1,\n        stickerId: 16\n    }\n    \n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":700,"y":680,"wires":[["5a84a7e2.11d2c8","9ab8413e.d067f","a1174d46.c1272"],["5a84a7e2.11d2c8","9ab8413e.d067f"]]},{"id":"433c7f03.3c2db","type":"function","z":"4667e2bc.3c826c","name":"","func":"msg.messageToNotify = {\n    message: \"testttt\",\n    stickerPackageId: 1,\n    stickerId: 16\n}\nreturn msg;","outputs":1,"noerr":0,"x":130,"y":1180,"wires":[["5cc1d6dc.c80c88","ecdb128d.77189"]]},{"id":"e956c155.892f1","type":"http request","z":"4667e2bc.3c826c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://notify-api.line.me/api/notify","tls":"","proxy":"","authType":"","x":550,"y":1140,"wires":[["31eac670.2d7dfa"]]},{"id":"ecdb128d.77189","type":"debug","z":"4667e2bc.3c826c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":270,"y":1220,"wires":[]},{"id":"9ab8413e.d067f","type":"function","z":"4667e2bc.3c826c","name":"UPDATE CURRENT SERVER STATUS TO FIRST SERVER STATUS","func":"let env = msg.env;\n\n// node.error(\"ENV === \"+env);\n// node.error(\"context.global['currentServerStatus'][env]['statusCode'] === \"+context.global['currentServerStatus'][env]['statusCode']);\n// node.error(\"context.global['currentServerStatus'][env]['lastUpdated'] === \"+context.global['currentServerStatus'][env]['lastUpdated']);\n// node.error(\"context.global['serverStatus'][env]['statusCode'] === \"+context.global['serverStatus'][env]['statusCode']);\n// node.error(\"context.global['serverStatus'][env]['lastUpdated'] === \"+context.global['serverStatus'][env]['lastUpdated']);\n\n\ncontext.global['serverStatus'][env]['statusCode'] = context.global['currentServerStatus'][env]['statusCode'];\ncontext.global['serverStatus'][env]['lastUpdated'] = context.global['currentServerStatus'][env]['lastUpdated'];\n\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":780,"wires":[[]]},{"id":"52aba04a.3ee63","type":"function","z":"4667e2bc.3c826c","name":"SERVER STILL OKAY OR IT'S NOT TIME TO NOTIFY","func":"let env = msg.env;\nlet currentServerStatus = context.global['currentServerStatus'][env];\nif( currentServerStatus['statusCode'] === 200 ) {\n    // node.error(\"SERVER IS STILL ONLINE, DON'T NOTIFY ANYTHING.\");\n    return [msg, null];\n} else {\n    // node.error(\"SERVER IS STILL DOWN, BUT IT IS NOT TIME TO NOTIFY.\");\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":680,"y":720,"wires":[["9ab8413e.d067f","a1174d46.c1272"],[]]},{"id":"508df331.ec5ebc","type":"comment","z":"4667e2bc.3c826c","name":"CHECK_SERVICE_STATUS","info":"","x":180,"y":880,"wires":[]},{"id":"a1174d46.c1272","type":"link out","z":"4667e2bc.3c826c","name":"CHECK_SERVICE_OUT","links":["92fc62c7.3a4c4"],"x":1035,"y":740,"wires":[]},{"id":"92fc62c7.3a4c4","type":"link in","z":"4667e2bc.3c826c","name":"CHECK_SERVICE_IN","links":["a1174d46.c1272"],"x":75,"y":960,"wires":[["b0929507.42b408"]]},{"id":"b0929507.42b408","type":"function","z":"4667e2bc.3c826c","name":"CHECK_RUNNING_SERVICES_IN_SERVER","func":"let env = msg.env;\n\nconst NOT_NOTIFY_SERVICE_NAME_LIST = ['rvpTLS'];\n\nlet statusList = context.global['serverStatus'][env]['statusList'];\nlet currentStatusList = context.global['currentServerStatus'][env]['statusList'];\nlet NOTIFICATION_TIME_INTERVAL = context.global['NOTIFICATION_TIME_INTERVAL'];\n\nlet offlineService = [];\nlet backToOnlineService = [];\nlet updateStatusList = [];\n\ncurrentStatusList.forEach((currentStatusInfo, index) => {\n\n    const lastStatus = statusList.find(service => service.serviceName === currentStatusInfo.serviceName);\n    \n    if ( NOT_NOTIFY_SERVICE_NAME_LIST.indexOf(lastStatus.serviceName) > -1 ) {\n        updateStatusList[index] = currentStatusInfo;\n        updateStatusList[index]['lastUpdated'] = Date.now()\n    }\n                \n    if( currentStatusInfo.status.toLocaleUpperCase() === \"ONLINE\" ) {\n        if( lastStatus.status === \"OFFLINE\" ) {\n            // node.error('online')\n            backToOnlineService.push( currentStatusInfo.serviceName );\n        }\n        \n        updateStatusList[index] = currentStatusInfo;\n        updateStatusList[index]['lastUpdated'] = Date.now()\n\n    } else {\n\n        if( lastStatus.status === \"ONLINE\" ) {\n            // node.error('last status ONLINE')\n            updateStatusList[index] = currentStatusInfo;\n            updateStatusList[index]['lastUpdated'] = Date.now()\n            // updateStatusList[index]['status'] = currentStatusInfo['status'];\n            // updateStatusList[index]['lastUpdated'] = currentStatusInfo['lastUpdated'];\n\n            if( NOT_NOTIFY_SERVICE_NAME_LIST.indexOf(lastStatus.serviceName) === -1 ) {\n                // node.error('offline 1');\n                offlineService.push( lastStatus.serviceName );\n            }\n        \n        } else {\n            // node.error('last status !== ONLINE')\n            if( lastStatus.hasOwnProperty('lastUpdated') && lastStatus.lastUpdated ) {\n                // node.error(`lastStatus.hasOwnProperty('lastUpdated') && lastStatus.lastUpdated `)\n                if( (currentStatusInfo.lastUpdated - lastStatus.lastUpdated) > NOTIFICATION_TIME_INTERVAL ) {\n                    // node.error(`currentStatusInfo.lastUpdated - lastStatus.lastUpdated) > NOTIFICATION_TIME_INTERVAL`)\n                    updateStatusList[index] = currentStatusInfo;\n                    updateStatusList[index]['lastUpdated'] = Date.now()\n                    // updateStatusList[index]['status'] = currentStatusInfo['status'];\n                    // updateStatusList[index]['lastUpdated'] = currentStatusInfo['lastUpdated'];\n                    \n                    if( NOT_NOTIFY_SERVICE_NAME_LIST.indexOf(lastStatus.serviceName) === -1 ) {\n                        // node.error('offline 2');\n                        offlineService.push( lastStatus.serviceName );\n                    }\n\n                } else {\n                    updateStatusList[index] = lastStatus;\n                }\n            } else {\n                updateStatusList[index] = currentStatusInfo;\n                updateStatusList[index]['lastUpdated'] = Date.now()\n                // updateStatusList[index]['status'] = currentStatusInfo['status'];\n                // updateStatusList[index]['lastUpdated'] = currentStatusInfo['lastUpdated'];\n            }\n\n        }\n\n    }\n});\n\nmsg.updateStatusList = updateStatusList;\nif (offlineService.length > 0 || backToOnlineService.length > 0 ) {\n    msg.offlineService = offlineService;\n    msg.backToOnlineService = backToOnlineService;\n    // node.error('offline > 0')\n    return [msg, null];\n} else {\n    // node.error('offline < 0')\n    return [null, msg];\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// let offlineServiceList = statusList.filter((service) => {\n//     return service.status === \"OFFLINE\";\n// });\n\n// msg.payload = offlineServiceList;\n\n// return msg;","outputs":2,"noerr":0,"x":310,"y":960,"wires":[["bfbf1ed6.8324d","27f540c8.f16e1"],["f36b45a2.17dba8","bfbf1ed6.8324d"]]},{"id":"f36b45a2.17dba8","type":"function","z":"4667e2bc.3c826c","name":"SERVICE STILL OKAY OR IT'S NOT TIME TO NOTIFY","func":"// let env = msg.env;\n// let currentServerStatus = context.global['currentServerStatus'][env];\n// if( currentServerStatus['statusCode'] === 200 ) {\n//     node.error(\"SERVER IS STILL ONLINE, DON'T NOTIFY ANYTHING.\");\n//     return [msg, null];\n// } else {\n//     node.error(\"SERVER IS STILL DOWN, BUT IT IS NOT TIME TO NOTIFY.\");\n//     return [null, msg];\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":980,"wires":[[]]},{"id":"27f540c8.f16e1","type":"function","z":"4667e2bc.3c826c","name":"NOTIFY_FOR_SERVICE_STATUS","func":"let env = msg.env\nlet envUppercase = msg.env.toUpperCase();\n\nvar offlineService = msg.offlineService;\nvar backToOnlineService = msg.backToOnlineService;\n\n\nif( offlineService.length > 0 ) {\n    \n    msg.messageToNotify = {\n        message: `[${envUppercase}] Tech Team จ๋า Service: ${offlineService.join(', ')} ดับไปแล้ว ช่วยเช็คให้ด้วยน้าาาาา`,\n        stickerPackageId: 1,\n        stickerId: 16\n    }\n    msg.offlineService = [];\n    \n    return [msg, null];\n}\n\nif( backToOnlineService.length >0 ) {\n\n    msg.messageToNotify = {\n        message: `[${envUppercase}] Service: ${backToOnlineService.join(', ')} กลับมาใช้งานได้ตามปกติแล้ว ดีใจ!!!`,\n        stickerPackageId: 1,\n        stickerId: 120\n    }\n    msg.backToOnlineService = [];\n    \n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":680,"y":940,"wires":[["6c456a0a.f35104","c3f5b4b7.bb5788"],["6c456a0a.f35104","c3f5b4b7.bb5788"]]},{"id":"bfbf1ed6.8324d","type":"debug","z":"4667e2bc.3c826c","name":"CHECK_SERVICE_STATUSCODE_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":1040,"wires":[]},{"id":"c3f5b4b7.bb5788","type":"function","z":"4667e2bc.3c826c","name":"UPDATE CURRENT SERVICE STATUS TO FIRST SERVICE STATUS","func":"let env = msg.env;\n\ncontext.global['serverStatus'][env]['statusList'] = msg.updateStatusList;\n\nreturn msg;","outputs":1,"noerr":0,"x":1220,"y":1060,"wires":[[]]},{"id":"308b289a.52eea8","type":"inject","z":"4667e2bc.3c826c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":100,"wires":[["26d33dac.34dd22"]]},{"id":"26d33dac.34dd22","type":"function","z":"4667e2bc.3c826c","name":"CHECK_CONTEXT_GLOBAL","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":140,"wires":[["59f0c6bd.969248"]]},{"id":"46c298a1.ee4ac8","type":"inject","z":"4667e2bc.3c826c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":100,"wires":[["414a1c43.75c884"]]},{"id":"414a1c43.75c884","type":"function","z":"4667e2bc.3c826c","name":"REMOVE_CONTEXT_GLOBAL","func":"delete context.global['serverStatus'];\ndelete context.global['currentServerStatus'];\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":140,"wires":[[]]},{"id":"59f0c6bd.969248","type":"debug","z":"4667e2bc.3c826c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":170,"y":180,"wires":[]},{"id":"eea2ebec.41d7c8","type":"inject","z":"4667e2bc.3c826c","name":"API","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1050,"y":80,"wires":[["4bdd27f9.d2c548"]]},{"id":"4bdd27f9.d2c548","type":"function","z":"4667e2bc.3c826c","name":"CHANGE_SERVER_STATUS","func":"let payload = msg.payload;\n\ncontext.global['serverStatus']['alpha']['statusList'][payload]['status'] = \"OFFLINE\";\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":100,"wires":[["b52a3820.f622f8"]]},{"id":"b52a3820.f622f8","type":"debug","z":"4667e2bc.3c826c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1210,"y":140,"wires":[]},{"id":"346b3fc.60602c","type":"inject","z":"4667e2bc.3c826c","name":"SECURESITE","topic":"","payload":"2","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1030,"y":120,"wires":[["4bdd27f9.d2c548"]]},{"id":"a70cc823.1924c8","type":"comment","z":"4667e2bc.3c826c","name":"INJECT","info":"","x":110,"y":40,"wires":[]},{"id":"bf9b0e37.e2b4b","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":1030,"y":120,"wires":[]},{"id":"79de08c3.19a758","type":"debug","z":"4855adbb.ec1254","name":"handleVerifyQRCode_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":230,"y":200,"wires":[]},{"id":"3891b3fe.711aac","type":"function","z":"4855adbb.ec1254","name":"INIT_PAYLOAD","func":"msg.headers = {\n    \"Content-type\" : \"multipart/form-data\"\n}\n\nlet reqPayload = msg.payload;\nmsg.payload = {\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo'],\n    \"amount\": reqPayload['amount']\n}\n\nnode.log('Verifying QRCode with payload: ' + JSON.stringify(msg.payload));\n\n// msg.url = \"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode\";\n// msg.method = \"POST\";\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":60,"wires":[["e14c35eb.2cd508","8f501dbf.d138"]]},{"id":"2c5a9cda.fdb3f4","type":"www-request-multipart","z":"4855adbb.ec1254","name":"","method":"POST","ret":"obj","url":"","follow-redirects":false,"tls":"","x":810,"y":60,"wires":[["bf9b0e37.e2b4b","ccc8806e.30d9"]]},{"id":"e14c35eb.2cd508","type":"debug","z":"4855adbb.ec1254","name":"handleVerifyQRCode_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":370,"y":120,"wires":[]},{"id":"e7ca3e55.d2196","type":"httpInMultipart","z":"4855adbb.ec1254","name":"","url":"/handleVerifyQRCode","method":"post","fields":"[{\"name\": \"referenceNo\"}, {\"name\": \"gbpReferenceNo\"}, {\"name\": \"amount\"}]","swaggerDoc":"","x":180,"y":60,"wires":[["3891b3fe.711aac","79de08c3.19a758"]]},{"id":"7566302f.72944","type":"change","z":"4855adbb.ec1254","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":100,"wires":[["2c5a9cda.fdb3f4"]]},{"id":"8f501dbf.d138","type":"change","z":"4855adbb.ec1254","name":"BETA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":140,"wires":[["2c5a9cda.fdb3f4"]]},{"id":"ccc8806e.30d9","type":"debug","z":"4855adbb.ec1254","name":"handleVerifyQRCode_debug3","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":1110,"y":60,"wires":[]},{"id":"8608f38b.9a965","type":"http in","z":"4855adbb.ec1254","name":"","url":"/liveEventCode","method":"get","upload":false,"swaggerDoc":"","x":150,"y":400,"wires":[["44cf97ba.123028","c3bf0a0d.0ae978"]]},{"id":"7e69fe69.d4e79","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":930,"y":600,"wires":[]},{"id":"e60d5a3c.f24a88","type":"function","z":"4855adbb.ec1254","name":"DEV","func":"let code = msg.payload.code.toUpperCase();\n\nmsg.url = `http://console.internal.arislab.ai:1780/api/event/code/${code}`;\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":440,"wires":[["16994769.a11de9"]]},{"id":"44cf97ba.123028","type":"debug","z":"4855adbb.ec1254","name":"liveEventCode_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":390,"y":580,"wires":[]},{"id":"16994769.a11de9","type":"http request","z":"4855adbb.ec1254","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":930,"y":440,"wires":[["7e69fe69.d4e79","10b8aa7.b9db256"]]},{"id":"10b8aa7.b9db256","type":"debug","z":"4855adbb.ec1254","name":"liveEventCode_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1070,"y":380,"wires":[]},{"id":"399bde5c.d894d2","type":"function","z":"4855adbb.ec1254","name":"ALPHA","func":"let code = msg.payload.code.toUpperCase();\n\nmsg.url = `http://console.cb-alpha.arislab.ai:1780/api/event/code/${code}`;\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":480,"wires":[["16994769.a11de9"]]},{"id":"9f34774f.a94b68","type":"function","z":"4855adbb.ec1254","name":"BETA","func":"let code = msg.payload.code.toUpperCase();\n\nmsg.url = `http://console.cb-beta.arislab.ai:1780/api/event/code/${code}`;\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":520,"wires":[["16994769.a11de9"]]},{"id":"5aec4bf9.2c76e4","type":"switch","z":"4855adbb.ec1254","name":"split by env","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":410,"y":480,"wires":[["e60d5a3c.f24a88"],["399bde5c.d894d2"],["9f34774f.a94b68"],["9f34774f.a94b68"]]},{"id":"c3bf0a0d.0ae978","type":"switch","z":"4855adbb.ec1254","name":"with ?code querystring or not","property":"payload.code","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":400,"wires":[["5aec4bf9.2c76e4"],["4dc8003.8a581"]]},{"id":"c62412bf.281b9","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":810,"y":380,"wires":[]},{"id":"4dc8003.8a581","type":"function","z":"4855adbb.ec1254","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Code must not by empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":380,"wires":[["c62412bf.281b9"]]},{"id":"c80c1616.21bf88","type":"http in","z":"4855adbb.ec1254","name":"","url":"/getStreamingVideo","method":"get","upload":false,"swaggerDoc":"","x":170,"y":720,"wires":[["a08aa118.7673a","bb952d65.c412f"]]},{"id":"e48dde50.d5ce5","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":1190,"y":700,"wires":[]},{"id":"a08aa118.7673a","type":"switch","z":"4855adbb.ec1254","name":"with ?code querystring or not","property":"payload.code","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":660,"wires":[["b4ef74b.c311888"],["1c9640b2.05a55f"]]},{"id":"1c9640b2.05a55f","type":"function","z":"4855adbb.ec1254","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Code must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":880,"wires":[["15bcbd54.2a4923"]]},{"id":"15bcbd54.2a4923","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":730,"y":880,"wires":[]},{"id":"bb952d65.c412f","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":170,"y":860,"wires":[]},{"id":"b4ef74b.c311888","type":"switch","z":"4855adbb.ec1254","name":"with ?ip querystring or not","property":"payload.ip","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":700,"wires":[["7dc1655d.0064ac"],["d8b0e8d0.fe2438"]]},{"id":"d8b0e8d0.fe2438","type":"function","z":"4855adbb.ec1254","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"IP must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":820,"wires":[["15bcbd54.2a4923"]]},{"id":"7dc1655d.0064ac","type":"function","z":"4855adbb.ec1254","name":"","func":"let code = msg.payload.code;\nlet ip = msg.payload.ip\nmsg.payload = {\n    url: `http://${ip}/live/${code}.flv`\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":680,"wires":[["cc4840d2.a6f7b","e48dde50.d5ce5"]]},{"id":"cc4840d2.a6f7b","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":760,"wires":[]},{"id":"4f52e7fe.67e218","type":"http in","z":"370ebe73.42de32","name":"","url":"/cloneProduct","method":"post","upload":false,"swaggerDoc":"","x":210,"y":100,"wires":[["d4b9b55a.c9c0b8"]]},{"id":"36a4536c.46c75c","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":710,"y":300,"wires":[]},{"id":"d4b9b55a.c9c0b8","type":"function","z":"370ebe73.42de32","name":"Check required fields","func":"let payload = msg.payload;\n\nif (\n    payload.hasOwnProperty('source') &&\n    payload.hasOwnProperty('target') &&\n    payload.hasOwnProperty('env')\n) {\n    return [msg, null];\n} else {\n    msg.statusCode = 400;\n    msg.payload = {\n        message: \"Missing required fields (source, target or env). Please check and try again\"\n    };\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":460,"y":120,"wires":[["49b318b8.c2d928"],["36a4536c.46c75c"]]},{"id":"23bebc1.4abda44","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":1110,"y":60,"wires":[]},{"id":"178ebf83.0185f","type":"function","z":"370ebe73.42de32","name":"echo payload back","func":"let payload = msg.payload;\n\nmsg.payload = payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":180,"wires":[[]]},{"id":"49b318b8.c2d928","type":"switch","z":"370ebe73.42de32","name":"env splitter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":730,"y":80,"wires":[["276e6af3.805716"],[],[]]},{"id":"276e6af3.805716","type":"change","z":"370ebe73.42de32","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":60,"wires":[["23bebc1.4abda44"]]},{"id":"9dd127e6.7af468","type":"inject","z":"370ebe73.42de32","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":760,"y":180,"wires":[["c73dc6cb.b7d2c8"]]},{"id":"7d78ef90.1286d","type":"http request","z":"370ebe73.42de32","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1020,"y":280,"wires":[["dffaf07e.c695c"]]},{"id":"dffaf07e.c695c","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1200,"y":380,"wires":[]},{"id":"c73dc6cb.b7d2c8","type":"function","z":"370ebe73.42de32","name":"","func":"const CREDENTIALS = {\n    \"user\": \"elastic\",\n    \"pass\": \"Ptox6rGdRdhr5gajOIZBXZQn\"\n}\n\nconst HOST = `${CREDENTIALS['user']}:${CREDENTIALS['pass']}@893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243`;\nconst INDEX = 'arislab-platform';\nconst TYPE = 'product';\n\nmsg.url = `https://${HOST}/${INDEX}/${TYPE}/_search?size=500`;\nmsg.method = \"GET\"\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":180,"wires":[["7d78ef90.1286d"]]},{"id":"fedb7bcc.39a6d8","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":890,"y":180,"wires":[]},{"id":"a75eb53d.c8cb28","type":"function","z":"4855adbb.ec1254","name":"ALWAYS_APPROVE","func":"let reqPayload = msg.payload;\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n}\n\nmsg.payload = {\n    \"resultCode\": \"00\",\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo']\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":180,"wires":[["fedb7bcc.39a6d8","a415e7fb.7bf5d8"]]},{"id":"a415e7fb.7bf5d8","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":240,"wires":[]},{"id":"dd72c1e.2b2774","type":"change","z":"4855adbb.ec1254","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":60,"wires":[["2c5a9cda.fdb3f4"]]},{"id":"3512c13a.6ba9ae","type":"http in","z":"370ebe73.42de32","name":"","url":"/setupDroplet","method":"get","upload":false,"swaggerDoc":"","x":170,"y":460,"wires":[["41b6677f.c614c8"]]},{"id":"5f641acf.e472e4","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":1270,"y":600,"wires":[]},{"id":"3ef6aea9.c18a32","type":"function","z":"370ebe73.42de32","name":"Init file content and filename","func":"let env = msg.env\n\nmsg.payload = `\n\n#!/bin/sh\n\n# Install npm\necho \"⏳ Installing npm...\"\nsudo apt update\napt -y install npm\n\n# Install NodeJS 8.x\necho \"⏳ Installing nodejs...\"\ncurl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -\napt -y install nodejs\n\n# Install yarn\necho \"⏳ Installing yarn...\"\ncurl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -\necho \"deb https://dl.yarnpkg.com/debian/ stable main\" | sudo tee /etc/apt/sources.list.d/yarn.list\napt-get -y install yarn\n\n# Install typescript\necho \"⏳ Installing typescript...\"\napt -y install node-typescript\n\n# Install ffmpeg\necho \"⏳ Installing ffmpeg..\"\nsudo add-apt-repository -y ppa:jonathonf/ffmpeg-4\nsudo apt -y install ffmpeg\n\n# Install libxcomposite\necho \"⏳ Installing libxcomposite...\"\napt-get -y install libxcomposite-dev && apt-get -y install libxtst6 && apt-get -y install libnss3-dev && apt-get -y install libatk1.0-0 && apt-get -y install libatk-bridge2.0-0 && apt -y install libgtk-3-0\n\n# Setup git\necho \"⏳ Cloning arislab-core...\"\ngit config --global credential.helper store\ncd /home && git clone --single-branch --branch ${env} https://6c30008265a798b84ea651f287646de07bbd98a6@github.com/arislab/arislab-core.git && cd arislab-core\n\necho \"⏳ Creating .env.production file...\"\ncurl https://manage.arislab.ai/createEnvFile?env=${env} >> .env.production\n\nsudo mv package.json _package.json\nsudo mv no_platform-package.json package.json\n\necho \"⏳ Starting all services...\"\nnpm install && npm run-script prod\n\n`;\nmsg.filename = `/setupDroplet_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":500,"wires":[["fc13ac7f.ba063","ea1d.132c65e3f"]]},{"id":"375c52ae.664fbe","type":"file in","z":"370ebe73.42de32","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":1270,"y":540,"wires":[["f49493fa.8841b"]]},{"id":"f49493fa.8841b","type":"change","z":"370ebe73.42de32","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":600,"wires":[["5f641acf.e472e4","f21ad7f5.49bd38"]]},{"id":"fc13ac7f.ba063","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":460,"wires":[]},{"id":"f21ad7f5.49bd38","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":640,"wires":[]},{"id":"ea1d.132c65e3f","type":"file","z":"370ebe73.42de32","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1270,"y":500,"wires":[["f1ee9a07.f7cf28"]]},{"id":"f1ee9a07.f7cf28","type":"function","z":"370ebe73.42de32","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":540,"wires":[["375c52ae.664fbe"]]},{"id":"fdb67fd.5b02e8","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":150,"y":740,"wires":[]},{"id":"41b6677f.c614c8","type":"switch","z":"370ebe73.42de32","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":460,"wires":[["c606d16d.aa0fc"],["19148a0.f74d276"]]},{"id":"19148a0.f74d276","type":"change","z":"370ebe73.42de32","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":180,"y":700,"wires":[["fdb67fd.5b02e8"]]},{"id":"2d5081.14918f8","type":"http in","z":"370ebe73.42de32","name":"","url":"/createEnvFile","method":"get","upload":false,"swaggerDoc":"","x":170,"y":840,"wires":[["7093b2e2.eec08c"]]},{"id":"7093b2e2.eec08c","type":"switch","z":"370ebe73.42de32","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":840,"wires":[["ce6e7902.9726c8"],["5670f585.e9f7cc"]]},{"id":"c606d16d.aa0fc","type":"switch","z":"370ebe73.42de32","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":530,"y":600,"wires":[["ebe9febb.0da29"],["97868d75.3be24"],["d8da1949.91cf08"]]},{"id":"ebe9febb.0da29","type":"change","z":"370ebe73.42de32","name":"dev","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":480,"wires":[["3ef6aea9.c18a32"]]},{"id":"97868d75.3be24","type":"change","z":"370ebe73.42de32","name":"alpha","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":520,"wires":[["3ef6aea9.c18a32"]]},{"id":"d8da1949.91cf08","type":"change","z":"370ebe73.42de32","name":"beta","rules":[{"t":"set","p":"env","pt":"msg","to":"master","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":560,"wires":[["3ef6aea9.c18a32"]]},{"id":"ce6e7902.9726c8","type":"switch","z":"370ebe73.42de32","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":430,"y":960,"wires":[["6882ee8f.bee91"],["ad36b2f2.afcf"],["47a33f04.e65fd"]]},{"id":"5abef298.ba747c","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":950,"y":860,"wires":[]},{"id":"5670f585.e9f7cc","type":"change","z":"370ebe73.42de32","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":820,"wires":[["5abef298.ba747c"]]},{"id":"f7e129f6.667008","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":1150,"y":1080,"wires":[]},{"id":"c5d654c8.c9da38","type":"file in","z":"370ebe73.42de32","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":950,"y":1040,"wires":[["9de75b60.029738"]]},{"id":"9de75b60.029738","type":"change","z":"370ebe73.42de32","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":1080,"wires":[["f7e129f6.667008","757c1e09.23a19"]]},{"id":"2936aa72.ebc216","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":900,"wires":[]},{"id":"757c1e09.23a19","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":1160,"wires":[]},{"id":"938bfb9f.ef37b8","type":"file","z":"370ebe73.42de32","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":950,"y":960,"wires":[["bc9ab4b5.1daa38"]]},{"id":"bc9ab4b5.1daa38","type":"function","z":"370ebe73.42de32","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1000,"wires":[["c5d654c8.c9da38"]]},{"id":"6882ee8f.bee91","type":"function","z":"370ebe73.42de32","name":"dev","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='dev-arislab-platform'\nnes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-dev'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://dev.arislab.ai/'\nAPI_URL='https://dev.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab-dev.auth0.com'\nAUTH0_CLIENT_ID='Jqr8WyfSYqgiw1NgRlQ2f0UJLi8aWOgb'\nAUTH0_CLIENT_SECRET='ciGvXGgVeMBIGXJHRAYTfCkIS5Bk6HnfaUbif1bf-HUZnaPiPTRVNvqgOjK2tmPT'\nAUTH0_SAML_IDP_CERT_FILE='arislab-dev.pem'\n#AUTH0_DOMAIN='arislab.auth0.com'\n#AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\n#AUTH0_CLIENT_SECRET='WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\n#AUTH0_SAML_IDP_CERT_FILE='arislab.pem'\nPACKAGE_URL='https://manage-uat.arislab.ai/getPlatformPackage?packageName=default'\nCALCULATE_STORE_PACKAGE_URL='https://manage-uat.arislab.ai/calculateStorePackage'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://dev.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://dev.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\n#LOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_DESTINATION='rapid7'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\nRAPID7_LOG_TOKEN='1255309c-e9b5-4ef7-9d98-5bf6eac596e6'\n\n#LINE\nSERVER_NAME='DEV'\nENABLE_NOTIFICATION=true\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\nMSG_HOST_LIST='http://msg-aws-sea01.convolab.ai,http://hooks.eu-gb.mybluemix.net,https://msg.convolab.ai'\nMSG_REFRESH_PATH='aris-uat'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='Ky2haeDb1LnsULwQrT4Vxw0A14WrjQc7ZqcVb+80Vy1qHnU00WHgGqQ95IVFuOu0K0h4BsyR+qV9LGA/nLq+PIH00VD+AtDfZteVOEA6/al1C+wwFqlQbB3sq9h6AknCbyf1fO/Gz/N6UltVeiJ+XeX2D1w='\nGB_PAY_SECRET_KEY='TLLWgLJwSql5VHXoMB2px1n4BCEhATMo'\nGB_PAY_GATEWAY='https://api.globalprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n#GB_PAY_ADMIN_ARISLAB_ACCOUNT\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_TOKEN='Ky2haeDb1LnsULwQrT4Vxw0A14WrjQc7ZqcVb+80Vy1qHnU00WHgGqQ95IVFuOu0K0h4BsyR+qV9LGA/nLq+PIH00VD+AtDfZteVOEA6/al1C+wwFqlQbB3sq9h6AknCbyf1fO/Gz/N6UltVeiJ+XeX2D1w='\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_PUBLIC_KEY='QnlexEQDVeUd41p4uO9xjfXbwYtJMp2C'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_SECRET_KEY='TLLWgLJwSql5VHXoMB2px1n4BCEhATMo'\nRECURRING_BACKGROUND_URL='https://manage-uat.arislab.ai/recurringResultDev'\nRECURRING_PERIOD='01'\n\n#WITHDRAW_MODE\nWITHDRAW_MODE=\"REALTIME\"\n#WITHDRAW_MODE=\"ON_TIME\"\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":920,"wires":[["938bfb9f.ef37b8"]]},{"id":"ad36b2f2.afcf","type":"function","z":"370ebe73.42de32","name":"alpha","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='alpha-arislab-platform'\n#nes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\nnes='elastic:g4Xz31uTb8seR3t7jKRgKkj1@bbba64697ea14e0884759935a8d425f7.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-uat'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\n\n#RVP\nWEB_URL='https://alpha.arislab.ai/'\nAPI_URL='https://alpha.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab.auth0.com'\nAUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nAUTH0_CLIENT_SECRET='ADW2KScxB32-WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\nAUTH0_SAML_IDP_CERT_FILE='arislab.pem'\nPACKAGE_URL='https://manage-uat.arislab.ai/getPlatformPackage?packageName=default'\nCALCULATE_STORE_PACKAGE_URL='https://manage-uat.arislab.ai/calculateStorePackage'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://alpha.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://alpha.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\n#LOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_DESTINATION='rapid7'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\nRAPID7_LOG_TOKEN='4ce91516-f85a-4b81-9168-3a6622c10c29'\n\n#LINE\nSERVER_NAME='ALPHA'\nENABLE_NOTIFICATION=true\n#LINE_NOTIFY_TOKEN='2830X9j2EqirUrFnxtHHd0Sli7edHKpvlhTVnAm3zuJ'\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\nMSG_HOST_LIST='http://msg-aws-sea01.convolab.ai,http://hooks.eu-gb.mybluemix.net,https://msg.convolab.ai'\nMSG_REFRESH_PATH='aris-uat'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz'\nGB_PAY_GATEWAY='https://api.gbprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n#GB_PAY_ADMIN_ARISLAB_ACCOUNT\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_TOKEN='AWN1mGuLXY7A3FD3OWL9MAVmKzY0oP8MCaO7C3iEK03QgvKwL+GlPn1Kkaoqqe/Ep8UFWzUKOa0feq+909lxm+MdpPYHrWh5XlC/NIe28/FMOtCkpG7g+WBRFB3sARN1nZUGOjiny0FHlA8AYM8PQ2s/Bydi3RzTlgJ9IphUs98CsN2e'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_PUBLIC_KEY='eG4ue6BHyLT6YxgtYISdIadzSu7G61Ns'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_SECRET_KEY='hRsWqup2Z0WkarOu45QJqUuQsaglCgDL'\nRECURRING_BACKGROUND_URL='https://manage-uat.arislab.ai/recurringResultUat'\nRECURRING_PERIOD='01'\n\n#WITHDRAW_MODE\nWITHDRAW_MODE=\"REALTIME\"\n#WITHDRAW_MODE=\"ON_TIME\"\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":960,"wires":[["938bfb9f.ef37b8"]]},{"id":"47a33f04.e65fd","type":"function","z":"370ebe73.42de32","name":"beta","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='arislab-platform'\n#nes='elastic:Ptox6rGdRdhr5gajOIZBXZQn@893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243'\nnes='elastic:FsOUZKwsn82xjCg4t1VJwA73@82910fa177334487bcc84bf9355a7aa3.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-prod'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://beta.arislab.ai/'\nAPI_URL='https://beta.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab.auth0.com'\nAUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nAUTH0_CLIENT_SECRET='ADW2KScxB32-WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\nAUTH0_SAML_IDP_CERT_FILE='arislab.pem'\nPACKAGE_URL='https://manage.arislab.ai/getPlatformPackage?packageName=default'\nCALCULATE_STORE_PACKAGE_URL='https://manage.arislab.ai/calculateStorePackage'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://beta.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://beta.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\n#LOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_DESTINATION='rapid7'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\nRAPID7_LOG_TOKEN='174097a7-7a98-415f-bae8-e3eb01902d76'\n\n#LINE\nSERVER_NAME='PRODUCTION'\nENABLE_NOTIFICATION=true\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\nMSG_HOST_LIST='http://msg-aws-sea01.convolab.ai,http://hooks.eu-gb.mybluemix.net,https://msg.convolab.ai'\nMSG_REFRESH_PATH='aris'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz'\nGB_PAY_GATEWAY='https://api.gbprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n#GB_PAY_ADMIN_ARISLAB_ACCOUNT\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_TOKEN='AWN1mGuLXY7A3FD3OWL9MAVmKzY0oP8MCaO7C3iEK03QgvKwL+GlPn1Kkaoqqe/Ep8UFWzUKOa0feq+909lxm+MdpPYHrWh5XlC/NIe28/FMOtCkpG7g+WBRFB3sARN1nZUGOjiny0FHlA8AYM8PQ2s/Bydi3RzTlgJ9IphUs98CsN2e'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_PUBLIC_KEY='eG4ue6BHyLT6YxgtYISdIadzSu7G61Ns'\nGB_PAY_ADMIN_ARISLAB_ACCOUNT_SECRET_KEY='hRsWqup2Z0WkarOu45QJqUuQsaglCgDL'\nRECURRING_BACKGROUND_URL='https://manage.arislab.ai/recurringResult'\nRECURRING_PERIOD='01'\n\n#WITHDRAW_MODE\nWITHDRAW_MODE=\"REALTIME\"\n#WITHDRAW_MODE=\"ON_TIME\"\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1000,"wires":[["938bfb9f.ef37b8"]]},{"id":"4b583744.504798","type":"inject","z":"e140dd9b.b381c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":100,"wires":[["77633e37.863c5"]]},{"id":"435d0ca0.08a854","type":"inject","z":"e140dd9b.b381c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":240,"wires":[["1dc322d0.dbf46d"]]},{"id":"59f3e0a4.93caf","type":"inject","z":"e140dd9b.b381c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":380,"wires":[["5fe1f26b.23d58c"]]},{"id":"f6945fd8.7ee8e","type":"comment","z":"e140dd9b.b381c","name":"DEV","info":"","x":390,"y":60,"wires":[]},{"id":"7564bfb4.9149c","type":"comment","z":"e140dd9b.b381c","name":"ALPHA","info":"","x":390,"y":200,"wires":[]},{"id":"61413dc6.01f754","type":"comment","z":"e140dd9b.b381c","name":"PROD","info":"","x":390,"y":340,"wires":[]},{"id":"d5cfa33.e58796","type":"cronplus","z":"e140dd9b.b381c","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 22:30","payload":"","type":"str","expression":"0 30 22 * * * *"}],"x":100,"y":240,"wires":[[]]},{"id":"77633e37.863c5","type":"change","z":"e140dd9b.b381c","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":140,"wires":[["db96a308.d3adf"]]},{"id":"1dc322d0.dbf46d","type":"change","z":"e140dd9b.b381c","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":280,"wires":[["db96a308.d3adf"]]},{"id":"5fe1f26b.23d58c","type":"change","z":"e140dd9b.b381c","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":420,"wires":[["db96a308.d3adf"]]},{"id":"ccbaa71d.63f2c8","type":"http request","z":"e140dd9b.b381c","name":"GET_ALL_UNVERIFIED_BANK_RECORDS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1050,"y":140,"wires":[["96dff35.6459b1","f468c063.8b8c8"]]},{"id":"96dff35.6459b1","type":"debug","z":"e140dd9b.b381c","name":"GET_ALL_UNVERIFIED_BANK_RECORDS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1200,"y":100,"wires":[]},{"id":"f468c063.8b8c8","type":"function","z":"e140dd9b.b381c","name":"SAVE_PAYLOAD_TO_MSG_OBJ","func":"msg.bankRecordList = msg.payload;\nmsg.bankRecordListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":200,"wires":[["a5357ab0.bb4138"]]},{"id":"a5357ab0.bb4138","type":"function","z":"e140dd9b.b381c","name":"PASSING_EACH_BANK_RECORD_TO_CHECK","func":"let bankRecordList = msg.bankRecordList;\nlet bankRecordListStatusCode = msg.bankRecordListStatusCode;\n\nif (bankRecordListStatusCode === 200) {\n    bankRecordList.forEach((bankRecord, index) => {\n        setTimeout(() => {\n            msg.bankRecord = bankRecord;\n            node.send(msg);\n        }, 2000 * index)\n    });\n}","outputs":1,"noerr":0,"x":1070,"y":240,"wires":[["befea9df.877868"]]},{"id":"befea9df.877868","type":"function","z":"e140dd9b.b381c","name":"CREATE_OBJECT_FOR_CHECK","func":"let bankRecord = msg.bankRecord;\nmsg.currentBankRecord = bankRecord;\n\nlet bankAccount = bankRecord.accountInfo.accountNumber.replace(/\\-/g, \"\");\nlet bankCode = bankRecord.accountInfo.bank.bankCode;\nlet amount = 1;\nlet timeline = 1;\n\nmsg.payload = {\n    bankAccount: bankAccount,\n    bankCode: bankCode,\n    amount: amount,\n    timeline: timeline\n}\n\nnode.error(`Process bank account. Name: ${bankRecord.accountInfo.accountName}, Number: ${bankRecord.accountInfo.accountNumber}`);\nnode.error(`Request of bank number: ${bankRecord.accountInfo.accountNumber} with body: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1440,"y":240,"wires":[["13d16211.21a7fe","4149aace.80aab4"]]},{"id":"13d16211.21a7fe","type":"function","z":"e140dd9b.b381c","name":"SET_HEADERS","func":"msg.headers = {}\nmsg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":280,"wires":[["34782133.7b00ae"]]},{"id":"34782133.7b00ae","type":"http request","z":"e140dd9b.b381c","name":"GB Pay for Prod","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":1620,"y":280,"wires":[["b2919f8f.8dcc5","b0f0002e.b8df3"]]},{"id":"4149aace.80aab4","type":"debug","z":"e140dd9b.b381c","name":"CREATE_OBJECT_FOR_CHECK_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1580,"y":200,"wires":[]},{"id":"b2919f8f.8dcc5","type":"debug","z":"e140dd9b.b381c","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1950,"y":220,"wires":[]},{"id":"6d788b3d.d416e4","type":"switch","z":"e140dd9b.b381c","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2000,"y":300,"wires":[["dd749405.5e6a18"],["dbfb817.5ed9b8"]]},{"id":"dd749405.5e6a18","type":"function","z":"e140dd9b.b381c","name":"VERIFIED_BANK_ACCOUNT","func":"let apiUrl = msg.apiUrl;\nlet gbpayResponse = msg.payload;\nlet currentBankRecord = msg.currentBankRecord;\nlet updatedBankRecord = currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\n\nnode.error(`Bank account ${currentBankRecord.accountInfo.accountNumber} is Verified. Update data to bank record: ${verifyID}.`);\n\nupdatedBankRecord.isVerified = true;\nupdatedBankRecord.verifiedAt = Date.now();\nupdatedBankRecord.verifyInfo.referenceNo = gbpayResponse.referenceNo;\n\nlet url = `${apiUrl}/bankRecord/verifyID/${verifyID}/update`;\n\nmsg.url = url;\nmsg.payload = updatedBankRecord;\n\nreturn msg;","outputs":1,"noerr":0,"x":2270,"y":280,"wires":[["278e7f2f.dce1c","9b590de8.a9fe2"]]},{"id":"278e7f2f.dce1c","type":"http request","z":"e140dd9b.b381c","name":"UPDATE_BANK_RECORD","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2260,"y":320,"wires":[["4ace1961.1e5058","b7101bb4.e98678"]]},{"id":"4ace1961.1e5058","type":"function","z":"e140dd9b.b381c","name":"PREPARE_LOAD_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet currentBankRecord = msg.currentBankRecord;\nlet storeID = currentBankRecord.storeID;\n\nnode.error(`Get payment info from storeID: ${storeID}.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}`;\n\nmsg.url = url;\ndelete msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":2290,"y":360,"wires":[["b0293e9c.3e5bd"]]},{"id":"b7101bb4.e98678","type":"debug","z":"e140dd9b.b381c","name":"RESULT_UPDATE_BANK_RECORD_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2630,"y":320,"wires":[]},{"id":"b0293e9c.3e5bd","type":"http request","z":"e140dd9b.b381c","name":"GET_PAYMENT_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2240,"y":400,"wires":[["b9cbaf7e.2b481","f32ea5f5.a532e8"]]},{"id":"b9cbaf7e.2b481","type":"debug","z":"e140dd9b.b381c","name":"RESULT_GET_PAYMENT_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2620,"y":400,"wires":[]},{"id":"f32ea5f5.a532e8","type":"function","z":"e140dd9b.b381c","name":"CHECK_PAYMENT_INFO","func":"let storeInfo = msg.payload;\nlet paymentInfo = storeInfo.storeInfo.paymentInfo;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyBankAccountInfo = currentBankRecord.accountInfo;\n\n\nif( \n    (verifyBankAccountInfo.accountNumber === paymentInfo.accountNumber) &&\n    (verifyBankAccountInfo.bank.bankCode === paymentInfo.bank.bankCode)\n) {\n    msg.storeInfo = storeInfo;\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":2260,"y":460,"wires":[["a5c7f3de.9ff04"],["61814b84.89fd34"]]},{"id":"a5c7f3de.9ff04","type":"function","z":"e140dd9b.b381c","name":"PREPARE_UPDATE_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet updateData = msg.storeInfo;\nlet storeID = updateData.storeID;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nlet verifyInfo = {\n    isVerified: true,\n    verifyID: verifyID\n};\n\nupdateData.storeInfo.paymentInfo.verifyInfo = verifyInfo;\n\nnode.error(`Bank account ${displayAccount} match with payment info of storeID: ${storeID}. Update verify info.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}/update`;\n\nmsg.url = url;\nmsg.payload = updateData;\n\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":440,"wires":[["7830325e.3a6e1c","174ba396.60ce3c"]]},{"id":"7830325e.3a6e1c","type":"http request","z":"e140dd9b.b381c","name":"UPDATE_PAYMENT_INFO","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2640,"y":480,"wires":[["9dd0fa23.e653e8"]]},{"id":"174ba396.60ce3c","type":"debug","z":"e140dd9b.b381c","name":"PREPARE_UPDATE_PAYMENT_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3080,"y":440,"wires":[]},{"id":"9b590de8.a9fe2","type":"debug","z":"e140dd9b.b381c","name":"VERIFIED_BANK_ACCOUNT_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2610,"y":280,"wires":[]},{"id":"9dd0fa23.e653e8","type":"debug","z":"e140dd9b.b381c","name":"RESULT_UPDATE_PAYMENT_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3070,"y":480,"wires":[]},{"id":"dbfb817.5ed9b8","type":"function","z":"e140dd9b.b381c","name":"NOT_VERIFY_BANK_ACCOUNT","func":"// node.error(msg)\nlet resultCode = msg.payload.resultCode;\nlet errorStatus = '';\n\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nswitch( resultCode ) {\n    case \"01\":\n        errorStatus = \"Balance is not enough\";\n        break;\n    case \"02\":\n        errorStatus = \"Bank account not found\";\n        break;\n    case \"90\":\n        errorStatus = \"System error\";\n        break;\n    default:\n        errorStatus = \"Unknown error\";\n}\n\nnode.error(`Can't check status of bank account ${displayAccount} , because \"${errorStatus}\". Skipping...`);\n","outputs":1,"noerr":0,"x":1920,"y":360,"wires":[[]]},{"id":"565ee38d.0d742c","type":"function","z":"e140dd9b.b381c","name":"TEST_POST_TO_GB_PAY","func":"msg.headers = {}\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n\n// msg.payload = {\n//     bankAccount: \"0018906546\",\n//     bankCode: \"004\",\n//     amount: 1,\n//     timeline: 1\n// }\n\n\nmsg.payload = {\n    bankAccount: \"0243687292\",\n    bankCode: \"025\",\n    amount: 1,\n    timeline: 1\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":720,"wires":[["54da320f.3a0b3c","216e10f5.fd5f"]]},{"id":"216e10f5.fd5f","type":"http request","z":"e140dd9b.b381c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.globalprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":950,"y":720,"wires":[["f4ae96e5.f1c6c8"]]},{"id":"a733ffa0.5f3a9","type":"inject","z":"e140dd9b.b381c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":500,"y":720,"wires":[["565ee38d.0d742c"]]},{"id":"f4ae96e5.f1c6c8","type":"debug","z":"e140dd9b.b381c","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1210,"y":720,"wires":[]},{"id":"54da320f.3a0b3c","type":"debug","z":"e140dd9b.b381c","name":"POST_DATA_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":780,"wires":[]},{"id":"61814b84.89fd34","type":"function","z":"e140dd9b.b381c","name":"NOT_MATCH_WITH_PAYMENT_INFO","func":"// node.error(msg)\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nnode.error(`Bank account ${displayAccount} not match with payment info. Skipping...`);\n","outputs":1,"noerr":0,"x":2300,"y":520,"wires":[[]]},{"id":"f820499a.fe34f8","type":"http request","z":"e140dd9b.b381c","name":"GB Pay for Test","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.globalprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":1620,"y":320,"wires":[["b2919f8f.8dcc5","b0f0002e.b8df3"]]},{"id":"7f59efce.71e88","type":"inject","z":"e140dd9b.b381c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":840,"wires":[["c9c56e9d.af516"]]},{"id":"c9c56e9d.af516","type":"function","z":"e140dd9b.b381c","name":"debug context.global","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":880,"wires":[["f20e9689.328aa8"]]},{"id":"f20e9689.328aa8","type":"debug","z":"e140dd9b.b381c","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":540,"y":920,"wires":[]},{"id":"f623439b.db296","type":"inject","z":"e140dd9b.b381c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":840,"wires":[["ea2e1bdc.1d6ba8"]]},{"id":"ea2e1bdc.1d6ba8","type":"function","z":"e140dd9b.b381c","name":"reset context.global","func":"delete context.global['currentData'];\ndelete context.global['resultCheck'];\n\nmsg.payload = context.global;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":880,"wires":[["bb4da14e.c6a0c"]]},{"id":"bb4da14e.c6a0c","type":"debug","z":"e140dd9b.b381c","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":240,"y":920,"wires":[]},{"id":"18b5de94.93e351","type":"function","z":"eb9ff6d6.6b53f8","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":2290,"y":380,"wires":[["1507c0c8.5ffd4f","d1bf7d63.25d0f"],["182d7f5e.63b221"]]},{"id":"6e08a79c.730ac8","type":"http request","z":"eb9ff6d6.6b53f8","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":600,"y":940,"wires":[["f03ae5ef.62fde8"]]},{"id":"1507c0c8.5ffd4f","type":"debug","z":"eb9ff6d6.6b53f8","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2770,"y":340,"wires":[]},{"id":"4c239e6f.0d65c","type":"http in","z":"370ebe73.42de32","name":"","url":"/createPlatformEnvFile","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1200,"wires":[["b57dcdd8.fe021"]]},{"id":"b57dcdd8.fe021","type":"switch","z":"370ebe73.42de32","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":1200,"wires":[["8a8060e8.321f4"],["2c30c533.dce13a"]]},{"id":"8a8060e8.321f4","type":"switch","z":"370ebe73.42de32","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":430,"y":1320,"wires":[["6a9b9f06.9a47d"],["23d3bd11.a1fac2"],["fc36096a.ffe998"]]},{"id":"3f347602.54554a","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":850,"y":1240,"wires":[]},{"id":"2c30c533.dce13a","type":"change","z":"370ebe73.42de32","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":880,"y":1200,"wires":[["3f347602.54554a"]]},{"id":"95bb010d.e9bc6","type":"file in","z":"370ebe73.42de32","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":950,"y":1400,"wires":[["4793bdfc.e8b684"]]},{"id":"4793bdfc.e8b684","type":"change","z":"370ebe73.42de32","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":1440,"wires":[["7c01f148.728e5","23c0dff9.2647b"]]},{"id":"258641f0.37a1ee","type":"file","z":"370ebe73.42de32","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":950,"y":1320,"wires":[["c12a9090.ed35d"]]},{"id":"c12a9090.ed35d","type":"function","z":"370ebe73.42de32","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1360,"wires":[["95bb010d.e9bc6"]]},{"id":"6a9b9f06.9a47d","type":"function","z":"370ebe73.42de32","name":"dev","func":"let env = msg.env\n\nmsg.payload = `\n\nREACT_APP_PLATFORM_FACEBOOK_APP_ID='502170539988549'\nREACT_APP_FACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\nREACT_APP_DEFAULT_GPPAY_TOKEN=\"yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT\"\nREACT_APP_WEB_URL='https://dev.arislab.ai/'\nREACT_APP_API_URL='https://dev.arislab.ai/api/'\nREACT_APP_MEDIA_URL='https://dev.arislab.ai/'\nREACT_APP_API_HOST='localhost'\nREACT_APP_API_PORT=1780\nREACT_APP_PLATFORM_HOST='localhost'\nREACT_APP_PLATFORM_PORT=3000\nREACT_APP_MEDIA_HOST='localhost'\nREACT_APP_MEDIA_PORT=8000\nREACT_APP_MEDIA_WEB_HOST='localhost'\nREACT_APP_MEDIA_WEB_PORT=4080\nREACT_APP_AUTH0_DOMAIN='arislab-dev.auth0.com'\nREACT_APP_AUTH0_CLIENT_ID='Jqr8WyfSYqgiw1NgRlQ2f0UJLi8aWOgb'\nREACT_APP_CONTACT_TEL_NUMBER='0612866328'\nREACT_APP_CONTACT_TEL_NUMBER_DISPLAY='061-286-6328'\nREACT_APP_CONTACT_EMAIL='contactus@arislab.ai'\nREACT_APP_FACEBOOK_URL='https://www.facebook.com/arislablive/'\nREACT_APP_LINE_URL='http://nav.cx/6oXLR5S'\nREACT_APP_INSTAGRAM_URL=''\nREACT_APP_MEDIUM_URL=''\nREACT_APP_CREATED_YEAR=2019\nREACT_APP_ANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nREACT_APP_IOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\nREACT_APP_GTM_ID='GTM-KQL8VMV'\nREACT_APP_TO_GBPAY_EMAIL='admin@arislab.ai'\nREACT_APP_MANAGE_URL='https://manage-uat.arislab.ai'\n\n#GB_PAY\nREACT_APP_GB_PAY_FEE=20\nREACT_APP_GB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/platform_env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1280,"wires":[["258641f0.37a1ee"]]},{"id":"23d3bd11.a1fac2","type":"function","z":"370ebe73.42de32","name":"alpha","func":"let env = msg.env\n\nmsg.payload = `\n\nREACT_APP_PLATFORM_FACEBOOK_APP_ID='502170539988549'\nREACT_APP_FACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\nREACT_APP_DEFAULT_GPPAY_TOKEN=\"yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT\"\nREACT_APP_WEB_URL='https://alpha.arislab.ai/'\nREACT_APP_API_URL='https://alpha.arislab.ai/api/'\nREACT_APP_MEDIA_URL='https://alpha.arislab.ai/'\nREACT_APP_API_HOST='localhost'\nREACT_APP_API_PORT=1780\nREACT_APP_PLATFORM_HOST='localhost'\nREACT_APP_PLATFORM_PORT=3000\nREACT_APP_MEDIA_HOST='localhost'\nREACT_APP_MEDIA_PORT=8000\nREACT_APP_MEDIA_WEB_HOST='localhost'\nREACT_APP_MEDIA_WEB_PORT=4080\nREACT_APP_AUTH0_DOMAIN='arislab.auth0.com'\nREACT_APP_AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nREACT_APP_CONTACT_TEL_NUMBER='0612866328'\nREACT_APP_CONTACT_TEL_NUMBER_DISPLAY='061-286-6328'\nREACT_APP_CONTACT_EMAIL='contactus@arislab.ai'\nREACT_APP_FACEBOOK_URL='https://www.facebook.com/arislablive/'\nREACT_APP_LINE_URL='http://nav.cx/6oXLR5S'\nREACT_APP_INSTAGRAM_URL=''\nREACT_APP_MEDIUM_URL=''\nREACT_APP_CREATED_YEAR=2019\nREACT_APP_ANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nREACT_APP_IOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\nREACT_APP_GTM_ID='GTM-KQL8VMV'\nREACT_APP_TO_GBPAY_EMAIL='it@gbprimepay.com'\nREACT_APP_MANAGE_URL='https://manage-uat.arislab.ai'\n\n#GB_PAY\nREACT_APP_GB_PAY_FEE=20\nREACT_APP_GB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/platform_env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1320,"wires":[["258641f0.37a1ee"]]},{"id":"fc36096a.ffe998","type":"function","z":"370ebe73.42de32","name":"beta","func":"let env = msg.env\n\nmsg.payload = `\n\nREACT_APP_PLATFORM_FACEBOOK_APP_ID='502170539988549'\nREACT_APP_FACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\nREACT_APP_DEFAULT_GPPAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nREACT_APP_WEB_URL='https://beta.arislab.ai/'\nREACT_APP_API_URL='https://beta.arislab.ai/api/'\nREACT_APP_MEDIA_URL='https://beta.arislab.ai/'\nREACT_APP_API_HOST='localhost'\nREACT_APP_API_PORT=1780\nREACT_APP_PLATFORM_HOST='localhost'\nREACT_APP_PLATFORM_PORT=3000\nREACT_APP_MEDIA_HOST='localhost'\nREACT_APP_MEDIA_PORT=8000\nREACT_APP_MEDIA_WEB_HOST='localhost'\nREACT_APP_MEDIA_WEB_PORT=4080\nREACT_APP_AUTH0_DOMAIN='arislab.auth0.com'\nREACT_APP_AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nREACT_APP_CONTACT_TEL_NUMBER='0612866328'\nREACT_APP_CONTACT_TEL_NUMBER_DISPLAY='061-286-6328'\nREACT_APP_CONTACT_EMAIL='contactus@arislab.ai'\nREACT_APP_FACEBOOK_URL='https://www.facebook.com/arislablive/'\nREACT_APP_INSTAGRAM_URL=''\nREACT_APP_MEDIUM_URL=''\nREACT_APP_CREATED_YEAR=2019\nREACT_APP_ANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nREACT_APP_IOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\nREACT_APP_GTM_ID='GTM-P7JB4DT'\nREACT_APP_TO_GBPAY_EMAIL='it@gbprimepay.com'\nREACT_APP_MANAGE_URL='https://manage.arislab.ai'\n\n#GB_PAY\nREACT_APP_GB_PAY_FEE=20\nREACT_APP_GB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/platform_env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1360,"wires":[["258641f0.37a1ee"]]},{"id":"23c0dff9.2647b","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1190,"y":1520,"wires":[]},{"id":"7c01f148.728e5","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":1150,"y":1440,"wires":[]},{"id":"db96a308.d3adf","type":"function","z":"e140dd9b.b381c","name":"SET_TIME_INTERVAL","func":"var intervalDay = 5;\nvar startTime = Date.now() - (24*60*60*intervalDay*1000);\nvar endTime = Date.now();\n\nmsg.url+= `&start=${startTime}&stop=${endTime}`;\nnode.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":140,"wires":[["ccbaa71d.63f2c8"]]},{"id":"3da49335.29806c","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_TIME_INTERVAL","func":"node.error('Running reconcile...');\n\nvar intervalDay = 1;\nvar startTime = Date.now() - (24*60*60*1000*intervalDay);\nvar endTime = Date.now();\n\nmsg.url+= `&startDate=${startTime}&endDate=${endTime}`;\n\n//node.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":754,"y":120,"wires":[["981c7f83.8d456"]]},{"id":"774a2b23.7985e4","type":"http in","z":"eb9ff6d6.6b53f8","name":"","url":"/test","method":"post","upload":false,"swaggerDoc":"","x":140,"y":780,"wires":[["d9250a5d.bca968","6968b262.66e9fc"]]},{"id":"80a5bd95.159c1","type":"http response","z":"eb9ff6d6.6b53f8","name":"","statusCode":"","headers":{},"x":540,"y":780,"wires":[]},{"id":"d9250a5d.bca968","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.payload = {\n    \"resultCode\": \"00\"\n};\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":760,"wires":[["80a5bd95.159c1"]]},{"id":"6968b262.66e9fc","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":390,"y":820,"wires":[]},{"id":"baacf816.078328","type":"http in","z":"d3a831f5.f8fec","name":"","url":"/_calculateGbpayPaymentFee","method":"post","upload":false,"swaggerDoc":"","x":180,"y":140,"wires":[["a8278459.ac1428","24efab66.ad9fe4"]]},{"id":"3e2123dc.8bdf9c","type":"http response","z":"d3a831f5.f8fec","name":"","statusCode":"","headers":{},"x":450,"y":260,"wires":[]},{"id":"a8278459.ac1428","type":"function","z":"d3a831f5.f8fec","name":"SET_FEE_PERCENTAGE","func":"let payloadData = msg.payload;\nlet nuser = payloadData.nuser;\nlet paymentInfo = payloadData.paymentInfo;\n\nvar feePercentage = {\n    \"DEV\": {\n        // \"CREDIT_CARD\": 3.103,\n        // \"QR_CODE\": 0.642\n        \"CREDIT_CARD\": 2.9,\n        \"QR_CODE\": 1\n    },\n    \"ALPHA\": {\n        // \"CREDIT_CARD\": 3.103,\n        // \"QR_CODE\": 0.642\n        \"CREDIT_CARD\": 2.9,\n        \"QR_CODE\": 1\n    },\n    \"PROD\": {\n        // \"CREDIT_CARD\": 3.103,\n        // \"QR_CODE\": 0.642\n        \"CREDIT_CARD\": 2.9,\n        \"QR_CODE\": 1\n    },\n};\n\nlet env = \"\";\nswitch(nuser) {\n    case \"arislab-dev\":\n        env = \"DEV\";\n        break;\n    case \"arislab-uat\":\n        env = \"ALPHA\";\n        break;\n    default:\n        env = \"PROD\";\n}\n\nmsg.payload = {\n    \"feePercentageData\": feePercentage[env],\n    \"paymentInfo\": paymentInfo\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":140,"wires":[["ab7a924f.ba7ba","3ce87cd7.0766c4"]]},{"id":"24efab66.ad9fe4","type":"debug","z":"d3a831f5.f8fec","name":"REQUEST_POST_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":490,"y":60,"wires":[]},{"id":"ab7a924f.ba7ba","type":"debug","z":"d3a831f5.f8fec","name":"SET_FEE_PERCENTAGE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":860,"y":140,"wires":[]},{"id":"fcb0e2e6.4e877","type":"function","z":"d3a831f5.f8fec","name":"CALCULATE_PAYMENT_FEE","func":"let payloadData = msg.payload;\nlet feePercentage = payloadData.feePercentage;\nlet paymentMethod = payloadData.paymentMethod;\nlet amount = Number(payloadData.amount);\n\nlet fee = Number( parseFloat((amount * feePercentage) / 100).toFixed(2) );\nlet totalAmount = amount - fee;\n\nmsg.payload = {\n    \"paymentMethod\": paymentMethod,\n    \"amount\": amount,\n    \"fee\": fee,\n    \"totalAmount\": totalAmount\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":220,"wires":[["1fbe0515.d23dab","3e2123dc.8bdf9c"]]},{"id":"3ce87cd7.0766c4","type":"function","z":"d3a831f5.f8fec","name":"CHECK_PAYMENT_METHOD","func":"let payloadData = msg.payload;\nlet feePercentageData = payloadData.feePercentageData;\nlet paymentInfo = payloadData.paymentInfo;\n\nlet paymentMethod = \"\";\nif( paymentInfo.hasOwnProperty('cardNo') && paymentInfo.cardNo.length > 0 ) {\n    paymentMethod = \"CREDIT_CARD\";\n} else {\n    paymentMethod = \"QR_CODE\";\n}\n\nmsg.payload = {\n    \"feePercentage\": feePercentageData[paymentMethod],\n    \"paymentMethod\": paymentMethod,\n    \"amount\": paymentInfo.amount\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":180,"wires":[["a92eced3.4332b","fcb0e2e6.4e877"]]},{"id":"a92eced3.4332b","type":"debug","z":"d3a831f5.f8fec","name":"CHECK_PAYMENT_METHOD_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":870,"y":180,"wires":[]},{"id":"1fbe0515.d23dab","type":"debug","z":"d3a831f5.f8fec","name":"CALCULATE_PAYMENT_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":870,"y":220,"wires":[]},{"id":"182d7f5e.63b221","type":"function","z":"eb9ff6d6.6b53f8","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nnode.error(`Recipient type of this order (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`)","outputs":1,"noerr":0,"x":2745,"y":580,"wires":[[]]},{"id":"f03ae5ef.62fde8","type":"debug","z":"eb9ff6d6.6b53f8","name":"INSERT_FUNDS_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":960,"y":940,"wires":[]},{"id":"90fe60f2.421e8","type":"http request","z":"eb9ff6d6.6b53f8","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2705,"y":500,"wires":[["bf45ef07.654"]]},{"id":"d1bf7d63.25d0f","type":"function","z":"eb9ff6d6.6b53f8","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2725,"y":380,"wires":[["c936d511.269948","cdae1faa.81c93"]]},{"id":"c936d511.269948","type":"http request","z":"eb9ff6d6.6b53f8","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2685,"y":420,"wires":[["f5faa9e2.cec798","397f7203.1e313e"]]},{"id":"cdae1faa.81c93","type":"debug","z":"eb9ff6d6.6b53f8","name":"PREPARE_CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3165,"y":380,"wires":[]},{"id":"f5faa9e2.cec798","type":"debug","z":"eb9ff6d6.6b53f8","name":"CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3135,"y":420,"wires":[]},{"id":"397f7203.1e313e","type":"function","z":"eb9ff6d6.6b53f8","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2735,"y":460,"wires":[["5a8c193.554fae8","90fe60f2.421e8"]]},{"id":"5a8c193.554fae8","type":"debug","z":"eb9ff6d6.6b53f8","name":"PREPARE_INSERT_FUND_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3185,"y":460,"wires":[]},{"id":"bf45ef07.654","type":"debug","z":"eb9ff6d6.6b53f8","name":"INSERT_FUNDS_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3145,"y":500,"wires":[]},{"id":"4fa683eb.4839bc","type":"function","z":"eb9ff6d6.6b53f8","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    let apiUrl = msg.apiUrl;\n    let url = `${apiUrl}/fundsTransaction/new`;\n    \n    let storeID = currentOrder['storeID'];\n    let amount = currentOrder['summary']['grandTotal'];\n    let orderID = currentOrder['orderID'];\n    let customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\n    msg.url = url;\n    msg.payload = {\n        \"storeID\": storeID,\n    \t\"amount\": amount,\n    \t\"actualAmount\": amount,\n    \t\"fee\": 0,\n    \t\"type\": \"DEPOSIT\",\n    \t\"orderInfo\": {\n        \t\"orderID\": orderID,\n            \"customerName\": customerName\n    \t},\n    \t\"createdAt\": Date.now(),\n    \t\"isDeleted\": false,\n    \t\"deletedAt\": 0\n    }\n\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":250,"y":940,"wires":[[],[]]},{"id":"1e3855de.984a4a","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":2390,"y":120,"wires":[]},{"id":"33df3ac5.4fa936","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1690,"y":180,"wires":[]},{"id":"9cc6249.4c6aed8","type":"function","z":"4855adbb.ec1254","name":"INIT_PAYLOAD","func":"msg.headers = {\n    \"Content-type\" : \"multipart/form-data\"\n}\n\nlet reqPayload = msg.payload;\nmsg.payload = {\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo'],\n    \"amount\": reqPayload['amount']\n}\n\n// msg.url = \"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode\";\n// msg.method = \"POST\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1780,"y":60,"wires":[["7b84cb0b.5fbe54","7bbeafe4.e135f"]]},{"id":"f725779a.753eb8","type":"www-request-multipart","z":"4855adbb.ec1254","name":"","method":"POST","ret":"obj","url":"","follow-redirects":false,"tls":"","x":2170,"y":60,"wires":[["1e3855de.984a4a","f2dd1ad0.627458"]]},{"id":"7b84cb0b.5fbe54","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1790,"y":120,"wires":[]},{"id":"404c079a.9bae78","type":"httpInMultipart","z":"4855adbb.ec1254","name":"","url":"/tHandleVerifyQRCode","method":"post","fields":"[{\"name\": \"referenceNo\"}, {\"name\": \"gbpReferenceNo\"}, {\"name\": \"amount\"}]","swaggerDoc":"","x":1540,"y":60,"wires":[["9cc6249.4c6aed8","33df3ac5.4fa936"]]},{"id":"75ff549c.f90c9c","type":"change","z":"4855adbb.ec1254","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1980,"y":100,"wires":[["f725779a.753eb8"]]},{"id":"ef08abb5.88bc38","type":"change","z":"4855adbb.ec1254","name":"BETA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1970,"y":140,"wires":[["f725779a.753eb8"]]},{"id":"f2dd1ad0.627458","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2390,"y":60,"wires":[]},{"id":"6693faf7.25f684","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":2250,"y":180,"wires":[]},{"id":"cc7f7eb0.9729d","type":"function","z":"4855adbb.ec1254","name":"ALWAYS_APPROVE","func":"let reqPayload = msg.payload;\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\"\n}\n\nmsg.payload = {\n    \"resultCode\": \"00\",\n    \"referenceNo\": reqPayload['referenceNo'],\n    \"gbpReferenceNo\": reqPayload['gbpReferenceNo']\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2020,"y":180,"wires":[["6693faf7.25f684","45efefde.c08dc"]]},{"id":"45efefde.c08dc","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2210,"y":240,"wires":[]},{"id":"7bbeafe4.e135f","type":"change","z":"4855adbb.ec1254","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/gbpay/handleVerifyQRCode","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1970,"y":60,"wires":[["f725779a.753eb8"]]},{"id":"82164d79.0c0e9","type":"template","z":"c7155c63.2294","name":"","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\">\n    <title></title>\n    <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\">\n</head>\n\n<body>\n    <div class=\"container\">\n        <h3>Reconcile</h3>\n        <div class=\"row\">\n            <div class=\"col-md-3\">\n                <div class=\"form-group\">\n                    <label for=\"webform_gbpayToken\">GBPay Token</label>\n                    <input type=\"text\" class=\"form-control\" id=\"webform_gbpayToken\" placeholder=\"GBPay Token\"\n                        autocomplete=\"off\" />\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"webform_gbpaySecretKey\">GBPay Secret Key</label>\n                    <input type=\"text\" class=\"form-control\" id=\"webform_gbpaySecretKey\" placeholder=\"GBPay Secret Key\" />\n                </div>\n                <button type=\"submit\" class=\"btn btn-primary btn-block\" id=\"btnSearchStore\">Search</button>\n            </div>\n    \n            <div class=\"col-md-9\">\n                <div class=\"form-group\" id=\"storeListSection\">\n                    <label for=\"storeList\">Select store</label>\n                    <select class=\"form-control\" id=\"storeListDropdown\" onchange=\"handleDropdownChange(this)\">\n                        <option hidden>-- Choose Store --</option>\n                    </select>\n                </div>\n                \n                <div class=\"form-group\" id=\"processingSection\">\n                    <button type=\"submit\" class=\"btn btn-primary btn-block\" id=\"btnSubmitWebForm\">Submit</button>\n    \n                    <div class=\"alert alert-warning mt-3\" id=\"processingMsg\" role=\"alert\">\n                        กรุณารอสักครู่ ระบบกำลังทำการประมวลผล\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js\"></script>\n    <script>\n        let reconcilePayload = {};\n        const btnSubmit = document.querySelector('#btnSubmitWebForm');\n        const btnSearch = document.querySelector('#btnSearchStore');\n        const processingMsg = document.querySelector('#processingMsg');\n        const storeListSection = document.querySelector('#storeListSection');\n        const storeListDropdown = document.getElementById('storeListDropdown');\n\n        const handleDropdownChange = (e) => {\n            console.log(`[handleDropdownChange] e`, e.value)\n            let dropdownSelectedValue = e.value;\n            reconcilePayload['storeID'] = dropdownSelectedValue;\n            btnSubmit.style.display = \"block\";\n        }\n\n        storeListSection.style.display = \"none\";\n        storeListDropdown.style.display = \"none\";\n        processingMsg.style.display = \"none\";\n        btnSubmit.style.display = \"none\";\n\n        btnSearch.addEventListener('click', function (e) {\n            e.preventDefault();\n\n            btnSearch.textContent = \"Searching...\"\n            btnSearch.setAttribute('disabled', true);\n\n            const token = document.querySelector('#webform_gbpayToken').value;\n\n            axios.post('/searchStoreAPI', {\n                token: token\n            })\n                .then(function (response) {\n                    console.log(response);\n                    reconcilePayload['token'] = token;\n                    response['data'].forEach((item, index) => {\n                        let option = document.createElement(\"option\");\n                        option.text = `${item['storeID']} ${item['storeInfo']['businessProfile']['accountDetails']['name']}`;\n                        option.value = item['storeID'];\n                        storeListDropdown.appendChild(option);\n\n                        if (index === response['data'].length - 1) {\n                            storeListSection.style.display = \"block\";\n                            storeListDropdown.style.display = \"block\";\n                            btnSearch.textContent = \"Search\"\n                            btnSearch.removeAttribute('disabled');\n                        }\n                    });\n                })\n                .catch(function (error) {\n                    console.log(error);\n                });\n        });\n\n        btnSubmit.addEventListener('click', function (e) {\n            e.preventDefault();\n\n            btnSubmit.textContent = \"Processing...\"\n            btnSubmit.setAttribute('disabled', true);\n\n            processingMsg.style.display = \"block\";\n\n            const token = document.querySelector('#webform_gbpayToken').value;\n            const secret_key = document.querySelector('#webform_gbpaySecretKey').value;\n\n            reconcilePayload['secret_key'] = secret_key;\n\n            axios.post('/reconcileAPI', {\n                token: reconcilePayload['token'],\n                secret_key: reconcilePayload['secret_key'],\n                storeID: reconcilePayload['storeID']\n            })\n                .then(function (response) {\n                    console.log(response);\n                })\n                .catch(function (error) {\n                    console.log(error);\n                });\n        });\n    </script>\n</body>\n\n</html> ","output":"str","x":400,"y":120,"wires":[["629663d5.96880c"]]},{"id":"afce5e7.9dfa2a","type":"http in","z":"c7155c63.2294","name":"","url":"/reconcile","method":"get","upload":false,"swaggerDoc":"","x":200,"y":120,"wires":[["82164d79.0c0e9"]]},{"id":"629663d5.96880c","type":"http response","z":"c7155c63.2294","name":"","statusCode":"","headers":{},"x":570,"y":120,"wires":[]},{"id":"f68f4d3d.d56ef","type":"comment","z":"c7155c63.2294","name":"Reconcile UI","info":"","x":190,"y":80,"wires":[]},{"id":"20078b69.1dd7d4","type":"comment","z":"c7155c63.2294","name":"Reconcile API","info":"","x":190,"y":180,"wires":[]},{"id":"91ce0a8e.fb8118","type":"http in","z":"c7155c63.2294","name":"","url":"/reconcileAPI","method":"post","upload":false,"swaggerDoc":"","x":210,"y":420,"wires":[["c22c674.d7e9598","b3712f04.f1865"]]},{"id":"5c5f99db.d02258","type":"http response","z":"c7155c63.2294","name":"","statusCode":"","headers":{},"x":910,"y":440,"wires":[]},{"id":"698f4348.d3de3c","type":"change","z":"c7155c63.2294","name":"","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"{\"message\":\"Missing required fields\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":440,"wires":[["5c5f99db.d02258"]]},{"id":"c22c674.d7e9598","type":"function","z":"c7155c63.2294","name":"CHECK_REQUIRED_FIELDS","func":"if (\n    msg.payload.hasOwnProperty('token') &&\n    msg.payload.hasOwnProperty('secret_key') &&\n    msg.payload.hasOwnProperty('storeID')\n) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":480,"y":420,"wires":[["daa656eb.804048"],["698f4348.d3de3c"]]},{"id":"5c91e473.1c154c","type":"link out","z":"c7155c63.2294","name":"RECONCILE_API_DEV_OUT","links":["b7a16e0b.56bd7","f41b62cd.8bd57"],"x":875,"y":400,"wires":[]},{"id":"10f6b081.7a7edf","type":"http response","z":"c7155c63.2294","name":"","statusCode":"","headers":{},"x":950,"y":120,"wires":[]},{"id":"21d5fcdc.434634","type":"function","z":"c7155c63.2294","name":"","func":"let payload = msg.payload;\n\nmsg.secret_key = payload['secret_key'];\nmsg.token = payload['token'];\nmsg.statusCode = 200;\nmsg.payload = {\n    secret_key: msg.secret_key,\n    token: msg.token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":120,"wires":[["10f6b081.7a7edf"]]},{"id":"b3712f04.f1865","type":"debug","z":"c7155c63.2294","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":400,"y":380,"wires":[]},{"id":"f41b62cd.8bd57","type":"link in","z":"c7155c63.2294","name":"RECONCILE_API_DEV_IN","links":["82338e5f.c3527","d6774712.37b528","ce5b8ce6.a026f","5c91e473.1c154c"],"x":55,"y":620,"wires":[["4a9cdb5d.47c9b4"]]},{"id":"a34a51c8.9d34c","type":"link in","z":"c7155c63.2294","name":"RECONCILE_API_UAT_IN","links":["5fabbb08.41bb24","8b509f0d.97d59"],"x":55,"y":760,"wires":[[]]},{"id":"578c7402.634c8c","type":"link in","z":"c7155c63.2294","name":"RECONCILE_API_PROD_IN","links":["f3d17c5c.9e7e3","bcb4e3f3.c2f09"],"x":55,"y":900,"wires":[[]]},{"id":"b32ee00.de3192","type":"inject","z":"c7155c63.2294","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":580,"wires":[["4a9cdb5d.47c9b4"]]},{"id":"483adc29.c09c34","type":"inject","z":"c7155c63.2294","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":720,"wires":[["5cbffc31.af4184"]]},{"id":"58060236.c41edc","type":"inject","z":"c7155c63.2294","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":860,"wires":[["439c7aac.3b1104"]]},{"id":"35266145.74697e","type":"comment","z":"c7155c63.2294","name":"DEV","info":"","x":170,"y":540,"wires":[]},{"id":"ea709fd9.b1169","type":"comment","z":"c7155c63.2294","name":"ALPHA","info":"","x":170,"y":680,"wires":[]},{"id":"ea505a4.d8844a8","type":"comment","z":"c7155c63.2294","name":"PROD","info":"","x":170,"y":820,"wires":[]},{"id":"4a9cdb5d.47c9b4","type":"change","z":"c7155c63.2294","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":170,"y":620,"wires":[["3412b41e.30185c"]]},{"id":"5cbffc31.af4184","type":"change","z":"c7155c63.2294","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":180,"y":760,"wires":[["3412b41e.30185c"]]},{"id":"439c7aac.3b1104","type":"change","z":"c7155c63.2294","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":170,"y":900,"wires":[["3412b41e.30185c"]]},{"id":"5227969a.b61768","type":"http request","z":"c7155c63.2294","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":520,"y":740,"wires":[["a53ca169.694e8","3fa7d792.398fa8"]]},{"id":"a53ca169.694e8","type":"debug","z":"c7155c63.2294","name":"GET_ALL_ORDERS_WITH_PENDING_STATUS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":740,"wires":[]},{"id":"3fa7d792.398fa8","type":"function","z":"c7155c63.2294","name":"SAVE_TO_MSG_OBJ","func":"msg.orderList = msg.payload;\nmsg.orderListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":780,"wires":[["7521b89f.e536e8"]]},{"id":"553571a0.075ed","type":"http request","z":"c7155c63.2294","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_status_txn","tls":"","proxy":"","authType":"","x":1050,"y":880,"wires":[["6fb9f80a.e71cb8","50c654f9.18e76c"]]},{"id":"6fb9f80a.e71cb8","type":"debug","z":"c7155c63.2294","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1340,"y":880,"wires":[]},{"id":"7521b89f.e536e8","type":"function","z":"c7155c63.2294","name":"PASSING_EACH_ORDER_TO_CHECK","func":"let orderList = msg.orderList;\nlet orderListStatusCode = msg.orderListStatusCode;\n\nif (orderListStatusCode === 200) {\n    orderList.forEach((order, index) => {\n        setTimeout(() => {\n            msg.payload = order;\n            node.send(msg);\n        }, 2000 * index);\n    });\n}","outputs":1,"noerr":0,"x":490,"y":820,"wires":[["7add4cc1.0f24b4"]]},{"id":"7add4cc1.0f24b4","type":"function","z":"c7155c63.2294","name":"CHECK_WITH_REFNO","func":"msg.currentOrder = msg.payload;\n\nlet order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":820,"wires":[["562fd8b4.502638","eba2a4f4.5c5f08"]]},{"id":"562fd8b4.502638","type":"debug","z":"c7155c63.2294","name":"CHECK_WITH_REFNO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":780,"wires":[]},{"id":"50c654f9.18e76c","type":"switch","z":"c7155c63.2294","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":980,"wires":[["bb0efdeb.674f9"],["42cba0b9.72477"]]},{"id":"4e577292.2fa3fc","type":"function","z":"c7155c63.2294","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":860,"wires":[["a53d5120.d9e93","eba2a4f4.5c5f08"]]},{"id":"42cba0b9.72477","type":"switch","z":"c7155c63.2294","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":1080,"wires":[["34bbbde8.9c29e2"],["c6eac995.2550f8"]]},{"id":"c6eac995.2550f8","type":"function","z":"c7155c63.2294","name":"Can't find REF_NO and LINK_NO 😢","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${orderID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)","outputs":1,"noerr":0,"x":730,"y":1100,"wires":[[]]},{"id":"1b9650c.2ee29af","type":"link in","z":"c7155c63.2294","name":"LINK_NO_IN","links":["34bbbde8.9c29e2"],"x":635,"y":860,"wires":[["4e577292.2fa3fc"]]},{"id":"34bbbde8.9c29e2","type":"link out","z":"c7155c63.2294","name":"LINK_NO_OUT","links":["1b9650c.2ee29af"],"x":595,"y":1060,"wires":[]},{"id":"a53d5120.d9e93","type":"debug","z":"c7155c63.2294","name":"CHECK_WITH_LINKNO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":900,"wires":[]},{"id":"eba2a4f4.5c5f08","type":"function","z":"c7155c63.2294","name":"SET_HEADERS","func":"// var SECRET_KEY = \"PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\";\nvar SECRET_KEY = msg.userWebformInfo['secret_key']\nmsg.headers = {}\n// msg.headers['Authorization'] = \"Basic UHdwUkFWaW1BSURGN0VFZTRpTFdoaDExTThFT2FBY3o6\";\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":840,"wires":[["553571a0.075ed"]]},{"id":"bb0efdeb.674f9","type":"function","z":"c7155c63.2294","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"let gbResponseObj = msg.payload;\n\nlet apiUrl = msg.apiUrl;\n\nlet currentOrder = msg.currentOrder;\nlet storeID = currentOrder['storeID'];\nlet orderDocID = currentOrder['orderDocID'];\nlet paymentMethod = gbResponseObj['txn']['status'];\nlet gbpReferenceNo = gbResponseObj['txn']['gbpReferenceNo'];\n// let paymentCompletedOn = paymentResponseObj.paymentCompletedOn;\n\nvar paymentStatus = \"PENDING\";\n\nif (paymentMethod === 'S') {\n    // paymentMethod = \"QR_PAYMENT\";\n    paymentMethod = \"PAID\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'A') {\n    paymentMethod = \"CREDIT_CARD\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'D') {\n    paymentMethod = \"DECLINE\";\n    paymentStatus = \"FAIL\";\n} else if (paymentMethod === 'G') {\n    paymentMethod = \"QR_PAYMENT\";\n}\n\ncurrentOrder['resultPaymentStatus'] = paymentStatus;\nmsg.currentOrder = currentOrder;\n\n// let customerInfo = paymentResponseObj.customerInfo;\n\nlet url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\n\nmsg.url = url;\nmsg.payload = {\n    \"paymentInfo\": {\n        \"method\": paymentMethod,\n        \"status\": paymentStatus,\n        \"details\": gbpReferenceNo,\n        // \"paymentCompletedOn\": paymentCompletedOn,\n        \"isFromBatchCheck\": true,\n        \"batchCheckTimestamp\": Date.now()\n    }\n}\n\n// msg.payload = {\n//     \"paymentInfo\": {\n//         \"method\": paymentMethod,\n//         \"status\": \"SUCCESS\",\n//         \"details\": gbpReferenceNo,\n//         \"paymentCompletedOn\": paymentCompletedOn,\n//         \"isFromBatchCheck\": true,\n//         \"batchCheckTimestamp\": Date.now(),\n//         \"gbPaymentDetails\": {\n//             \"customerName\": customerInfo.customerName,\n//             \"customerEmail\": customerInfo.customerEmail,\n//             \"customerAddress\": customerInfo.customerAddress,\n//             \"customerTelephone\": customerInfo.customerTelephone\n//         }\n//     }\n// }\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":960,"wires":[["3b5cbf0d.77acd","60b98ae.49c7f74"]]},{"id":"60b98ae.49c7f74","type":"http request","z":"c7155c63.2294","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":670,"y":1000,"wires":[["58a6c2cc.8b50cc","51ca6065.0e8e3"]]},{"id":"3b5cbf0d.77acd","type":"debug","z":"c7155c63.2294","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1140,"y":960,"wires":[]},{"id":"58a6c2cc.8b50cc","type":"debug","z":"c7155c63.2294","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1010,"y":1000,"wires":[]},{"id":"51ca6065.0e8e3","type":"function","z":"c7155c63.2294","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":1030,"y":1040,"wires":[["7e087eef.4ba94","c04ebef8.9ee8e"],["539d450e.8bdfac"]]},{"id":"7e087eef.4ba94","type":"debug","z":"c7155c63.2294","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1510,"y":1000,"wires":[]},{"id":"ab7aef09.c652","type":"function","z":"c7155c63.2294","name":"SET_TIME_INTERVAL","func":"var intervalDay = 1;\nvar startTime = Math.floor(Date.now() / 1000) - (24 * 60 * 60 * intervalDay);\nvar endTime = Math.floor(Date.now() / 1000);\n\nmsg.url += `&startDate=${startTime}&endDate=${endTime}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":700,"wires":[["5227969a.b61768"]]},{"id":"539d450e.8bdfac","type":"function","z":"c7155c63.2294","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nnode.error(`Recipient type of this order (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`)","outputs":1,"noerr":0,"x":1485,"y":1240,"wires":[[]]},{"id":"effc3e2e.47d45","type":"http request","z":"c7155c63.2294","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1445,"y":1160,"wires":[["e006ea18.ad8ba8"]]},{"id":"c04ebef8.9ee8e","type":"function","z":"c7155c63.2294","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let currentOrder = msg.currentOrder;\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": currentOrder['orderID']\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":1450,"y":1040,"wires":[["77127cb1.cac494","fc861897.b87cb8"]]},{"id":"77127cb1.cac494","type":"http request","z":"c7155c63.2294","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1425,"y":1080,"wires":[["e213bcd3.2d264","a34dcd7c.0d7ec"]]},{"id":"fc861897.b87cb8","type":"debug","z":"c7155c63.2294","name":"PREPARE_CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1890,"y":1040,"wires":[]},{"id":"e213bcd3.2d264","type":"debug","z":"c7155c63.2294","name":"CALCULATE_GB_PAY_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1875,"y":1080,"wires":[]},{"id":"a34dcd7c.0d7ec","type":"function","z":"c7155c63.2294","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1475,"y":1120,"wires":[["4f0d981d.5884c8"]]},{"id":"4f0d981d.5884c8","type":"debug","z":"c7155c63.2294","name":"PREPARE_INSERT_FUND_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1925,"y":1120,"wires":[]},{"id":"e006ea18.ad8ba8","type":"debug","z":"c7155c63.2294","name":"INSERT_FUNDS_TRANSACTION_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1885,"y":1160,"wires":[]},{"id":"daa656eb.804048","type":"function","z":"c7155c63.2294","name":"INIT_MSG_OBJ","func":"let payload = msg.payload;\n\nmsg.secret_key = payload['secret_key'];\nmsg.token = payload['token'];\nmsg.storeID = payload['storeID'];\nmsg.userWebformInfo = {\n    secret_key: msg.secret_key,\n    storeID: msg.storeID,\n    token: msg.token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":400,"wires":[["bcb4e3f3.c2f09"]]},{"id":"3412b41e.30185c","type":"function","z":"c7155c63.2294","name":"FIND_STORE_DETAIL_BY_GIVEN_BODY","func":"const token = msg.userWebformInfo['token'];\nconst storeID = msg.userWebformInfo['storeID'];\nconst apiUrl = msg.apiUrl;\n\nmsg.payload = [\n    {\n    \t\"fieldName\": \"storeInfo.paymentInfo.gbPayInfo.token\",\n    \t\"fieldValue\": token\n    },\n    {\n    \t\"fieldName\": \"storeID\",\n    \t\"fieldValue\": storeID\n    }\n];\n\nmsg.url = `${apiUrl}/utility/findStoreByCustomFields`;\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":580,"wires":[["3c984da5.1d17b2"]]},{"id":"3c984da5.1d17b2","type":"http request","z":"c7155c63.2294","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":410,"y":620,"wires":[["81624514.500f78","f418e493.d14d08"]]},{"id":"81624514.500f78","type":"function","z":"c7155c63.2294","name":"SET_REQUEST_URL","func":"const apiUrl = msg.apiUrl;\nconst responsePayload = msg.payload;\nconst storeID = responsePayload[0]['storeID'];\n\nmsg.url = `${apiUrl}/order/findOrdersByStatus?status=PENDING&storeID=${storeID}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":660,"wires":[["ab7aef09.c652"]]},{"id":"f418e493.d14d08","type":"debug","z":"c7155c63.2294","name":"RESULT_FIND_STORE_DETAIL_BY_GIVEN_BODY","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":620,"wires":[]},{"id":"bb598d9c.8ad3a","type":"http in","z":"c7155c63.2294","name":"","url":"/searchStoreAPI","method":"post","upload":false,"swaggerDoc":"","x":220,"y":240,"wires":[["daa2bb2b.ed4898","aea39c6e.d5b78"]]},{"id":"daa2bb2b.ed4898","type":"function","z":"c7155c63.2294","name":"CHECK_REQUIRED_FIELDS","func":"if (\n    msg.payload.hasOwnProperty('token')\n) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":480,"y":240,"wires":[["7ef61506.a1484c"],["e34ead05.88084"]]},{"id":"e34ead05.88084","type":"change","z":"c7155c63.2294","name":"","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"},{"t":"set","p":"payload","pt":"msg","to":"{\"message\":\"Missing required fields\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":340,"wires":[["ff31398d.bb3598"]]},{"id":"ff31398d.bb3598","type":"http response","z":"c7155c63.2294","name":"","statusCode":"","headers":{},"x":910,"y":340,"wires":[]},{"id":"d0cbc799.97ee58","type":"change","z":"c7155c63.2294","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":910,"y":180,"wires":[["de494df6.c903f"]]},{"id":"34020838.bdc1c8","type":"change","z":"c7155c63.2294","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":220,"wires":[[]]},{"id":"1118f1ec.917f5e","type":"change","z":"c7155c63.2294","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":910,"y":260,"wires":[[]]},{"id":"de494df6.c903f","type":"function","z":"c7155c63.2294","name":"FIND_STOREID_BY_GIVEN_TOKEN","func":"const token = msg.searchStore['token'];\nconst apiUrl = msg.apiUrl;\n\nmsg.payload = [{\n\t\"fieldName\": \"storeInfo.paymentInfo.gbPayInfo.token\",\n\t\"fieldValue\": token\n}];\n\nmsg.url = `${apiUrl}/utility/findStoreByCustomFields`;\n\nreturn msg;","outputs":1,"noerr":0,"x":1170,"y":180,"wires":[["d9df782d.4367d8"]]},{"id":"d9df782d.4367d8","type":"http request","z":"c7155c63.2294","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1090,"y":220,"wires":[["caa4159a.99a358","5345e881.29d388"]]},{"id":"caa4159a.99a358","type":"debug","z":"c7155c63.2294","name":"RESULT_FIND_STOREID_BY_GIVEN_TOKEN","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1380,"y":220,"wires":[]},{"id":"5345e881.29d388","type":"http response","z":"c7155c63.2294","name":"","statusCode":"","headers":{},"x":1070,"y":260,"wires":[]},{"id":"aea39c6e.d5b78","type":"debug","z":"c7155c63.2294","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":410,"y":200,"wires":[]},{"id":"7ef61506.a1484c","type":"function","z":"c7155c63.2294","name":"INIT_MSG_OBJ","func":"let payload = msg.payload;\n\nmsg.token = payload['token'];\nmsg.searchStore = {\n    token: msg.token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":220,"wires":[["1118f1ec.917f5e"]]},{"id":"c39a8627.db3468","type":"switch","z":"c7155c63.2294","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1170,"y":420,"wires":[["ce5b8ce6.a026f"],["8b509f0d.97d59"],["bcb4e3f3.c2f09"]]},{"id":"ce5b8ce6.a026f","type":"link out","z":"c7155c63.2294","name":"RECONCILE_API_DEV_OUT","links":["b7a16e0b.56bd7","f41b62cd.8bd57"],"x":1355,"y":380,"wires":[]},{"id":"8b509f0d.97d59","type":"link out","z":"c7155c63.2294","name":"RECONCILE_API_UAT_OUT","links":["d24a81f7.4fea2","a34a51c8.9d34c"],"x":1355,"y":420,"wires":[]},{"id":"bcb4e3f3.c2f09","type":"link out","z":"c7155c63.2294","name":"RECONCILE_API_PROD_OUT","links":["b313eae.9848b18","578c7402.634c8c"],"x":1355,"y":460,"wires":[]},{"id":"2169722d.f8c09e","type":"inject","z":"b29be39b.cf04","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":120,"wires":[["c5230175.19913"]]},{"id":"e1fef8f8.645088","type":"inject","z":"b29be39b.cf04","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":260,"wires":[["5f8ef504.37f25c"]]},{"id":"a1ceeec3.1039d","type":"inject","z":"b29be39b.cf04","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":400,"wires":[["c499f0bc.a3f92"]]},{"id":"28b30ad1.ddc6a6","type":"comment","z":"b29be39b.cf04","name":"DEV","info":"","x":130,"y":80,"wires":[]},{"id":"642a3f07.f50d6","type":"comment","z":"b29be39b.cf04","name":"ALPHA","info":"","x":130,"y":220,"wires":[]},{"id":"1b665bd0.5abaa4","type":"comment","z":"b29be39b.cf04","name":"PROD","info":"","x":130,"y":360,"wires":[]},{"id":"c5230175.19913","type":"change","z":"b29be39b.cf04","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":160,"wires":[["c9c27b56.bfe078"]]},{"id":"5f8ef504.37f25c","type":"change","z":"b29be39b.cf04","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":140,"y":300,"wires":[[]]},{"id":"c499f0bc.a3f92","type":"change","z":"b29be39b.cf04","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":440,"wires":[[]]},{"id":"ad3b3e6c.abb19","type":"inject","z":"b29be39b.cf04","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":760,"y":40,"wires":[["33f9c53c.50226a"]]},{"id":"2b8fa885.2f15a8","type":"http request","z":"a17250b6.4d78f","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":530,"y":160,"wires":[["32835e1d.8b4d02","4545a7f9.5ecc58"]]},{"id":"a0656a4e.031a78","type":"function","z":"a17250b6.4d78f","name":"INIT_REQUEST","func":"const FB_ACCESS_TOKEN = msg.FB_ACCESS_TOKEN;\nconst INPUT_TOKEN = msg.TOKEN_TO_VALIDATE;\n\nmsg.url = `https://graph.facebook.com/debug_token?input_token=${INPUT_TOKEN}&access_token=${FB_ACCESS_TOKEN}`\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":200,"wires":[["2b8fa885.2f15a8","9cb8c22f.07d1b"]]},{"id":"9cb8c22f.07d1b","type":"debug","z":"a17250b6.4d78f","name":"VALIDATE_PAGE_TOKEN_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":380,"wires":[]},{"id":"32835e1d.8b4d02","type":"debug","z":"a17250b6.4d78f","name":"VALIDATE_PAGE_TOKEN_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"33f9c53c.50226a","type":"subflow:a17250b6.4d78f","z":"b29be39b.cf04","name":"","env":[],"x":970,"y":40,"wires":[[]]},{"id":"5f82a0be.90f3b","type":"function","z":"8a26c817.ca88c8","name":"INIT_REQUEST_FOR_GETTING_SALES_CHANNEL","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/sales_channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"regexp\":{\n      \"channels.facebook\": \".+\"\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["afc95987.b44af8","3766344e.747eec"]]},{"id":"afc95987.b44af8","type":"debug","z":"8a26c817.ca88c8","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":140,"wires":[]},{"id":"e6aad62d.dc0358","type":"debug","z":"8a26c817.ca88c8","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":180,"wires":[]},{"id":"78fe2463.c2205c","type":"debug","z":"8a26c817.ca88c8","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":740,"y":220,"wires":[]},{"id":"1a78bf09.3d8c21","type":"change","z":"8a26c817.ca88c8","name":"","rules":[{"t":"set","p":"arisSalesChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["78fe2463.c2205c"]]},{"id":"c9c27b56.bfe078","type":"subflow:8a26c817.ca88c8","z":"b29be39b.cf04","name":"","env":[],"x":470,"y":120,"wires":[["cc3a696f.f6fa28"]]},{"id":"5a55dad.3a3ad24","type":"function","z":"8f943ed3.b8305","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":140,"wires":[["cf81f807.fdef98","108123f5.cd0a0c"]]},{"id":"cf81f807.fdef98","type":"debug","z":"8f943ed3.b8305","name":"GET_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":140,"wires":[]},{"id":"280915c5.33a17a","type":"debug","z":"8f943ed3.b8305","name":"GET_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":180,"wires":[]},{"id":"c69e5242.66fa4","type":"debug","z":"8f943ed3.b8305","name":"GET_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":820,"y":220,"wires":[]},{"id":"bd459ca7.e8131","type":"change","z":"8f943ed3.b8305","name":"","rules":[{"t":"set","p":"njoinChannelList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":220,"wires":[["c69e5242.66fa4"]]},{"id":"cc3a696f.f6fa28","type":"subflow:8f943ed3.b8305","z":"b29be39b.cf04","name":"","env":[],"x":450,"y":160,"wires":[["629a448b.97e73c"]]},{"id":"dd89a75a.0f4a88","type":"debug","z":"b29be39b.cf04","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":200,"wires":[]},{"id":"3766344e.747eec","type":"http request","z":"8a26c817.ca88c8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":230,"y":180,"wires":[["e6aad62d.dc0358","1a78bf09.3d8c21"]]},{"id":"108123f5.cd0a0c","type":"http request","z":"8f943ed3.b8305","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["280915c5.33a17a","bd459ca7.e8131"]]},{"id":"629a448b.97e73c","type":"function","z":"b29be39b.cf04","name":"ITERATE_OVER_ARIS_SALES_CHANNEL","func":"const arisSalesChannelList = msg.arisSalesChannelList.hits.hits;\n\narisSalesChannelList.forEach((channel, index) => {\n    setTimeout(() => {\n        msg.payload = channel;\n        msg.isLastIndex_arisSalesChannelList = false;\n        \n        if (index === arisSalesChannelList.length - 1) {\n            msg.isLastIndex_arisSalesChannelList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":480,"y":200,"wires":[["dd89a75a.0f4a88","c5b9096f.7ef4f8"]]},{"id":"c5b9096f.7ef4f8","type":"subflow:1d5e4154.f4c77f","z":"b29be39b.cf04","name":"","env":[],"x":450,"y":240,"wires":[["84ba7179.3fd4c","e2debf40.f65c1"]]},{"id":"58b379ff.c81bf8","type":"function","z":"1d5e4154.f4c77f","name":"INIT_REQUEST_FOR_GETTING_NJOIN_CHANNEL_INFO","func":"const nuser = msg.nuser;\nconst nes = msg.nes;\nconst url = `https://${nes}/njoin-${nuser}/channel/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nlet FB_ID = msg.payload._source.channels.facebook;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nnode.error('Getting facebook channel id: ' + FB_ID + ' from njoin');\n\nmsg.url = url;\nmsg.payload = {\n    \"query\": {\n        \"match\": {\n            \"id\": `facebook_${FB_ID}`\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":140,"wires":[["bb70e1ab.1f2b2","ae2d8448.395768"]]},{"id":"36aee158.130fbe","type":"change","z":"1d5e4154.f4c77f","name":"","rules":[{"t":"set","p":"njoinChannelInfo","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":220,"wires":[["e0e0632e.0a4b3"]]},{"id":"bb70e1ab.1f2b2","type":"http request","z":"1d5e4154.f4c77f","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":180,"wires":[["36aee158.130fbe","d838499a.f21598"]]},{"id":"ae2d8448.395768","type":"debug","z":"1d5e4154.f4c77f","name":"GET_NJOIN_CHANNEL_INFO_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":140,"wires":[]},{"id":"d838499a.f21598","type":"debug","z":"1d5e4154.f4c77f","name":"GET_NJOIN_CHANNEL_INFO_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":180,"wires":[]},{"id":"e0e0632e.0a4b3","type":"debug","z":"1d5e4154.f4c77f","name":"GET_NJOIN_CHANNEL_INFO_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":220,"wires":[]},{"id":"84ba7179.3fd4c","type":"debug","z":"b29be39b.cf04","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":240,"wires":[]},{"id":"5686ea66.630d84","type":"subflow:279aa9ae.249436","z":"8a26c817.ca88c8","name":"","env":[],"x":270,"y":100,"wires":[["5f82a0be.90f3b"]]},{"id":"7837e754.9df298","type":"subflow:279aa9ae.249436","z":"1d5e4154.f4c77f","name":"","env":[],"x":330,"y":100,"wires":[["58b379ff.c81bf8"]]},{"id":"3a85e429.2f76cc","type":"subflow:279aa9ae.249436","z":"8f943ed3.b8305","name":"","x":290,"y":100,"wires":[["5a55dad.3a3ad24"]]},{"id":"e2debf40.f65c1","type":"switch","z":"b29be39b.cf04","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":500,"wires":[["bb2a1cc7.272d5"],["59afc7c4.508968"]]},{"id":"bb2a1cc7.272d5","type":"function","z":"b29be39b.cf04","name":"ITERATE_OVER_FOUNDED_CHANNEL_INFO","func":"node.error(\" > 1\");\n\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":1360,"y":200,"wires":[["2a50e2d2.876aae"]]},{"id":"23deeb8.9085d14","type":"subflow:2e6cb6a3.d0261a","z":"a17250b6.4d78f","name":"","env":[],"x":290,"y":80,"wires":[["a0656a4e.031a78"]]},{"id":"4545a7f9.5ecc58","type":"change","z":"a17250b6.4d78f","name":"","rules":[{"t":"set","p":"RESULT_VALIDATE_PAGE_TOKEN","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":160,"wires":[[]]},{"id":"70564e6e.ebf2c","type":"subflow:a17250b6.4d78f","z":"b29be39b.cf04","name":"","env":[],"x":1290,"y":260,"wires":[["559f4f6b.2353e","f7b41785.5814e8"]]},{"id":"f7b41785.5814e8","type":"debug","z":"b29be39b.cf04","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1710,"y":260,"wires":[]},{"id":"17175122.d37eaf","type":"change","z":"b29be39b.cf04","name":"","rules":[{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"njoinCurrentChannelToValidate","tot":"msg"},{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1700,"y":320,"wires":[["3ec1b92f.92a026"]]},{"id":"559f4f6b.2353e","type":"switch","z":"b29be39b.cf04","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1290,"y":340,"wires":[["83f9bff8.e8619"],["33a26ea1.fb7532"]]},{"id":"2a50e2d2.876aae","type":"change","z":"b29be39b.cf04","name":"","rules":[{"t":"set","p":"njoinCurrentChannelToValidate","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1720,"y":200,"wires":[["70564e6e.ebf2c"]]},{"id":"83f9bff8.e8619","type":"function","z":"b29be39b.cf04","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has valid token, setting page obj to temp_facebook_channel_config');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":320,"wires":[["17175122.d37eaf"]]},{"id":"3ec1b92f.92a026","type":"debug","z":"b29be39b.cf04","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1890,"y":320,"wires":[]},{"id":"7ac2376.214a3c8","type":"subflow:279aa9ae.249436","z":"eb94d442.a4d8f8","name":"","env":[],"x":290,"y":120,"wires":[["3d53276.6d93fd8"]]},{"id":"3d53276.6d93fd8","type":"function","z":"eb94d442.a4d8f8","name":"INIT_REQUEST_FOR_DELETING_CURRENT_NJOIN_CHANNEL_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst channelDocID = msg.njoinChannelDocID;\nconst url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}/_update`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\n// msg.payload = {\n//     \"doc\": {\n//         \"isDeleted\": true\n//     }\n// }\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["6479ecd7.590844","ed41b5d2.840c18"]]},{"id":"ed41b5d2.840c18","type":"http request","z":"eb94d442.a4d8f8","name":"","method":"DELETE","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":200,"wires":[["2659e192.73c89e","d5872531.2ac248"]]},{"id":"2659e192.73c89e","type":"change","z":"eb94d442.a4d8f8","name":"","rules":[{"t":"set","p":"resultDeleteCurrentNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":240,"wires":[["17509b4e.44c425"]]},{"id":"297ecbc5.a47534","type":"subflow:eb94d442.a4d8f8","z":"b29be39b.cf04","name":"","env":[],"x":1340,"y":420,"wires":[["df5ca63b.3795a8","5a94ef25.d6d7d"]]},{"id":"6479ecd7.590844","type":"debug","z":"eb94d442.a4d8f8","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":160,"wires":[]},{"id":"d5872531.2ac248","type":"debug","z":"eb94d442.a4d8f8","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":200,"wires":[]},{"id":"17509b4e.44c425","type":"debug","z":"eb94d442.a4d8f8","name":"DELETE_CURRENT_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":940,"y":240,"wires":[]},{"id":"df5ca63b.3795a8","type":"debug","z":"b29be39b.cf04","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1630,"y":420,"wires":[]},{"id":"5a94ef25.d6d7d","type":"switch","z":"b29be39b.cf04","name":"CHECK_ITERATE_OVER_NJOIN_IS_DONE","property":"isLastIndex_njoinChannelInfoList","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1350,"y":460,"wires":[["b4ca6262.5008b"]]},{"id":"b4ca6262.5008b","type":"function","z":"b29be39b.cf04","name":"","func":"node.error('loop njoin channel list ended!');\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":500,"wires":[["b382f8bc.0482f8","e8ed3d04.c3a1a"]]},{"id":"b382f8bc.0482f8","type":"debug","z":"b29be39b.cf04","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1630,"y":500,"wires":[]},{"id":"be43b972.57fc88","type":"subflow:279aa9ae.249436","z":"5ef2d864.115918","name":"","env":[],"x":230,"y":100,"wires":[["a4e9d352.ac3ed"]]},{"id":"a4e9d352.ac3ed","type":"function","z":"5ef2d864.115918","name":"INIT_REQUEST_FOR_CREATING_NEW_NJOIN_CHANNEL","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst docID = msg.temp_facebook_channel_config['_source']['id'];\n// const url = `https://${nes}/njoin-${nuser}/channel/${channelDocID}`;\nconst url = `https://${nes}/njoin-${nuser}/channel/${docID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.payload = msg.temp_facebook_channel_config._source;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["bdbafc71.bb3a9","339b3e53.2f16d2"]]},{"id":"339b3e53.2f16d2","type":"http request","z":"5ef2d864.115918","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":180,"wires":[["b733c0e2.5885b","18f6be25.e618f2"]]},{"id":"b733c0e2.5885b","type":"change","z":"5ef2d864.115918","name":"","rules":[{"t":"set","p":"resultCreateNewNjoinChannel","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":220,"wires":[["cc74b.81a2a8b58"]]},{"id":"bdbafc71.bb3a9","type":"debug","z":"5ef2d864.115918","name":"CREATE_NEW_NJOIN_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":140,"wires":[]},{"id":"18f6be25.e618f2","type":"debug","z":"5ef2d864.115918","name":"CREATE_NEW_NJOIN_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":180,"wires":[]},{"id":"cc74b.81a2a8b58","type":"debug","z":"5ef2d864.115918","name":"CREATE_NEW_NJOIN_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":220,"wires":[]},{"id":"bcb63948.dbe278","type":"subflow:5ef2d864.115918","z":"b29be39b.cf04","name":"","env":[],"x":1780,"y":560,"wires":[["eee760a4.cc9a4"]]},{"id":"eee760a4.cc9a4","type":"debug","z":"b29be39b.cf04","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2010,"y":560,"wires":[]},{"id":"845c2fac.96627","type":"change","z":"b29be39b.cf04","name":"","rules":[{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":360,"wires":[["297ecbc5.a47534"]]},{"id":"e8ed3d04.c3a1a","type":"function","z":"b29be39b.cf04","name":"TEMP_FACEBOOK_CHANNEL_IS_EMPTY_OR_NOT","func":"if (Object.keys(msg.temp_facebook_channel_config).length) {\n    return [msg, null];\n} else {\n    return [null, null];\n}","outputs":2,"noerr":0,"x":1380,"y":580,"wires":[["bcb63948.dbe278"],["8bd8e9cf.47c118"]]},{"id":"8bd8e9cf.47c118","type":"function","z":"b29be39b.cf04","name":"","func":"node.error('temp_facebook_channel_config is empty, skipping...');\nreturn msg;","outputs":1,"noerr":0,"x":1690,"y":600,"wires":[[]]},{"id":"33a26ea1.fb7532","type":"function","z":"b29be39b.cf04","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has invalid token, setting to njoinChannelDocID to delete');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":360,"wires":[["845c2fac.96627"]]},{"id":"59afc7c4.508968","type":"function","z":"b29be39b.cf04","name":"","func":"node.error('njoinChannelInfo is less than 0, skipping iteration...')\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":780,"wires":[[]]},{"id":"cc782f4d.1eee4","type":"inject","z":"a80659c4.09c238","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":140,"wires":[["e0db8689.e5d198"]]},{"id":"6a9dddff.2a6174","type":"inject","z":"a80659c4.09c238","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":280,"wires":[["3f258df.eb9b772"]]},{"id":"9ee02070.6c233","type":"inject","z":"a80659c4.09c238","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":420,"wires":[["d1bac465.551c78"]]},{"id":"c5841864.2dbbc8","type":"comment","z":"a80659c4.09c238","name":"DEV","info":"","x":110,"y":100,"wires":[]},{"id":"2866ace6.dd0c34","type":"comment","z":"a80659c4.09c238","name":"ALPHA","info":"","x":110,"y":240,"wires":[]},{"id":"8c5e2ec3.ed7b4","type":"comment","z":"a80659c4.09c238","name":"PROD","info":"","x":110,"y":380,"wires":[]},{"id":"e0db8689.e5d198","type":"change","z":"a80659c4.09c238","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":110,"y":180,"wires":[[]]},{"id":"3f258df.eb9b772","type":"change","z":"a80659c4.09c238","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":120,"y":320,"wires":[[]]},{"id":"d1bac465.551c78","type":"change","z":"a80659c4.09c238","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":110,"y":460,"wires":[["8ce2770e.a4a578"]]},{"id":"9e152a99.1da938","type":"inject","z":"a80659c4.09c238","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":740,"y":60,"wires":[["95ef9bb4.eab5d8"]]},{"id":"95ef9bb4.eab5d8","type":"subflow:a17250b6.4d78f","z":"a80659c4.09c238","name":"","env":[],"x":950,"y":60,"wires":[[]]},{"id":"8ce2770e.a4a578","type":"subflow:8a26c817.ca88c8","z":"a80659c4.09c238","name":"","env":[],"x":450,"y":140,"wires":[["1a381626.727d0a","fd08a093.b20df"]]},{"id":"28cfb864.5be138","type":"subflow:8f943ed3.b8305","z":"a80659c4.09c238","name":"","env":[],"x":630,"y":1020,"wires":[[]]},{"id":"70d6edaa.860ac4","type":"debug","z":"a80659c4.09c238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":950,"y":1060,"wires":[]},{"id":"62baba75.e4cc94","type":"function","z":"a80659c4.09c238","name":"ITERATE_OVER_ARIS_SALES_CHANNEL","func":"const arisSalesChannelList = msg.arisSalesChannelList.hits.hits;\n\narisSalesChannelList.forEach((channel, index) => {\n    setTimeout(() => {\n        msg.payload = channel;\n        msg.isLastIndex_arisSalesChannelList = false;\n        \n        if (index === arisSalesChannelList.length - 1) {\n            msg.isLastIndex_arisSalesChannelList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":670,"y":1060,"wires":[["70d6edaa.860ac4","31b74648.847a1a"]]},{"id":"31b74648.847a1a","type":"subflow:1d5e4154.f4c77f","z":"a80659c4.09c238","name":"","env":[],"x":630,"y":1100,"wires":[["68878877.ac3408","640cfa7b.142494"]]},{"id":"68878877.ac3408","type":"debug","z":"a80659c4.09c238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":950,"y":1100,"wires":[]},{"id":"640cfa7b.142494","type":"switch","z":"a80659c4.09c238","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":630,"y":1200,"wires":[["3a81ba6c.db1ab6"],["aee76792.7ce1f8"]]},{"id":"3a81ba6c.db1ab6","type":"function","z":"a80659c4.09c238","name":"ITERATE_OVER_FOUNDED_CHANNEL_INFO","func":"node.error(\" > 1\");\n\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n\n// return msg;","outputs":1,"noerr":0,"x":1400,"y":820,"wires":[["c090d555.b5bdb8"]]},{"id":"e2999978.4752a8","type":"subflow:a17250b6.4d78f","z":"a80659c4.09c238","name":"","env":[],"x":1330,"y":880,"wires":[["69a52d5f.c3ab34","c5bd0c3b.84c92"]]},{"id":"c5bd0c3b.84c92","type":"debug","z":"a80659c4.09c238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1750,"y":880,"wires":[]},{"id":"38eea4a.514a65c","type":"change","z":"a80659c4.09c238","name":"","rules":[{"t":"set","p":"temp_facebook_channel_config","pt":"msg","to":"njoinCurrentChannelToValidate","tot":"msg"},{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":940,"wires":[["9756bca5.9c5dd"]]},{"id":"69a52d5f.c3ab34","type":"switch","z":"a80659c4.09c238","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":960,"wires":[["55fd159.cf9c1ec"],["a6192f71.85653"]]},{"id":"c090d555.b5bdb8","type":"change","z":"a80659c4.09c238","name":"","rules":[{"t":"set","p":"njoinCurrentChannelToValidate","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":820,"wires":[["e2999978.4752a8"]]},{"id":"55fd159.cf9c1ec","type":"function","z":"a80659c4.09c238","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has valid token, setting page obj to temp_facebook_channel_config');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1550,"y":940,"wires":[["38eea4a.514a65c"]]},{"id":"9756bca5.9c5dd","type":"debug","z":"a80659c4.09c238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1930,"y":940,"wires":[]},{"id":"791fa3d6.b3ee6c","type":"subflow:eb94d442.a4d8f8","z":"a80659c4.09c238","name":"","env":[],"x":1380,"y":1040,"wires":[["680fd30d.2566ac","3194ac41.d81364"]]},{"id":"680fd30d.2566ac","type":"debug","z":"a80659c4.09c238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1670,"y":1040,"wires":[]},{"id":"3194ac41.d81364","type":"switch","z":"a80659c4.09c238","name":"CHECK_ITERATE_OVER_NJOIN_IS_DONE","property":"isLastIndex_njoinChannelInfoList","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1390,"y":1080,"wires":[["74d28a5b.1ee114"]]},{"id":"74d28a5b.1ee114","type":"function","z":"a80659c4.09c238","name":"","func":"node.error('loop njoin channel list ended!');\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":1120,"wires":[["e802f15a.a1e9","df6700b3.65f01"]]},{"id":"e802f15a.a1e9","type":"debug","z":"a80659c4.09c238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1670,"y":1120,"wires":[]},{"id":"748e53d1.483eac","type":"subflow:5ef2d864.115918","z":"a80659c4.09c238","name":"","env":[],"x":1820,"y":1180,"wires":[["5be0c18f.7c79f"]]},{"id":"5be0c18f.7c79f","type":"debug","z":"a80659c4.09c238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2050,"y":1180,"wires":[]},{"id":"dd2529e4.ba3308","type":"change","z":"a80659c4.09c238","name":"","rules":[{"t":"set","p":"njoinChannelDocID","pt":"msg","to":"njoinCurrentChannelToValidate._id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1780,"y":980,"wires":[["791fa3d6.b3ee6c"]]},{"id":"df6700b3.65f01","type":"function","z":"a80659c4.09c238","name":"TEMP_FACEBOOK_CHANNEL_IS_EMPTY_OR_NOT","func":"if (Object.keys(msg.temp_facebook_channel_config).length) {\n    return [msg, null];\n} else {\n    return [null, null];\n}","outputs":2,"noerr":0,"x":1420,"y":1200,"wires":[["748e53d1.483eac"],["c1eb9f87.9183e"]]},{"id":"c1eb9f87.9183e","type":"function","z":"a80659c4.09c238","name":"","func":"node.error('temp_facebook_channel_config is empty, skipping...');\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1220,"wires":[[]]},{"id":"a6192f71.85653","type":"function","z":"a80659c4.09c238","name":"","func":"let pageID = msg.njoinCurrentChannelToValidate._source.id;\nnode.error('This pageID : ' + pageID + ' has invalid token, setting to njoinChannelDocID to delete');\n\n// if (!msg.hasOwnProperty('totalValidPage')) {\n//     msg.totalValidPage = Number(0);\n// }\n// msg.totalValidPage = Number(msg.totalValidPage + 1);\n\nreturn msg;","outputs":1,"noerr":0,"x":1550,"y":980,"wires":[["dd2529e4.ba3308"]]},{"id":"aee76792.7ce1f8","type":"function","z":"a80659c4.09c238","name":"","func":"node.error('njoinChannelInfo is less than 0, skipping iteration...')\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":1400,"wires":[[]]},{"id":"1a381626.727d0a","type":"debug","z":"a80659c4.09c238","name":"RESULT_ARIS_SALES_CHANNEL_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":140,"wires":[]},{"id":"fd08a093.b20df","type":"function","z":"a80659c4.09c238","name":"INITIAL_INDEX_SALES_CHANNEL","func":"msg.indexSalesChannel = 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":180,"wires":[["a96bc49d.0c9748"]]},{"id":"a96bc49d.0c9748","type":"switch","z":"a80659c4.09c238","name":"Index Sale Channel = salesChannelList length?","property":"indexSalesChannel","propertyType":"msg","rules":[{"t":"lt","v":"arisSalesChannelList.hits.hits.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":260,"wires":[["37838cec.c19c84"],["278df9f7.0e3646"]]},{"id":"eb14f97f.0459d8","type":"comment","z":"a80659c4.09c238","name":"Sales Channel LOOP","info":"","x":400,"y":220,"wires":[]},{"id":"37838cec.c19c84","type":"function","z":"a80659c4.09c238","name":"INITIAL_SALES_CHANNEL_BEFORE_PROCESS","func":"let processIndex = msg.indexSalesChannel;\nlet processSalesChannel = msg.arisSalesChannelList.hits.hits[processIndex];\nmsg.payload = processSalesChannel;\nmsg.tempNjoinChannelInfo = {};\n//node.error(processSalesChannel);\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":320,"wires":[["701534c0.c67e6c"]]},{"id":"278df9f7.0e3646","type":"function","z":"a80659c4.09c238","name":"PROCESS_DONE","func":"node.error('End Sales Channel Loop. Process done.');\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":280,"wires":[[]]},{"id":"701534c0.c67e6c","type":"subflow:1d5e4154.f4c77f","z":"a80659c4.09c238","name":"","env":[],"x":510,"y":360,"wires":[["1651a642.15224a","396fa13.171895e"]]},{"id":"5d389215.e3b14c","type":"function","z":"a80659c4.09c238","name":"INCREASE_INDEX_SALES_CHANNEL","func":"msg.indexSalesChannel++;\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":620,"wires":[["e4e8e593.a89308"]]},{"id":"2a0e0a0f.1d66a6","type":"link in","z":"a80659c4.09c238","name":"","links":["1cca0ed8.dc90a1"],"x":255,"y":260,"wires":[["a96bc49d.0c9748"]]},{"id":"1cca0ed8.dc90a1","type":"link out","z":"a80659c4.09c238","name":"","links":["2a0e0a0f.1d66a6","3cc94b42.40c124"],"x":815,"y":620,"wires":[]},{"id":"1651a642.15224a","type":"debug","z":"a80659c4.09c238","name":"RESULT_NJOIN_CHANNEL_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":360,"wires":[]},{"id":"396fa13.171895e","type":"subflow:6c36ea94.094f04","z":"a80659c4.09c238","name":"","env":[],"x":540,"y":400,"wires":[["5d389215.e3b14c"]]},{"id":"fbaf0bdc.d50bc8","type":"switch","z":"6c36ea94.094f04","name":"NJOIN_CHANNEL_INFO > 0 ?","property":"njoinChannelInfo.hits.total","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":240,"wires":[["7f71dd0f.112fe4"],["98f70a38.ba4628"]]},{"id":"7f71dd0f.112fe4","type":"function","z":"6c36ea94.094f04","name":"","func":"node.error('njoinChannelInfo is equal 0, go next...');\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":40,"wires":[[]]},{"id":"98f70a38.ba4628","type":"function","z":"6c36ea94.094f04","name":"INITIAL_INDEX_NJOIN_CHANNEL","func":"node.error('njoinChannelInfo(s) are more than 0 : '+msg.njoinChannelInfo.hits.total);\n\nmsg.indexNjoinChannel = 0;\nmsg.njoinChannelList = msg.njoinChannelInfo.hits.hits;\n\nreturn msg;\n\n/*\nconst njoinChannelInfoList = msg.njoinChannelInfo.hits.hits;\n\nnjoinChannelInfoList.forEach((njoinChannel, index) => {\n    setTimeout(() => {\n        let njoinChannelToken = njoinChannel._source.token;\n        \n        msg.TOKEN_TO_VALIDATE = njoinChannelToken;\n        msg.payload = njoinChannel;\n        msg.isLastIndex_njoinChannelInfoList = true;\n        \n        if (index === njoinChannelInfoList.length - 1) {\n            msg.isLastIndex_njoinChannelInfoList = true;\n        }\n        \n        node.send(msg);\n    }, 500 * index);\n});\n*/","outputs":1,"noerr":0,"x":340,"y":300,"wires":[["7297841f.73494c"]]},{"id":"d2c21871.3a1f98","type":"comment","z":"6c36ea94.094f04","name":"Njoin Channel LOOP","info":"","x":290,"y":340,"wires":[]},{"id":"7297841f.73494c","type":"switch","z":"6c36ea94.094f04","name":"Index Njoin Channel = njoinChannelList length?","property":"indexNjoinChannel","propertyType":"msg","rules":[{"t":"lt","v":"njoinChannelList.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":380,"wires":[["b1bca7fb.7a33e8"],["7c1c79aa.1eb618"]]},{"id":"a17f2a02.b44d88","type":"link in","z":"6c36ea94.094f04","name":"","links":["30350014.2cafd"],"x":135,"y":380,"wires":[["7297841f.73494c"]]},{"id":"98e44496.802258","type":"function","z":"6c36ea94.094f04","name":"INCREASE_INDEX_NJOIN_CHANNEL","func":"msg.indexNjoinChannel++;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":940,"wires":[["9158b719.313d68"]]},{"id":"30350014.2cafd","type":"link out","z":"6c36ea94.094f04","name":"","links":["a17f2a02.b44d88"],"x":695,"y":940,"wires":[]},{"id":"7c1c79aa.1eb618","type":"function","z":"6c36ea94.094f04","name":"END_LOOP","func":"node.error('End Njoin Channel Loop.');\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":240,"wires":[["c19b5f32.37607"]]},{"id":"b1bca7fb.7a33e8","type":"function","z":"6c36ea94.094f04","name":"INITIAL_NJOIN_CHANNEL_BEFORE_PROCESS","func":"let processIndex = msg.indexNjoinChannel;\nlet processNjoinChannel = msg.njoinChannelList[processIndex];\n//msg.payload = processNjoinChannel;\nmsg.processNjoinChannel = processNjoinChannel;\nmsg.TOKEN_TO_VALIDATE = processNjoinChannel._source.token;\nnode.error(processNjoinChannel);\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":440,"wires":[["b41716f3.bb4598"]]},{"id":"b41716f3.bb4598","type":"subflow:a17250b6.4d78f","z":"6c36ea94.094f04","name":"","env":[],"x":400,"y":480,"wires":[["8a173b1f.eefa98","60e800be.6f7ce"]]},{"id":"8a173b1f.eefa98","type":"debug","z":"6c36ea94.094f04","name":"RESULT_VALIDATE_PAGE_TOKEN_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":480,"wires":[]},{"id":"60e800be.6f7ce","type":"switch","z":"6c36ea94.094f04","name":"VALIDATE_PAGE_TOKEN","property":"RESULT_VALIDATE_PAGE_TOKEN.data.is_valid","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":400,"y":560,"wires":[["6b670503.c5307c"],["c7efc198.f9943"]]},{"id":"6b670503.c5307c","type":"function","z":"6c36ea94.094f04","name":"PAGE_TOKEN_VALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is VALID.');\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":620,"wires":[["7fedbc8e.5d8354"]]},{"id":"c7efc198.f9943","type":"function","z":"6c36ea94.094f04","name":"PAGE_TOKEN_INVALID","func":"node.error('Page Token: '+msg.processNjoinChannel._source.id+' is INVALID. Prepare to DELETE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":620,"wires":[["14e91b71.ae2a15"]]},{"id":"14e91b71.ae2a15","type":"function","z":"6c36ea94.094f04","name":"SET_NJOIN_CHANNEL_DOC_ID","func":"node.error('Set njoin channel doc ID: '+msg.processNjoinChannel._id+' with Page Token: '+msg.processNjoinChannel._source.id+' to DELETE.');\nmsg.njoinChannelDocID = msg.processNjoinChannel._id;\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":820,"wires":[["2dea03fe.ab771c"]]},{"id":"2dea03fe.ab771c","type":"subflow:eb94d442.a4d8f8","z":"6c36ea94.094f04","name":"","env":[],"x":480,"y":860,"wires":[["98e44496.802258"]]},{"id":"7fedbc8e.5d8354","type":"switch","z":"6c36ea94.094f04","name":"Temp njoin channel is not empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":800,"y":680,"wires":[["268ab2e9.f3be4e"],["14e91b71.ae2a15"]]},{"id":"268ab2e9.f3be4e","type":"function","z":"6c36ea94.094f04","name":"Temp join channel is empty","func":"node.error('temp njoin channel is empty, so set njoin channel: '+msg.processNjoinChannel._source.id+' into temp njoin channel.');\nmsg.tempNjoinChannelInfo = msg.processNjoinChannel;\n\n//node.error(msg.tempNjoinChannelInfo);\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":740,"wires":[["14e91b71.ae2a15"]]},{"id":"c19b5f32.37607","type":"switch","z":"6c36ea94.094f04","name":"Temp njoin channel is empty?","property":"tempNjoinChannelInfo","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":300,"wires":[["f9d11738.218278"],["985034fe.eb04f8"]]},{"id":"985034fe.eb04f8","type":"function","z":"6c36ea94.094f04","name":"INIT_PAGE_DATA_TO_CREATE","func":"msg.temp_facebook_channel_config = msg.tempNjoinChannelInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":360,"wires":[["b123d5d2.2001d8"]]},{"id":"b123d5d2.2001d8","type":"subflow:5ef2d864.115918","z":"6c36ea94.094f04","name":"","env":[],"x":880,"y":400,"wires":[["d4ff59fb.445928","f9d11738.218278"]]},{"id":"d4ff59fb.445928","type":"debug","z":"6c36ea94.094f04","name":"RESULT_CREATE_NJOIN_CHANNEL","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1290,"y":440,"wires":[]},{"id":"f9d11738.218278","type":"function","z":"6c36ea94.094f04","name":"PROCESS_DONE","func":"node.error('Process DONE.');\n\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":340,"wires":[[]]},{"id":"e4e8e593.a89308","type":"delay","z":"a80659c4.09c238","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":710,"y":620,"wires":[["1cca0ed8.dc90a1"]]},{"id":"9158b719.313d68","type":"delay","z":"6c36ea94.094f04","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":590,"y":940,"wires":[["30350014.2cafd"]]},{"id":"adb615b0.5f4568","type":"inject","z":"457d904.813437","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":120,"wires":[["bed67711.667938"]]},{"id":"eafa35ac.3e1878","type":"inject","z":"457d904.813437","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":260,"wires":[["c6719a03.340308"]]},{"id":"816d918c.c1b68","type":"inject","z":"457d904.813437","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":400,"wires":[["93cd23d7.42182"]]},{"id":"439f0a50.cd9824","type":"comment","z":"457d904.813437","name":"DEV","info":"","x":130,"y":80,"wires":[]},{"id":"4f9e7f1b.896cd","type":"comment","z":"457d904.813437","name":"ALPHA","info":"","x":130,"y":220,"wires":[]},{"id":"79dab4ec.3db4ac","type":"comment","z":"457d904.813437","name":"PROD","info":"","x":130,"y":360,"wires":[]},{"id":"bed67711.667938","type":"change","z":"457d904.813437","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":160,"wires":[["e2c27754.86cc28"]]},{"id":"c6719a03.340308","type":"change","z":"457d904.813437","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":140,"y":300,"wires":[[]]},{"id":"93cd23d7.42182","type":"change","z":"457d904.813437","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":440,"wires":[[]]},{"id":"564b3408.99031c","type":"subflow:8f943ed3.b8305","z":"457d904.813437","name":"","env":[],"x":990,"y":120,"wires":[[]]},{"id":"336f47ee.9ef688","type":"function","z":"dc4923b1.2b53a","name":"INIT_REQUEST_FOR_GETTING_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst storeID = msg.storeID\nconst url = `https://${nes}/${platform_index}/order/_search?size=500`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        { \"match\": { \"storeID.keyword\": storeID } },\n        { \"match\": { \"userInfo.firstName.keyword\": \"\" } },\n        { \"match\": { \"userInfo.lastName.keyword\": \"\" } }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["d8cf217b.fdf0f","51d3452f.18d32c"]]},{"id":"d8cf217b.fdf0f","type":"debug","z":"dc4923b1.2b53a","name":"GET_ARIS_SALES_CHANNEL_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":120,"wires":[]},{"id":"3170b9b6.6fe4c6","type":"debug","z":"dc4923b1.2b53a","name":"GET_ARIS_SALES_CHANNEL_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":160,"wires":[]},{"id":"a2fa3696.e8bad8","type":"debug","z":"dc4923b1.2b53a","name":"GET_ARIS_SALES_CHANNEL_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":200,"wires":[]},{"id":"641c43ef.c8edfc","type":"change","z":"dc4923b1.2b53a","name":"","rules":[{"t":"set","p":"arisOrdersList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":200,"wires":[["a2fa3696.e8bad8"]]},{"id":"51d3452f.18d32c","type":"http request","z":"dc4923b1.2b53a","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":210,"y":160,"wires":[["3170b9b6.6fe4c6","641c43ef.c8edfc"]]},{"id":"27d6ae25.0b8d72","type":"subflow:279aa9ae.249436","z":"dc4923b1.2b53a","name":"","env":[],"x":250,"y":80,"wires":[["336f47ee.9ef688"]]},{"id":"29cee4c0.6c9a8c","type":"subflow:dc4923b1.2b53a","z":"457d904.813437","name":"","env":[],"x":670,"y":120,"wires":[["613870de.df421"]]},{"id":"613870de.df421","type":"debug","z":"457d904.813437","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":80,"wires":[]},{"id":"e2c27754.86cc28","type":"function","z":"457d904.813437","name":"SET_STORE_ID_TO_FIND_ORDERS","func":"msg.storeID = \"e6593c83-b8eb-49c8-b725-12e99fda61bd\";\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":160,"wires":[["29cee4c0.6c9a8c"]]},{"id":"2ca4e15f.90a93e","type":"inject","z":"a80659c4.09c238","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":560,"wires":[["5229689f.206408"]]},{"id":"31b4c200.72acce","type":"comment","z":"a80659c4.09c238","name":"TEST PROD","info":"","x":130,"y":520,"wires":[]},{"id":"5229689f.206408","type":"change","z":"a80659c4.09c238","name":"TEST PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"test-arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"test-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":130,"y":600,"wires":[[]]},{"id":"feb7ed3a.56331","type":"ical-events","z":"462d4e7.f271db","confignode":"db05d877.b1ba08","cron":"50 8 * * *","name":"","offset":"","x":310,"y":220,"wires":[["63350f76.dd0b9"],["644c6899.93b278"]]},{"id":"946ea872.4c8898","type":"ical-upcoming","z":"462d4e7.f271db","confignode":"db05d877.b1ba08","cron":"50 8 * * *","timeout":"30","timeoutUnits":"seconds","name":"","offset":"","endpreview":"","endpreviewUnits":"days","pastview":"","pastviewUnits":"days","trigger":"match","filter":"","x":330,"y":300,"wires":[["1c1ec837.b33a28","f4017bba.6eb328"]]},{"id":"bc592bad.445e28","type":"inject","z":"462d4e7.f271db","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":280,"wires":[["feb7ed3a.56331","946ea872.4c8898"]]},{"id":"644c6899.93b278","type":"debug","z":"462d4e7.f271db","name":"event_trigger_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":540,"y":240,"wires":[]},{"id":"63350f76.dd0b9","type":"debug","z":"462d4e7.f271db","name":"event_trigger_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":540,"y":200,"wires":[]},{"id":"1c1ec837.b33a28","type":"debug","z":"462d4e7.f271db","name":"upcoming_events_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":350,"y":360,"wires":[]},{"id":"cdff1965.dbc448","type":"function","z":"462d4e7.f271db","name":"SET_UPCOMING_EVENT_TO_MEMORY","func":"context.global['upcomingEvent'] = {};\ncontext.global['upcomingEvent']['eventList'] = msg.payload;\ncontext.global['upcomingEvent']['lastUpdated'] = Date.now();\n\nmsg.payload = context.global['upcomingEvent'];\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":340,"wires":[["bd66eb24.5a1ce8"]]},{"id":"72863347.5c8f6c","type":"inject","z":"462d4e7.f271db","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":860,"wires":[["95f3f855.7f27a8"]]},{"id":"95f3f855.7f27a8","type":"function","z":"462d4e7.f271db","name":"debug upcomingEvent","func":"msg.payload = context.global['upcomingEvent'];\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":880,"wires":[["2b7e6398.ec37bc"]]},{"id":"2b7e6398.ec37bc","type":"debug","z":"462d4e7.f271db","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":690,"y":900,"wires":[]},{"id":"817f7e80.63f67","type":"debug","z":"462d4e7.f271db","name":"filter_upcoming_event_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1070,"y":300,"wires":[]},{"id":"3a0ff720.e36fc8","type":"http in","z":"462d4e7.f271db","name":"","url":"/upcomingEvent","method":"get","upload":false,"swaggerDoc":"","x":140,"y":60,"wires":[["bb3be324.79efa"]]},{"id":"132e9551.a954db","type":"http response","z":"462d4e7.f271db","name":"","statusCode":"","headers":{},"x":490,"y":60,"wires":[]},{"id":"bb3be324.79efa","type":"function","z":"462d4e7.f271db","name":"get_upcoming_event_debug","func":"msg.payload = context.global['upcomingEvent'];\n\nmsg.statusCode = 200;\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":60,"wires":[["132e9551.a954db","9456de78.f3a17"]]},{"id":"9456de78.f3a17","type":"debug","z":"462d4e7.f271db","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":490,"y":100,"wires":[]},{"id":"bd66eb24.5a1ce8","type":"debug","z":"462d4e7.f271db","name":"set_upcoming_event_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1060,"y":340,"wires":[]},{"id":"f4017bba.6eb328","type":"function-npm","z":"462d4e7.f271db","name":"FILTER_UPCOMING_EVENT_IN_NEXT_24_HOURS","func":"const moment = require('moment');\n\nconst startDate = moment().format();\nconst endDate = moment().add(1, 'days').format();\n\nlet eventList = msg.payload;\n\neventList = eventList\n    .filter((event, index) => {\n        event.eventStart = moment(event.eventStart).format();\n        return event.eventStart >= startDate && event.eventStart <= endDate;\n    })\n    .map((event, index) => {\n        event.eventStart = moment(event.eventStart).add(7, 'hours');\n        event.eventEnd = moment(event.eventEnd).add(7, 'hours');\n        return event;\n    })\n    .sort((a, b) => {\n        return (a.eventStart > b.eventStart) ? 1 : ((b.eventStart > a.eventStart) ? -1 : 0)\n    });\n\n\nmsg.payload = eventList;\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":300,"wires":[["817f7e80.63f67","cdff1965.dbc448"]]},{"id":"323504f7.732cbc","type":"comment","z":"462d4e7.f271db","name":"TRIGGER_LINE_NOTIFY","info":"","x":290,"y":640,"wires":[]},{"id":"2bc041bd.c1edee","type":"function","z":"462d4e7.f271db","name":"SET_HEADERS","func":"const TOKEN = \"yD1dkEa3ZZTk9t2G4xCqbyXuBM2NqRxfRwrbT2RTTQq\";\n\nlet messageToNotify = msg.messageToNotify;\n\nmsg.headers = {\n    \"Content-Type\": \"application/x-www-form-urlencoded\",\n    \"Authorization\": `Bearer ${TOKEN}`,\n    // \"Cache-Control\": \"no-cache\"\n}\nmsg.payload = messageToNotify;\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":720,"wires":[["f5c20533.c28b58","aa58ef8b.43ac6"]]},{"id":"d0167d2a.64af8","type":"debug","z":"462d4e7.f271db","name":"line_notify_http_req_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":760,"wires":[]},{"id":"bc086890.004b18","type":"inject","z":"462d4e7.f271db","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":700,"wires":[["9aeddfa6.b43fa"]]},{"id":"f5c20533.c28b58","type":"debug","z":"462d4e7.f271db","name":"set_line_notify_headers_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":550,"y":760,"wires":[]},{"id":"9aeddfa6.b43fa","type":"function","z":"462d4e7.f271db","name":"","func":"msg.messageToNotify = {\n    message: \"Upcoming Event: \",\n    stickerPackageId: 1,\n    stickerId: 16\n}\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":760,"wires":[["2bc041bd.c1edee","440836ea.363528"]]},{"id":"aa58ef8b.43ac6","type":"http request","z":"462d4e7.f271db","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://notify-api.line.me/api/notify","tls":"","proxy":"","authType":"","x":750,"y":720,"wires":[["d0167d2a.64af8"]]},{"id":"440836ea.363528","type":"debug","z":"462d4e7.f271db","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":390,"y":800,"wires":[]},{"id":"f842622c.2d568","type":"cronplus","z":"462d4e7.f271db","name":"","outputField":"payload","timeZone":"","options":[{"topic":"every 9am","payload":"","type":"str","expression":"0 9 * * *"}],"x":120,"y":500,"wires":[["5979e3cb.0e583c"]]},{"id":"5979e3cb.0e583c","type":"function","z":"462d4e7.f271db","name":"SET_MESSAGE_BODY","func":"const eventList = context.global['upcomingEvent']['eventList'];\nlet upcomingEvent = \"\";\n\neventList.forEach((event, index) => {\n    event.eventStart = event.eventStart.toString().replace(\" GMT+0000\", \"\");\n    event.eventEnd = event.eventEnd.toString().replace(\" GMT+0000\", \"\");\n    upcomingEvent += `\\n - 📅 *${event.event}* ⏰ ${event.eventStart} ~ ${event.eventEnd} \\n` \n});\n\nmsg.messageToNotify = {\n    message: `\\n ${upcomingEvent}`,\n    stickerPackageId: 2,\n    stickerId: 527\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":500,"wires":[["2493d30c.2b70ec","4816106c.b0269"]]},{"id":"2493d30c.2b70ec","type":"debug","z":"462d4e7.f271db","name":"set_message_body_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":520,"wires":[]},{"id":"4816106c.b0269","type":"function","z":"462d4e7.f271db","name":"CHECK_LENGTH_OF_EVENT_LIST","func":"const eventList = context.global['upcomingEvent']['eventList'];\n\nif (eventList.length > 0) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":550,"y":600,"wires":[["2bc041bd.c1edee"],["e0d12718.c8d328"]]},{"id":"e0d12718.c8d328","type":"function","z":"462d4e7.f271db","name":"","func":"node.error('No upcoming event, skipping notify')\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":620,"wires":[[]]},{"id":"68a60181.5a1f5","type":"http in","z":"8ea5e8ac.227478","name":"","url":"/ghWebhook","method":"post","upload":false,"swaggerDoc":"","x":160,"y":60,"wires":[["ea439a9.f82e868","b2813c76.3a3c5","aa0d582c.a5fa68"]]},{"id":"b2813c76.3a3c5","type":"http response","z":"8ea5e8ac.227478","name":"","statusCode":"","headers":{},"x":450,"y":60,"wires":[]},{"id":"ea439a9.f82e868","type":"debug","z":"8ea5e8ac.227478","name":"ghWebhook_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":180,"wires":[]},{"id":"aa0d582c.a5fa68","type":"function","z":"8ea5e8ac.227478","name":"EVENT_SPLITTER","func":"msg.currentEvent = msg.payload\n\nif (msg.currentEvent.hasOwnProperty(\"pull_request\")) {\n    return [msg, null];\n} else {\n    return [null, msg]\n}","outputs":2,"noerr":0,"x":350,"y":280,"wires":[["f30accaf.54f3d"],[]]},{"id":"f30accaf.54f3d","type":"function","z":"8ea5e8ac.227478","name":"PULL_REQUEST_EVENT_NOTIFY","func":"node.error(\"Pull Request Event\");\n\nconst currentEvent = msg.currentEvent;\n\nmsg.payload = {\n    \"type\": \"pull_request\",\n    \"action\": \"opened\",\n    \"url\": currentEvent['pull_request']['url'],\n    \"title\": currentEvent['pull_request']['title'],\n    \"repository\": currentEvent['repository']['name'],\n    \"sender\": currentEvent['sender']['login']\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":280,"wires":[["5607521e.abccec"]]},{"id":"5607521e.abccec","type":"debug","z":"8ea5e8ac.227478","name":"pr_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":420,"wires":[]},{"id":"6ac17ba0.2eadf4","type":"function","z":"eb9ff6d6.6b53f8","name":"GET_DISTINCT_STORE_ID_FROM_ORDERS","func":"const orderList = msg.orderList;\n\nconst distinctStoreList = [...new Set(orderList.map(order => order.storeID))];\n\nmsg.distinctStoreList = distinctStoreList;\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":200,"wires":[["a41990fc.e7616","605ee8c8.ea4478"]]},{"id":"b09d3b19.057c88","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":160,"wires":[]},{"id":"a41990fc.e7616","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":200,"wires":[]},{"id":"fd0981d3.1d373","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_BODY_FOR_GET_TOKEN_LIST","func":"const apiUrl = msg.apiUrl;\n\nconst distinctStoreList = msg.distinctStoreList;\n\nmsg.url = `${apiUrl}/storeConfig/tokenList`;\n\nmsg.payload = {\n    \"storeList\": distinctStoreList\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":400,"wires":[["307b6b5.2c0e994"]]},{"id":"307b6b5.2c0e994","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1010,"y":440,"wires":[["77c0df3.dd0f12","89b1086d.be40a8"]]},{"id":"77c0df3.dd0f12","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":440,"wires":[]},{"id":"605ee8c8.ea4478","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_BODY_TO_GET_GB_PAY_ACCOUNT_LIST","func":"const apiUrl = msg.apiUrl;\n\nconst distinctStoreList = msg.distinctStoreList;\n\nmsg.url = `${apiUrl}/gbpayAccount/all`;\n\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":260,"wires":[["d84d337f.077e6"]]},{"id":"d84d337f.077e6","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1010,"y":300,"wires":[["5c2777c9.0db908","e335d8ce.dc86d8"]]},{"id":"5c2777c9.0db908","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":300,"wires":[]},{"id":"e335d8ce.dc86d8","type":"change","z":"eb9ff6d6.6b53f8","name":"","rules":[{"t":"set","p":"gbPayAccountList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":340,"wires":[["fd0981d3.1d373"]]},{"id":"89b1086d.be40a8","type":"change","z":"eb9ff6d6.6b53f8","name":"","rules":[{"t":"set","p":"storeTokenList","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":480,"wires":[["316dd2b8.a1010e"]]},{"id":"316dd2b8.a1010e","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_MAPPED_STORE_TOKEN","func":"const gbPayAccountList = msg.gbPayAccountList;\n\nlet tempPayload = [];\n\nconst findTokenFromGBPayAccountList = (token, list) => {\n    return list.find((listItem) => {\n        return listItem['gbPayAccountInfo']['token'] === token;\n    });\n}\n\nif (msg.payload && msg.payload.length > 0) {\n    msg.payload.splice(1);\n    msg.payload.forEach((payload) => {\n        const storeList = payload['STORE_ID']['buckets'].map((store) => {\n            return store['key'];\n        });\n        \n        const resultFilterTokenFromList = findTokenFromGBPayAccountList(payload['key'], gbPayAccountList);\n        \n        if (resultFilterTokenFromList) {\n            tempPayload.push({\n                \"storeID\": storeList,\n                \"token\": resultFilterTokenFromList['gbPayAccountInfo']['token'],\n                \"secret_key\": resultFilterTokenFromList['gbPayAccountInfo']['secret_key']\n            });\n        }\n        \n    });\n}\n\nmsg.mapped_store_token = tempPayload;\n\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":580,"wires":[["9599d64.00de128","ed299938.d229d8"]]},{"id":"9599d64.00de128","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1310,"y":620,"wires":[]},{"id":"cb75bfe6.b8629","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1930,"y":80,"wires":[]},{"id":"3a852bf2.184b74","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2310,"y":220,"wires":[["da693c9c.10df4","bb809a8c.a363f8"]]},{"id":"23a175a5.7f910a","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_status_txn","tls":"","proxy":"","authType":"basic","x":2450,"y":80,"wires":[[]]},{"id":"482c7ea2.c82c5","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2490,"y":160,"wires":[]},{"id":"381ef0a7.ef7df","type":"http in","z":"bf8f440.22744c","name":"","url":"/logReceiver","method":"post","upload":false,"swaggerDoc":"","x":420,"y":200,"wires":[["a03ead54.b5ee3","1a4d6911.d73a77"]]},{"id":"320b4e85.41e5d2","type":"http response","z":"bf8f440.22744c","name":"","statusCode":"","headers":{},"x":840,"y":200,"wires":[]},{"id":"a03ead54.b5ee3","type":"debug","z":"bf8f440.22744c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":820,"y":280,"wires":[]},{"id":"1a4d6911.d73a77","type":"function","z":"bf8f440.22744c","name":"","func":"msg.payload = Buffer.from(msg.payload);\nmsg.payload = msg.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":200,"wires":[["320b4e85.41e5d2","2820ff25.7eabb"]]},{"id":"2820ff25.7eabb","type":"debug","z":"bf8f440.22744c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":810,"y":240,"wires":[]},{"id":"81ddb767.de9318","type":"http in","z":"370ebe73.42de32","name":"","url":"/createHomepageEnvFile","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1620,"wires":[["2eb4130f.636b0c"]]},{"id":"2eb4130f.636b0c","type":"switch","z":"370ebe73.42de32","name":"with ?env querystring or not","property":"payload.env","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":1620,"wires":[["5e2933e3.23572c"],["b8efdd07.61eee"]]},{"id":"5e2933e3.23572c","type":"switch","z":"370ebe73.42de32","name":"env spliiter","property":"payload.env","propertyType":"msg","rules":[{"t":"eq","v":"dev","vt":"str"},{"t":"eq","v":"alpha","vt":"str"},{"t":"eq","v":"beta","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":470,"y":1740,"wires":[["7268a974.c6a298"],["c27c24d.6f8aad8"],["86b1b7f2.771618"]]},{"id":"654b9c2c.47bd94","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":990,"y":1640,"wires":[]},{"id":"b8efdd07.61eee","type":"change","z":"370ebe73.42de32","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing env querystring, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":1600,"wires":[["654b9c2c.47bd94"]]},{"id":"aa3cbaf.0525248","type":"http response","z":"370ebe73.42de32","name":"","statusCode":"","headers":{},"x":1190,"y":1860,"wires":[]},{"id":"f1711e86.8930f","type":"file in","z":"370ebe73.42de32","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"utf8","x":990,"y":1820,"wires":[["781b8108.1a387"]]},{"id":"781b8108.1a387","type":"change","z":"370ebe73.42de32","name":"Set Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers.content-type","pt":"msg","to":"text/plain","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":1860,"wires":[["aa3cbaf.0525248","4231f43d.dbd26c"]]},{"id":"24a5595c.7a5f86","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":1680,"wires":[]},{"id":"4231f43d.dbd26c","type":"debug","z":"370ebe73.42de32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1230,"y":1940,"wires":[]},{"id":"9006efed.94dcb","type":"file","z":"370ebe73.42de32","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":990,"y":1740,"wires":[["5872a715.333948"]]},{"id":"5872a715.333948","type":"function","z":"370ebe73.42de32","name":"Response with created filename","func":"let filename = msg.filename;\nmsg.filename = filename;\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":1780,"wires":[["f1711e86.8930f"]]},{"id":"7268a974.c6a298","type":"function","z":"370ebe73.42de32","name":"dev","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='dev-arislab-platform'\nnes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-dev'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://dev.arislab.ai/'\nAPI_URL='https://dev.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab-dev.auth0.com'\nAUTH0_CLIENT_ID='Jqr8WyfSYqgiw1NgRlQ2f0UJLi8aWOgb'\nAUTH0_CLIENT_SECRET='ciGvXGgVeMBIGXJHRAYTfCkIS5Bk6HnfaUbif1bf-HUZnaPiPTRVNvqgOjK2tmPT'\nAUTH0_SAML_IDP_CERT_FILE='arislab-dev.pem'\n#AUTH0_DOMAIN='arislab.auth0.com'\n#AUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\n#AUTH0_CLIENT_SECRET='WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\n#AUTH0_SAML_IDP_CERT_FILE='arislab.pem'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://dev.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://dev.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\nLOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\n\n#LINE\nSERVER_NAME='DEV'\nENABLE_NOTIFICATION=true\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='TLLWgLJwSql5VHXoMB2px1n4BCEhATMo'\nGB_PAY_GATEWAY='https://api.globalprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1700,"wires":[["9006efed.94dcb"]]},{"id":"c27c24d.6f8aad8","type":"function","z":"370ebe73.42de32","name":"alpha","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='alpha-arislab-platform'\nnes='elastic:4KYpEDDrxGod9rddatrxmSKX@e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243'\n\n#API\nINSTANCE_NAME='arislab-uat'\nINSTANCE_EMAIL='origin@convolab.ai'\nINSTANCE_PASS='1qazZAQ!'\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n#PLATFORM_FACEBOOK_APP_ID='222468068422440'\n#FACEBOOK_APP_SECRET='527af72b036bd44de6b3280e29adafa6'\n\n#RVP\nWEB_URL='https://alpha.arislab.ai/'\nAPI_URL='https://alpha.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nPLATFORM_HOST='localhost'\nPLATFORM_PORT=3000\nSECURESITE_HOST='localhost'\nSECURESITE_PORT=1380\nMEDIA_HOST='localhost'\nMEDIA_PORT=8000\nMEDIA_WEB_HOST='localhost'\nMEDIA_WEB_PORT=4080\nSERVICE_STATUS_HOST='localhost'\nSERVICE_STATUS_PORT=1150\nSTREAM_STATUS_HOST='localhost'\nSTREAM_STATUS_PORT=1112\nWEBHOOK_HOST='localhost'\nWEBHOOK_PORT=3111\nQUEUESERVICE_HOST='localhost'\nQUEUESERVICE_PORT=1415\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n#SSL_CUSTOM_CERT=\n#SSL_CUSTOM_PEM=\nAUTH0_DOMAIN='arislab.auth0.com'\nAUTH0_CLIENT_ID='6XmLzLa5uAUb44VQeALbBcOyFlHZf3CN'\nAUTH0_CLIENT_SECRET='ADW2KScxB32-WbEkF5TpTtfU7qP4XEGl7qdi7gbsLD6JaCCQEQwY7kfD09v7VxG-QZoDcjL-CLdf'\nAUTH0_SAML_IDP_CERT_FILE='arislab.pem'\n\n#MEDIA\nWEB_PORT=4080\n\n#SECURESITE\nPAYMENT_RESPONSE_URL='https://alpha.arislab.ai/site/payment/checkout/result'\nPAYMENT_WEBHOOK_URL='https://alpha.arislab.ai/webhook'\nANDROID_APP_URL='https://play.google.com/store/apps/details?id=ai.arislab.arislive'\nIOS_APP_URL='https://apps.apple.com/us/app/aris/id1466936667'\n\n#LOG\nLOG_DESTINATION='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FOLDER='/home/arislab-core/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\n\n#LINE\nSERVER_NAME='ALPHA'\nENABLE_NOTIFICATION=true\n#LINE_NOTIFY_TOKEN='2830X9j2EqirUrFnxtHHd0Sli7edHKpvlhTVnAm3zuJ'\nLINE_NOTIFY_TOKEN='A6TrQ8t1Icin8DvXi8dYVK4qCwk5faNRvySSUQleEnc'\nNOTIFICATION_TIME_INTERVAL=1800\n\n#CHATBOT\nCHATBOT_OUT_OF_STOCK_MESSAGE='ขออภัยค่ะ สินค้าที่ต้องการชำระเงินหมดพอดีเลยค่ะ 😅'\nCHATBOT_PRODUCT_OUT_OF_BOOKING_MESSAGE='ขออภัยค่ะ คุณไม่ได้ชำระค่าสินค้าภายในระยะเวลาที่กำหนด กรุณากดสั่งซื้อสินค้าใหม่อีกครั้งนะคะ 😅'\nIS_SCALE_BOT='true'\nMSG_REFRESH_URL='https://msg.convolab.ai/aris/refresh'\nMSG_PURGE_URL='https://msg.convolab.ai/aris/purge'\n\n#BULKSMS\nBULKSMS_URL='https://api.bulksms.com/v1/messages'\nBULKSMS_USERNAME='nattaponk'\nBULKSMS_PASSWORD='3edcCDE#'\n\n#GB_PAY\nDEFAULT_GB_PAY_TOKEN='yrFKx7r0eZTfEQKJUdRunZTtKOAXthFLZQ4ds0AdDSZpDMQaSEw9mw2+EyYn9FsgZm3gwvrlgMq5KRl0l5Rw/p40fbZ10rkUYkrFDJT3lg81LtfcpgL0gVbuU0mqc10L2ErhxSZrHqYgY8SCRWFTou03yoDKkaKZxlpdPM7XdblRfQLT'\nGB_PAY_SECRET_KEY='PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz'\nGB_PAY_GATEWAY='https://api.gbprimepay.com/'\nGB_PAY_FEE=20\nGB_PAY_AMOUNT_FOR_NO_FEE=50000\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1740,"wires":[["9006efed.94dcb"]]},{"id":"86b1b7f2.771618","type":"function","z":"370ebe73.42de32","name":"beta","func":"let env = msg.env\n\nmsg.payload = `\n#DB\nnuser='arislab-platform'\nnpwd='arislab-platform'\ndb_index='arislab-platform'\nnes='elastic:Ptox6rGdRdhr5gajOIZBXZQn@893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243'\n\n#FB APP\nPLATFORM_FACEBOOK_APP_ID='502170539988549'\nFACEBOOK_APP_SECRET='73fc7474f3879738ac173d845c473930'\n\n#RVP\nWEB_URL='https://landing.arislab.ai/'\nAPI_URL='https://landing.arislab.ai/api/'\nAPI_HOST='localhost'\nAPI_PORT=1780\nHOMEPAGE_HOST='localhost'\nHOMEPAGE_PORT=5000\nRVP_PORT=80\nRVP_PORT_TLS=1843\nDOMAIN_ALLOW_ORIGIN='*'\nXPOWEREDBY='ArisLab'\n\n#LOG\nLOG_DESTINATION='/home/arislab.ai/arislab-console/console/public/logs'\nLOG_FOLDER='/home/arislab.ai/arislab-console/console/public/logs'\nLOG_FILE='./logs/main.log'\nlog='debug'\n\n`;\nmsg.filename = `/env_${env}_${Date.now()}.txt`;\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1780,"wires":[["9006efed.94dcb"]]},{"id":"107f8936.c2f437","type":"change","z":"c4594cab.1347","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":160,"wires":[["32848818.e6d008"]]},{"id":"3098f74d.7c6cd8","type":"change","z":"c4594cab.1347","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":200,"wires":[["32848818.e6d008"]]},{"id":"e10ca5e.e137e58","type":"change","z":"c4594cab.1347","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":240,"wires":[["32848818.e6d008"]]},{"id":"32848818.e6d008","type":"function","z":"c4594cab.1347","name":"SET_ORDER_ID_TO_API","func":"msg.url+= `?orderID=${msg.orderDocID}`;\n\nnode.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":160,"wires":[["d00a8886.b32038"]]},{"id":"d96983cc.22561","type":"http in","z":"c4594cab.1347","name":"","url":"/checkSingleOrderStatus","method":"get","upload":false,"swaggerDoc":"","x":140,"y":160,"wires":[["89a5245c.0deff8"]]},{"id":"7d073f2e.577b3","type":"function","z":"c4594cab.1347","name":"","func":"let orderDocID = msg.payload.orderDocID;\n\nmsg.orderDocID = orderDocID;\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":160,"wires":[["e10ca5e.e137e58"]]},{"id":"89a5245c.0deff8","type":"switch","z":"c4594cab.1347","name":"with ?orderDocID querystring or not","property":"payload.orderDocID","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":160,"wires":[["7d073f2e.577b3"],["45634f64.3cf97"]]},{"id":"45634f64.3cf97","type":"function","z":"c4594cab.1347","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Order ID must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":200,"wires":[["af2752c8.1397c"]]},{"id":"af2752c8.1397c","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":370,"y":240,"wires":[]},{"id":"d00a8886.b32038","type":"http request","z":"c4594cab.1347","name":"GET_ORDER","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1080,"y":200,"wires":[["3fb0e098.c598e"]]},{"id":"3fb0e098.c598e","type":"function","z":"c4594cab.1347","name":"SAVE_ORDER_TO_MSG_OBJ","func":"msg.orderInfo = msg.payload;\nmsg.orderInfo['orderDocID'] = msg.orderDocID;\nmsg.storeID = msg.orderInfo.storeID;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":240,"wires":[["4d268145.ec169"]]},{"id":"4d268145.ec169","type":"function","z":"c4594cab.1347","name":"SET_BODY_TO_GET_STORE_INFO","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/businessProfile/storeID/${msg.storeID}/`;\n\nreturn msg;","outputs":1,"noerr":0,"x":1490,"y":160,"wires":[["b9dd1396.dcb91"]]},{"id":"b9dd1396.dcb91","type":"http request","z":"c4594cab.1347","name":"GET_STORE_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1440,"y":200,"wires":[["e83e7829.8f9698"]]},{"id":"4558ff64.00d6c","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":4150,"y":380,"wires":[]},{"id":"e83e7829.8f9698","type":"function","z":"c4594cab.1347","name":"SAVE_STORE_TO_MSG_OBJ","func":"msg.storeInfo = msg.payload;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1470,"y":240,"wires":[["410b9b77.ec0f34"]]},{"id":"12a31380.78e25d","type":"http request","z":"c4594cab.1347","name":"GET_GB_ACCOUNT","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1840,"y":200,"wires":[["7f842e58.d99af"]]},{"id":"410b9b77.ec0f34","type":"function","z":"c4594cab.1347","name":"SET_BODY_TO_GET_GB_ACCOUNT","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/gbpayAccount/findByToken`;\nmsg.payload = {\n    \"token\": msg.storeInfo.storeInfo.paymentInfo.gbPayInfo.token\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1890,"y":160,"wires":[["12a31380.78e25d"]]},{"id":"7f842e58.d99af","type":"function","z":"c4594cab.1347","name":"SAVE_GB_ACCOUNT_TO_MSG_OBJ","func":"msg.gbPayAccountObj = msg.payload.gbPayAccountInfo;\nmsg.gbPayAccountObj.found = true;\n\nmsg.currentOrder = msg.orderInfo;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1890,"y":240,"wires":[["77233093.e2129"]]},{"id":"77233093.e2129","type":"function","z":"c4594cab.1347","name":"CHECK_WITH_REFNO","func":"let order = msg.orderInfo;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\n// let gbPayLink = order['paymentInfo']['gbPayLink'];\n// let gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2330,"y":160,"wires":[["53fe88b7.5f25d8"]]},{"id":"53fe88b7.5f25d8","type":"function","z":"c4594cab.1347","name":"SET_HEADERS","func":"const gbPayAccountObj = msg.gbPayAccountObj;\n\nvar SECRET_KEY = \"\";\n\nif (gbPayAccountObj['found']) {\n    SECRET_KEY = gbPayAccountObj['secret_key'];\n}\n\nmsg.headers = {}\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nmsg.url = \"https://api.gbprimepay.com/v1/check_status_txn\";\n\n// node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":180,"wires":[["13b2a46f.ca69bc"]]},{"id":"13b2a46f.ca69bc","type":"http request","z":"c4594cab.1347","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2670,"y":220,"wires":[["24659a3c.54cb26","f5ee535a.03818"]]},{"id":"2a6bbad5.250096","type":"function","z":"c4594cab.1347","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2330,"y":220,"wires":[["53fe88b7.5f25d8"]]},{"id":"24659a3c.54cb26","type":"switch","z":"c4594cab.1347","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2680,"y":280,"wires":[["5e2302a0.fc277c"],["4d971bf1.8c0a44"]]},{"id":"5e2302a0.fc277c","type":"function","z":"c4594cab.1347","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"let gbResponseObj = msg.payload;\nmsg.gbResponseObj = gbResponseObj;\n\nlet apiUrl = msg.apiUrl;\n\nlet currentOrder = msg.currentOrder;\nlet storeID = currentOrder['storeID'];\nlet orderDocID = currentOrder['orderDocID'];\nlet paymentMethod = gbResponseObj['txn']['status'];\nlet gbpReferenceNo = gbResponseObj['txn']['gbpReferenceNo'];\n// let paymentCompletedOn = paymentResponseObj.paymentCompletedOn;\n\n\nvar paymentStatus = \"PENDING\";\n\nif( gbResponseObj['txn'].hasOwnProperty('cardNo') ) {\n    paymentMethod = \"CREDIT_CARD\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'S') {\n    paymentMethod = \"QR_CODE\";\n    // paymentMethod = \"PAID\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'A') {\n    paymentMethod = \"CREDIT_CARD\";\n    paymentStatus = \"SUCCESS\";\n} else if (paymentMethod === 'D') {\n    paymentMethod = \"DECLINE\";\n    paymentStatus = \"FAIL\";\n} else if (paymentMethod === 'G') {\n    paymentMethod = \"QR_CODE\";\n    paymentStatus = \"SUCCESS\";\n}\n\ncurrentOrder['resultPaymentStatus'] = paymentStatus;\nmsg.currentOrder = currentOrder;\n\n// let customerInfo = paymentResponseObj.customerInfo;\n\nlet url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\n\nmsg.url = url;\nmsg.payload = {\n    \"paymentInfo\": {\n        \"method\": paymentMethod,\n        \"status\": paymentStatus,\n        \"details\": gbpReferenceNo,\n        // \"paymentCompletedOn\": paymentCompletedOn,\n        \"isFromBatchCheck\": true,\n        \"batchCheckTimestamp\": Date.now(),\n        \"gbPaymentDetails\": {\n            \"customerName\": gbResponseObj['txn']['customerName'],\n            \"customerEmail\": gbResponseObj['txn']['customerEmail'],\n            // \"customerAddress\": gbResponseObj['txn']['customerName'],\n            // \"customerTelephone\": gbResponseObj['txn']['customerName']\n        }\n    }\n}\n\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":3140,"y":260,"wires":[["c0ff8c49.e0751"]]},{"id":"ebd89323.50948","type":"function","z":"c4594cab.1347","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let currentOrder = msg.currentOrder;\nlet recipientAccountType = currentOrder['recipientAccountType'];\nlet paymentStatus = currentOrder['resultPaymentStatus'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":3450,"y":300,"wires":[["73b3d1e3.23d7c"],["e19e6eb3.e94b7"]]},{"id":"4d971bf1.8c0a44","type":"switch","z":"c4594cab.1347","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2760,"y":340,"wires":[["c425a125.d7481"],["1b7f277b.467a09"]]},{"id":"1b7f277b.467a09","type":"function","z":"c4594cab.1347","name":"Can't find REF_NO and LINK_NO 😢","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${orderID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)","outputs":1,"noerr":0,"x":2970,"y":400,"wires":[[]]},{"id":"c425a125.d7481","type":"link out","z":"c4594cab.1347","name":"LINK_NO_OUT","links":["d4c24441.d948c8","157c055c.d842db","7c5ee746.8bbe18"],"x":2915,"y":320,"wires":[]},{"id":"7c5ee746.8bbe18","type":"link in","z":"c4594cab.1347","name":"","links":["c425a125.d7481"],"x":2175,"y":220,"wires":[[]]},{"id":"e19e6eb3.e94b7","type":"function","z":"c4594cab.1347","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nnode.error(`Recipient type of this order (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`)","outputs":1,"noerr":0,"x":3520,"y":360,"wires":[[]]},{"id":"63663bfd.ea9364","type":"http request","z":"c4594cab.1347","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3920,"y":380,"wires":[["4558ff64.00d6c"]]},{"id":"73b3d1e3.23d7c","type":"function","z":"c4594cab.1347","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":3940,"y":260,"wires":[["8ecd3b3c.a2e568"]]},{"id":"8ecd3b3c.a2e568","type":"http request","z":"c4594cab.1347","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3900,"y":300,"wires":[["6ae27f2f.cef45"]]},{"id":"6ae27f2f.cef45","type":"function","z":"c4594cab.1347","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":3950,"y":340,"wires":[["63663bfd.ea9364"]]},{"id":"c0ff8c49.e0751","type":"http request","z":"c4594cab.1347","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3080,"y":300,"wires":[["ebd89323.50948"]]},{"id":"d14610f6.e6274","type":"subflow:eaee04b7.92b4a8","z":"df1fdcc0.8c179","name":"","env":[],"x":630,"y":300,"wires":[["e852345.972d2c8","46217d5e.db1c44"]]},{"id":"b8060f53.c72ff","type":"inject","z":"df1fdcc0.8c179","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":180,"wires":[["beaa9d56.5b02a"]]},{"id":"a7088d9c.ea44d","type":"inject","z":"df1fdcc0.8c179","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":320,"wires":[["fab060ae.efdba"]]},{"id":"82f0393c.7a7878","type":"inject","z":"df1fdcc0.8c179","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":460,"wires":[["9e51f1b4.f80b"]]},{"id":"8d096d52.568ce","type":"comment","z":"df1fdcc0.8c179","name":"DEV","info":"","x":330,"y":140,"wires":[]},{"id":"6c9ac13.5b3594","type":"comment","z":"df1fdcc0.8c179","name":"ALPHA","info":"","x":330,"y":280,"wires":[]},{"id":"136fed32.4b6333","type":"comment","z":"df1fdcc0.8c179","name":"PROD","info":"","x":330,"y":420,"wires":[]},{"id":"beaa9d56.5b02a","type":"change","z":"df1fdcc0.8c179","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":220,"wires":[[]]},{"id":"fab060ae.efdba","type":"change","z":"df1fdcc0.8c179","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":360,"wires":[[]]},{"id":"9e51f1b4.f80b","type":"change","z":"df1fdcc0.8c179","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":500,"wires":[["d14610f6.e6274"]]},{"id":"438c664f.97fd98","type":"function","z":"eaee04b7.92b4a8","name":"INIT_REQUEST_FOR_GETTING_UNENRICHED_ORDERS","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst url = `https://${nes}/${platform_index}/order/_search?size=100`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\nmsg.payload = {\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"exists\": {\n            \"field\": \"userInfo.firstName\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.firstName.keyword\": \"\"\n          }\n        },\n        {\n          \"match\": {\n            \"userInfo.lastName.keyword\": \"\"\n          }\n        }\n      ]\n    }\n  }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":180,"wires":[["f72dfa6.4eda608","994d7504.85c448"]]},{"id":"f72dfa6.4eda608","type":"debug","z":"eaee04b7.92b4a8","name":"GET_UNENRICHED_ORDERS_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":180,"wires":[]},{"id":"4e800205.aebb1c","type":"debug","z":"eaee04b7.92b4a8","name":"GET_UNENRICHED_ORDERS_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":220,"wires":[]},{"id":"32ca54e7.3e88fc","type":"debug","z":"eaee04b7.92b4a8","name":"GET_UNENRICHED_ORDERS_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":260,"wires":[]},{"id":"2988a4ac.5c101c","type":"change","z":"eaee04b7.92b4a8","name":"","rules":[{"t":"set","p":"unenrichedOrders","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":260,"wires":[["32ca54e7.3e88fc"]]},{"id":"994d7504.85c448","type":"http request","z":"eaee04b7.92b4a8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":330,"y":220,"wires":[["4e800205.aebb1c","2988a4ac.5c101c"]]},{"id":"359ad90b.8906e6","type":"subflow:279aa9ae.249436","z":"eaee04b7.92b4a8","name":"","env":[],"x":370,"y":140,"wires":[["438c664f.97fd98"]]},{"id":"e852345.972d2c8","type":"debug","z":"df1fdcc0.8c179","name":"GET_UNENRICHED_ORDERS_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":990,"y":300,"wires":[]},{"id":"41d03af6.5dea24","type":"function","z":"9bfa29fe.7e3298","name":"INIT_REQUEST_FOR_GETTING_USER_INFO","func":"const nes = msg.nes;\nconst nuser = msg.nuser;\nconst userPSID = msg.userPSID;\nconst url = `https://${nes}/njoin-${nuser}/user/${userPSID}`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nmsg.userInfo = {\n    \"firstName\": \"\",\n    \"lastName\": \"\"\n};\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":140,"wires":[["9260ffba.d9226","f7d884f3.e119b8"]]},{"id":"9260ffba.d9226","type":"debug","z":"9bfa29fe.7e3298","name":"GET_USER_INFO_BY_PSID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":140,"wires":[]},{"id":"55f6830d.3668ec","type":"debug","z":"9bfa29fe.7e3298","name":"GET_USER_INFO_BY_PSID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":180,"wires":[]},{"id":"56ab7b23.241d14","type":"debug","z":"9bfa29fe.7e3298","name":"GET_USER_INFO_BY_PSID_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":810,"y":680,"wires":[]},{"id":"3516f86d.60ecf8","type":"change","z":"9bfa29fe.7e3298","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload._source.info.facebook.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload._source.info.facebook.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":560,"wires":[["56ab7b23.241d14"]]},{"id":"dc276f7f.59945","type":"subflow:279aa9ae.249436","z":"9bfa29fe.7e3298","name":"","env":[],"x":290,"y":100,"wires":[["41d03af6.5dea24"]]},{"id":"46217d5e.db1c44","type":"function","z":"df1fdcc0.8c179","name":"ITERATE_OVER_UNENRICHED_ORDERS","func":"const unenrichedOrdersList = msg.unenrichedOrders.hits.hits;\n\nunenrichedOrdersList.forEach((order, index) => {\n    setTimeout(() => {\n        msg.UnenrichedOrderDocID = order._id;\n        msg.currentUnenrichedOrder = order._source;\n        msg.userPSID = order._source.userID;\n        node.send(msg);\n    }, 500 * index);\n});","outputs":1,"noerr":0,"x":660,"y":340,"wires":[["204a7f75.77f6"]]},{"id":"204a7f75.77f6","type":"subflow:9bfa29fe.7e3298","z":"df1fdcc0.8c179","name":"","env":[],"x":620,"y":380,"wires":[["ae7ec590.7d6a38","7b066b09.0aed74"]]},{"id":"ae7ec590.7d6a38","type":"debug","z":"df1fdcc0.8c179","name":"GET_USER_INFO_BY_PSID_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":980,"y":380,"wires":[]},{"id":"f7d884f3.e119b8","type":"http request","z":"9bfa29fe.7e3298","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":250,"y":180,"wires":[["55f6830d.3668ec","9b7a917a.8611b"]]},{"id":"a6b4d3fe.7ec81","type":"subflow:279aa9ae.249436","z":"6d5cace2.84fcb4","name":"","env":[],"x":350,"y":180,"wires":[["40998624.ab59d8"]]},{"id":"40998624.ab59d8","type":"function","z":"6d5cace2.84fcb4","name":"INIT_REQUEST_UPDATE_ORDER","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst docID = msg.UnenrichedOrderDocID;\n\nconst url = `https://${nes}/${platform_index}/order/${docID}/_update`;\n\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\n\nconst updateBody = msg.UnenrichedOrderUpdateBody;\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nmsg.payload = {\n    \"doc\": {\n        \"userInfo\": {\n            \"firstName\": updateBody['firstName'],\n            \"lastName\": updateBody['lastName']\n        }\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":220,"wires":[["67972704.0c6c88","4335b9b9.046ba8"]]},{"id":"67972704.0c6c88","type":"http request","z":"6d5cace2.84fcb4","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":310,"y":260,"wires":[["a228c233.96273"]]},{"id":"f88101bf.26e5","type":"subflow:6d5cace2.84fcb4","z":"df1fdcc0.8c179","name":"","env":[],"x":610,"y":500,"wires":[["5d6c2f79.84dc7"]]},{"id":"4335b9b9.046ba8","type":"debug","z":"6d5cace2.84fcb4","name":"UPDATE_ORDER_BY_ID_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":790,"y":220,"wires":[]},{"id":"a228c233.96273","type":"debug","z":"6d5cace2.84fcb4","name":"UPDATE_ORDER_BY_ID_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":260,"wires":[]},{"id":"5d6c2f79.84dc7","type":"function","z":"df1fdcc0.8c179","name":"","func":"if (msg.payload.result === \"updated\") {\n    node.error('Update userID: ' + msg.userPSID + ' of orderID: ' + msg.currentUnenrichedOrder.orderID + ' successful')\n}\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":540,"wires":[[]]},{"id":"7b066b09.0aed74","type":"function","z":"df1fdcc0.8c179","name":"","func":"msg.UnenrichedOrderUpdateBody = msg.userInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":440,"wires":[["f88101bf.26e5"]]},{"id":"9b7a917a.8611b","type":"function","z":"9bfa29fe.7e3298","name":"CHECK_USER_IS_UNDEFINED","func":"const sourceObj = msg.payload._source;\nconst fbName = sourceObj.info.facebook.name;\nconst fbPSID = sourceObj.info.facebook.id;\nconst pageToken = sourceObj.info._channel.config.token;\n\nif (\n    fbName === \"undefined undefined\" &&\n    sourceObj.info.facebook.hasOwnProperty('first_name') === false &&\n    sourceObj.info.facebook.hasOwnProperty('last_name') === false\n) {\n    node.error('This user info is un-enriched, re-enriching..');\n    msg.enrichPSID = fbPSID;\n    msg.enrichToken = pageToken;\n    return [msg, null];\n} else {\n    node.error('This user info is already enriched')\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":310,"y":340,"wires":[["6ecc7d1d.f32264"],["3516f86d.60ecf8"]]},{"id":"6ecc7d1d.f32264","type":"subflow:ca31d962.2b9aa8","z":"9bfa29fe.7e3298","name":"","env":[],"x":590,"y":280,"wires":[["765429df.35b0e8","6b9557fe.d74938"]]},{"id":"765429df.35b0e8","type":"debug","z":"9bfa29fe.7e3298","name":"enrich_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":920,"y":280,"wires":[]},{"id":"e2e05b0c.c4b4b8","type":"change","z":"9bfa29fe.7e3298","name":"","rules":[{"t":"set","p":"userInfo.firstName","pt":"msg","to":"payload.first_name","tot":"msg"},{"t":"set","p":"userInfo.lastName","pt":"msg","to":"payload.last_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":380,"wires":[[]]},{"id":"6b9557fe.d74938","type":"function","z":"9bfa29fe.7e3298","name":"CHECK_ENRICH_RESPONSE","func":"const reqResponse = msg.payload;\n\nif (\n    reqResponse.hasOwnProperty('first_name') &&\n    reqResponse.hasOwnProperty('last_name')\n) {\n    node.error('Enrich user successful');\n    return [msg, null];\n} else {\n    node.error('Error while enriching user: ');\n    node.error(reqResponse);\n    return [msg, null];\n}","outputs":2,"noerr":0,"x":660,"y":340,"wires":[["e2e05b0c.c4b4b8"],[]]},{"id":"6b1913c5.6d9e0c","type":"cronplus","z":"df1fdcc0.8c179","name":"","outputField":"payload","timeZone":"","options":[{"topic":"Every 5AM","payload":"","type":"str","expression":"0 5 * * *"}],"x":100,"y":320,"wires":[["9e51f1b4.f80b"]]},{"id":"ac75cb5a.46a8a8","type":"cronplus","z":"9aca2020.7fe83","name":"","outputField":"payload","timeZone":"","options":[{"topic":"Every 6AM","payload":"","type":"str","expression":"0 6 * * *"},{"topic":"Every 12PM","payload":"","type":"str","expression":"0 12 * * *"},{"topic":"Every 6PM","payload":"","type":"str","expression":"0 18 * * *"}],"x":80,"y":220,"wires":[[]]},{"id":"ab5596d8.c70618","type":"inject","z":"9aca2020.7fe83","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":80,"wires":[["cd39fd28.03bc8"]]},{"id":"6bb740d9.c2868","type":"inject","z":"9aca2020.7fe83","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":220,"wires":[["e924a51b.633f78"]]},{"id":"387377f1.eb0fb8","type":"inject","z":"9aca2020.7fe83","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":360,"wires":[["d4ba95e1.7b0538"]]},{"id":"71d71e44.b429e","type":"comment","z":"9aca2020.7fe83","name":"DEV","info":"","x":270,"y":40,"wires":[]},{"id":"f76af17d.a60d1","type":"comment","z":"9aca2020.7fe83","name":"ALPHA","info":"","x":270,"y":180,"wires":[]},{"id":"a9bb585e.642ca8","type":"comment","z":"9aca2020.7fe83","name":"PROD","info":"","x":270,"y":320,"wires":[]},{"id":"cd39fd28.03bc8","type":"change","z":"9aca2020.7fe83","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"dev-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":120,"wires":[["b674dd38.dfba8"]]},{"id":"e924a51b.633f78","type":"change","z":"9aca2020.7fe83","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"e865b4fe9f434efbaa337fd2e30e417c.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzo0S1lwRUREcnhHb2Q5cmRkYXRyeG1TS1g=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"alpha-arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":260,"wires":[["b674dd38.dfba8"]]},{"id":"d4ba95e1.7b0538","type":"change","z":"9aca2020.7fe83","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-prod","tot":"str"},{"t":"set","p":"nes","pt":"msg","to":"893a21fe51a74190932d97db0d466483.ap-southeast-1.aws.found.io:9243","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"headers","pt":"msg","to":"{\"Authorization\":\"Basic ZWxhc3RpYzpQdG94NnJHZFJkaHI1Z2FqT0laQlhaUW4=\"}","tot":"json"},{"t":"set","p":"platform_index","pt":"msg","to":"arislab-platform","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":400,"wires":[["b674dd38.dfba8"]]},{"id":"980dd14b.8ff0c","type":"function","z":"c0c31daa.5965f","name":"INIT_REQUEST_FOR_UPDATING_FIELD_WITH_SCRIPT","func":"const nes = msg.nes;\nconst platform_index = msg.platform_index;\nconst type = msg.updateType;\nconst url = `https://${nes}/${platform_index}/${type}/_update_by_query`;\nconst basicAuth = msg.ES_BASIC_AUTH_HEADER;\nconst query = JSON.parse(msg.updateQuery);\nconst script = JSON.parse(msg.updateScript);\n\nmsg.headers = {};\nmsg.headers['Authorization'] = `Basic ${basicAuth}`;\n\nmsg.url = url;\n\nlet tempPayload = {};\ntempPayload['query'] = query;\ntempPayload['script'] = script;\n\nmsg.payload = JSON.stringify(tempPayload);\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["d1df5ba0.ee3018","a32c5a66.c95818"]]},{"id":"99b28daa.722c6","type":"change","z":"c0c31daa.5965f","name":"","rules":[{"t":"set","p":"resultUpdateFieldWithScript","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":240,"wires":[["98aa49e3.7511d8"]]},{"id":"d1df5ba0.ee3018","type":"http request","z":"c0c31daa.5965f","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":290,"y":200,"wires":[["99b28daa.722c6","ca00f932.b2fd78"]]},{"id":"9c1cb3a9.46669","type":"subflow:279aa9ae.249436","z":"c0c31daa.5965f","name":"","env":[],"x":330,"y":120,"wires":[["980dd14b.8ff0c","f012f5df.de5888"]]},{"id":"c430ed14.2216c","type":"comment","z":"c0c31daa.5965f","name":"Params: updateType / updateQuery / updateScript","info":"**msg.updateType:** Type to update\n**msg.updateQuery:** Query to execute\n**msg.updateScript:** Script to execute","x":390,"y":60,"wires":[]},{"id":"7ffd6a50.223434","type":"subflow:c0c31daa.5965f","z":"9aca2020.7fe83","name":"","env":[],"x":1090,"y":220,"wires":[[]]},{"id":"6008a5b8.2af57c","type":"function","z":"9aca2020.7fe83","name":"[STORE] SET_FILTERDATE_FIELD","func":"msg.updateType = \"store\";\nmsg.updateQuery = JSON.stringify({\n    \"bool\": {\n        \"must_not\": [\n            { \"exists\": { \"field\": \"filterDate\" } }\n        ]\n    }\n});\n\nmsg.updateScript = JSON.stringify({\n    \"source\": \"ctx._source.filterDate = ctx._source.createdAt\",\n    \"lang\": \"painless\"\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":220,"wires":[["7ffd6a50.223434"]]},{"id":"f012f5df.de5888","type":"debug","z":"c0c31daa.5965f","name":"UPDATE_FIELD_WITH_SCRIPT_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":120,"wires":[]},{"id":"a32c5a66.c95818","type":"debug","z":"c0c31daa.5965f","name":"UPDATE_FIELD_WITH_SCRIPT_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":160,"wires":[]},{"id":"ca00f932.b2fd78","type":"debug","z":"c0c31daa.5965f","name":"UPDATE_FIELD_WITH_SCRIPT_debug3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":200,"wires":[]},{"id":"98aa49e3.7511d8","type":"debug","z":"c0c31daa.5965f","name":"UPDATE_FIELD_WITH_SCRIPT_debug4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":240,"wires":[]},{"id":"c8b1d934.6dcf48","type":"function","z":"9aca2020.7fe83","name":"[PRODUCT] SET_FILTERDATE_FIELD","func":"msg.updateType = \"product\";\nmsg.updateQuery = JSON.stringify({\n    \"bool\": {\n        \"must_not\": [\n            { \"exists\": { \"field\": \"filterDate\" } }\n        ]\n    }\n});\n\nmsg.updateScript = JSON.stringify({\n    \"source\": \"if (ctx._source.containsKey(\\\"productInfo\\\") && ctx._source.productInfo.containsKey(\\\"createAt\\\")) { ctx._source.filterDate = ctx._source.productInfo.createAt }\",\n    \"lang\": \"painless\"\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":260,"wires":[["28fdc01a.b1db"]]},{"id":"eca16779.891db8","type":"function","z":"9aca2020.7fe83","name":"[ORDER] SET_FILTERDATE_FIELD","func":"msg.updateType = \"order\";\nmsg.updateQuery = JSON.stringify({\n    \"bool\": {\n        \"must_not\": [\n            { \"exists\": { \"field\": \"filterDate\" } }\n        ]\n    }\n});\n\nmsg.updateScript = JSON.stringify({\n    \"source\": \"ctx._source.filterDate = ctx._source.orderDate\",\n    \"lang\": \"painless\"\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":300,"wires":[["2c21f8e.3af3708"]]},{"id":"28fdc01a.b1db","type":"subflow:c0c31daa.5965f","z":"9aca2020.7fe83","name":"","env":[],"x":1090,"y":260,"wires":[[]]},{"id":"2c21f8e.3af3708","type":"subflow:c0c31daa.5965f","z":"9aca2020.7fe83","name":"","env":[],"x":1090,"y":300,"wires":[[]]},{"id":"b674dd38.dfba8","type":"function","z":"9aca2020.7fe83","name":"","func":"node.error('Updating fields...')\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":260,"wires":[["eca16779.891db8","c8b1d934.6dcf48","6008a5b8.2af57c"]]},{"id":"d4aefec0.5c1d","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"node.error(`Can't check order, error:`);\nnode.error(msg.payload)\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":520,"wires":[["7a200a9d.f7d954"]]},{"id":"162dd4ea.d95ebb","type":"http in","z":"7aca8d6b.5bd9a4","name":"","url":"/getPlatformPackage","method":"get","upload":false,"swaggerDoc":"","x":150,"y":120,"wires":[["74588d41.e7fc34"]]},{"id":"a1c5cac6.eb3d88","type":"function","z":"7aca8d6b.5bd9a4","name":"CHECK_QUERY_PARAMS","func":"let packageName = msg.payload.packageName;\nlet data;\n\nif( typeof packageName == 'undefined' ) {\n    data = msg.PACKAGE_LIST;\n} else {\n    packageName = packageName.toUpperCase();\n    if( msg.PACKAGE_NAME_INDEX.hasOwnProperty(packageName) ) {\n        let index = msg.PACKAGE_NAME_INDEX[packageName];\n        data = msg.PACKAGE_LIST[index];\n    } else {\n        data = msg.PACKAGE_LIST;\n    }\n}\n\n\nmsg.statusCode = 200;\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":160,"wires":[["75330786.4151d8"]]},{"id":"75330786.4151d8","type":"http response","z":"7aca8d6b.5bd9a4","name":"","statusCode":"","headers":{},"x":630,"y":160,"wires":[]},{"id":"74588d41.e7fc34","type":"function","z":"7aca8d6b.5bd9a4","name":"SET_ALL_PACKAGE","func":"\nconst PACKAGE_LIST = [\n    {\n        \"name\": \"Free Trial\",\n        \"code\": \"000\",\n        \"description\": \"1 Month\",\n        \"isSubscribePackage\": false,\n        \"memberPrice\": 0,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"FIX\",\n            \"billingDate\": 0\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 0,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Beginner\",\n        \"code\": \"001\",\n        \"description\": \"\",\n        \"isSubscribePackage\": false,\n        \"memberPrice\": 0,\n        \"activeDays\": 36500,\n        \"billingInfo\": {\n            \"billingType\": \"\",\n            \"billingDate\": 0\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Standard\",\n        \"code\": \"002\",\n        \"description\": \"\",\n        \"isSubscribePackage\": true,\n        \"memberPrice\": 990,\n        //\"memberPrice\": 20,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"MONTHLY\",\n            \"billingDate\": 1\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 3,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Pro\",\n        \"code\": \"003\",\n        \"description\": \"\",\n        \"isSubscribePackage\": true,\n        \"memberPrice\": 4900,\n        //\"memberPrice\": 40,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"MONTHLY\",\n            \"billingDate\": 1\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 1,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    },\n    {\n        \"name\": \"Expert\",\n        \"code\": \"004\",\n        \"description\": \"\",\n        \"isSubscribePackage\": true,\n        \"memberPrice\": 9900,\n        //\"memberPrice\": 60,\n        \"activeDays\": 30,\n        \"billingInfo\": {\n            \"billingType\": \"MONTHLY\",\n            \"billingDate\": 1\n        },\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 0,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        }\n    }\n];\n\nconst PACKAGE_NAME_INDEX = {\n    \"DEFAULT\": 0,\n    \"FREE\": 0,\n    \"FREE TRIAL\": 0,\n    \"BEGINNER\": 1,\n    \"STANDARD\": 2,\n    \"PRO\": 3,\n    \"EXPERT\": 4\n};\n\n\nmsg.PACKAGE_LIST = PACKAGE_LIST;\nmsg.PACKAGE_NAME_INDEX = PACKAGE_NAME_INDEX;\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":120,"wires":[["a1c5cac6.eb3d88"]]},{"id":"6d25a8d9.2f1fb8","type":"http in","z":"d3a831f5.f8fec","name":"","url":"/_calculateServiceFee","method":"post","upload":false,"swaggerDoc":"","x":160,"y":400,"wires":[["e1281bf0.c93d78","5498a3b1.d6149c"]]},{"id":"e1281bf0.c93d78","type":"function","z":"d3a831f5.f8fec","name":"SET_DEFAULT_FEE_PERCENTAGE","func":"let payloadData = msg.payload;\nlet nuser = payloadData.nuser;\nlet paymentInfo = payloadData.paymentInfo;\nlet storeID = payloadData.storeID;\n\nvar feePercentage = {\n    \"DEV\": {\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        },\n        \"apiUrl\": \"http://console.internal.arislab.ai:1780/api\"\n    },\n    \"ALPHA\": {\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        },\n        \"apiUrl\": \"http://console.cb-alpha.arislab.ai:1780/api\"\n    },\n    \"PROD\": {\n        \"feeInfo\": {\n            \"service\": {\n                \"feeName\": \"SERVICE\",\n                \"charge\": 4,\n                \"chargeType\": \"PERCENT\"\n            },\n            \"qrCodeService\": {\n                \"feeName\": \"QR_CODE\",\n                \"charge\": 1, \n                \"chargeType\": \"PERCENT\"\n            },\n            \"creditCardService\": {\n                \"feeName\": \"CREDIT_CARD\",\n                \"charge\": 2.9,\n                \"chargeType\": \"PERCENT\"\n            }\n        },\n        \"apiUrl\": \"http://console.cb-beta.arislab.ai:1780/api\"\n    },\n};\n\nlet env = \"\";\nswitch(nuser) {\n    case \"arislab-dev\":\n        env = \"DEV\";\n        break;\n    case \"arislab-uat\":\n        env = \"ALPHA\";\n        break;\n    default:\n        env = \"PROD\";\n}\n\n\nmsg.defaultFeeInfo = feePercentage[env][\"feeInfo\"];\nmsg.apiUrl = feePercentage[env][\"apiUrl\"];\nmsg.storeID = storeID;\nmsg.paymentInfo = paymentInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":400,"wires":[["67b0b1a4.98f5a","3ac93e14.87a1d2"]]},{"id":"5498a3b1.d6149c","type":"debug","z":"d3a831f5.f8fec","name":"REQUEST_POST_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":490,"y":340,"wires":[]},{"id":"67b0b1a4.98f5a","type":"debug","z":"d3a831f5.f8fec","name":"SET_DEFAULT_FEE_PERCENTAGE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":400,"wires":[]},{"id":"3ac93e14.87a1d2","type":"function","z":"d3a831f5.f8fec","name":"GET_CURRENT_STORE_PACKAGE","func":"let storeID = msg.storeID;\n\nlet requestUrl = `${msg.apiUrl}/storePackage/storeID/${storeID}/current`;\nmsg.url = requestUrl;\n\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":440,"wires":[["db7ee10c.33013"]]},{"id":"db7ee10c.33013","type":"http request","z":"d3a831f5.f8fec","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":470,"y":480,"wires":[["a3f173d3.0ca92","c0481cfd.66e01"]]},{"id":"91d7fae1.2ed228","type":"http response","z":"d3a831f5.f8fec","name":"","statusCode":"","headers":{},"x":450,"y":640,"wires":[]},{"id":"a3f173d3.0ca92","type":"debug","z":"d3a831f5.f8fec","name":"RESULT_CURRENT_STORE_PACKAGE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":930,"y":480,"wires":[]},{"id":"1d2aa45e.fb3dfc","type":"function","z":"d3a831f5.f8fec","name":"CHECK_PAYMENT_KEY_DATA","func":"let paymentInfo = msg.paymentInfo;\nlet paymentKeyData = \"\";\n\nif( paymentInfo.hasOwnProperty('cardNo') && paymentInfo.cardNo.length > 0 ) {\n    paymentKeyData = \"creditCardService\";\n    paymentMethod = \"CREDIT_CARD\";\n} else {\n    paymentKeyData = \"qrCodeService\";\n    paymentMethod = \"QR_CODE\";\n}\n\nmsg.paymentKeyData = paymentKeyData;\nmsg.paymentMethod = paymentMethod;\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":560,"wires":[["6d37fd61.3d1e84","fd0bc3f0.a5ff9"]]},{"id":"c0481cfd.66e01","type":"function","z":"d3a831f5.f8fec","name":"SET_PACKAGE_FEE_INFO","func":"let payloadData = msg.payload;\nlet packageFeeInfo;\n\nif( payloadData.length > 0 ) {\n    packageFeeInfo = payloadData[0]['packageInfo']['feeInfo'];\n} else {\n    packageFeeInfo = msg.defaultFeeInfo;\n}\n\nmsg.packageFeeInfo = packageFeeInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":520,"wires":[["1d2aa45e.fb3dfc","686db98a.bbafa8"]]},{"id":"6d37fd61.3d1e84","type":"function","z":"d3a831f5.f8fec","name":"CALCULATE_PAYMENT_FEE","func":"let paymentKeyData = msg.paymentKeyData;\nlet paymentMethod = msg.paymentMethod;\nlet packageFeeInfo = msg.packageFeeInfo;\nlet paymentInfo = msg.paymentInfo;\n\nlet amount = Number(paymentInfo.amount);\nlet paymentGatewayFeeInfo = {};\nlet feeList = [];\nlet fee = 0;\n\n\nfunction calculateFee(feeType, packageFeeInfo) {\n    let returnObj = {};\n    if( packageFeeInfo.hasOwnProperty(feeType) ) {\n        returnObj = packageFeeInfo[feeType];\n        \n        let charge = returnObj['charge'];\n        let amountCharge = 0;\n        if( returnObj['chargeType'] === \"PERCENT\" ) {\n            amountCharge = Number( parseFloat((amount * charge) / 100).toFixed(2) );\n        } else {\n            amountCharge = Number( parseFloat(amount - charge) );\n        }\n        \n        \n        returnObj['serviceType'] = ( feeType === \"service\" ) ? \"SERVICE_FEE\" : \"PAYMENT_GATEWAY_FEE\" ;\n        returnObj['amountCharge'] = amountCharge;\n    }\n    \n    return returnObj;\n}\n\nlet serviceFeeInfo = calculateFee('service', packageFeeInfo);\nlet paymentFeeInfo = calculateFee(paymentKeyData, packageFeeInfo);\n\nif( serviceFeeInfo.hasOwnProperty('amountCharge') ) {\n    fee+= serviceFeeInfo['amountCharge'];\n    feeList.push(serviceFeeInfo);\n}\n    \nif( paymentFeeInfo.hasOwnProperty('amountCharge') ) {\n    fee+= paymentFeeInfo['amountCharge'];\n    feeList.push(paymentFeeInfo);\n}\n\n\n// if( packageFeeInfo.hasOwnProperty('service') ) {\n//     let serviceFeeInfo = packageFeeInfo['service'];\n//     let charge = serviceFeeInfo['charge'];\n//     let amountCharge = 0;\n//     if( serviceFeeInfo['chargeType'] === \"PERCENT\" ) {\n//         amountCharge = Number( parseFloat((amount * charge) / 100).toFixed(2) );\n//     } else {\n//         amountCharge = Number( parseFloat(amount - charge) );\n//     }\n    \n//     fee+= amountCharge;\n    \n//     serviceFeeInfo['serviceType'] = \"SERVICE_FEE\";\n//     serviceFeeInfo['amountCharge'] = amountCharge;\n// }\n\nlet totalAmount = amount - fee;\n\nmsg.payload = {\n    \"paymentMethod\": paymentMethod,\n    \"amount\": amount,\n    \"fee\": fee,\n    \"feeList\": feeList,\n    \"totalAmount\": totalAmount\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":600,"wires":[["91d7fae1.2ed228","85a47e21.fef92","59dacfb.5ebd03"]]},{"id":"686db98a.bbafa8","type":"debug","z":"d3a831f5.f8fec","name":"SET_PACKAGE_FEE_INFO_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":520,"wires":[]},{"id":"fd0bc3f0.a5ff9","type":"debug","z":"d3a831f5.f8fec","name":"CHECK_PAYMENT_KEY_DATA_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":900,"y":560,"wires":[]},{"id":"85a47e21.fef92","type":"debug","z":"d3a831f5.f8fec","name":"CALCULATE_PAYMENT_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":600,"wires":[]},{"id":"59dacfb.5ebd03","type":"debug","z":"d3a831f5.f8fec","name":"RESPONSE_CALULATE_SERVICE_FEE_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":930,"y":640,"wires":[]},{"id":"2038f540.e2960a","type":"function","z":"c4594cab.1347","name":"PREPARE_CALCULATE_SERVICE_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateServiceFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    },\n    \"storeID\": currentOrder['storeID']\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":3800,"y":560,"wires":[["b5b3c720.7764b8"]]},{"id":"b5b3c720.7764b8","type":"http request","z":"c4594cab.1347","name":"CALCULATE_SERVICE_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":3770,"y":600,"wires":[["5f4c4996.2f15e8"]]},{"id":"5f4c4996.2f15e8","type":"function","z":"c4594cab.1347","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"feeList\": resultCalculate['feeList'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":3810,"y":640,"wires":[[]]},{"id":"8219b8d2.4a6c58","type":"function","z":"eb9ff6d6.6b53f8","name":"PREPARE_CALCULATE_SERVICE_FEE","func":"let currentOrder = msg.currentOrder;\nlet gbResponseObj = msg.gbResponseObj;\nlet cardNo = ( gbResponseObj.txn.hasOwnProperty('cardNo') ) ? gbResponseObj.txn.cardNo : \"\" ;\n\nmsg.url = \"https://manage.arislab.ai/calculateServiceFee\";\nmsg.payload = {\n    \"nuser\": msg.nuser,\n    \"paymentInfo\": {\n        \"amount\": currentOrder['summary']['grandTotal'],\n        \"cardNo\": cardNo\n    },\n    \"storeID\": currentOrder['storeID']\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2840,"y":760,"wires":[["7eb96948.5b33a8"]]},{"id":"7eb96948.5b33a8","type":"http request","z":"eb9ff6d6.6b53f8","name":"CALCULATE_SERVICE_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2810,"y":800,"wires":[["7b790110.37e4a"]]},{"id":"7b790110.37e4a","type":"function","z":"eb9ff6d6.6b53f8","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet currentOrder = msg.currentOrder;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = currentOrder['storeID'];\nlet amount = currentOrder['summary']['grandTotal'];\nlet orderID = currentOrder['orderID'];\nlet customerName = currentOrder['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"feeList\": resultCalculate['feeList'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":2850,"y":840,"wires":[[]]},{"id":"b1887f68.dea33","type":"comment","z":"c4594cab.1347","name":"New calculate service fee","info":"","x":3750,"y":520,"wires":[]},{"id":"58276326.54c8bc","type":"comment","z":"eb9ff6d6.6b53f8","name":"New calculate service fee","info":"","x":2790,"y":720,"wires":[]},{"id":"e9a54a00.2a9fc8","type":"inject","z":"d45fe8d5.c48c98","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":100,"wires":[["d08853c0.629a2"]]},{"id":"6eac35be.eddc8c","type":"inject","z":"d45fe8d5.c48c98","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":240,"wires":[["70bfd012.e1fea"]]},{"id":"95f85426.4cd7a8","type":"inject","z":"d45fe8d5.c48c98","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":380,"wires":[["fd4552ba.e7bd8"]]},{"id":"18b0bfc8.b096e","type":"comment","z":"d45fe8d5.c48c98","name":"DEV","info":"","x":150,"y":60,"wires":[]},{"id":"30f3a17c.4524ce","type":"comment","z":"d45fe8d5.c48c98","name":"ALPHA","info":"","x":150,"y":200,"wires":[]},{"id":"a3b8f518.544608","type":"comment","z":"d45fe8d5.c48c98","name":"PROD","info":"","x":150,"y":340,"wires":[]},{"id":"d08853c0.629a2","type":"change","z":"d45fe8d5.c48c98","name":"DEV","rules":[{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":140,"wires":[["af2b2166.42cf1"]]},{"id":"70bfd012.e1fea","type":"change","z":"d45fe8d5.c48c98","name":"ALPHA","rules":[{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":160,"y":280,"wires":[["af2b2166.42cf1"]]},{"id":"fd4552ba.e7bd8","type":"change","z":"d45fe8d5.c48c98","name":"PROD","rules":[{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":420,"wires":[["af2b2166.42cf1"]]},{"id":"e83a2acb.99a318","type":"function","z":"d45fe8d5.c48c98","name":"SET_ALL_PACKAGE_INTO_MSG","func":"let packageList = msg.payload;\n\nnode.error(\"Get all package: \");\nnode.error(packageList);\nmsg.PACKAGE_LIST = packageList;\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":180,"wires":[["a33b37ec.306b28"]]},{"id":"bee8e557.704658","type":"function","z":"d45fe8d5.c48c98","name":"SET_ALL_STORE_INTO_MSG","func":"let storeList = msg.payload;\n\nnode.error(\"Get all store: \");\nnode.error(storeList);\nmsg.STORE_LIST = storeList;\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":260,"wires":[["e46b71d1.12578"]]},{"id":"a33b37ec.306b28","type":"subflow:3c2507c8.c9fd68","z":"d45fe8d5.c48c98","name":"GET_ALL_STORE","env":[],"x":450,"y":220,"wires":[["bee8e557.704658"]]},{"id":"af2b2166.42cf1","type":"subflow:e6b945fb.d44a58","z":"d45fe8d5.c48c98","name":"GET_ALL_PACKAGE","env":[],"x":460,"y":140,"wires":[["e83a2acb.99a318"]]},{"id":"e46b71d1.12578","type":"function","z":"d45fe8d5.c48c98","name":"INITIAL_INDEX_STORE","func":"msg.indexStore = 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":140,"wires":[["762f0c7b.68c394"]]},{"id":"762f0c7b.68c394","type":"switch","z":"d45fe8d5.c48c98","name":"Index Store = STORE_LIST length?","property":"indexStore","propertyType":"msg","rules":[{"t":"lt","v":"STORE_LIST.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":940,"y":180,"wires":[["44571e57.06632"],["9bca3469.8debe8"]]},{"id":"bdf5e85f.a5c3a8","type":"comment","z":"d45fe8d5.c48c98","name":"STORE LOOP","info":"","x":870,"y":100,"wires":[]},{"id":"83e56090.fbdd8","type":"function","z":"d45fe8d5.c48c98","name":"INCREASE_INDEX_STORE","func":"msg.indexStore++;\nreturn msg;","outputs":1,"noerr":0,"x":920,"y":940,"wires":[["ef88bfa3.40c7c"]]},{"id":"ef88bfa3.40c7c","type":"delay","z":"d45fe8d5.c48c98","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1150,"y":940,"wires":[["5be6f86f.ba3ba8"]]},{"id":"5be6f86f.ba3ba8","type":"link out","z":"d45fe8d5.c48c98","name":"","links":["f4b84081.b8029","3cc94b42.40c124"],"x":1275,"y":940,"wires":[]},{"id":"f4b84081.b8029","type":"link in","z":"d45fe8d5.c48c98","name":"","links":["5be6f86f.ba3ba8"],"x":755,"y":180,"wires":[["762f0c7b.68c394"]]},{"id":"9bca3469.8debe8","type":"function","z":"d45fe8d5.c48c98","name":"END_STORE_LOOP","func":"node.error(\"End LOOP.\");\n\nreturn msg;","outputs":1,"noerr":0,"x":1280,"y":120,"wires":[[]]},{"id":"44571e57.06632","type":"function","z":"d45fe8d5.c48c98","name":"INITIAL_PROCESS_STORE","func":"let processStore = msg.STORE_LIST[msg.indexStore];\nmsg.processStore = processStore;\n\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":220,"wires":[["454509e6.f6a7a8"]]},{"id":"ca7f982b.fb3bf8","type":"function","z":"d45fe8d5.c48c98","name":"Has current store package","func":"node.error(`storeID: ${msg.processStore['storeID']} has current store package, 😃 ✔️ go next.....`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1360,"y":300,"wires":[["27ea847.6f57d7c"]]},{"id":"ba236468.5d26f8","type":"switch","z":"d45fe8d5.c48c98","name":"Process store has current store package?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1040,"y":320,"wires":[["ca7f982b.fb3bf8"],["c7bc0f9.418daf"]]},{"id":"c7bc0f9.418daf","type":"function","z":"d45fe8d5.c48c98","name":"Hasn't got current store package","func":"node.error(`storeID: ${msg.processStore['storeID']} hasn't got current store package. ❌`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1370,"y":340,"wires":[["56e6f13f.8b4b6"]]},{"id":"454509e6.f6a7a8","type":"subflow:94013090.2d433","z":"d45fe8d5.c48c98","name":"GET_CURRENT_STORE_PACKAGE","env":[],"x":990,"y":260,"wires":[["ba236468.5d26f8"]]},{"id":"64035a5b.176c34","type":"link in","z":"d45fe8d5.c48c98","name":"","links":["27ea847.6f57d7c","3477d1c0.183d2e"],"x":755,"y":940,"wires":[["83e56090.fbdd8"]]},{"id":"27ea847.6f57d7c","type":"link out","z":"d45fe8d5.c48c98","name":"","links":["3cc94b42.40c124","64035a5b.176c34"],"x":1655,"y":300,"wires":[]},{"id":"788cc03e.69757","type":"switch","z":"d45fe8d5.c48c98","name":"Current store has store package?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1800,"y":560,"wires":[["d81e5bff.992f78"],["6c490ebe.e8257"]]},{"id":"4befe062.ef7b1","type":"subflow:69d4cd1.f737134","z":"d45fe8d5.c48c98","name":"GET_ALL_STORE_PACKAGE","env":[],"x":1750,"y":500,"wires":[["788cc03e.69757"]]},{"id":"6c490ebe.e8257","type":"function","z":"d45fe8d5.c48c98","name":"Hasn't got any store package","func":"let packageList = msg.PACKAGE_LIST;\n\nlet newPackageIndex = 0;\nlet diffDate = 0;\n\nlet processStore = msg.processStore;\nif( processStore.hasOwnProperty('createdAt') ) {\n    let createdAt = processStore['createdAt'];\n    let packageObj = packageList[newPackageIndex];\n    let nowDate = Date.now();\n    diffDate = (nowDate - createdAt) / 86400000;\n    if( diffDate > packageObj.activeDays ) {\n        newPackageIndex = 1;\n    }\n    \n}\n\nnode.error(`storeID: ${msg.processStore['storeID']} hasn't got any store package. Current store is \"NEW\" store..... 🆕`);\n\nmsg.newPackageIndex = newPackageIndex;\nreturn msg;","outputs":1,"noerr":0,"x":2100,"y":580,"wires":[["3a6200ff.a9bd4"]]},{"id":"d81e5bff.992f78","type":"function","z":"d45fe8d5.c48c98","name":"Has some store package","func":"let packageList = msg.PACKAGE_LIST;\nlet newPackageIndex = 1;\n\nnode.error(`storeID: ${msg.processStore['storeID']} has some store package. Current store is \"Actived\" store..... 👨💻`);\n\nmsg.newPackageIndex = newPackageIndex;\nreturn msg;","outputs":1,"noerr":0,"x":2090,"y":540,"wires":[["3a6200ff.a9bd4"]]},{"id":"e59d82a3.af7e7","type":"function","z":"d45fe8d5.c48c98","name":"INIT_NEW_PACKAGE","func":"let packageList = msg.PACKAGE_LIST;\nlet newPackageIndex = msg.newPackageIndex;\n\nnode.error(`➕ Create new package of store: ${msg.processStore['storeID']} with body:`);\nnode.error(packageList[newPackageIndex]);\n\nmsg.newPackage = packageList[newPackageIndex];\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":680,"wires":[["fed6c8f0.633558"]]},{"id":"c3b735fc.a62d78","type":"http in","z":"7aca8d6b.5bd9a4","name":"","url":"/calculateStorePackage","method":"post","upload":false,"swaggerDoc":"","x":160,"y":280,"wires":[["df30e3f2.555e3"]]},{"id":"df30e3f2.555e3","type":"switch","z":"7aca8d6b.5bd9a4","name":"","property":"payload.newPackageObj","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":280,"wires":[["1e8b618e.95aa8e"],["6159b80f.623548"]]},{"id":"b908af4b.65e5b","type":"http response","z":"7aca8d6b.5bd9a4","name":"","statusCode":"","headers":{},"x":770,"y":280,"wires":[]},{"id":"6159b80f.623548","type":"function","z":"7aca8d6b.5bd9a4","name":"Not found packageObj","func":"let data = {};\n\nmsg.statusCode = 400;\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":300,"wires":[["b908af4b.65e5b"]]},{"id":"1e8b618e.95aa8e","type":"function","z":"7aca8d6b.5bd9a4","name":"Found package","func":"let newPackageObj = msg.payload.newPackageObj;\nlet currentPackageObj = msg.payload.currentPackageObj;\nlet isActiveNow = msg.payload.isActiveNow;\nlet currentDate = (msg.payload.currentDate && msg.payload.currentDate.length > 0) ? new Date(msg.payload.currentDate).getTime() : Date.now() - (1000 * 10) ;\n\nlet chargePrice = 0;\nlet activeDate = currentDate;\nlet expiryDate = currentDate;\n\n// function changeCurrentHourToTimeStamp(currentDate) {\n//     return ( (new Date(currentDate).getHours() * 60 * 60 * 1000) + (new Date(currentDate).getMinutes() * 60 * 1000) + (new Date(currentDate).getSeconds() * 1000) );\n// }\n\n// function calculateActiveDate(packageObj, currentDate) {\n//     let billingType = packageObj.billingInfo.billingType; \n//     let billingDate = packageObj.billingInfo.billingDate;\n\n//     let activeDate = currentDate;\n//     if( billingType.length > 0 ) {\n//         switch( billingType ) {\n//             case \"WEEKLY\":\n//                 activeDate = currentDate + ( ( (6 - new Date(currentDate).getDay()) + billingDate) * 24 * 60 * 60 * 1000);\n//                 break;\n//             case \"MONTHLY\":\n//                 let nextMonth = new Date(currentDate).getMonth() + 1;\n//                 let year = new Date(currentDate).getFullYear();\n//                 if( nextMonth > 11 ) {\n//                     nextMonth = 0;\n//                     year = year + 1;\n//                 }\n//                 activeDate = new Date(year, nextMonth, billingDate, new Date(currentDate).getHours(), new Date(currentDate).getMinutes(), new Date(currentDate).getSeconds()).getTime();\n//                 break;\n//             case \"YEARLY\":\n//                 activeDate = new Date(new Date(currentDate).getFullYear() + 1, 0, billingDate, new Date(currentDate).getHours(), new Date(currentDate).getMinutes(), new Date(currentDate).getSeconds()).getTime();\n//                 break;\n//             default:\n//                 activeDate = currentDate;\n//         }\n//     }\n\n//     return activeDate;\n// }\n\n// function calculateExpiryDate(packageObj, currentDate, activeDate) {\n//     let billingType = packageObj.billingInfo.billingType; \n//     let billingDate = packageObj.billingInfo.billingDate;\n\n//     let expiryDate = Date.now();\n//     if( billingType.length > 0 ) {\n//         switch( billingType ) {\n//             case \"WEEKLY\":\n//                 expiryDate = activeDate + ( ( (6 - new Date(activeDate).getDay()) + billingDate) * 24 * 60 * 60 * 1000);\n//                 break;\n//             case \"MONTHLY\":\n//                 let nextMonth = new Date(activeDate).getMonth() + 1;\n//                 let year = new Date(activeDate).getFullYear();\n//                 if( nextMonth > 11 ) {\n//                     nextMonth = 0;\n//                     year = year + 1;\n//                 }\n//                 activeDate = new Date(year, nextMonth, billingDate, 0, 0, 1).getTime();\n//                 break;\n//             case \"YEARLY\":\n//                 activeDate = new Date(new Date(activeDate).getFullYear() + 1, 0, billingDate, 0, 0, 1).getTime();\n//                 break;\n//             default:\n//                 activeDate = Date.now();\n//         }\n//     } else {\n//         expiryDate = activeDate + ( packageObj.activeDays * 24 * 60 * 60 * 1000);\n//     }\n\n//     return expiryDate;\n// }\n\n\nfunction calculateNextCircleDate(packageObj, startDate) {\n    let billingType = packageObj.billingInfo.billingType; \n    let billingDate = packageObj.billingInfo.billingDate;\n\n    let nextStartDate = startDate;\n    if( billingType.length > 0 ) {\n        switch( billingType ) {\n            case \"WEEKLY\":\n                nextStartDate = startDate + ( ( (6 - new Date(startDate).getDay()) + billingDate) * 24 * 60 * 60 * 1000);\n                break;\n            case \"MONTHLY\":\n                let nextMonth = new Date(startDate).getMonth() + 1;\n                let year = new Date(startDate).getFullYear();\n                if( nextMonth > 11 ) {\n                    nextMonth = 0;\n                    year = year + 1;\n                }\n                nextStartDate = new Date(year, nextMonth, billingDate, new Date(startDate).getHours(), new Date(startDate).getMinutes(), new Date(startDate).getSeconds()).getTime();\n                break;\n            case \"YEARLY\":\n                nextStartDate = new Date(new Date(startDate).getFullYear() + 1, 0, billingDate, new Date(startDate).getHours(), new Date(startDate).getMinutes(), new Date(startDate).getSeconds()).getTime();\n                break;\n            case \"FIX\":\n                nextStartDate = startDate + ( packageObj.activeDays * 24 * 60 * 60 * 1000);\n                break;\n            default:\n                nextStartDate = startDate;\n        }\n    } else {\n        nextStartDate = startDate + ( packageObj.activeDays * 24 * 60 * 60 * 1000);\n    }\n\n    return nextStartDate;\n}\n\nfunction calculateChargePrice(currentDate, activeDate, newPackageObj, currentPackageObj) {\n    let billingType = newPackageObj.billingInfo.billingType; \n    // let billingDate = newPackageObj.billingInfo.billingDate;\n\n    let newMemberPrice = 0;\n    let currentMemberPrice = currentPackageObj && currentPackageObj.hasOwnProperty('memberPrice') ? currentPackageObj.memberPrice : 0 ;\n    if(newPackageObj.memberPrice > currentMemberPrice) {\n        newMemberPrice = newPackageObj.memberPrice - currentMemberPrice;\n    }\n\n    let chargePrice = 0;\n    if( billingType.length > 0 ) {\n        let lastDayOfMonth;\n        let lastDayOfYear;\n        switch( billingType ) {\n            case \"WEEKLY\":\n                chargePrice = (newMemberPrice / 7) * ( (activeDate - currentDate) / 86400 );\n                break;\n            case \"MONTHLY\":\n                lastDayOfMonth = new Date(new Date(currentDate).getFullYear(), new Date(currentDate).getMonth() + 1, 0).getDate();\n                chargePrice = (newMemberPrice / lastDayOfMonth) * ( (activeDate - currentDate) / 86400000 );               \n                break;\n            case \"YEARLY\":\n                lastDayOfYear = new Date(new Date(currentDate).getFullYear() + 1, 0, 0).getDate();\n                chargePrice = (newMemberPrice / lastDayOfYear) * ( (activeDate - currentDate) / 86400 );\n                break;\n            default:\n                chargePrice = newMemberPrice * ( (activeDate - currentDate) / 86400 );\n        }\n    } else {\n        chargePrice = newMemberPrice;\n    }\n\n    return chargePrice;\n}\n\n\nif( newPackageObj.isSubscribePackage ) {\n    if( isActiveNow === \"false\" || isActiveNow === false ) {\n        // activeDate = calculateActiveDate(newPackageObj, currentDate);\n        activeDate = calculateNextCircleDate(currentPackageObj, currentDate);\n        expiryDate = calculateNextCircleDate(newPackageObj, activeDate);\n        chargePrice = newPackageObj.memberPrice;\n    } else {\n        activeDate = currentDate;\n        expiryDate = calculateNextCircleDate(newPackageObj, activeDate);\n        chargePrice = calculateChargePrice(activeDate, expiryDate, newPackageObj, currentPackageObj);\n    }\n    // expiryDate = calculateExpiryDate(newPackageObj.billingInfo.billingType, newPackageObj.billingInfo.billingDate, currentDate, activeDate);\n} else {\n    chargePrice = newPackageObj.memberPrice;\n    if( isActiveNow === \"false\" || isActiveNow === false ) {\n        // activeDate = this.calculateActiveDate(newPackageObj, currentDate);\n        activeDate = calculateNextCircleDate(currentPackageObj, currentDate);\n    } else {\n        activeDate = currentDate;\n    }\n    expiryDate = activeDate + ( newPackageObj.activeDays * 24 * 60 * 60 * 1000);\n}\n\n\nmsg.statusCode = 200;\nmsg.payload = {\n    \"chargePrice\": Number( (Math.round(chargePrice * 100) / 100).toFixed(2) ),\n    \"activeDate\": activeDate,\n    \"expiryDate\": expiryDate\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":260,"wires":[["b908af4b.65e5b"]]},{"id":"5b9b4c49.37b8f4","type":"function-npm","z":"7aca8d6b.5bd9a4","name":"","func":"var moment = require('moment');\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":460,"wires":[[]]},{"id":"3a6200ff.a9bd4","type":"link out","z":"d45fe8d5.c48c98","name":"","links":["3cc94b42.40c124","60948d0.da5fc74"],"x":2275,"y":560,"wires":[]},{"id":"60948d0.da5fc74","type":"link in","z":"d45fe8d5.c48c98","name":"","links":["3a6200ff.a9bd4","7bddd64f.7df488"],"x":795,"y":680,"wires":[["e59d82a3.af7e7"]]},{"id":"80eec579.8a3828","type":"function","z":"d45fe8d5.c48c98","name":"INIT_NEW_PACKAGE","func":"let packageData = msg.payload;\n\nlet storePackageData = {\n    \"storeID\": msg.processStore['storeID'],\n    \"packageInfo\": msg.newPackage,\n    // \"chargePrice\": packageData.chargePrice,\n    \"status\": \"ACTIVE\",\n    \"createdAt\": Date.now(),\n    \"activeDate\": packageData.activeDate,\n    \"updatedAt\": 0,\n    \"expiryDate\": packageData.expiryDate\n};\n\nnode.error(`➕ Create store package of store: ${msg.processStore['storeID']} with body:`);\nnode.error(storePackageData);\n\nmsg.storePackageData = storePackageData;\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":760,"wires":[["63a573af.49400c"]]},{"id":"fed6c8f0.633558","type":"subflow:1bda0cde.761773","z":"d45fe8d5.c48c98","name":"","env":[],"x":970,"y":720,"wires":[["80eec579.8a3828"]]},{"id":"485c946d.80f0ec","type":"change","z":"75afdbb7.002304","name":"ALPHA","rules":[{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":360,"y":320,"wires":[["7a6d4af4.4f5734"]]},{"id":"bc5c77b.93bb988","type":"change","z":"75afdbb7.002304","name":"BETA","rules":[{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":360,"wires":[["7a6d4af4.4f5734"]]},{"id":"60739a48.755d94","type":"change","z":"75afdbb7.002304","name":"DEV","rules":[{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":280,"wires":[["7a6d4af4.4f5734"]]},{"id":"6bd6cc01.557324","type":"httpInMultipart","z":"75afdbb7.002304","name":"","url":"/recurringResultDev","method":"post","fields":"[]","swaggerDoc":"","x":150,"y":280,"wires":[["60739a48.755d94","ca8f7dac.8ff5b"]]},{"id":"d5a4e5bc.2dc778","type":"httpInMultipart","z":"75afdbb7.002304","name":"","url":"/recurringResultUat","method":"post","fields":"[]","swaggerDoc":"","x":150,"y":320,"wires":[["485c946d.80f0ec","ca8f7dac.8ff5b"]]},{"id":"c906d4ef.203dd8","type":"httpInMultipart","z":"75afdbb7.002304","name":"","url":"/recurringResult","method":"post","fields":"[{\"name\": \"referenceNo\"}, {\"name\": \"gbpReferenceNo\"}, {\"name\": \"amount\"}, {\"name\": \"recurringNo\"}]","swaggerDoc":"","x":140,"y":360,"wires":[["bc5c77b.93bb988","ca8f7dac.8ff5b"]]},{"id":"ca8f7dac.8ff5b","type":"debug","z":"75afdbb7.002304","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":350,"y":440,"wires":[]},{"id":"7a6d4af4.4f5734","type":"function","z":"75afdbb7.002304","name":"SAVE_TO_recurringResult","func":"const reqPayload = msg.payload;\nmsg.recurringResult = reqPayload;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":320,"wires":[["1aeffa5f.30c046","9cb628c6.3b94b8"]]},{"id":"ed41eabb.59c928","type":"switch","z":"75afdbb7.002304","name":"Found Recurring??","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1090,"y":320,"wires":[["945478e7.f629e8"],["7a8e7c16.273ee4"]]},{"id":"9d1f4814.ca2898","type":"subflow:56720de6.f1f724","z":"75afdbb7.002304","name":"GET_RECURRING_INFO","env":[],"x":850,"y":320,"wires":[["ed41eabb.59c928"]]},{"id":"7a8e7c16.273ee4","type":"function","z":"75afdbb7.002304","name":"Not found recurring","func":"node.error(`Not found recurring!! Process done.`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":340,"wires":[["ac4391a.597fc7"]]},{"id":"945478e7.f629e8","type":"function","z":"75afdbb7.002304","name":"SAVE_TO_recurringInfo","func":"msg.recurringInfo = msg.payload[0];\nmsg.STORE_ID = msg.recurringInfo.storeID;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1330,"y":300,"wires":[["ce35ef5b.4ed3c"]]},{"id":"3c2c8ba6.b1c3a4","type":"switch","z":"75afdbb7.002304","name":"Found Store Package??","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1930,"y":300,"wires":[["1a886d66.c70bb3"],["a59c2f06.cc18f"]]},{"id":"1a886d66.c70bb3","type":"function","z":"75afdbb7.002304","name":"SAVE_TO_storePackageInfo","func":"const recurringResult = msg.recurringResult;\nconst recurringStatus = ( recurringResult.resultCode === \"00\" ) ? \"SUCCESS\" : \"FALSE\" ;\nconst storePackageInfo = msg.payload[0];\n\nfunction getDate(dateObj) {\n    return dateObj.getFullYear()+'-'+(dateObj.getMonth()+1)+'-'+dateObj.getDate();\n}\n\n\n\nconst todayDate = getDate(new Date());\nconst expiryDate = getDate(new Date(storePackageInfo.expiryDate));\n\nmsg.storePackageInfo = storePackageInfo;\nmsg.recurringStatus = recurringStatus;\nmsg.todayDate = todayDate;\nmsg.expiryDate = expiryDate;\n\nreturn msg;","outputs":1,"noerr":0,"x":2200,"y":280,"wires":[["a8fc08ba.702c18"]]},{"id":"a59c2f06.cc18f","type":"function","z":"75afdbb7.002304","name":"Not found store package","func":"node.error(`Not found store package!! Process done.`);\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":320,"wires":[["eeeee6f1.777e48"]]},{"id":"f30b7898.4bbf38","type":"switch","z":"75afdbb7.002304","name":"Is expiryDate","property":"expiryDate","propertyType":"msg","rules":[{"t":"eq","v":"todayDate","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2710,"y":140,"wires":[["9d36300e.5a6ff"],["68c6d67d.3a8e48"]]},{"id":"68c6d67d.3a8e48","type":"subflow:af5887d6.e48a98","z":"75afdbb7.002304","name":"","env":[],"x":2980,"y":160,"wires":[["dbb9d17c.724d9"]]},{"id":"9d36300e.5a6ff","type":"function","z":"75afdbb7.002304","name":"SET_PACKAGE_TO_MSG","func":"const packageInfo = msg.storePackageInfo.packageInfo;\nmsg.packageInfo = packageInfo;\n\nreturn msg;","outputs":1,"noerr":0,"x":2980,"y":20,"wires":[["e3d95ce7.a7615"]]},{"id":"a8fc08ba.702c18","type":"switch","z":"75afdbb7.002304","name":"Recurring success??","property":"recurringResult.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2460,"y":280,"wires":[["f30b7898.4bbf38"],["95034504.3977b8"]]},{"id":"1aeffa5f.30c046","type":"http response","z":"75afdbb7.002304","name":"","statusCode":"200","headers":{},"x":760,"y":440,"wires":[]},{"id":"9c99a25d.7779c","type":"link in","z":"75afdbb7.002304","name":"","links":["ac4391a.597fc7","eeeee6f1.777e48","fa0a943c.466958","625080b6.b6b7e","1347e2fc.a667bd"],"x":535,"y":440,"wires":[["1aeffa5f.30c046"]]},{"id":"ac4391a.597fc7","type":"link out","z":"75afdbb7.002304","name":"","links":["9c99a25d.7779c"],"x":1455,"y":340,"wires":[]},{"id":"eeeee6f1.777e48","type":"link out","z":"75afdbb7.002304","name":"","links":["9c99a25d.7779c"],"x":2355,"y":320,"wires":[]},{"id":"fa0a943c.466958","type":"link out","z":"75afdbb7.002304","name":"","links":["9c99a25d.7779c"],"x":3495,"y":180,"wires":[]},{"id":"95034504.3977b8","type":"function","z":"75afdbb7.002304","name":"SET_PACKAGE_INACTIVE","func":"let storePackageInfo = msg.storePackageInfo;\nstorePackageInfo['status'] = \"INACTIVE\";\nstorePackageInfo['updatedAt'] = Date.now();\n\nmsg.storePackageInfo = storePackageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":2720,"y":300,"wires":[["8be5edca.4c30b"]]},{"id":"8be5edca.4c30b","type":"subflow:489b834b.3efb9c","z":"75afdbb7.002304","name":"","env":[],"x":2730,"y":340,"wires":[["12e78a18.ef7376"]]},{"id":"12e78a18.ef7376","type":"subflow:af5887d6.e48a98","z":"75afdbb7.002304","name":"","env":[],"x":2760,"y":380,"wires":[["dbc06194.35eb"]]},{"id":"19d66306.502b6d","type":"function","z":"75afdbb7.002304","name":"SET_PACKAGE_TO_MSG","func":"let packageInfo = msg.payload;\n\nmsg.packageInfo = packageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":2720,"y":460,"wires":[["deac9c6.2a3146"]]},{"id":"dbc06194.35eb","type":"subflow:e909bb98.e0f978","z":"75afdbb7.002304","name":"","env":[],"x":2730,"y":420,"wires":[["19d66306.502b6d"]]},{"id":"34b6d1ee.0cadae","type":"function","z":"75afdbb7.002304","name":"UPDATE_STORE_PACKAGE_DATA","func":"const calculatePackageInfo = msg.payload;\nconst packageInfo = msg.packageInfo;\n\nconst newStorePackageInfo = {\n    storePackageID: \"\",\n    storeID: msg.STORE_ID,\n    packageInfo: packageInfo,\n    status: \"ACTIVE\",\n    createdAt: Date.now(),\n    updatedAt: 0,\n    activeDate: calculatePackageInfo.activeDate,\n    expiryDate: calculatePackageInfo.expiryDate\n};\n\nmsg.storePackageInfo = newStorePackageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":2750,"y":540,"wires":[["f24c093b.faa308"]]},{"id":"deac9c6.2a3146","type":"subflow:2a7162e3.17b21e","z":"75afdbb7.002304","name":"","env":[],"x":2710,"y":500,"wires":[["34b6d1ee.0cadae"]]},{"id":"625080b6.b6b7e","type":"link out","z":"75afdbb7.002304","name":"","links":["9c99a25d.7779c"],"x":2895,"y":580,"wires":[]},{"id":"f24c093b.faa308","type":"subflow:c4bf3c42.2f2e7","z":"75afdbb7.002304","name":"","env":[],"x":2720,"y":580,"wires":[["625080b6.b6b7e"]]},{"id":"e3d95ce7.a7615","type":"subflow:2a7162e3.17b21e","z":"75afdbb7.002304","name":"","env":[],"x":2970,"y":60,"wires":[["e5e517e8.fab068"]]},{"id":"e5e517e8.fab068","type":"function","z":"75afdbb7.002304","name":"UPDATE_STORE_PACKAGE_DATA","func":"const calculatePackageInfo = msg.payload;\nlet storePackageInfo = msg.storePackageInfo;\n\nstorePackageInfo['expiryDate'] = calculatePackageInfo.expiryDate;\n\nmsg.storePackageInfo = storePackageInfo;\nreturn msg;","outputs":1,"noerr":0,"x":3010,"y":100,"wires":[["a55fb747.229f18"]]},{"id":"a55fb747.229f18","type":"subflow:489b834b.3efb9c","z":"75afdbb7.002304","name":"","env":[],"x":3370,"y":20,"wires":[["cbc4b517.30a6d8"]]},{"id":"cbc4b517.30a6d8","type":"subflow:af5887d6.e48a98","z":"75afdbb7.002304","name":"","env":[],"x":3400,"y":60,"wires":[["1347e2fc.a667bd"]]},{"id":"1347e2fc.a667bd","type":"link out","z":"75afdbb7.002304","name":"","links":["9c99a25d.7779c"],"x":3255,"y":100,"wires":[]},{"id":"2e13cfed.f3d4b","type":"function","z":"d8cc33e4.add7f","name":"INSERT_STORE_PACKAGE","func":"msg.url = `${msg.apiUrl}/storePackage/new`;\nmsg.payload = msg.storePackageData;\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":80,"wires":[["3049841b.0b25cc","b1455909.c44658"]]},{"id":"3049841b.0b25cc","type":"http request","z":"d8cc33e4.add7f","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":190,"y":120,"wires":[["5b60238.d2d7bdc"]]},{"id":"5b60238.d2d7bdc","type":"debug","z":"d8cc33e4.add7f","name":"INSERT_STORE_PACKAGE_debug2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":590,"y":120,"wires":[]},{"id":"b1455909.c44658","type":"debug","z":"d8cc33e4.add7f","name":"INSERT_STORE_PACKAGE_debug1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"url","targetType":"msg","x":590,"y":80,"wires":[]},{"id":"63a573af.49400c","type":"subflow:d8cc33e4.add7f","z":"d45fe8d5.c48c98","name":"","env":[],"x":960,"y":800,"wires":[["624a2961.f28b28"]]},{"id":"624a2961.f28b28","type":"switch","z":"d45fe8d5.c48c98","name":"Insert store package success?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1010,"y":860,"wires":[["aaa60f56.e804d"],["8df3268a.b0d698"]]},{"id":"aaa60f56.e804d","type":"function","z":"d45fe8d5.c48c98","name":"Insert success","func":"node.error(`Insert store package of storeID: ${msg.processStore['storeID']} success. New store package id is ${msg.payload}..... ✔️`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":840,"wires":[["83e56090.fbdd8"]]},{"id":"8df3268a.b0d698","type":"function","z":"d45fe8d5.c48c98","name":"Insert fail","func":"node.error(`Fail to insert store package of storeID: ${msg.processStore['storeID']}. Something went wrong..... ❌`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1240,"y":880,"wires":[["83e56090.fbdd8"]]},{"id":"772ba41.478d65c","type":"http in","z":"d3a831f5.f8fec","name":"","url":"/calculateGbpayPaymentFee","method":"post","upload":false,"swaggerDoc":"","x":180,"y":180,"wires":[["a8278459.ac1428","24efab66.ad9fe4"]]},{"id":"f928c8e7.58fa08","type":"http in","z":"d3a831f5.f8fec","name":"","url":"/calculateServiceFee","method":"post","upload":false,"swaggerDoc":"","x":150,"y":440,"wires":[["5498a3b1.d6149c","e1281bf0.c93d78"]]},{"id":"9cb628c6.3b94b8","type":"delay","z":"75afdbb7.002304","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":760,"y":260,"wires":[["9d1f4814.ca2898"]]},{"id":"dbb9d17c.724d9","type":"function","z":"75afdbb7.002304","name":"Check charging is pro rate?","func":"const recurringResult = msg.recurringResult;\nconst storePackageInfo = msg.storePackageInfo;\n\nif( Number(recurringResult.amount) !== Number(storePackageInfo.packageInfo.memberPrice) ) {\n    node.error(\"This recurring is 'Pro Rate', must update recurring amount to GB Pay.....\");\n    return [msg, null];\n} else {\n    node.error(\"This recurring is normal charging, not thing to do.\");\n    return [null, msg];\n}\n\nreturn msg;","outputs":2,"noerr":0,"x":3300,"y":160,"wires":[["25a284c6.351b0c"],["fa0a943c.466958"]]},{"id":"25a284c6.351b0c","type":"subflow:fe4bb160.370d2","z":"75afdbb7.002304","name":"","env":[],"x":3590,"y":140,"wires":[["fa0a943c.466958"]]},{"id":"ec350824.701028","type":"switch","z":"d45fe8d5.c48c98","name":"Current store has next store package?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1430,"y":440,"wires":[["9bbc1843.43bc28"],["c580d411.ef36e8"]]},{"id":"56e6f13f.8b4b6","type":"subflow:a69a0811.f42928","z":"d45fe8d5.c48c98","name":"","env":[],"x":1380,"y":380,"wires":[["ec350824.701028"]]},{"id":"9bbc1843.43bc28","type":"function","z":"d45fe8d5.c48c98","name":"Has next store package","func":"node.error(`storeID: ${msg.processStore['storeID']} has next store package, 😃 ✔️ go next.....`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":420,"wires":[["27ea847.6f57d7c"]]},{"id":"c580d411.ef36e8","type":"function","z":"d45fe8d5.c48c98","name":"Hasn't got next store package","func":"node.error(`storeID: ${msg.processStore['storeID']} hasn't got next store package. ❌`);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1750,"y":460,"wires":[["4befe062.ef7b1"]]},{"id":"cf47c123.26fcf","type":"inject","z":"4855adbb.ec1254","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":300,"wires":[["96550939.8ddda8"]]},{"id":"96550939.8ddda8","type":"function","z":"4855adbb.ec1254","name":"","func":"let obj = {\"key\": \"val\"};\nnode.log('test log')\nnode.log('test log obj:'+ JSON.stringify(obj))\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":300,"wires":[[]]},{"id":"f5ee535a.03818","type":"debug","z":"c4594cab.1347","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2850,"y":220,"wires":[]},{"id":"ce35ef5b.4ed3c","type":"subflow:7c10c31.7d9cc3c","z":"75afdbb7.002304","name":"","env":[],"x":1610,"y":300,"wires":[["3c2c8ba6.b1c3a4"]]},{"id":"2de9d82d.370a08","type":"http in","z":"c4594cab.1347","name":"","url":"/changeOrderStatus","method":"post","upload":false,"swaggerDoc":"","x":130,"y":460,"wires":[["f9fb6434.5449d8"]]},{"id":"f9fb6434.5449d8","type":"switch","z":"c4594cab.1347","name":"with ?orderID querystring or not","property":"payload.result","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":460,"wires":[["2f9b7715.1ccda8"],["cc7f6a31.0ef8c8"]]},{"id":"cc7f6a31.0ef8c8","type":"function","z":"c4594cab.1347","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Webhook result must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":500,"wires":[["9f1a6b.357e1598"]]},{"id":"9f1a6b.357e1598","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":330,"y":540,"wires":[]},{"id":"673c0d58.50fae4","type":"function","z":"c4594cab.1347","name":"","func":"let webhookResponse = msg.payload.result;\n\nmsg.webhookResponse = webhookResponse;\nmsg.ORDER_DOC_ID = webhookResponse.merchantDefined2;\nmsg.AMOUNT = webhookResponse.amount;\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":420,"wires":[["535912aa.b87c3c"]]},{"id":"833ccdc9.bc95a","type":"change","z":"c4594cab.1347","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":420,"wires":[["32a19bc9.ff07b4"]]},{"id":"856036c3.3ba8b8","type":"change","z":"c4594cab.1347","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":460,"wires":[["32a19bc9.ff07b4"]]},{"id":"535912aa.b87c3c","type":"change","z":"c4594cab.1347","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/findByOrderDocID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":500,"wires":[["32a19bc9.ff07b4"]]},{"id":"32a19bc9.ff07b4","type":"function","z":"c4594cab.1347","name":"SET_ORDER_ID_TO_API","func":"msg.url+= `?orderID=${msg.ORDER_DOC_ID}`;\n\nnode.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":420,"wires":[["6efb501e.98d7c"]]},{"id":"6efb501e.98d7c","type":"http request","z":"c4594cab.1347","name":"GET_ORDER","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1220,"y":460,"wires":[["5b862e21.47ddc","853e0c49.187a2"]]},{"id":"2d8ab9.eeb12548","type":"function","z":"c4594cab.1347","name":"SAVE_ORDER_TO_MSG_OBJ","func":"msg.orderInfo = msg.payload;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":420,"wires":[["1d3d03cd.dd7e7c"]]},{"id":"fb6da92b.7b1c18","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":1530,"y":540,"wires":[]},{"id":"1d3d03cd.dd7e7c","type":"switch","z":"c4594cab.1347","name":"order status us PENDING","property":"orderInfo.paymentInfo.status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1590,"y":460,"wires":[["c59fb6ac.d5be18"],["b88012bd.e916d"]]},{"id":"b88012bd.e916d","type":"function","z":"c4594cab.1347","name":"SAVE_ORDER_TO_MSG_OBJ","func":"let result = {\n    result: \"This order status is SUCCESS.\",\n    orderInfo: msg.orderInfo\n};\n\nmsg.payload = result;\n\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":500,"wires":[["fb6da92b.7b1c18"]]},{"id":"2f9b7715.1ccda8","type":"switch","z":"c4594cab.1347","name":"result code == 00","property":"payload.result.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":440,"wires":[["673c0d58.50fae4"],["f25b34ca.8dda88"]]},{"id":"f25b34ca.8dda88","type":"function","z":"c4594cab.1347","name":"","func":"msg.statusCode = 200;\nmsg.payload = {\n    \"message\": \"Result code != '00'\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":480,"wires":[["61896579.31078c"]]},{"id":"61896579.31078c","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":650,"y":520,"wires":[]},{"id":"c59fb6ac.d5be18","type":"function","z":"c4594cab.1347","name":"INIT_PAYLOAD_FOR_UPDATE_ORDER","func":"const orderInfo = msg.orderInfo;\nconst webhookResponse = msg.webhookResponse;\n\nconst storeID = orderInfo.storeID;\nconst orderDocID = msg.ORDER_DOC_ID;\n\nlet updateData = orderInfo;\n\nupdateData['orderDocID'] = orderDocID;\nif( webhookResponse.hasOwnProperty('cardNo') ) {\n    updateData['paymentInfo']['method'] = \"CREDIT_CARD\";\n    msg.PAYMENT_METHOD = \"CREDIT_CARD\";\n} else {\n    updateData['paymentInfo']['method'] = \"QR_CODE\";\n    msg.PAYMENT_METHOD = \"QR_CODE\";\n}\n\nif( webhookResponse.hasOwnProperty(\"gbpReferenceNo\") ) {\n    updateData['paymentInfo']['details'] = webhookResponse['gbpReferenceNo'];\n}\nif( webhookResponse.hasOwnProperty(\"customerName\") ) {\n    updateData['paymentInfo']['gbPaymentDetails']['customerName'] = webhookResponse['customerName'];\n}\nif( webhookResponse.hasOwnProperty(\"customerEmail\") ) {\n    updateData['paymentInfo']['gbPaymentDetails']['customerEmail'] = webhookResponse['customerEmail'];\n}\nupdateData['paymentInfo']['status'] = \"SUCCESS\";\nupdateData['paymentInfo']['isFromBatchCheck'] = true;\nupdateData['paymentInfo']['batchCheckTimestamp'] = Date.now();\nupdateData['paymentInfo']['paymentCompletedOn'] = Date.now();\n\nconst apiUrl = msg.apiUrl;\nconst url = `${apiUrl}/order/storeID/${storeID}/orderID/${orderDocID}/update`;\n\nmsg.url = url;\nmsg.payload = updateData;\nmsg.orderInfo = updateData;\n\n// node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1980,"y":440,"wires":[["22fab818.1a88f8","b68e2a25.7ac968"]]},{"id":"b68e2a25.7ac968","type":"http request","z":"c4594cab.1347","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1920,"y":480,"wires":[["3c7f218a.44b40e"]]},{"id":"4e31ee7a.f264b","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":2130,"y":740,"wires":[]},{"id":"3c7f218a.44b40e","type":"function","z":"c4594cab.1347","name":"CHECK_ORDER_RECIPIENT_ACCOUNT_TYPE","func":"let orderInfo = msg.orderInfo;\nlet recipientAccountType = orderInfo['recipientAccountType'];\nlet paymentStatus = orderInfo['paymentInfo']['status'];\n\nif( recipientAccountType === 'GB_PAY_WALLET' && paymentStatus === 'SUCCESS' ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"x":2330,"y":480,"wires":[["5e6e4cef.f2b044"],["15b9f6d0.d84629"]]},{"id":"15b9f6d0.d84629","type":"function","z":"c4594cab.1347","name":"Order Recipient Type isn't \"GB_PAY_WALLET\"","func":"// node.error(msg)\nlet orderInfo = msg.orderInfo;\nlet orderID = orderInfo['orderID'];\nnode.error(`Recipient type of this orderDocID: ${msg.ORDER_DOC_ID}, orderID: (${orderID}) isn't \"GB_PAY_WALLET\". Do not add money to merchant's wallet...`);\n\nreturn msg;","outputs":1,"noerr":0,"x":2340,"y":520,"wires":[["a91ee015.7efee"]]},{"id":"5e6e4cef.f2b044","type":"function","z":"c4594cab.1347","name":"PREPARE_CALCULATE_GB_PAY_FEE","func":"let nuser = 'arislab-prod';\nif( msg.hasOwnProperty('nuser') ) {\n    nuser = msg.nuser;\n}\n\n\nmsg.url = \"https://manage.arislab.ai/calculateGbpayPaymentFee\";\nmsg.payload = {\n    \"nuser\": nuser,\n    \"paymentInfo\": msg.webhookResponse\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2740,"y":460,"wires":[["e6362de3.1146c"]]},{"id":"5b862e21.47ddc","type":"switch","z":"c4594cab.1347","name":"Found order","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1210,"y":500,"wires":[["2d8ab9.eeb12548"],["cb35013.a9ad2"]]},{"id":"cb35013.a9ad2","type":"function","z":"c4594cab.1347","name":"","func":"msg.statusCode = 501;\nmsg.payload = {\n    \"message\": \"Not found orderID: \"+msg.ORDER_ID\n}\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":540,"wires":[["1059148f.c8292b"]]},{"id":"1059148f.c8292b","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":1190,"y":580,"wires":[]},{"id":"47c2232.28558dc","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":2990,"y":660,"wires":[]},{"id":"1331ba0f.15db86","type":"http request","z":"c4594cab.1347","name":"INSERT_FUNDS_TRANSACTION","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2720,"y":580,"wires":[["998f3a8b.e06a88"]]},{"id":"e6362de3.1146c","type":"http request","z":"c4594cab.1347","name":"CALCULATE_GB_PAY_FEE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2700,"y":500,"wires":[["3a05859e.cacc0a"]]},{"id":"3a05859e.cacc0a","type":"function","z":"c4594cab.1347","name":"PREPARE_INSERT_FUND_TRANSACTION","func":"let resultCalculate = msg.payload;\nlet orderInfo = msg.orderInfo;\n\nlet apiUrl = msg.apiUrl;\nlet url = `${apiUrl}/fundsTransaction/new`;\n\nlet storeID = orderInfo['storeID'];\nlet amount = msg.AMOUNT;\nlet orderID = orderInfo['orderID'];\nlet customerName = orderInfo['paymentInfo']['gbPaymentDetails']['customerName'];\n\nmsg.url = url;\nmsg.payload = {\n    \"storeID\": storeID,\n\t\"amount\": amount,\n\t\"actualAmount\": resultCalculate['totalAmount'],\n\t\"fee\": resultCalculate['fee'],\n\t\"type\": \"DEPOSIT\",\n\t\"orderInfo\": {\n    \t\"orderID\": orderID,\n        \"customerName\": customerName\n\t},\n\t\"createdAt\": Date.now(),\n\t\"isDeleted\": false,\n\t\"deletedAt\": 0\n}\n\nnode.error(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":2750,"y":540,"wires":[["1331ba0f.15db86"]]},{"id":"998f3a8b.e06a88","type":"function","z":"c4594cab.1347","name":"SAVE_FUNDS_TRANSACTION_ID","func":"msg.FUNDS_TRANSACTION_ID = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":2720,"y":620,"wires":[["a91ee015.7efee"]]},{"id":"a91ee015.7efee","type":"function","z":"c4594cab.1347","name":"PROCESS_RESULT","func":"msg.FUNDS_TRANSACTION_ID;\n\nlet result = {};\nresult['orderDocID'] = msg.ORDER_DOC_ID;\nif( msg.hasOwnProperty('FUNDS_TRANSACTION_ID') ) {\n    result['fundsTransactionID'] = msg.FUNDS_TRANSACTION_ID;\n} else {\n    result['fundsTransactionID'] = \"\";\n}\nresult['orderInfo'] = msg.orderInfo;\n\nmsg.payload = result;\n\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":660,"wires":[["47c2232.28558dc"]]},{"id":"853e0c49.187a2","type":"debug","z":"c4594cab.1347","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1380,"y":620,"wires":[]},{"id":"22fab818.1a88f8","type":"debug","z":"c4594cab.1347","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2250,"y":440,"wires":[]},{"id":"b0f0002e.b8df3","type":"function","z":"e140dd9b.b381c","name":"RESULT","func":"let currentBankRecord = msg.currentBankRecord;\n\nnode.error(`Response of bank number ${currentBankRecord.accountInfo.accountNumber} is: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1820,"y":300,"wires":[["6d788b3d.d416e4"]]},{"id":"384d9355.5676ec","type":"inject","z":"c80eab85.dafc88","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":80,"wires":[["360dd458.8bf83c"]]},{"id":"84c8ea19.65b178","type":"inject","z":"c80eab85.dafc88","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":220,"wires":[["2fc81ebb.dcae92"]]},{"id":"c97eaeec.2d94d","type":"inject","z":"c80eab85.dafc88","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":360,"wires":[["6212bcf8.4ce324"]]},{"id":"9b2ac5ad.9e2498","type":"comment","z":"c80eab85.dafc88","name":"DEV","info":"","x":390,"y":40,"wires":[]},{"id":"50906606.37b828","type":"comment","z":"c80eab85.dafc88","name":"ALPHA","info":"","x":390,"y":180,"wires":[]},{"id":"59af1124.d1ff7","type":"comment","z":"c80eab85.dafc88","name":"PROD","info":"","x":390,"y":320,"wires":[]},{"id":"4443c89b.b53298","type":"cronplus","z":"c80eab85.dafc88","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 22:30","payload":"","type":"str","expression":"0 30 22 * * * *"},{"topic":"10:30 AM","payload":"","type":"str","expression":"30 10 * * *"}],"x":100,"y":220,"wires":[["6212bcf8.4ce324"]]},{"id":"360dd458.8bf83c","type":"change","z":"c80eab85.dafc88","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":120,"wires":[["484d32b1.0a01bc"]]},{"id":"2fc81ebb.dcae92","type":"change","z":"c80eab85.dafc88","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":260,"wires":[["484d32b1.0a01bc"]]},{"id":"6212bcf8.4ce324","type":"change","z":"c80eab85.dafc88","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/bankRecord/findbankRecordsByStatus?isVerified=false","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":400,"wires":[["484d32b1.0a01bc"]]},{"id":"25f7fcd1.34f8d4","type":"http request","z":"c80eab85.dafc88","name":"GET_ALL_UNVERIFIED_BANK_RECORDS","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1050,"y":120,"wires":[["ae59e9d3.caba28","a9d4e045.4b8c9"]]},{"id":"ae59e9d3.caba28","type":"debug","z":"c80eab85.dafc88","name":"GET_ALL_UNVERIFIED_BANK_RECORDS_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1200,"y":80,"wires":[]},{"id":"a9d4e045.4b8c9","type":"function","z":"c80eab85.dafc88","name":"SAVE_PAYLOAD_TO_MSG_OBJ","func":"msg.bankRecordList = msg.payload;\nmsg.bankRecordListStatusCode = msg.statusCode;\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":180,"wires":[["a6e46aec.151058"]]},{"id":"be6b219.cb8a0e","type":"function","z":"c80eab85.dafc88","name":"PASSING_EACH_BANK_RECORD_TO_CHECK","func":"let bankRecordList = msg.bankRecordList;\nlet bankRecordListStatusCode = msg.bankRecordListStatusCode;\n\nif (msg.counter < bankRecordList.length) {\n    msg.bankRecord = bankRecordList[msg.counter];\n}\n\nreturn msg\n/*if (bankRecordListStatusCode === 200) {\n    bankRecordList.forEach((bankRecord, index) => {\n        setTimeout(() => {\n            msg.bankRecord = bankRecord;\n            node.send(msg);\n        }, 2000 * index)\n    });\n}*/","outputs":1,"noerr":0,"x":1110,"y":340,"wires":[["b7704c2a.cd2e8"]]},{"id":"b7704c2a.cd2e8","type":"function","z":"c80eab85.dafc88","name":"CREATE_OBJECT_FOR_CHECK","func":"let bankRecord = msg.bankRecord;\nmsg.currentBankRecord = bankRecord;\n\nlet bankAccount = bankRecord.accountInfo.accountNumber.replace(/\\-/g, \"\");\nlet bankCode = bankRecord.accountInfo.bank.bankCode;\nlet amount = 1;\nlet timeline = 1;\n\nmsg.payload = {\n    bankAccount: bankAccount,\n    bankCode: bankCode,\n    amount: amount,\n    timeline: timeline\n}\n\nnode.error(`Process bank account. Name: ${bankRecord.accountInfo.accountName}, Number: ${bankRecord.accountInfo.accountNumber}`);\nnode.error(`Request of bank number: ${bankRecord.accountInfo.accountNumber} with body: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1440,"y":220,"wires":[["48d10be9.468664","55c2de41.e5623"]]},{"id":"48d10be9.468664","type":"function","z":"c80eab85.dafc88","name":"SET_HEADERS","func":"//msg.headers = {}\n//msg.headers['Authorization'] = \"Basic PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\";\n//msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":280,"wires":[["3d8e7d85.20fc82"]]},{"id":"3d8e7d85.20fc82","type":"http request","z":"c80eab85.dafc88","name":"GB Pay for Prod","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_account","tls":"","proxy":"","authType":"basic","x":1620,"y":280,"wires":[["384526a0.db1d7a","9b74cb81.2f58c8"]]},{"id":"55c2de41.e5623","type":"debug","z":"c80eab85.dafc88","name":"CREATE_OBJECT_FOR_CHECK_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1460,"y":160,"wires":[]},{"id":"384526a0.db1d7a","type":"debug","z":"c80eab85.dafc88","name":"RESULT_CHECK_WITH_GB_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1950,"y":200,"wires":[]},{"id":"679b8214.d0fcec","type":"switch","z":"c80eab85.dafc88","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2000,"y":280,"wires":[["399b96cd.509f7a"],["da3a1917.f046d8"]]},{"id":"399b96cd.509f7a","type":"function","z":"c80eab85.dafc88","name":"VERIFIED_BANK_ACCOUNT","func":"let apiUrl = msg.apiUrl;\nlet gbpayResponse = msg.payload;\nlet currentBankRecord = msg.currentBankRecord;\nlet updatedBankRecord = currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\n\nnode.error(`Bank account ${currentBankRecord.accountInfo.accountNumber} is Verified. Update data to bank record: ${verifyID}.`);\n\nupdatedBankRecord.isVerified = true;\nupdatedBankRecord.verifiedAt = Date.now();\nupdatedBankRecord.verifyInfo.referenceNo = gbpayResponse.referenceNo;\n\nlet url = `${apiUrl}/bankRecord/verifyID/${verifyID}/update`;\n\nmsg.url = url;\nmsg.payload = updatedBankRecord;\n\nreturn msg;","outputs":1,"noerr":0,"x":2270,"y":260,"wires":[["dbebed0b.fbc1c","aa2ddfb0.10c3f"]]},{"id":"dbebed0b.fbc1c","type":"http request","z":"c80eab85.dafc88","name":"UPDATE_BANK_RECORD","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2260,"y":300,"wires":[["cbd30e53.7a362","afe24580.0579c8"]]},{"id":"cbd30e53.7a362","type":"function","z":"c80eab85.dafc88","name":"PREPARE_LOAD_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet currentBankRecord = msg.currentBankRecord;\nlet storeID = currentBankRecord.storeID;\n\nnode.error(`Get payment info from storeID: ${storeID}.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}`;\n\nmsg.url = url;\ndelete msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":2290,"y":340,"wires":[["3581ccf.cf73834"]]},{"id":"afe24580.0579c8","type":"debug","z":"c80eab85.dafc88","name":"RESULT_UPDATE_BANK_RECORD_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2630,"y":300,"wires":[]},{"id":"3581ccf.cf73834","type":"http request","z":"c80eab85.dafc88","name":"GET_PAYMENT_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2240,"y":380,"wires":[["eca0fc80.4945d","8d507cc5.c4861"]]},{"id":"eca0fc80.4945d","type":"debug","z":"c80eab85.dafc88","name":"RESULT_GET_PAYMENT_INFO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2620,"y":380,"wires":[]},{"id":"8d507cc5.c4861","type":"function","z":"c80eab85.dafc88","name":"CHECK_PAYMENT_INFO","func":"let storeInfo = msg.payload;\nlet paymentInfo = storeInfo.storeInfo.paymentInfo;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyBankAccountInfo = currentBankRecord.accountInfo;\n\n\nif( \n    (verifyBankAccountInfo.accountNumber === paymentInfo.accountNumber) &&\n    (verifyBankAccountInfo.bank.bankCode === paymentInfo.bank.bankCode)\n) {\n    msg.storeInfo = storeInfo;\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":2260,"y":440,"wires":[["3fb6c0bd.4d298"],["5e6a4c81.9ef394"]]},{"id":"3fb6c0bd.4d298","type":"function","z":"c80eab85.dafc88","name":"PREPARE_UPDATE_PAYMENT_INFO","func":"let apiUrl = msg.apiUrl;\nlet updateData = msg.storeInfo;\nlet storeID = updateData.storeID;\nlet currentBankRecord = msg.currentBankRecord;\nlet verifyID = currentBankRecord.verifyID;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nlet verifyInfo = {\n    isVerified: true,\n    verifyID: verifyID\n};\n\nupdateData.storeInfo.paymentInfo.verifyInfo = verifyInfo;\n\nnode.error(`Bank account ${displayAccount} match with payment info of storeID: ${storeID}. Update verify info.`);\n\nlet url = `${apiUrl}/payment/storeID/${storeID}/update`;\n\nmsg.url = url;\nmsg.payload = updateData;\n\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":420,"wires":[["24d7672d.3e2ce8","5927fe85.33815"]]},{"id":"24d7672d.3e2ce8","type":"http request","z":"c80eab85.dafc88","name":"UPDATE_PAYMENT_INFO","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2640,"y":460,"wires":[["fbf2ae11.f5fa7","74238f04.8584"]]},{"id":"5927fe85.33815","type":"debug","z":"c80eab85.dafc88","name":"PREPARE_UPDATE_PAYMENT_INFO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3080,"y":420,"wires":[]},{"id":"aa2ddfb0.10c3f","type":"debug","z":"c80eab85.dafc88","name":"VERIFIED_BANK_ACCOUNT_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2610,"y":260,"wires":[]},{"id":"fbf2ae11.f5fa7","type":"debug","z":"c80eab85.dafc88","name":"RESULT_UPDATE_PAYMENT_INFO_debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3070,"y":460,"wires":[]},{"id":"da3a1917.f046d8","type":"function","z":"c80eab85.dafc88","name":"NOT_VERIFY_BANK_ACCOUNT","func":"// node.error(msg)\nlet resultCode = msg.payload.resultCode;\nlet errorStatus = '';\n\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nswitch( resultCode ) {\n    case \"01\":\n        errorStatus = \"Balance is not enough\";\n        break;\n    case \"02\":\n        errorStatus = \"Bank account not found\";\n        break;\n    case \"90\":\n        errorStatus = \"System error\";\n        break;\n    default:\n        errorStatus = \"Unknown error\";\n}\n\nnode.error(`Can't check status of bank account ${displayAccount} , because \"${errorStatus}\". Skipping...`);\n\nreturn msg;","outputs":1,"noerr":0,"x":1920,"y":340,"wires":[["74238f04.8584"]]},{"id":"b0dfa722.7d2238","type":"function","z":"c80eab85.dafc88","name":"TEST_POST_TO_GB_PAY","func":"msg.headers = { Authorization: \"Basic PwpRAVimAIDF7EEe4iLWhh11M8EOaAcz\" }\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n// msg.headers['Authorization'] = \"Basic VExMV2dMSndTcWw1VkhYb01CMnB4MW40QkNFaEFUTW86\";\n\n// msg.payload = {\n//     bankAccount: \"0018906546\",\n//     bankCode: \"004\",\n//     amount: 1,\n//     timeline: 1\n// }\n\n\nmsg.payload = {\n    bankAccount: \"1615711908\",\n    bankCode: \"002\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":700,"wires":[["304fb3ed.eb87bc","889b65c5.7541e8"]]},{"id":"889b65c5.7541e8","type":"http request","z":"c80eab85.dafc88","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.gbprimepay.com/v1/check_account","tls":"","proxy":"","authType":"basic","x":950,"y":700,"wires":[["2e5b5e9d.848222"]]},{"id":"e89965a1.d2dd18","type":"inject","z":"c80eab85.dafc88","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":500,"y":700,"wires":[["b0dfa722.7d2238"]]},{"id":"2e5b5e9d.848222","type":"debug","z":"c80eab85.dafc88","name":"RESULT_CHECK_WITH_GB_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1210,"y":700,"wires":[]},{"id":"304fb3ed.eb87bc","type":"debug","z":"c80eab85.dafc88","name":"POST_DATA_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1000,"y":760,"wires":[]},{"id":"5e6a4c81.9ef394","type":"function","z":"c80eab85.dafc88","name":"NOT_MATCH_WITH_PAYMENT_INFO","func":"// node.error(msg)\nlet currentBankRecord = msg.currentBankRecord;\nlet displayAccount = currentBankRecord.accountInfo.accountNumber;\n\nnode.error(`Bank account ${displayAccount} not match with payment info. Skipping...`);\n","outputs":1,"noerr":0,"x":2280,"y":500,"wires":[["74238f04.8584"]]},{"id":"27ac9e93.eb0152","type":"http request","z":"c80eab85.dafc88","name":"GB Pay for Test","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.globalprimepay.com/v1/transfers","tls":"","proxy":"","authType":"basic","x":1620,"y":340,"wires":[["384526a0.db1d7a","9b74cb81.2f58c8"]]},{"id":"c4657b7b.82c588","type":"inject","z":"c80eab85.dafc88","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":820,"wires":[["46b9774b.9b0d68"]]},{"id":"46b9774b.9b0d68","type":"function","z":"c80eab85.dafc88","name":"debug context.global","func":"msg.payload = context.global;\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":860,"wires":[["ee0e46d9.b608d8"]]},{"id":"ee0e46d9.b608d8","type":"debug","z":"c80eab85.dafc88","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":540,"y":900,"wires":[]},{"id":"2276f916.60c2c6","type":"inject","z":"c80eab85.dafc88","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":820,"wires":[["338af9f.7db4106"]]},{"id":"338af9f.7db4106","type":"function","z":"c80eab85.dafc88","name":"reset context.global","func":"delete context.global['currentData'];\ndelete context.global['resultCheck'];\n\nmsg.payload = context.global;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":860,"wires":[["135cb265.128bde"]]},{"id":"135cb265.128bde","type":"debug","z":"c80eab85.dafc88","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","x":240,"y":900,"wires":[]},{"id":"484d32b1.0a01bc","type":"function","z":"c80eab85.dafc88","name":"SET_TIME_INTERVAL","func":"var intervalDay = 5;\nvar startTime = Date.now() - (24*60*60*intervalDay*1000);\nvar endTime = Date.now();\n\nmsg.url+= `&start=${startTime}&stop=${endTime}`;\nnode.error(msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":120,"wires":[["25f7fcd1.34f8d4"]]},{"id":"9b74cb81.2f58c8","type":"function","z":"c80eab85.dafc88","name":"RESULT","func":"let currentBankRecord = msg.currentBankRecord;\n\nnode.error(`Response of bank number ${currentBankRecord.accountInfo.accountNumber} is: `);\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1820,"y":280,"wires":[["679b8214.d0fcec"]]},{"id":"a6e46aec.151058","type":"function","z":"c80eab85.dafc88","name":"SET_COUNTER_FOR_LOOP","func":"msg.counter = 0;\nmsg.bankRecordListLength = msg.bankRecordList.length;\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":240,"wires":[["be6b219.cb8a0e"]]},{"id":"533b4cde.04ab54","type":"switch","z":"c80eab85.dafc88","name":"counter < bankRecordListLength","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"bankRecordListLength","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":420,"wires":[["be6b219.cb8a0e"],[]]},{"id":"74238f04.8584","type":"function","z":"c80eab85.dafc88","name":"INCREASE_COUNTER","func":"msg.counter += 1;\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":520,"wires":[["533b4cde.04ab54"]]},{"id":"45ca12c6.5fbafc","type":"http in","z":"9505666a.550668","name":"","url":"/refreshPage","method":"get","upload":false,"swaggerDoc":"","x":230,"y":100,"wires":[["11f109da.d1d326","46c5825.d05207c","11c22e8d.b2c541","ecc2bbf2.eccc58"]]},{"id":"53cc1ec4.f76ba","type":"http response","z":"9505666a.550668","name":"","statusCode":"","headers":{},"x":650,"y":100,"wires":[]},{"id":"46c5825.d05207c","type":"http request","z":"9505666a.550668","name":"msg-aws-sea01.convolab.ai","method":"GET","ret":"obj","paytoqs":false,"url":"https://msg-aws-sea01.convolab.ai/aris/refresh","tls":"","proxy":"","authType":"","x":500,"y":140,"wires":[[]]},{"id":"11c22e8d.b2c541","type":"http request","z":"9505666a.550668","name":"hooks.eu-gb.mybluemix.net","method":"GET","ret":"obj","paytoqs":false,"url":"https://hooks.eu-gb.mybluemix.net/aris/refresh","tls":"","proxy":"","authType":"","x":500,"y":180,"wires":[[]]},{"id":"ecc2bbf2.eccc58","type":"http request","z":"9505666a.550668","name":"msg.convolab.ai","method":"GET","ret":"obj","paytoqs":false,"url":"https://msg.convolab.ai/aris/refresh","tls":"","proxy":"","authType":"","x":460,"y":220,"wires":[[]]},{"id":"11f109da.d1d326","type":"change","z":"9505666a.550668","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"result\":\"success\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":100,"wires":[["53cc1ec4.f76ba"]]},{"id":"2569e5b1.8ee81a","type":"cronplus","z":"9505666a.550668","name":"","outputField":"payload","timeZone":"Asia/Bangkok","options":[{"topic":"Every 12AM","payload":"","type":"str","expression":"0 */12 * * *"}],"x":180,"y":180,"wires":[["11f109da.d1d326","46c5825.d05207c","11c22e8d.b2c541","ecc2bbf2.eccc58"]]},{"id":"7a200a9d.f7d954","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1890,"y":520,"wires":[]},{"id":"937df198.d4e42","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1930,"y":580,"wires":[]},{"id":"81edfc3.7e81b","type":"http request","z":"eb9ff6d6.6b53f8","name":"TRIGGER_UPDATE","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1970,"y":360,"wires":[[]]},{"id":"283fe96d.c2c816","type":"csv","z":"eb9ff6d6.6b53f8","name":"","sep":",","hdrin":"","hdrout":"","multi":"one","ret":"\\n","temp":"","skip":"0","x":1710,"y":620,"wires":[["937df198.d4e42","5aba50a6.c2fdf"]]},{"id":"5aba50a6.c2fdf","type":"file","z":"eb9ff6d6.6b53f8","name":"","filename":"txn2.csv","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":1860,"y":660,"wires":[[]]},{"id":"f621f509.52c928","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1570,"y":260,"wires":[]},{"id":"2c505302.6af15c","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.payload = msg.payload.txn;\nreturn msg;","outputs":1,"noerr":0,"x":1550,"y":640,"wires":[["283fe96d.c2c816"]]},{"id":"b68a5ada.409968","type":"http in","z":"eb9ff6d6.6b53f8","name":"","url":"/txnres","method":"get","upload":false,"swaggerDoc":"","x":1580,"y":740,"wires":[["f91718c7.a1a198"]]},{"id":"f91718c7.a1a198","type":"file in","z":"eb9ff6d6.6b53f8","name":"","filename":"txn2.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1780,"y":800,"wires":[["392d70ee.26fc9"]]},{"id":"392d70ee.26fc9","type":"http response","z":"eb9ff6d6.6b53f8","name":"","statusCode":"","headers":{},"x":2010,"y":740,"wires":[]},{"id":"4acce116.a3057","type":"change","z":"c4594cab.1347","name":"DEV","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.internal.arislab.ai:1780/api/order/orderID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"dev","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.internal.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-dev","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":770,"y":820,"wires":[["5cb053aa.5a64dc"]]},{"id":"2542ceae.218a92","type":"change","z":"c4594cab.1347","name":"ALPHA","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api/order/orderID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"alpha","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-alpha.arislab.ai:1780/api","tot":"str"},{"t":"set","p":"nuser","pt":"msg","to":"arislab-uat","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":860,"wires":[["5cb053aa.5a64dc"]]},{"id":"ad295385.a16e9","type":"change","z":"c4594cab.1347","name":"PROD","rules":[{"t":"set","p":"url","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api/order/orderID","tot":"str"},{"t":"set","p":"env","pt":"msg","to":"prod","tot":"str"},{"t":"set","p":"apiUrl","pt":"msg","to":"http://console.cb-beta.arislab.ai:1780/api","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":770,"y":900,"wires":[["5cb053aa.5a64dc"]]},{"id":"5cb053aa.5a64dc","type":"function","z":"c4594cab.1347","name":"SET_ORDER_ID_TO_API","func":"msg.url+= `/${msg.orderID}`;\n\nnode.error('GET order info: '+msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1120,"y":820,"wires":[["525ee782.add278"]]},{"id":"ebdb0e34.99127","type":"http in","z":"c4594cab.1347","name":"","url":"/checkOrder","method":"get","upload":false,"swaggerDoc":"","x":100,"y":820,"wires":[["46ebd92d.d2d498"]]},{"id":"3bbc5f1a.72f5b","type":"function","z":"c4594cab.1347","name":"","func":"let orderID = msg.payload.orderID;\n\nmsg.orderID = orderID;\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":820,"wires":[["ad295385.a16e9"]]},{"id":"46ebd92d.d2d498","type":"switch","z":"c4594cab.1347","name":"with ?orderID querystring or not","property":"payload.orderID","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":820,"wires":[["3bbc5f1a.72f5b"],["e982d929.c14068"]]},{"id":"e982d929.c14068","type":"function","z":"c4594cab.1347","name":"","func":"msg.statusCode = 400;\nmsg.payload = {\n    \"message\": \"Order ID must not be empty\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":860,"wires":[["7adc6fab.ef93d"]]},{"id":"7adc6fab.ef93d","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":290,"y":900,"wires":[]},{"id":"525ee782.add278","type":"http request","z":"c4594cab.1347","name":"GET_ORDER","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1080,"y":860,"wires":[["76e036dd.d98df8"]]},{"id":"b08ebf30.67b7d","type":"function","z":"c4594cab.1347","name":"SAVE_ORDER_TO_MSG_OBJ","func":"msg.orderInfo = msg.payload[0];\nmsg.storeID = msg.orderInfo['storeID'];\n\nnode.error('Result from get order:');\nnode.error(msg.payload);\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":920,"wires":[["2df78538.a2c44a"]]},{"id":"d1f3b866.752f68","type":"function","z":"c4594cab.1347","name":"CHECK_WITH_REFNO","func":"let order = msg.orderInfo;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\n// let gbPayLink = order['paymentInfo']['gbPayLink'];\n// let gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"REF_NO\";\n\nmsg.payload = {\n    referenceNo: refNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2430,"y":820,"wires":[["f0280522.ba3de8"]]},{"id":"f0280522.ba3de8","type":"function","z":"c4594cab.1347","name":"SET_HEADERS","func":"const gbPayAccountObj = msg.gbPayAccountObj;\n\nvar SECRET_KEY = \"\";\n\nif (gbPayAccountObj['found']) {\n    SECRET_KEY = gbPayAccountObj['secret_key'];\n}\n\nmsg.headers = {}\nmsg.headers['Authorization'] = `Basic ${Buffer.from(SECRET_KEY + \":\").toString('base64')}`;\n\nmsg.url = \"https://api.gbprimepay.com/v1/check_status_txn\";\n\n// node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":2680,"y":840,"wires":[["a8656b13.d52798"]]},{"id":"a8656b13.d52798","type":"http request","z":"c4594cab.1347","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2670,"y":880,"wires":[["29cc21d0.5426de"]]},{"id":"6617d47d.4f14ac","type":"function","z":"c4594cab.1347","name":"CHECK_WITH_LINKNO","func":"let order = msg.currentOrder;\n\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\n\nmsg.checkWith = \"LINK_NO\";\n\nmsg.payload = {\n    referenceNo: gbPayLinkNo\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2430,"y":880,"wires":[["f0280522.ba3de8"]]},{"id":"29cc21d0.5426de","type":"switch","z":"c4594cab.1347","name":"RESULT_CODE","property":"payload.resultCode","propertyType":"msg","rules":[{"t":"eq","v":"00","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2680,"y":940,"wires":[["e7cf381e.30d9a8"],["1399ecb9.70e3e3"]]},{"id":"1399ecb9.70e3e3","type":"switch","z":"c4594cab.1347","name":"REFNO_OR_LINKNO","property":"checkWith","propertyType":"msg","rules":[{"t":"eq","v":"REF_NO","vt":"str"},{"t":"eq","v":"LINK_NO","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2760,"y":1000,"wires":[["53e5322c.751d7c"],["55987ce0.45c084"]]},{"id":"55987ce0.45c084","type":"function","z":"c4594cab.1347","name":"Can't find REF_NO and LINK_NO 😢","func":"const ORDER_ID = msg.orderID;\n\nlet order = msg.currentOrder;\nlet orderID = order['orderID'];\nlet refNo = order['paymentInfo']['referenceNo'];\nlet gbPayLink = order['paymentInfo']['gbPayLink'];\nlet gbPayLinkNo = gbPayLink.split(\"/\")[6];\nnode.error(`Tried my best to find reference no of orderID: ${ORDER_ID} with refno: ${refNo} or ${gbPayLinkNo} , but I can't find it 😢. Skipping...`)\n\nmsg.payload = {\n    \"orderID\": ORDER_ID,\n    \"method\": \"\",\n    \"status\": \"PENDING\",\n    \"order_info\": msg.orderInfo,\n    \"gb_response\": {}\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":2970,"y":1060,"wires":[["53bad5d2.ed982c"]]},{"id":"53e5322c.751d7c","type":"link out","z":"c4594cab.1347","name":"LINK_NO_OUT","links":["d4c24441.d948c8","157c055c.d842db","e5fab1c7.29fd8"],"x":2915,"y":980,"wires":[]},{"id":"e5fab1c7.29fd8","type":"link in","z":"c4594cab.1347","name":"","links":["53e5322c.751d7c"],"x":2295,"y":940,"wires":[["6617d47d.4f14ac"]]},{"id":"2df78538.a2c44a","type":"function","z":"c4594cab.1347","name":"SET_BODY_TO_GET_STORE_INFO","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/businessProfile/storeID/${msg.storeID}/`;\nnode.error('GET store info: '+msg.url);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1710,"y":820,"wires":[["beedfeee.026e2"]]},{"id":"beedfeee.026e2","type":"http request","z":"c4594cab.1347","name":"GET_STORE_INFO","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1660,"y":860,"wires":[["a94ce075.04573"]]},{"id":"a94ce075.04573","type":"function","z":"c4594cab.1347","name":"SAVE_STORE_TO_MSG_OBJ","func":"msg.storeInfo = msg.payload;\n\nnode.error('Result from get store:');\nnode.error(msg.payload);\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":1690,"y":900,"wires":[["49fc8a73.420354"]]},{"id":"d9f5ad9c.cf7c4","type":"http request","z":"c4594cab.1347","name":"GET_GB_ACCOUNT","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":2040,"y":860,"wires":[["51b48784.2a1c68"]]},{"id":"49fc8a73.420354","type":"function","z":"c4594cab.1347","name":"SET_BODY_TO_GET_GB_ACCOUNT","func":"const apiUrl = msg.apiUrl;\n\nmsg.url = `${apiUrl}/gbpayAccount/findByToken`;\nmsg.payload = {\n    \"token\": msg.storeInfo.storeInfo.paymentInfo.gbPayInfo.token\n};\n\nnode.error('GET gb account info: '+msg.url+' with body:');\nnode.error(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":2090,"y":820,"wires":[["d9f5ad9c.cf7c4"]]},{"id":"51b48784.2a1c68","type":"function","z":"c4594cab.1347","name":"SAVE_GB_ACCOUNT_TO_MSG_OBJ","func":"msg.gbPayAccountObj = msg.payload.gbPayAccountInfo;\nmsg.gbPayAccountObj.found = true;\n\nmsg.currentOrder = msg.orderInfo;\n\nnode.error('Result from gb account store:');\nnode.error(msg.payload);\n\ndelete msg.url;\n\nreturn msg;","outputs":1,"noerr":0,"x":2090,"y":900,"wires":[["d1f3b866.752f68"]]},{"id":"76e036dd.d98df8","type":"switch","z":"c4594cab.1347","name":"Found order","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":940,"wires":[["b08ebf30.67b7d"],["b5960125.cfb19"]]},{"id":"b5960125.cfb19","type":"function","z":"c4594cab.1347","name":"","func":"msg.statusCode = 501;\nmsg.payload = {\n    \"message\": \"Not found orderID: \"+msg.orderID\n}\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":960,"wires":[["5d55193c.e94988"]]},{"id":"5d55193c.e94988","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":1230,"y":1000,"wires":[]},{"id":"e7cf381e.30d9a8","type":"function","z":"c4594cab.1347","name":"Find reference no","func":"node.error('Result from gb pay:');\nnode.error(msg.payload);\n\nmsg.GB_RESPONSE = msg.payload.txn;\n\nreturn msg;","outputs":1,"noerr":0,"x":2910,"y":880,"wires":[["af056837.32ba38"]]},{"id":"53bad5d2.ed982c","type":"http response","z":"c4594cab.1347","name":"","statusCode":"","headers":{},"x":3310,"y":880,"wires":[]},{"id":"af056837.32ba38","type":"function","z":"c4594cab.1347","name":"Process response.","func":"let GB_RESPONSE = msg.GB_RESPONSE;\nconst ORDER_ID = msg.orderID;\n\nconst checkMerchantDefined1 = (ORDER_ID, responseObj) => {\n    return responseObj.hasOwnProperty('merchantDefined1') && ( (responseObj['merchantDefined1'] !== null && responseObj['merchantDefined1'] == ORDER_ID) || responseObj['merchantDefined1'] === null );\n}\n\nconst processResponse = (ORDER_ID, responseObj) => {\n    let returnObj = {\n        \"method\": \"\",\n        \"status\": \"\"\n    };\n\n    let paymentMethod = \"QR_CODE\";\n    let paymentStatus = \"PENDING\";\n    if( responseObj.hasOwnProperty('cardNo') ) {\n        paymentMethod = \"CREDIT_CARD\";\n    }\n\n    if( responseObj.hasOwnProperty('status') ) {\n        const responseStatus = responseObj['status'].toUpperCase();\n\n        if( checkMerchantDefined1(ORDER_ID, responseObj) ) {\n            if( responseStatus === \"S\" ) {\n                paymentStatus = \"SUCCESS\";\n            } else if ( responseStatus === \"G\" ) {\n                paymentStatus = \"PENDING\";\n            } else if ( responseStatus === \"D\" ) {\n                paymentStatus = \"FAIL\";\n            } else if ( responseStatus === \"A\" ) {\n                if( paymentMethod === \"CREDIT_CARD\" ) {\n                    paymentStatus = \"SUCCESS\";\n                } else {\n                    paymentStatus = \"PENDING\";\n                }\n            }\n\n            returnObj['gb_response'] = responseObj;\n        }\n        \n    }\n    returnObj['method'] = paymentMethod;\n    returnObj['status'] = paymentStatus;\n    \n    return returnObj;\n}\n\nlet response = {};\nif( Array.isArray(GB_RESPONSE) ) {\n    node.error('Found multi response.');\n    for(i=0; i<GB_RESPONSE.length; i++) {\n        const gbResponse = GB_RESPONSE[i];\n        if( gbResponse.hasOwnProperty('merchantDefined1') && gbResponse['merchantDefined1'] === ORDER_ID ) {\n            response = processResponse(ORDER_ID, gbResponse);\n            break;\n        }\n    }\n} else {\n    node.error('Found single response.');\n    response = processResponse(ORDER_ID, GB_RESPONSE);\n}\n\nmsg.payload = {\n    \"orderID\": ORDER_ID,\n    \"method\": response['method'],\n    \"status\": response['status'],\n    \"order_info\": msg.orderInfo,\n    \"gb_response\": response['gb_response']\n};\n\nnode.error(msg.payload);\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":3130,"y":880,"wires":[["53bad5d2.ed982c"]]},{"id":"8fb1fce6.8ccce","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_PAYLOAD_FOR_WGET","func":"const url = msg.csvFileToGet;\nconst filename = msg.csvFilename;\n\n// msg.payload = `wget -O ${filename} ${url}`;\n// msg.payload = `wget ${url}`;\nmsg.url = url;\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":1580,"wires":[["5670dc32.3a7c14"]]},{"id":"c10971c3.bae16","type":"csv","z":"eb9ff6d6.6b53f8","name":"","sep":",","hdrin":"","hdrout":"","multi":"one","ret":"\\n","temp":"","skip":"0","x":730,"y":1700,"wires":[["62304368.a9084c"]]},{"id":"5670dc32.3a7c14","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":790,"y":1620,"wires":[["c10971c3.bae16"]]},{"id":"8045682e.f8d778","type":"file","z":"eb9ff6d6.6b53f8","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":750,"y":1800,"wires":[[]]},{"id":"62304368.a9084c","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.filename = msg.csvFilename;\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":1740,"wires":[["8045682e.f8d778"]]},{"id":"70cc1926.01ba68","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_EMAIL_BODY","func":"// const attachmentFilename = msg.csvFilename;\n\nmsg.emailTo = \"thatchanon@arislab.ai\";\nmsg.emailSubject = \"Daily order report: \" + Date.now();\nmsg.emailText = \"Here's your daily order report. \\n\";\nmsg.emailHtml = `<a href=\"https://www.google.com/\">Download daily report</a>`;\n// msg.emailAttachments = [\n//     {\n//         \"filename\": attachmentFilename,\n//         \"path\": `./${attachmentFilename}`\n//     }\n// ];\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":1640,"wires":[["5f3761ba.25872"]]},{"id":"7d61c4df.bdce1c","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":1580,"wires":[["70cc1926.01ba68"]]},{"id":"fe94bbe6.742ce8","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":290,"y":1720,"wires":[]},{"id":"5f3761ba.25872","type":"subflow:a3b720d7.727fa","z":"eb9ff6d6.6b53f8","name":"","env":[],"x":280,"y":1680,"wires":[["fe94bbe6.742ce8"]]},{"id":"1253f42.0c4670c","type":"csv","z":"eb9ff6d6.6b53f8","name":"data","sep":",","hdrin":true,"hdrout":false,"multi":"one","ret":"\\n","temp":"","skip":"0","x":1010,"y":1420,"wires":[["237080fb.a2719"]]},{"id":"237080fb.a2719","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1190,"y":1420,"wires":[]},{"id":"30839c26.7be1d4","type":"http in","z":"ea16a615.8ec0c8","name":"","url":"/liveChecker","method":"get","upload":false,"swaggerDoc":"","x":330,"y":120,"wires":[["59a8695d.0e99e8"]]},{"id":"c71fafaa.12555","type":"http response","z":"ea16a615.8ec0c8","name":"","statusCode":"","headers":{},"x":670,"y":140,"wires":[]},{"id":"59a8695d.0e99e8","type":"template","z":"ea16a615.8ec0c8","name":"","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html lang=\"en\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Live checker</title>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css\">\n</head>\n\n<body>\n    <div class=\"container\">\n        <h1>Live checker</h1>\n        <div class=\"row\">\n            <div class=\"col-md-12\">\n                <div class=\"form-group\">\n                    <input type=\"text\" class=\"form-control\" id=\"liveTitle\" placeholder=\"Live title\" />\n                    <span id=\"liveTitleStatus\"></span>\n                </div>\n                <!--<div class=\"form-group\">-->\n                <!--    <input type=\"text\" class=\"form-control\" id=\"liveDesc\" placeholder=\"Live description\" />-->\n                <!--    <span id=\"liveTitleDesc\"></span>-->\n                <!--</div>-->\n            </div>\n        </div>\n    </div>\n    <script type=\"text/javascript\">\n        const liveTitle = document.getElementById('liveTitle');\n        const liveTitleStatus = document.getElementById('liveTitleStatus');\n        \n        liveTitleStatus.innerText = \"\";\n        \n        const liveTitleHandler = function(e) {\n            let status = \"✅\";\n            if ((new TextEncoder().encode(e.target.value)).length > 254) {\n                status = \"❌\";\n            }\n            liveTitleStatus.innerText = status;\n        }\n        \n        liveTitle.addEventListener('input', liveTitleHandler);\n    </script>\n</body>\n\n</html>","output":"str","x":500,"y":260,"wires":[["c71fafaa.12555"]]},{"id":"2f2f139.87fe0ec","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_EMAIL_BODY","func":"const attachmentFilename = msg.csvFilename;\nnode.error('completed')\nmsg.emailTo = \"admin@arislab.ai\";\nmsg.emailSubject = \"Daily order report: \" + msg.REPORT_DATE;\nmsg.emailText = \"Here's your daily order report. \\n\";\n//msg.emailHtml = `<a href=\"https://manage.arislab.ai/reconcile.csv\">Download daily report</a>`;\nmsg.emailHtml = `<a href=\"https://manage.arislab.ai/download?file=${msg.FILE_NAME}\">Download daily report</a>`;\n\n// msg.emailAttachments = [\n//     {\n//         \"filename\": attachmentFilename,\n//         \"path\": `./${attachmentFilename}`\n//     }\n// ];\n\nreturn msg;","outputs":1,"noerr":0,"x":3160,"y":1320,"wires":[["5b78c000.e972d"]]},{"id":"5b78c000.e972d","type":"subflow:a3b720d7.727fa","z":"eb9ff6d6.6b53f8","name":"","env":[],"x":3140,"y":1380,"wires":[["6b307266.09ae9c"]]},{"id":"6b307266.09ae9c","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":3390,"y":1400,"wires":[]},{"id":"6d7ee8ba.ff06d8","type":"comment","z":"eb9ff6d6.6b53f8","name":"Automatically send yesterday order report to specified email","info":"","x":320,"y":1060,"wires":[]},{"id":"aad81159.82396","type":"function-npm","z":"eb9ff6d6.6b53f8","name":"SET_START_AND_END_TIMESTAMP","func":"const moment = require(\"moment-timezone\");\n// const momentTZ = require(\"moment-timezone\");\n\nconst start = moment().tz(\"Asia/Bangkok\").subtract(1,'days').startOf('day').valueOf();\nconst end = moment().tz(\"Asia/Bangkok\").subtract(1,'days').endOf('day').valueOf();\n\nmsg.orderReportStartTimestamp = start;\nmsg.orderReportEndTimestamp = end;\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":1120,"wires":[["a5cb54c5.35d258"]]},{"id":"a5cb54c5.35d258","type":"function","z":"eb9ff6d6.6b53f8","name":"SET_URL_OF_CSV_FILE_TO_SEND","func":"const start = msg.orderReportStartTimestamp;\nconst end = msg.orderReportEndTimestamp;\nmsg.csvFileToGet = `https://admin-internal.arislab.ai/export/csv/order?selectedStoreID=&selectedStatus=&startDate=${start}&endDate=${end}`;\nmsg.csvFilename = `order_daily_report_${Date.now()}.csv`;\nmsg.url = `https://admin-internal.arislab.ai/export/csv/order?selectedStoreID=&selectedStatus=&startDate=${start}&endDate=${end}`;\nnode.error(msg.url)\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":1160,"wires":[["282a7c5a.338b44"]]},{"id":"cb472188.dd804","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1120,"wires":[["aad81159.82396"]]},{"id":"cfc08542.c9ce68","type":"cronplus","z":"eb9ff6d6.6b53f8","name":"","outputField":"payload","timeZone":"","options":[{"topic":"every 1AM","payload":"","type":"str","expression":"0 1 * * *"}],"x":140,"y":1180,"wires":[[]]},{"id":"282a7c5a.338b44","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":710,"y":1140,"wires":[["2b28a374.0712ec"]]},{"id":"d2ae1d6.73ab7e","type":"csv","z":"eb9ff6d6.6b53f8","name":"data","sep":",","hdrin":true,"hdrout":false,"multi":"mult","ret":"\\n","temp":"","skip":"0","strings":true,"x":1050,"y":1140,"wires":[["ef868f23.35141"]]},{"id":"ac5a6113.0981d","type":"file","z":"eb9ff6d6.6b53f8","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":2430,"y":1200,"wires":[["159d5d2.5d20ba3"]]},{"id":"2b28a374.0712ec","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.payload = msg.payload.replace(/[) ][\\n]/gm, \"\").replace(/\"\"/gm, \"-\");\nmsg.csv = []\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":1140,"wires":[["f97fce12.1566c","d2ae1d6.73ab7e"]]},{"id":"e5ad4e8d.df5df","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"if (msg.payload) {\n    if (msg.payload.hasOwnProperty('status')) {\n        msg.csvBody[msg.counter]['gbStatus'] = msg.payload['status'];\n    } else {\n        msg.csvBody[msg.counter]['gbStatus'] = \"No gbStatus\"\n    }\n} else {\n    msg.csvBody[msg.counter]['gbStatus'] = \"No gbStatus\";\n}\n\nmsg.url = `http://console.cb-beta.arislab.ai:1780/api/fundsTransaction/orderID/${msg.csvBody[msg.counter].orderID}`\n// msg.url = `http://console.internal.arislab.ai:1780/api/fundsTransaction/orderID/xxxyyy`\n\nreturn msg;","outputs":1,"noerr":0,"x":1870,"y":1140,"wires":[["eec438c0.7b0888"]]},{"id":"f8491a6d.a0d8b8","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":1280,"wires":[["9d750de9.bf2d4"]]},{"id":"865de737.ed1c48","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1650,"y":1140,"wires":[["758d077a.d7b958","e5ad4e8d.df5df"]]},{"id":"ef868f23.35141","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.csvHeader = [\n    \"orderDocID\",\n    \"storeID\",\n    \"referenceNo\",\n    \"orderID\",\n    \"orderDate\",\n    \"paymentCompletedOn\",\n    \"customerFBFullName\",\n    \"customerName\",\n    \"customerEmail\",\n    \"customerAddress\",\n    \"subDistrict\",\n    \"district\",\n    \"province\",\n    \"postalCode\",\n    \"customerTelephone\",\n    \"selectedProduct\",\n    \"productHashtag\",\n    \"productSKU\",\n    \"paymentStatus\",\n    \"paymentMethod\",\n    \"totalPrice\",\n    \"totalDeliveryCost\",\n    \"grandTotal\",\n    \"fee\",\n    \"afterFee\",\n    \"gbPayReferenceNo\",\n    \"gbPayLink\",\n    \"fbPageName\",\n    \"gbStatus\",\n    \"fundsTransactionStatus\"\n];\n\nmsg.csvBody = msg.payload;\nmsg.csvBodyLength = msg.csvBody.length;\nmsg.counter = 0;\nmsg.timeout = 2000;\nreturn msg;\n\n// msg.csv = msg.payload\n// msg.url = `http://manage.arislab.ai/checkOrder?orderID=${msg.csv.orderID}`\n// return msg;","outputs":1,"noerr":0,"x":1250,"y":1140,"wires":[["44485521.f435cc"]]},{"id":"9d750de9.bf2d4","type":"file","z":"eb9ff6d6.6b53f8","name":"","filename":"orders.csv","appendNewline":true,"createDir":false,"overwriteFile":"delete","encoding":"none","x":470,"y":1340,"wires":[[]]},{"id":"c5b2236e.bd7fd","type":"csv","z":"eb9ff6d6.6b53f8","name":"data","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\n","temp":"","skip":"0","x":2290,"y":1200,"wires":[["ac5a6113.0981d"]]},{"id":"4a67ba25.f70a24","type":"http in","z":"eb9ff6d6.6b53f8","name":"","url":"/reconcile.csv","method":"get","upload":false,"swaggerDoc":"","x":1650,"y":1340,"wires":[["7c12511.22361b"]]},{"id":"7c12511.22361b","type":"file in","z":"eb9ff6d6.6b53f8","name":"","filename":"orders.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1830,"y":1340,"wires":[["be36a7e7.620558"]]},{"id":"be36a7e7.620558","type":"http response","z":"eb9ff6d6.6b53f8","name":"","statusCode":"","headers":{"content-type":"text/csv"},"x":1990,"y":1340,"wires":[]},{"id":"6ae2a7a6.c01058","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"// msg.payload = msg.csvBody[msg.counter]\nnode.error(`Requesting @${msg.counter}/${msg.csvBody.length}`);\nmsg.url = `http://manage.arislab.ai/checkOrder?orderID=${msg.csvBody[msg.counter].orderID}`\nnode.error(`OrderID ${msg.csvBody[msg.counter].orderID}`)\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1140,"wires":[["865de737.ed1c48"]]},{"id":"44485521.f435cc","type":"switch","z":"eb9ff6d6.6b53f8","name":"switch","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"csvBody.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1430,"y":1220,"wires":[["6ae2a7a6.c01058"],["5046855c.2d287c","778f57f2.7dfbd8"]]},{"id":"b9b0192e.7c49b8","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.counter += 1;\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1300,"wires":[["44485521.f435cc"]]},{"id":"5046855c.2d287c","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.payload = msg.csvHeader;\nnode.error('Test');\nnode.error(msg.csvHeader);\n\nvar d = new Date();\nvar year = d.getFullYear();\nvar month = (100 + d.getMonth() + 1).toString().substring(1)\nvar day = (100 + d.getDate() - 1).toString().substring(1);\nmsg.REPORT_DATE = `${day}/${month}/${year}`;\nmsg.FILE_NAME = `reconcile_order_${year}_${month}_${day}.csv`;\nmsg.filename = `report/${msg.FILE_NAME}`;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2130,"y":1200,"wires":[["c5b2236e.bd7fd"]]},{"id":"159d5d2.5d20ba3","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.counter = 0;\nmsg.payload = [];\nnode.error('Set start loop');\nreturn msg;","outputs":1,"noerr":0,"x":2650,"y":1200,"wires":[["d1790900.fb68f8"]]},{"id":"d1790900.fb68f8","type":"switch","z":"eb9ff6d6.6b53f8","name":"","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"csvBody.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2810,"y":1200,"wires":[["7ecb8401.f6e24c"],["2f2f139.87fe0ec"]]},{"id":"af0864fe.a297a8","type":"csv","z":"eb9ff6d6.6b53f8","name":"data","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\n","temp":"","skip":"0","x":3090,"y":1200,"wires":[["c8827e32.bb69e"]]},{"id":"7ecb8401.f6e24c","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.payload = msg.csvBody[msg.counter];\nreturn msg;","outputs":1,"noerr":0,"x":2950,"y":1200,"wires":[["af0864fe.a297a8"]]},{"id":"c8827e32.bb69e","type":"file","z":"eb9ff6d6.6b53f8","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"false","encoding":"none","x":3230,"y":1200,"wires":[["882477e.8f4a688"]]},{"id":"882477e.8f4a688","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"node.error(`Writing @${msg.counter}/${msg.csvBody.length}`)\nmsg.counter += 1;\nreturn msg;","outputs":1,"noerr":0,"x":2850,"y":1080,"wires":[["d1790900.fb68f8"]]},{"id":"87f79290.679ff","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"msg.csv.push(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":1060,"wires":[[]]},{"id":"778f57f2.7dfbd8","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"csvBody","targetType":"msg","x":1670,"y":1260,"wires":[]},{"id":"f97fce12.1566c","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1070,"y":1260,"wires":[]},{"id":"eec438c0.7b0888","type":"http request","z":"eb9ff6d6.6b53f8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":1890,"y":1080,"wires":[["10bb220e.f1034e","7f0a41ee.89043"]]},{"id":"10bb220e.f1034e","type":"function","z":"eb9ff6d6.6b53f8","name":"","func":"\nif (msg.payload.length > 0) {\n    msg.csvBody[msg.counter]['fundsTransactionStatus'] = \"SUCCESS\";\n} else {\n    msg.csvBody[msg.counter]['fundsTransactionStatus'] = \"-\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2070,"y":1080,"wires":[["b9b0192e.7c49b8"]]},{"id":"3528c597.7a17fa","type":"switch","z":"eb9ff6d6.6b53f8","name":"","property":"counter","propertyType":"msg","rules":[{"t":"lt","v":"csvBody.length","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1430,"y":1040,"wires":[[],[]]},{"id":"fd8305b0.245ec8","type":"inject","z":"eb9ff6d6.6b53f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2980,"y":1260,"wires":[["2f2f139.87fe0ec"]]},{"id":"758d077a.d7b958","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1710,"y":1000,"wires":[]},{"id":"7f0a41ee.89043","type":"debug","z":"eb9ff6d6.6b53f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2090,"y":1000,"wires":[]},{"id":"f0999df4.4d22d","type":"http in","z":"47a19322.f1f68c","name":"","url":"/download","method":"get","upload":false,"swaggerDoc":"","x":100,"y":100,"wires":[["7d54b2ac.14b6dc"]]},{"id":"dde48aa5.103e08","type":"file in","z":"47a19322.f1f68c","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":910,"y":60,"wires":[["f57929b0.12d7a8"]]},{"id":"f57929b0.12d7a8","type":"http response","z":"47a19322.f1f68c","name":"","statusCode":"","headers":{},"x":1070,"y":60,"wires":[]},{"id":"7d54b2ac.14b6dc","type":"switch","z":"47a19322.f1f68c","name":"with ?file querystring or not","property":"payload.file","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":100,"wires":[["e55c5026.42f48"],["bd72a06b.018c5"]]},{"id":"bd72a06b.018c5","type":"change","z":"47a19322.f1f68c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"Missing file download, Please check and try again","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"400","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":580,"y":180,"wires":[["4b3aa316.ee692c"]]},{"id":"4b3aa316.ee692c","type":"http response","z":"47a19322.f1f68c","name":"","statusCode":"","headers":{},"x":550,"y":220,"wires":[]},{"id":"e55c5026.42f48","type":"function","z":"47a19322.f1f68c","name":"CHECK_FILE_DOWNLOAD","func":"var fileName = msg.payload.file;\n\nlet foundFile = false;\nconst reconcilePattern = /^reconcile/g;\n\nif( reconcilePattern.test(fileName) ) {\n    foundFile = true;\n    msg.filename = `report/${fileName}`;\n    msg.headers = {\n        'Content-Type': 'text/csv',\n        'Content-Disposition': `attachment; filename=\"${fileName}\"`\n    };\n}\n\n\n\nif( foundFile ) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":640,"y":80,"wires":[["dde48aa5.103e08"],["3007993d.927266"]]},{"id":"3007993d.927266","type":"change","z":"47a19322.f1f68c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.message","pt":"msg","to":"file not found","tot":"str"},{"t":"set","p":"statusCode","pt":"msg","to":"404","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":160,"wires":[["490d2b39.6403d4"]]},{"id":"490d2b39.6403d4","type":"http response","z":"47a19322.f1f68c","name":"","statusCode":"","headers":{},"x":830,"y":200,"wires":[]},{"id":"2cf83aac.b87036","type":"http in","z":"4855adbb.ec1254","name":"","url":"/getVoucherCode","method":"get","upload":false,"swaggerDoc":"","x":160,"y":1040,"wires":[["e8076b40.0b04d8"]]},{"id":"7f4cc035.f479e","type":"file in","z":"4855adbb.ec1254","name":"","filename":"testVoucher.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":670,"y":1000,"wires":[["2f7e8afa.6534b6"]]},{"id":"2f7e8afa.6534b6","type":"function","z":"4855adbb.ec1254","name":"","func":"let voucherArr = msg.payload.split(\"\\n\");\n\nmsg.payload = voucherArr[0];\n\nnode.error(\"Before splice \"+ voucherArr.length)\n\nvoucherArr.splice(0,1)\n\nnode.error(\"After splice \"+ voucherArr.length)\n\nlet voucherString = voucherArr.join('\\n')\n\nvoucherString = voucherString.replace(/\\n$/g,\"\")\n\nnode.error(voucherString)\n\ncontext.global.voucherString = voucherString\n\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":1040,"wires":[["965e6b24.c65bc8","2b0ebef7.4ea992","5e994a57.ffa8e4"]]},{"id":"2b0ebef7.4ea992","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":1010,"y":960,"wires":[]},{"id":"965e6b24.c65bc8","type":"debug","z":"4855adbb.ec1254","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1010,"y":1120,"wires":[]},{"id":"c68490f7.e1b2c","type":"file","z":"4855adbb.ec1254","name":"","filename":"testVoucher.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1340,"y":1000,"wires":[[]]},{"id":"2728a4f0.bdc61c","type":"switch","z":"4855adbb.ec1254","name":"","property":"payload.useFile","propertyType":"msg","rules":[{"t":"eq","v":"file1","vt":"str"},{"t":"eq","v":"file2","vt":"str"},{"t":"eq","v":"file3","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":490,"y":1040,"wires":[["7f4cc035.f479e"],["5c51cd7c.9ec1a4"],["29679ca5.142994"],["12a17c80.495af4"]]},{"id":"5c51cd7c.9ec1a4","type":"file in","z":"4855adbb.ec1254","name":"","filename":"testVoucher2.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":680,"y":1040,"wires":[["2f7e8afa.6534b6"]]},{"id":"29679ca5.142994","type":"file in","z":"4855adbb.ec1254","name":"","filename":"testVoucher3.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":680,"y":1080,"wires":[["2f7e8afa.6534b6"]]},{"id":"5e994a57.ffa8e4","type":"switch","z":"4855adbb.ec1254","name":"","property":"useFile","propertyType":"global","rules":[{"t":"eq","v":"file1","vt":"str"},{"t":"eq","v":"file2","vt":"str"},{"t":"eq","v":"file3","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1010,"y":1040,"wires":[["71e54eeb.d27b2"],["64be926d.53bdcc"],["49b206ba.89ef08"]]},{"id":"e8076b40.0b04d8","type":"function","z":"4855adbb.ec1254","name":"","func":"context.global.useFile = msg.payload.useFile;\nnode.error(msg.payload.useFile)\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":1040,"wires":[["2728a4f0.bdc61c"]]},{"id":"2740b724.9659b8","type":"file","z":"4855adbb.ec1254","name":"","filename":"testVoucher2.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1350,"y":1040,"wires":[[]]},{"id":"2307cbd9.5dd904","type":"file","z":"4855adbb.ec1254","name":"","filename":"testVoucher3.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1350,"y":1080,"wires":[[]]},{"id":"71e54eeb.d27b2","type":"function","z":"4855adbb.ec1254","name":"","func":"msg.payload = context.global.voucherString\nnode.error(msg)\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1000,"wires":[["c68490f7.e1b2c"]]},{"id":"64be926d.53bdcc","type":"function","z":"4855adbb.ec1254","name":"","func":"msg.payload = context.global.voucherString\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1040,"wires":[["2740b724.9659b8"]]},{"id":"49b206ba.89ef08","type":"function","z":"4855adbb.ec1254","name":"","func":"msg.payload = context.global.voucherString\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1080,"wires":[["2307cbd9.5dd904"]]},{"id":"12a17c80.495af4","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":650,"y":1120,"wires":[]},{"id":"122c8493.6d7b2b","type":"http in","z":"4855adbb.ec1254","name":"","url":"/vote","method":"post","upload":false,"swaggerDoc":"","x":130,"y":1180,"wires":[["3af9a85f.549688"]]},{"id":"792ee0f.369a52","type":"file in","z":"4855adbb.ec1254","name":"","filename":"voteResult.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":480,"y":1180,"wires":[["e79dc9b6.0584e8"]]},{"id":"3af9a85f.549688","type":"function","z":"4855adbb.ec1254","name":"","func":"context.global.voteNumber = msg.payload.voteNumber;\nnode.error(msg.payload.voteNumber)\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":1180,"wires":[["792ee0f.369a52"]]},{"id":"e79dc9b6.0584e8","type":"function","z":"4855adbb.ec1254","name":"","func":"let voteArr = msg.payload.split(\"\\n\");\nlet hadVote = false;\nlet voteNumber = context.global.voteNumber;\nlet index = 0;\n\nvoteArr.splice(voteArr.length-1, 1)\n\nnode.error(voteArr)\n\nfor(let i=0;i < voteArr.length;i++){\n    if(voteArr[i].length > 0){\n        let voteObj = JSON.parse(voteArr[i])\n        if(voteObj.number == voteNumber){\n            hadVote = true\n            index = i\n        }\n    }\n}\n\nif(hadVote){\n    let voteObj = JSON.parse(voteArr[index])\n    let voteStr = JSON.stringify({\"number\": voteObj.number,\"value\": voteObj.value+1})\n    voteArr.splice(index,1)\n    voteArr.push(voteStr)\n}\nelse{\n    let voteStr = JSON.stringify({\"number\": voteNumber,\"value\": 1});\n    voteArr.push(voteStr)\n}\nlet voteArrStr = voteArr.join(\"\\n\")\nvoteArrStr = voteArrStr.replace(/\\n$/g,\"\")\nnode.error(voteArrStr)\n\nmsg.payload = voteArrStr\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":1180,"wires":[["471ff735.b0d0a8","36d4d48.dad9d2c"]]},{"id":"471ff735.b0d0a8","type":"file","z":"4855adbb.ec1254","name":"","filename":"voteResult.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":840,"y":1180,"wires":[[]]},{"id":"36d4d48.dad9d2c","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":820,"y":1260,"wires":[]},{"id":"3a8f890.b118878","type":"http in","z":"4855adbb.ec1254","name":"","url":"/voteResult","method":"get","upload":false,"swaggerDoc":"","x":150,"y":1320,"wires":[["bfc1437e.4a2c6"]]},{"id":"bfc1437e.4a2c6","type":"file in","z":"4855adbb.ec1254","name":"","filename":"voteResult.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":360,"y":1320,"wires":[["218b613c.a37e3e"]]},{"id":"218b613c.a37e3e","type":"http response","z":"4855adbb.ec1254","name":"","statusCode":"","headers":{},"x":540,"y":1320,"wires":[]}]